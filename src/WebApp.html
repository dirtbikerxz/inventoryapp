<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Denham Venom Parts System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --lsu-purple: #461D7C;
      --lsu-gold: #FDD023;
      --white: #FFFFFF;
      --light-gray: #F5F5F5;
      --medium-gray: #E0E0E0;
      --dark-gray: #333333;
      --success-green: #28a745;
      --error-red: #dc3545;
      --warning-orange: #ffc107;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--lsu-purple) 0%, #5a2a8f 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark-gray);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: var(--white);
      padding: 25px;
      border-radius: 10px 10px 0 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      border-bottom: 4px solid var(--lsu-gold);
    }

    .header h1 {
      color: var(--lsu-purple);
      font-size: 2em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      color: var(--dark-gray);
      font-size: 1.1em;
    }

    .tab-navigation {
      display: flex;
      background: var(--white);
      border-bottom: 2px solid var(--medium-gray);
    }

    .tab-button {
      flex: 1;
      padding: 18px;
      background: var(--light-gray);
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      color: var(--dark-gray);
      transition: all 0.3s ease;
      border-right: 1px solid var(--medium-gray);
    }

    .tab-button:last-child {
      border-right: none;
    }

    .tab-button:hover {
      background: var(--medium-gray);
    }

    .tab-button.active {
      background: var(--lsu-purple);
      color: var(--white);
    }

    .content-area {
      background: var(--white);
      padding: 30px;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-height: 500px;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark-gray);
      font-size: 0.95em;
    }

    .required {
      color: var(--error-red);
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--medium-gray);
      border-radius: 5px;
      font-size: 1em;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--lsu-purple);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .button {
      padding: 14px 28px;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .button-primary {
      background: var(--lsu-purple);
      color: var(--white);
    }

    .button-primary:hover {
      background: #5a2a8f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(70, 29, 124, 0.3);
    }

    .button-secondary {
      background: var(--lsu-gold);
      color: var(--dark-gray);
    }

    .button-secondary:hover {
      background: #f4c700;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(253, 208, 35, 0.3);
    }

    .button:disabled {
      background: var(--medium-gray);
      color: var(--dark-gray);
      cursor: not-allowed;
      transform: none;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: flex-end;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .alert.show {
      display: block;
    }

    .alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--lsu-purple);
      font-weight: 600;
    }

    .loading.show {
      display: block;
    }

    .loading-spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid var(--medium-gray);
      border-top-color: var(--lsu-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .cart-container {
      margin-top: 30px;
      padding: 20px;
      background: var(--light-gray);
      border-radius: 5px;
      border: 2px solid var(--medium-gray);
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--medium-gray);
    }

    .cart-header h3 {
      color: var(--lsu-purple);
      font-size: 1.3em;
    }

    .cart-empty {
      text-align: center;
      padding: 30px;
      color: var(--dark-gray);
      font-style: italic;
    }

    .cart-item {
      background: var(--white);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid var(--medium-gray);
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 15px;
      align-items: center;
    }

    .cart-item-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .cart-item-name {
      font-weight: 600;
      color: var(--lsu-purple);
    }

    .cart-item-details {
      font-size: 0.9em;
      color: var(--dark-gray);
    }

    .cart-item-price {
      font-weight: 700;
      color: var(--lsu-purple);
      font-size: 1.1em;
    }

    .remove-button {
      padding: 8px 16px;
      background: var(--error-red);
      color: var(--white);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    .remove-button:hover {
      background: #c82333;
    }

    .cart-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 3px solid var(--lsu-purple);
      font-size: 1.4em;
      font-weight: 700;
      color: var(--lsu-purple);
    }

    .part-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
      border: 2px solid var(--medium-gray);
      border-radius: 5px;
    }

    .part-item {
      padding: 12px 15px;
      border-bottom: 1px solid var(--medium-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .part-item:last-child {
      border-bottom: none;
    }

    .part-item-name {
      font-weight: 600;
      color: var(--lsu-purple);
    }

    .part-item-stock {
      color: var(--dark-gray);
      font-size: 0.9em;
    }

    .part-item.out-of-stock {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .password-section {
      background: var(--warning-orange);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 25px;
      border: 2px solid #f4c700;
    }

    .password-section p {
      margin-bottom: 10px;
      font-weight: 600;
    }

    .info-box {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .info-box h4 {
      color: #1976d2;
      margin-bottom: 8px;
    }

    .info-box p {
      color: var(--dark-gray);
      line-height: 1.6;
    }

    .dropdown-container {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--white);
      border: 2px solid var(--medium-gray);
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 1000;
      margin-top: 5px;
    }

    .dropdown-menu button {
      display: block;
      width: 100%;
      padding: 12px 15px;
      background: var(--white);
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      color: var(--dark-gray);
      transition: background 0.2s ease;
    }

    .dropdown-menu button:hover {
      background: var(--light-gray);
    }

    .dropdown-menu hr {
      margin: 5px 0;
      border: none;
      border-top: 1px solid var(--medium-gray);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content {
      background: var(--white);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      min-width: 400px;
      max-width: 90%;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header h1 {
        font-size: 1.5em;
      }

      .header p {
        font-size: 0.95em;
      }

      .tab-button {
        padding: 12px;
        font-size: 0.95em;
      }

      .content-area {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .button {
        width: 100%;
      }

      .cart-item {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .cart-item-price,
      .remove-button {
        justify-self: start;
      }

      .modal-content {
        min-width: 90%;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Denham Venom Parts Management System</h1>
      <p>Team 8044 - Parts Directory and Ordering</p>
    </div>

    <div class="tab-navigation">
      <button class="tab-button active" onclick="switchTab('order')">Order Parts</button>
      <button class="tab-button" onclick="switchTab('addPart')">Add Part to Directory</button>
    </div>

    <div class="content-area">
      <!-- ORDER PARTS FORM -->
      <div id="orderSection" class="form-section active">
        <div class="info-box">
          <h4>How to Order Parts</h4>
          <p>Select your name, choose a category, subcategory, and type to view available parts, then add items to your cart. Review your order and submit when ready.</p>
        </div>

        <div class="button-group" style="margin-bottom: 20px;">
          <button type="button" id="browseModeBtn" class="button button-primary" onclick="showBrowseInventory()">Browse Inventory</button>
          <button type="button" id="customModeBtn" class="button button-secondary" onclick="showCustomRequest()">Request Custom Part</button>
          <button type="button" id="csvModeBtn" class="button button-secondary" onclick="showCSVUpload()">Order by WCP CSV</button>
        </div>

        <div id="orderAlert" class="alert"></div>
        <div id="orderLoading" class="loading">
          <span class="loading-spinner"></span>
          <span id="orderLoadingText">Loading parts catalog...</span>
        </div>

        <form id="orderForm" onsubmit="return false;">
          <div class="form-group">
            <label for="subteam">Subteam <span class="required">*</span></label>
            <select id="subteam">
              <option value="">Select subteam...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="studentName">Name <span class="required">*</span></label>
            <select id="studentName" disabled>
              <option value="">Select subteam first...</option>
            </select>
          </div>

          <!-- SEARCH MODE SECTION -->
          <div id="searchModeSection" style="background: var(--light-gray); padding: 20px; border-radius: 5px; margin-bottom: 20px;">
            <h3 style="color: var(--lsu-purple); margin-bottom: 15px;">Search Mode</h3>

            <div class="form-group">
              <label style="margin-bottom: 10px;">Select Search Type:</label>
              <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="radio" name="searchMode" value="simple" onchange="toggleSearchMode()" checked style="width: auto; margin-right: 8px;">
                  <span>Simple Search</span>
                </label>
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="radio" name="searchMode" value="advanced" onchange="toggleSearchMode()" style="width: auto; margin-right: 8px;">
                  <span>Advanced Search</span>
                </label>
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="radio" name="searchMode" value="browse" onchange="toggleSearchMode()" style="width: auto; margin-right: 8px;">
                  <span>Browse by Category</span>
                </label>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="checkbox" id="inventoryOnlyFilter" onchange="handleFilterChange()" style="width: auto; margin-right: 8px;">
                  <span>Show Inventory Parts Only</span>
                </label>
              </div>

              <div class="form-group">
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="checkbox" id="seasonOnlyFilter" onchange="toggleSeasonFilter()" style="width: auto; margin-right: 8px;">
                  <span>Filter by Season</span>
                </label>
              </div>
            </div>

            <div class="form-group" id="seasonFilterGroup" style="display: none;">
              <label for="seasonFilterSelect">Season</label>
              <select id="seasonFilterSelect" disabled onchange="handleFilterChange()">
                <option value="">Select season...</option>
              </select>
            </div>
          </div>

          <!-- SIMPLE SEARCH SECTION -->
          <div id="simpleSearchSection" style="display: block; margin-bottom: 20px;">
            <h3 style="color: var(--lsu-purple); margin-bottom: 15px;">Simple Search</h3>
            <div class="form-group">
              <label for="simpleSearchInput">Search All Fields</label>
              <input type="text" id="simpleSearchInput" placeholder="Search by part name, ID, product code, or specifications...">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">
                Enter any text to search across all part fields
              </small>
            </div>
            <div class="button-group" style="justify-content: flex-start;">
              <button type="button" class="button button-primary" onclick="executeSimpleSearch()">Search</button>
              <button type="button" class="button button-secondary" onclick="clearSearch()">Clear</button>
            </div>
          </div>

          <!-- ADVANCED SEARCH SECTION -->
          <div id="advancedSearchSection" style="display: none; margin-bottom: 20px;">
            <h3 style="color: var(--lsu-purple); margin-bottom: 15px;">Advanced Search</h3>
            <div class="form-group">
              <label for="advancedSearchInput">Search Term</label>
              <input type="text" id="advancedSearchInput" placeholder="Enter search term...">
            </div>

            <div class="form-group">
              <label>Search In Fields:</label>
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="checkbox" id="searchPartName" checked style="width: auto; margin-right: 8px;">
                  <span>Part Name</span>
                </label>
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="checkbox" id="searchPartID" style="width: auto; margin-right: 8px;">
                  <span>Part ID</span>
                </label>
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="checkbox" id="searchProductCode" style="width: auto; margin-right: 8px;">
                  <span>Product Code</span>
                </label>
                <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                  <input type="checkbox" id="searchSpecifications" style="width: auto; margin-right: 8px;">
                  <span>Specifications</span>
                </label>
              </div>
            </div>

            <div class="button-group" style="justify-content: flex-start;">
              <button type="button" class="button button-primary" onclick="executeAdvancedSearch()">Search</button>
              <button type="button" class="button button-secondary" onclick="clearSearch()">Clear</button>
            </div>
          </div>

          <!-- QUICK VIEW BUTTONS -->
          <div id="quickViewSection" style="margin-bottom: 20px;">
            <h3 style="color: var(--lsu-purple); margin-bottom: 15px;">Quick Views</h3>
            <div class="button-group" style="justify-content: flex-start;">
              <button type="button" class="button button-secondary" onclick="viewAllInventory()">View All Inventory Parts</button>
              <button type="button" class="button button-secondary" onclick="viewSeasonParts()">View Season Parts</button>
              <button type="button" class="button button-secondary" onclick="resetToOriginal()">Reset View</button>
            </div>
          </div>

          <!-- BROWSE INVENTORY SECTION -->
          <div id="browseInventorySection" style="display: none;">
          <div class="form-group">
            <label for="productCodeSearch">Quick Search by Product Code (Optional)</label>
            <input type="text" id="productCodeSearch" placeholder="e.g., WCP-0448" style="width: 100%; padding: 10px; font-size: 1em;">
            <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Enter manufacturer product code to find specific parts. Leave blank to browse by category.</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="orderCategory">Category <span class="required">*</span></label>
              <select id="orderCategory" required>
                <option value="">Select category...</option>
              </select>
            </div>

            <div class="form-group">
              <label for="orderSubcategory">Subcategory <span class="required">*</span></label>
              <select id="orderSubcategory" disabled>
                <option value="">Select category first...</option>
              </select>
            </div>
          </div>

          <!-- NEW: Type Dropdown -->
          <div class="form-group">
            <label for="orderType">Type <span class="required">*</span></label>
            <select id="orderType" disabled>
              <option value="">Select subcategory first...</option>
            </select>
          </div>

          <!-- Dynamic Spec Filter Dropdowns -->
          <div id="specFilters"></div>

          <div class="button-group">
            <button type="button" class="button button-secondary" onclick="searchParts()">Search Parts</button>
          </div>

          <!-- ORDER DETAIL PAGE -->
          <div id="orderDetailPage" style="display: none;">
            <h3 style="margin-top: 30px; margin-bottom: 20px; color: var(--lsu-purple);">Order Details</h3>

            <div class="info-box" style="background: var(--light-gray); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
              <div style="margin-bottom: 10px;">
                <strong>Student:</strong> <span id="orderDetailStudent"></span>
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Part:</strong> <span id="orderDetailPartName"></span>
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Part ID:</strong> <span id="orderDetailPartID"></span>
              </div>
              <div>
                <strong>Specifications:</strong> <span id="orderDetailSpecs"></span>
              </div>
            </div>

            <div class="form-group">
              <label for="orderDetailQuantity">Quantity to Order <span class="required">*</span></label>
              <input type="number" id="orderDetailQuantity" min="1" value="1" style="width: 100%; padding: 10px; font-size: 1em;" oninput="updateOrderCalculation()">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">How many units do you want to order?</small>
            </div>

            <div class="info-box" style="border-left: 4px solid var(--lsu-gold); background: #fffef0; padding: 15px; margin: 20px 0;">
              <div style="margin-bottom: 10px; font-size: 1.1em;">
                <strong>You are ordering:</strong> <span id="orderDetailTotalItems" style="color: var(--lsu-purple); font-weight: 600;">0</span> items
              </div>
              <div style="font-size: 0.9em; color: var(--dark-gray);">
                <span id="orderDetailCalcExplanation"></span>
              </div>
              <div style="margin-top: 10px; font-size: 1.2em;">
                <strong>Total Cost:</strong> <span id="orderDetailTotalCost" style="color: var(--lsu-purple); font-weight: 600;">$0.00</span>
              </div>
            </div>

            <div class="button-group" style="margin-top: 20px;">
              <button type="button" class="button button-secondary" onclick="cancelOrder()">Cancel</button>
              <button type="button" class="button button-primary" onclick="addOrderToCart()">Add to Cart</button>
            </div>
          </div>
          </div>
          <!-- END BROWSE INVENTORY SECTION -->

          <!-- PARTS LIST CONTAINER (Shared across all search modes) -->
          <div id="partsListContainer" style="display: none;">
            <h3 style="margin-top: 30px; margin-bottom: 10px; color: var(--lsu-purple);">Available Parts</h3>
            <div id="partsList" class="part-list"></div>
          </div>

          <!-- CUSTOM REQUEST SECTION -->
          <div id="customRequestSection" style="display: none;">
            <h3 style="margin-top: 20px; margin-bottom: 20px; color: var(--lsu-purple);">Request Custom Part</h3>

            <div class="form-group">
              <label for="customPartName">Part Name/Description <span class="required">*</span></label>
              <input type="text" id="customPartName" placeholder="Enter the name or description of the part..." required style="width: 100%; padding: 10px; font-size: 1em;">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">What is the part called or what does it do?</small>
            </div>

            <div class="form-group">
              <label for="customPartLink">Product Link/URL <span class="required">*</span></label>
              <input type="url" id="customPartLink" placeholder="https://example.com/product" required style="width: 100%; padding: 10px; font-size: 1em;">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Where can we order this part online?</small>
            </div>

            <div class="form-group">
              <label for="customPartCost">Estimated Cost (Optional)</label>
              <input type="number" id="customPartCost" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; font-size: 1em;">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">If known, approximately how much does this part cost?</small>
            </div>

            <div class="form-group">
              <label for="customPartJustification">Justification/Use Case <span class="required">*</span></label>
              <textarea id="customPartJustification" rows="4" placeholder="Explain why you need this part and what you plan to use it for..." required style="width: 100%; padding: 10px; font-size: 1em;"></textarea>
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Why do you need this part? What will you use it for?</small>
            </div>

            <div class="form-group">
              <label for="customPriority">Priority <span class="required">*</span></label>
              <select id="customPriority" required style="width: 100%; padding: 10px; font-size: 1em;">
                <option value="">Select priority...</option>
                <option value="Low">Low - Whenever Possible</option>
                <option value="Medium" selected>Medium - within 1 Week</option>
                <option value="High">High - 2 Days</option>
                <option value="Emergency">Emergency - Next Day</option>
              </select>
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">How urgently do you need this part?</small>
            </div>

            <div class="button-group">
              <button type="button" class="button button-primary" onclick="submitCustomRequest()">Submit Custom Request</button>
            </div>
          </div>
          <!-- END CUSTOM REQUEST SECTION -->

          <!-- CSV UPLOAD SECTION -->
          <div id="csvUploadSection" style="display: none;">
            <h3 style="margin-top: 20px; margin-bottom: 20px; color: var(--lsu-purple);">
              Order Parts by WCP CSV Upload
            </h3>

            <div class="info-box">
              <h4>How This Works</h4>
              <p>Upload a WCP (West Coast Products) CSV file containing the parts you want to order.
                 The file will be reviewed by team leadership and processed accordingly.</p>
              <p><strong>Note:</strong> This method bypasses the shopping cart and does not require justification.</p>
            </div>

            <div class="form-group">
              <label for="csvFileInput">
                Select WCP CSV File <span class="required">*</span>
              </label>
              <input type="file"
                     id="csvFileInput"
                     accept=".csv"
                     style="width: 100%; padding: 10px; font-size: 1em; border: 2px solid var(--medium-gray); border-radius: 5px;">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">
                Maximum file size: 10MB. Only CSV files accepted.
              </small>
              <div id="csvFilePreview" style="margin-top: 10px; display: none;">
                <strong>Selected file:</strong> <span id="csvFileName"></span>
                (<span id="csvFileSize"></span>)
              </div>
            </div>

            <div class="form-group">
              <label for="csvOrderPriority">Priority <span class="required">*</span></label>
              <select id="csvOrderPriority" required>
                <option value="">Select priority...</option>
                <option value="Emergency">Emergency - Next Day</option>
                <option value="High">High - 2 Days</option>
                <option value="Medium" selected>Medium - within 1 Week</option>
                <option value="Low">Low - Whenever Possible</option>
              </select>
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">
                CSV orders default to Medium priority unless changed.
              </small>
            </div>

            <div class="form-group">
              <label for="csvOrderNotes">Notes (Optional)</label>
              <textarea id="csvOrderNotes"
                        rows="3"
                        placeholder="Add any special instructions or context for this CSV order..."></textarea>
            </div>

            <div class="button-group">
              <button type="button" class="button button-primary" onclick="submitCSVOrder()">
                Upload and Submit Order
              </button>
            </div>
          </div>
          <!-- END CSV UPLOAD SECTION -->

          <div id="cartContainer" class="cart-container" style="display: none;">
            <div class="cart-header">
              <h3>Your Order</h3>
              <button type="button" class="button button-secondary" style="padding: 8px 16px; font-size: 0.9em;" onclick="clearCart()">Clear All</button>
            </div>
            <div id="cartItems"></div>
            <div class="cart-total">
              <span>Total Cost:</span>
              <span id="cartTotal">$0.00</span>
            </div>

            <div class="form-group" style="margin-top: 20px;">
              <label for="orderPriority">Priority <span class="required">*</span></label>
              <select id="orderPriority" required>
                <option value="">Select priority...</option>
                <option value="Emergency">Emergency - Next Day</option>
                <option value="High">High - 2 Days</option>
                <option value="Medium">Medium - within 1 Week</option>
                <option value="Low">Low - Whenever Possible</option>
              </select>
            </div>

            <div class="form-group">
              <label for="orderJustification">Justification/Use Case <span class="required">*</span></label>
              <textarea id="orderJustification" required
                placeholder="Describe how these parts will be used and why they are needed for the robot or team operations"
                rows="4"
                style="width: 100%; padding: 10px; font-size: 1em; border: 1px solid var(--border-gray); border-radius: 4px; resize: vertical;"></textarea>
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Required: Explain the purpose and benefit of this order</small>
            </div>

            <div class="form-group">
              <label for="orderNotes">Notes (Optional)</label>
              <textarea id="orderNotes" rows="3" placeholder="Add any special instructions or notes about this order..."></textarea>
            </div>

            <div class="button-group">
              <button type="button" class="button button-primary" onclick="submitOrder()">Submit Order</button>
            </div>
          </div>
        </form>
      </div>

      <!-- ADD PART FORM -->
      <div id="addPartSection" class="form-section">
        <div class="password-section">
          <p>Access Control: Enter password to unlock form</p>
          <input type="password" id="accessPassword" placeholder="Enter password...">
          <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="validatePassword()">Unlock Form</button>
        </div>

        <div id="addPartFormContainer" style="display: none;">
          <div class="info-box">
            <h4>Adding New Parts</h4>
            <p>Use this form to add new parts to the inventory directory. All fields marked with an asterisk are required. The system will check for duplicate parts before adding.</p>
          </div>

          <div id="addPartAlert" class="alert"></div>
          <div id="addPartLoading" class="loading">
            <span class="loading-spinner"></span>
            <span>Processing your request...</span>
          </div>

          <form id="addPartForm" onsubmit="return false;">
            <div class="form-row">
              <div class="form-group">
                <label for="addCategory">Category <span class="required">*</span></label>
                <select id="addCategory" required>
                  <option value="">Select category...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="addSubcategory">Subcategory <span class="required">*</span></label>
                <select id="addSubcategory" disabled onchange="handleSubcategoryChange()">
                  <option value="">Select category first...</option>
                </select>
                <input type="text" id="addSubcategoryCustom" placeholder="Enter new subcategory..." style="display: none; margin-top: 10px;">
              </div>
            </div>

            <!-- NEW: Type field for Add Part form -->
            <div class="form-group">
              <label for="addType">Type <span class="required">*</span></label>
              <select id="addType" disabled onchange="handleTypeChange()">
                <option value="">Select subcategory first...</option>
              </select>
              <input type="text" id="addTypeCustom" placeholder="Enter new type..." style="display: none; margin-top: 10px;">
            </div>

            <div class="form-group">
              <label for="addPartName">Part Name <span class="required">*</span></label>
              <input type="text" id="addPartName" placeholder="Enter part name..." required>
            </div>

            <div class="form-group">
              <label for="addProductCode">Product Code (Optional)</label>
              <input type="text" id="addProductCode" placeholder="e.g., WCP-0448">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Manufacturer's product/part number (if applicable)</small>
            </div>

            <!-- Inventory and Season Fields -->
            <div class="form-group">
              <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="addInventoryCheckbox" style="width: auto; margin-right: 8px;">
                <span>Add to Inventory (common stock)</span>
              </label>
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Check this box if this part should be tracked as inventory stock</small>
            </div>

            <div class="form-group">
              <label for="addPartSeasons">Seasons (Optional)</label>
              <select id="addPartSeasons" multiple size="4" style="width: 100%; padding: 10px;">
                <option value="">Loading seasons...</option>
              </select>
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Hold Ctrl (Windows) or Cmd (Mac) to select multiple seasons</small>
            </div>

            <!-- Dynamic Spec Fields Container -->
            <div id="dynamicSpecFields"></div>

            <div class="form-row">
              <div class="form-group">
                <label for="addQuantity">Initial Quantity <span class="required">*</span></label>
                <input type="number" id="addQuantity" min="0" value="0" required>
              </div>

              <div class="form-group">
                <label for="addUnitCost">Unit Cost ($) <span class="required">*</span></label>
                <input type="number" id="addUnitCost" step="0.01" min="0" value="0.00" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="addStorageLocation">Storage Location</label>
                <input type="text" id="addStorageLocation" placeholder="e.g., Bin A3, Shelf 2">
              </div>

              <div class="form-group">
                <label for="addSupplier">Supplier</label>
                <input type="text" id="addSupplier" placeholder="e.g., McMaster-Carr, AndyMark">
              </div>
            </div>

            <div class="form-group">
              <label for="addSupplierPartNumber">Supplier Part Number</label>
              <input type="text" id="addSupplierPartNumber" placeholder="Enter supplier's part number...">
            </div>

            <div class="form-group">
              <label for="addNotes">Additional Notes</label>
              <textarea id="addNotes" placeholder="Enter any additional information..."></textarea>
            </div>

            <div class="button-group">
              <button type="button" class="button button-secondary" onclick="resetAddPartForm()">Reset Form</button>
              <button type="button" class="button button-primary" onclick="submitNewPart()">Add Part to Directory</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentCart = [];
    let availableParts = [];
    let currentOrderPart = null;
    let isFormUnlocked = false;
    let currentSpecConfig = null;
    let addPartSpecConfig = null;

    // Initialize application
    document.addEventListener('DOMContentLoaded', function() {
      loadInitialData();
    });

    // CSV file input handler
    window.addEventListener('load', function() {
      const csvFileInput = document.getElementById('csvFileInput');
      if (csvFileInput) {
        csvFileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          const previewDiv = document.getElementById('csvFilePreview');

          if (!file) {
            previewDiv.style.display = 'none';
            return;
          }

          if (!file.name.toLowerCase().endsWith('.csv')) {
            showAlert('order', 'error', 'Please select a CSV file');
            e.target.value = '';
            previewDiv.style.display = 'none';
            return;
          }

          const maxSize = 10 * 1024 * 1024;
          if (file.size > maxSize) {
            showAlert('order', 'error', 'File size exceeds 10MB limit. Please select a smaller file.');
            e.target.value = '';
            previewDiv.style.display = 'none';
            return;
          }

          document.getElementById('csvFileName').textContent = file.name;
          document.getElementById('csvFileSize').textContent = formatFileSize(file.size);
          previewDiv.style.display = 'block';
          hideAlert('order');
        });
      }
    });

    /**
     * Loads initial data for the application
     */
    function loadInitialData() {
      showLoading('order', true);

      // Load categories for order form
      google.script.run
        .withSuccessHandler(function(categories) {
          populateDropdown('orderCategory', categories);
          showLoading('order', false);
        })
        .withFailureHandler(function(error) {
          showAlert('order', 'error', 'Failed to load categories: ' + error.message);
          showLoading('order', false);
        })
        .getCategories();

      // Load subteams on page load
      google.script.run
        .withSuccessHandler(function(subteams) {
          populateDropdown('subteam', subteams);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load subteams:', error);
          showAlert('order', 'error', 'Failed to load subteam list');
        })
        .getSubteams();

      // Load categories for add part form
      google.script.run
        .withSuccessHandler(function(categories) {
          populateDropdown('addCategory', categories);
          setupAddPartEventHandlers();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load categories for add form:', error);
        })
        .getCategories();
    }

    /**
     * Sets up event handlers for add part form
     */
    function setupAddPartEventHandlers() {
      document.getElementById('addCategory').addEventListener('change', handleAddPartCategoryChange);
      document.getElementById('addSubcategory').addEventListener('change', handleAddPartSubcategoryChange);
      document.getElementById('addType').addEventListener('change', handleAddPartTypeChange);
    }

    /**
     * Switches between tabs
     */
    function switchTab(tabName) {
      // Update tab buttons
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Update content sections
      const sections = document.querySelectorAll('.form-section');
      sections.forEach(section => section.classList.remove('active'));

      if (tabName === 'order') {
        document.getElementById('orderSection').classList.add('active');
      } else if (tabName === 'addPart') {
        document.getElementById('addPartSection').classList.add('active');
      }
    }

    /**
     * Populates a dropdown with options
     */
    function populateDropdown(elementId, options) {
      const select = document.getElementById(elementId);
      const currentValue = select.value;

      // Keep first option (placeholder)
      while (select.options.length > 1) {
        select.remove(1);
      }

      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });

      // Restore previous selection if it still exists
      if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
      }
    }

    /**
     * Handles category change for order form
     */
    document.getElementById('orderCategory').addEventListener('change', function() {
      const category = this.value;
      const subcategorySelect = document.getElementById('orderSubcategory');
      const typeSelect = document.getElementById('orderType');

      if (!category) {
        subcategorySelect.disabled = true;
        subcategorySelect.innerHTML = '<option value="">Select category first...</option>';
        typeSelect.disabled = true;
        typeSelect.innerHTML = '<option value="">Select subcategory first...</option>';
        clearSpecFilters();
        hideParts();
        return;
      }

      showLoading('order', true, 'Loading subcategories...');
      subcategorySelect.disabled = true;
      subcategorySelect.innerHTML = '<option value="">Loading...</option>';
      typeSelect.disabled = true;
      typeSelect.innerHTML = '<option value="">Select subcategory first...</option>';
      clearSpecFilters();

      google.script.run
        .withSuccessHandler(function(subcategories) {
          subcategorySelect.disabled = false;
          subcategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
          populateDropdown('orderSubcategory', subcategories);
          showLoading('order', false);
        })
        .withFailureHandler(function(error) {
          showAlert('order', 'error', 'Failed to load subcategories: ' + error.message);
          subcategorySelect.disabled = true;
          showLoading('order', false);
        })
        .getSubcategories(category);
    });

    /**
     * Handles subcategory change for order form - loads types
     */
    document.getElementById('orderSubcategory').addEventListener('change', function() {
      const category = document.getElementById('orderCategory').value;
      const subcategory = this.value;
      const typeSelect = document.getElementById('orderType');

      clearSpecFilters();
      hideParts();

      if (!category || !subcategory) {
        typeSelect.disabled = true;
        typeSelect.innerHTML = '<option value="">Select subcategory first...</option>';
        return;
      }

      showLoading('order', true, 'Loading types...');
      typeSelect.disabled = true;
      typeSelect.innerHTML = '<option value="">Loading...</option>';

      google.script.run
        .withSuccessHandler(function(types) {
          typeSelect.disabled = false;
          typeSelect.innerHTML = '<option value="">Select type...</option>';
          populateDropdown('orderType', types);
          showLoading('order', false);
        })
        .withFailureHandler(function(error) {
          showAlert('order', 'error', 'Failed to load types: ' + error.message);
          typeSelect.disabled = true;
          showLoading('order', false);
        })
        .getTypes(category, subcategory);
    });

    /**
     * Handles type change for order form - loads spec filters
     */
    document.getElementById('orderType').addEventListener('change', function() {
      const category = document.getElementById('orderCategory').value;
      const subcategory = document.getElementById('orderSubcategory').value;
      const type = this.value;

      clearSpecFilters();
      hideParts();

      if (!category || !subcategory || !type) {
        return;
      }

      showLoading('order', true, 'Loading filter options...');

      google.script.run
        .withSuccessHandler(handleSpecConfig)
        .withFailureHandler(function(error) {
          console.error('Failed to load spec config:', error);
          showLoading('order', false);
        })
        .getSpecConfig(category, subcategory, type);
    });

    /**
     * Subteam selection handler
     */
    document.getElementById('subteam').addEventListener('change', function() {
      const subteam = this.value;
      const studentNameSelect = document.getElementById('studentName');

      // Reset student name dropdown
      studentNameSelect.innerHTML = '<option value="">Select name...</option>';

      if (!subteam) {
        studentNameSelect.disabled = true;
        return;
      }

      // Load students for selected subteam
      google.script.run
        .withSuccessHandler(function(students) {
          studentNameSelect.disabled = false;
          populateDropdown('studentName', students);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load students:', error);
          showAlert('order', 'error', 'Failed to load student names');
        })
        .getStudentsBySubteam(subteam);
    });

    /**
     * Clears spec filter dropdowns
     */
    function clearSpecFilters() {
      const specFiltersDiv = document.getElementById('specFilters');
      specFiltersDiv.innerHTML = '';
      currentSpecConfig = null;
    }

    /**
     * Handles spec configuration response from backend
     */
    function handleSpecConfig(config) {
      currentSpecConfig = config;
      const category = document.getElementById('orderCategory').value;
      const subcategory = document.getElementById('orderSubcategory').value;
      const type = document.getElementById('orderType').value;
      const specFiltersDiv = document.getElementById('specFilters');

      specFiltersDiv.innerHTML = '';

      // Create container for spec filters with grid layout
      const filterRow = document.createElement('div');
      filterRow.className = 'form-row';
      filterRow.id = 'specFilterRow';

      let hasVisibleSpecs = false;

      // Create dropdowns for each spec (1-5) - UPDATED from 4 to 5
      for (let specNum = 1; specNum <= 5; specNum++) {
        const labelKey = 'spec' + specNum + 'Label';
        const label = config[labelKey];

        if (label && label !== '-' && label.trim() !== '') {
          hasVisibleSpecs = true;

          // Create form group
          const formGroup = document.createElement('div');
          formGroup.className = 'form-group';
          formGroup.id = 'specFilter' + specNum + 'Group';

          // Create label
          const labelElement = document.createElement('label');
          labelElement.setAttribute('for', 'specFilter' + specNum);
          labelElement.textContent = label;
          formGroup.appendChild(labelElement);

          // Create select
          const select = document.createElement('select');
          select.id = 'specFilter' + specNum;
          select.className = 'form-control';
          select.innerHTML = '<option value="">All ' + label + '...</option>';
          formGroup.appendChild(select);

          filterRow.appendChild(formGroup);

          // Load values for this spec - UPDATED to include type parameter
          google.script.run
            .withSuccessHandler(function(values) {
              populateSpecDropdown(specNum, label, values);
            })
            .withFailureHandler(function(error) {
              console.error('Failed to load spec values for ' + label + ':', error);
            })
            .getSpecValues(category, subcategory, type, specNum);
        }
      }

      if (hasVisibleSpecs) {
        specFiltersDiv.appendChild(filterRow);
      }

      showLoading('order', false);
    }

    /**
     * Populates a spec filter dropdown with values
     */
    function populateSpecDropdown(specNum, label, values) {
      const select = document.getElementById('specFilter' + specNum);
      if (!select) return;

      // Keep the "All" option and add the values
      const currentValue = select.value;
      select.innerHTML = '<option value="">All ' + label + '...</option>';

      values.forEach(function(value) {
        if (value && value !== '-' && value.trim() !== '') {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        }
      });

      // Restore previous selection if it exists
      if (currentValue && values.includes(currentValue)) {
        select.value = currentValue;
      }
    }

    /**
     * Searches for parts based on filters
     */
    function searchParts() {
      // Check if product code search is being used
      const productCode = document.getElementById('productCodeSearch').value.trim();

      if (productCode) {
        // Search by product code instead
        showLoading('order', true, 'Searching by product code...');
        hideParts();

        google.script.run
          .withSuccessHandler(function(parts) {
            availableParts = parts;
            displayParts(parts);
            showLoading('order', false);
          })
          .withFailureHandler(function(error) {
            showAlert('order', 'error', 'Failed to search: ' + error.message);
            showLoading('order', false);
          })
          .getPartsByProductCode(productCode);
        return;
      }

      // Otherwise, proceed with category/subcategory/type/spec filtering
      const category = document.getElementById('orderCategory').value;
      const subcategory = document.getElementById('orderSubcategory').value;
      const type = document.getElementById('orderType').value;

      if (!category || !subcategory || !type) {
        showAlert('order', 'warning', 'Please select category, subcategory, and type');
        return;
      }

      // Collect spec filter values - UPDATED to include spec5
      const filters = {
        category: category,
        subcategory: subcategory,
        type: type,
        spec1: getSpecFilterValue(1),
        spec2: getSpecFilterValue(2),
        spec3: getSpecFilterValue(3),
        spec4: getSpecFilterValue(4),
        spec5: getSpecFilterValue(5)
      };

      showLoading('order', true, 'Searching for parts...');
      hideParts();

      google.script.run
        .withSuccessHandler(function(parts) {
          availableParts = parts;
          displayParts(parts);
          showLoading('order', false);
        })
        .withFailureHandler(function(error) {
          showAlert('order', 'error', 'Failed to search parts: ' + error.message);
          showLoading('order', false);
        })
        .getPartsByFilters(filters);
    }

    /**
     * Gets the value of a spec filter dropdown
     */
    function getSpecFilterValue(specNum) {
      const select = document.getElementById('specFilter' + specNum);
      return select ? select.value : '';
    }

    /**
     * Displays parts in the list
     */
    function displayParts(parts) {
      console.log('[DEBUG] displayParts called with ' + parts.length + ' parts');
      console.log('[DEBUG] Parts data:', parts);

      const container = document.getElementById('partsListContainer');
      const list = document.getElementById('partsList');

      console.log('[DEBUG] Container element:', container);
      console.log('[DEBUG] List element:', list);

      list.innerHTML = '';

      if (parts.length === 0) {
        list.innerHTML = '<div class="cart-empty">No parts found matching filters</div>';
      } else {
        console.log('[DEBUG] Building HTML for ' + parts.length + ' parts...');
        parts.forEach((part, index) => {
          console.log('[DEBUG] Building part at index:', index, 'Part ID:', part.partID);

          const item = document.createElement('div');
          item.className = 'part-item';

          const quantityPer = part.quantityPer || part.quantity || 0;
          const unitCost = part.unitCost || 0;

          if (quantityPer === 0) {
            item.classList.add('out-of-stock');
          }

          // Build spec display with dynamic labels
          let specDisplay = formatSpecDisplay(part);

          // Build status indicators
          let statusBadges = '';

          // Inventory badge
          if (part.inventory === 'Yes') {
            statusBadges += '<span style="display: inline-block; background: var(--success-green); color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.85em; margin-right: 5px;">In Inventory</span>';
          }

          // Seasons badges
          if (part.seasons && part.seasons.trim() !== '') {
            const seasonsList = part.seasons.split(',').map(s => s.trim()).filter(s => s !== '');
            seasonsList.forEach(season => {
              statusBadges += '<span style="display: inline-block; background: var(--lsu-purple); color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.85em; margin-right: 5px;">' + season + '</span>';
            });
          }

          item.innerHTML = `
            <div style="flex: 1;">
              <div class="part-item-name">${part.partName || 'Unknown Part'}</div>
              <div class="part-item-details">${part.partID || 'N/A'}${specDisplay ? ' - ' + specDisplay : ''}</div>
              ${part.productCode ? '<div class="part-item-details" style="color: var(--lsu-gold);">Product Code: ' + part.productCode + '</div>' : ''}
              ${statusBadges ? '<div style="margin-top: 5px;">' + statusBadges + '</div>' : ''}
              <div class="part-item-stock">Quantity Per: ${quantityPer} | Unit Cost: $${unitCost.toFixed(2)}</div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
              ${quantityPer > 0 ? '<button class="button button-primary" onclick="showOrderPage(' + index + '); event.stopPropagation();" style="padding: 10px 20px;">Order</button>' : '<span style="color: #999;">Out of Stock</span>'}
              <div class="dropdown-container">
                <button class="button button-secondary" onclick="toggleAddToMenu(${index}, \'${part.partID || ''}\'); event.stopPropagation();" style="padding: 10px 15px;">Add to </button>
                <div class="dropdown-menu" id="addToMenu${index}" style="display: none;">
                  <button onclick="handleAddToInventory('${part.partID}', ${index}); event.stopPropagation();">
                    ${part.inventory === 'Yes' ? ' ' : ''}Add to Inventory
                  </button>
                  <button onclick="showSeasonModal('add', '${part.partID}', ${index}); event.stopPropagation();">
                    Add to Season
                  </button>
                  <hr>
                  <button onclick="handleRemoveFromInventory('${part.partID}', ${index}); event.stopPropagation();">
                    Remove from Inventory
                  </button>
                  <button onclick="showSeasonModal('remove', '${part.partID}', ${index}); event.stopPropagation();">
                    Remove from Season
                  </button>
                </div>
              </div>
            </div>
          `;

          // No longer using click event on entire item

          list.appendChild(item);

          // Verify menu element exists in DOM
          const menuCheck = document.getElementById('addToMenu' + index);
          console.log('[DEBUG] Verified menu element addToMenu' + index + ' exists:', menuCheck !== null);
        });
      }

      console.log('[DEBUG] Setting container display to block');
      container.style.display = 'block';
      console.log('[DEBUG] displayParts completed');
    }

    /**
     * Formats spec display with dynamic labels - UPDATED to support 5 specs
     */
    function formatSpecDisplay(part) {
      if (!currentSpecConfig) {
        // Fallback to generic display if config not loaded
        const specs = [];
        if (part.spec1 && part.spec1 !== '-') specs.push(part.spec1);
        if (part.spec2 && part.spec2 !== '-') specs.push(part.spec2);
        if (part.spec3 && part.spec3 !== '-') specs.push(part.spec3);
        if (part.spec4 && part.spec4 !== '-') specs.push(part.spec4);
        if (part.spec5 && part.spec5 !== '-') specs.push(part.spec5);
        return specs.join(' | ');
      }

      // Use dynamic labels from config - UPDATED loop from 4 to 5
      const specs = [];
      for (let i = 1; i <= 5; i++) {
        const label = currentSpecConfig['spec' + i + 'Label'];
        const value = part['spec' + i];

        if (label && label !== '-' && value && value !== '-') {
          specs.push(label + ': ' + value);
        }
      }

      return specs.join(' | ');
    }

    /**
     * Hides the parts list
     */
    function hideParts() {
      document.getElementById('partsListContainer').style.display = 'none';
    }

    /**
     * Updates the cart display
     */
    function updateCartDisplay() {
      const container = document.getElementById('cartContainer');
      const itemsDiv = document.getElementById('cartItems');
      const totalSpan = document.getElementById('cartTotal');

      if (currentCart.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      itemsDiv.innerHTML = '';

      let total = 0;
      currentCart.forEach((item, index) => {
        total += item.totalCost;

        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';

        // Show specs if available, otherwise show simple message
        const specText = item.specifications && item.specifications.trim() ? item.specifications : 'Standard part';

        // Calculate total items (quantity  quantityPer)
        const totalItems = item.quantity * (item.quantityPer || 1);

        cartItem.innerHTML = `
          <div class="cart-item-info">
            <div class="cart-item-name">${item.partName}</div>
            <div class="cart-item-details">
              ${item.partID} - ${specText}<br>
              Quantity: ${item.quantity} units (${totalItems} items total) x $${item.unitCost.toFixed(2)}
            </div>
          </div>
          <div class="cart-item-price">$${item.totalCost.toFixed(2)}</div>
          <button class="remove-button" onclick="removeFromCart(${index})">Remove</button>
        `;
        itemsDiv.appendChild(cartItem);
      });

      totalSpan.textContent = '$' + total.toFixed(2);
    }

    /**
     * Removes an item from the cart
     */
    function removeFromCart(index) {
      currentCart.splice(index, 1);
      updateCartDisplay();
      showAlert('order', 'success', 'Item removed from cart');
      setTimeout(() => hideAlert('order'), 3000);
    }

    /**
     * Shows the order detail page for a selected part
     */
    function showOrderPage(index) {
      const part = availableParts[index];
      if (!part) return;

      const subteam = document.getElementById('subteam').value;
      const studentName = document.getElementById('studentName').value;

      if (!subteam) {
        showAlert('order', 'warning', 'Please select your subteam first');
        return;
      }

      if (!studentName) {
        showAlert('order', 'warning', 'Please select your name first');
        return;
      }

      // Store current part
      currentOrderPart = part;

      // Populate order detail page
      document.getElementById('orderDetailStudent').textContent = subteam + ' - ' + studentName;
      document.getElementById('orderDetailPartName').textContent = part.partName || 'Unknown Part';
      document.getElementById('orderDetailPartID').textContent = part.partID || 'N/A';
      document.getElementById('orderDetailSpecs').textContent = formatSpecDisplay(part) || 'No specifications';

      // Reset quantity to 1
      document.getElementById('orderDetailQuantity').value = 1;

      // Update calculation
      updateOrderCalculation();

      // Hide parts list, show order detail page
      document.getElementById('partsListContainer').style.display = 'none';
      document.getElementById('orderDetailPage').style.display = 'block';

      // Scroll to top
      window.scrollTo(0, 0);
    }

    /**
     * Updates the order calculation display
     */
    function updateOrderCalculation() {
      if (!currentOrderPart) return;

      const quantity = parseInt(document.getElementById('orderDetailQuantity').value) || 1;
      const quantityPer = currentOrderPart.quantityPer || currentOrderPart.quantity || 1;
      const unitCost = currentOrderPart.unitCost || 0;

      const totalItems = quantity * quantityPer;
      const totalCost = quantity * unitCost;

      // Update display
      document.getElementById('orderDetailTotalItems').textContent = totalItems;
      document.getElementById('orderDetailCalcExplanation').textContent =
        `(${quantity} units  ${quantityPer} per unit)`;
      document.getElementById('orderDetailTotalCost').textContent = '$' + totalCost.toFixed(2);
    }

    /**
     * Cancels the current order and returns to parts list
     */
    function cancelOrder() {
      currentOrderPart = null;
      document.getElementById('orderDetailPage').style.display = 'none';
      document.getElementById('partsListContainer').style.display = 'block';
    }

    /**
     * Adds the configured order to the cart
     */
    function addOrderToCart() {
      if (!currentOrderPart) return;

      const quantity = parseInt(document.getElementById('orderDetailQuantity').value) || 1;

      if (quantity <= 0) {
        showAlert('order', 'warning', 'Please enter a valid quantity');
        return;
      }

      const quantityPer = currentOrderPart.quantityPer || currentOrderPart.quantity || 1;
      const unitCost = currentOrderPart.unitCost || 0;
      const totalCost = quantity * unitCost;

      // Add to cart with all necessary fields
      const cartItem = {
        partID: currentOrderPart.partID,
        partName: currentOrderPart.partName,
        category: currentOrderPart.category,
        subcategory: currentOrderPart.subcategory,
        type: currentOrderPart.type,
        specifications: formatSpecDisplay(currentOrderPart),
        quantity: quantity,
        quantityPer: quantityPer,
        unitCost: unitCost,
        totalCost: totalCost
      };

      currentCart.push(cartItem);
      updateCartDisplay();

      // Show success message
      showAlert('order', 'success', `Added ${currentOrderPart.partName} to cart`);
      setTimeout(() => hideAlert('order'), 3000);

      // Return to parts list
      cancelOrder();
    }

    /**
     * Clears all items from the cart
     */
    function clearCart() {
      if (currentCart.length === 0) return;

      if (confirm('Are you sure you want to clear all items from your cart?')) {
        currentCart = [];
        updateCartDisplay();
        showAlert('order', 'success', 'Cart cleared');
        setTimeout(() => hideAlert('order'), 3000);
      }
    }

    /**
     * Submits the order
     */
    function submitOrder() {
      const subteam = document.getElementById('subteam').value;
      const studentName = document.getElementById('studentName').value;
      const priority = document.getElementById('orderPriority').value;
      const justification = document.getElementById('orderJustification').value.trim();
      const notes = document.getElementById('orderNotes').value.trim();

      if (!subteam) {
        showAlert('order', 'warning', 'Please select your subteam');
        return;
      }

      if (!studentName) {
        showAlert('order', 'warning', 'Please select your name');
        return;
      }

      if (currentCart.length === 0) {
        showAlert('order', 'warning', 'Your cart is empty');
        return;
      }

      if (!priority) {
        showAlert('order', 'warning', 'Please select a priority level for this order');
        return;
      }

      if (!justification) {
        showAlert('order', 'warning', 'Please provide a justification for this order');
        return;
      }

      // Require team leader password approval
      const password = prompt('Team Leader Approval Required\n\nEnter leadership password to approve this order:');

      if (!password) {
        showAlert('order', 'warning', 'Order submission cancelled - no password entered');
        return;
      }

      if (password !== 'venom8044') {
        showAlert('order', 'error', 'Incorrect password - order not submitted');
        return;
      }

      if (!confirm('Submit this order? This action cannot be undone.')) {
        return;
      }

      const totalCost = currentCart.reduce((sum, item) => sum + item.totalCost, 0);

      const orderData = {
        studentName: studentName,
        department: subteam,
        items: currentCart,
        totalCost: totalCost,
        priority: priority,
        justification: justification,
        notes: notes || ''
      };

      showLoading('order', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('order', false);
          if (result.success) {
            showAlert('order', 'success',
              `Order ${result.orderNumber} submitted successfully! Total: $${totalCost.toFixed(2)}`);
            currentCart = [];
            updateCartDisplay();
            resetOrderForm();
          } else {
            showAlert('order', 'error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading('order', false);
          showAlert('order', 'error', 'Failed to submit order: ' + error.message);
        })
        .submitOrder(orderData);
    }

    /**
     * Resets the order form
     */
    function resetOrderForm() {
      document.getElementById('orderForm').reset();
      document.getElementById('studentName').disabled = true;
      document.getElementById('studentName').innerHTML = '<option value="">Select subteam first...</option>';
      document.getElementById('orderSubcategory').disabled = true;
      document.getElementById('orderSubcategory').innerHTML = '<option value="">Select category first...</option>';
      document.getElementById('orderType').disabled = true;
      document.getElementById('orderType').innerHTML = '<option value="">Select subcategory first...</option>';
      document.getElementById('orderPriority').value = '';
      document.getElementById('orderJustification').value = '';
      document.getElementById('orderNotes').value = '';
      hideParts();
      availableParts = [];
    }

    /**
     * Shows the browse inventory mode
     */
    function showBrowseInventory() {
      document.getElementById('browseInventorySection').style.display = 'block';
      document.getElementById('customRequestSection').style.display = 'none';
      document.getElementById('csvUploadSection').style.display = 'none';
      document.getElementById('browseModeBtn').className = 'button button-primary';
      document.getElementById('customModeBtn').className = 'button button-secondary';
      document.getElementById('csvModeBtn').className = 'button button-secondary';
    }

    /**
     * Shows the custom request mode
     */
    function showCustomRequest() {
      document.getElementById('browseInventorySection').style.display = 'none';
      document.getElementById('customRequestSection').style.display = 'block';
      document.getElementById('csvUploadSection').style.display = 'none';
      document.getElementById('browseModeBtn').className = 'button button-secondary';
      document.getElementById('customModeBtn').className = 'button button-primary';
      document.getElementById('csvModeBtn').className = 'button button-secondary';
    }

    /**
     * Shows the CSV upload mode
     */
    function showCSVUpload() {
      document.getElementById('browseInventorySection').style.display = 'none';
      document.getElementById('customRequestSection').style.display = 'none';
      document.getElementById('csvUploadSection').style.display = 'block';
      document.getElementById('browseModeBtn').className = 'button button-secondary';
      document.getElementById('customModeBtn').className = 'button button-secondary';
      document.getElementById('csvModeBtn').className = 'button button-primary';
    }

    /**
     * Formats file size in human-readable format
     */
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    /**
     * Submits a CSV order
     */
    function submitCSVOrder() {
      const subteam = document.getElementById('subteam').value;
      const studentName = document.getElementById('studentName').value;
      const fileInput = document.getElementById('csvFileInput');
      const priority = document.getElementById('csvOrderPriority').value;
      const notes = document.getElementById('csvOrderNotes').value.trim();

      if (!subteam) {
        showAlert('order', 'warning', 'Please select your subteam');
        return;
      }

      if (!studentName) {
        showAlert('order', 'warning', 'Please select your name');
        return;
      }

      if (!fileInput.files || fileInput.files.length === 0) {
        showAlert('order', 'warning', 'Please select a CSV file to upload');
        return;
      }

      if (!priority) {
        showAlert('order', 'warning', 'Please select a priority level');
        return;
      }

      const file = fileInput.files[0];

      // Require team leader password approval for CSV uploads
      const password = prompt('Team Leader Approval Required\n\nEnter leadership password to approve this CSV upload:');

      if (!password) {
        showAlert('order', 'warning', 'Upload cancelled - no password entered');
        return;
      }

      if (password !== 'venom8044') {
        showAlert('order', 'error', 'Incorrect password - upload not submitted');
        return;
      }

      if (!confirm('Submit this WCP CSV order?\n\nFile: ' + file.name + '\nThis action cannot be undone.')) {
        return;
      }

      showLoading('order', true, 'Uploading CSV file...');

      const reader = new FileReader();
      reader.onload = function(e) {
        const fileContent = e.target.result;
        const fileName = file.name;

        const tempOrderNumber = 'ORD-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-TMP';

        google.script.run
          .withSuccessHandler(function(uploadResult) {
            if (!uploadResult.success) {
              showLoading('order', false);
              showAlert('order', 'error', 'File upload failed: ' + uploadResult.message);
              return;
            }

            const orderData = {
              studentName: studentName,
              department: subteam,
              csvFileLink: uploadResult.fileUrl,
              csvFileName: uploadResult.fileName,
              priority: priority,
              notes: notes || 'WCP CSV Order: ' + fileName,
              items: []
            };

            showLoading('order', true, 'Submitting order...');

            google.script.run
              .withSuccessHandler(function(result) {
                showLoading('order', false);
                if (result.success) {
                  showAlert('order', 'success',
                    'CSV order submitted successfully! Order Number: ' + result.orderNumber);

                  fileInput.value = '';
                  document.getElementById('csvFilePreview').style.display = 'none';
                  document.getElementById('csvOrderPriority').value = 'Medium';
                  document.getElementById('csvOrderNotes').value = '';
                } else {
                  showAlert('order', 'error', result.message);
                }
              })
              .withFailureHandler(function(error) {
                showLoading('order', false);
                showAlert('order', 'error', 'Failed to submit order: ' + error.message);
              })
              .submitOrder(orderData);
          })
          .withFailureHandler(function(error) {
            showLoading('order', false);
            showAlert('order', 'error', 'File upload failed: ' + error.message);
          })
          .uploadCSVToDrive(fileContent, fileName, tempOrderNumber);
      };

      reader.onerror = function() {
        showLoading('order', false);
        showAlert('order', 'error', 'Failed to read file. Please try again.');
      };

      reader.readAsDataURL(file);
    }

    /**
     * Submits a custom part request
     */
    function submitCustomRequest() {
      const subteam = document.getElementById('subteam').value;
      const studentName = document.getElementById('studentName').value;
      const partName = document.getElementById('customPartName').value.trim();
      const partLink = document.getElementById('customPartLink').value.trim();
      const estimatedCost = parseFloat(document.getElementById('customPartCost').value) || 0;
      const justification = document.getElementById('customPartJustification').value.trim();
      const priority = document.getElementById('customPriority').value;

      // Validate required fields
      if (!subteam) {
        showAlert('order', 'warning', 'Please select your subteam');
        return;
      }

      if (!studentName) {
        showAlert('order', 'warning', 'Please select your name');
        return;
      }

      if (!partName) {
        showAlert('order', 'warning', 'Please enter the part name or description');
        return;
      }

      if (!partLink) {
        showAlert('order', 'warning', 'Please provide a product link');
        return;
      }

      if (!justification) {
        showAlert('order', 'warning', 'Please explain why you need this part');
        return;
      }

      if (!priority) {
        showAlert('order', 'warning', 'Please select a priority level');
        return;
      }

      // Require team leader password approval
      const password = prompt('Team Leader Approval Required\n\nEnter leadership password to approve this custom request:');

      if (!password) {
        showAlert('order', 'warning', 'Request cancelled - no password entered');
        return;
      }

      if (password !== 'venom8044') {
        showAlert('order', 'error', 'Incorrect password - request not submitted');
        return;
      }

      // Prepare custom request data
      const requestData = {
        studentName: studentName,
        department: subteam,
        partName: partName,
        whereToBuy: partLink,
        partLink: partLink,
        estimatedCost: estimatedCost,
        justification: justification,
        priority: priority
      };

      showLoading('order', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('order', false);
          if (result.success) {
            showAlert('order', 'success',
              `Custom request submitted successfully! Request ID: ${result.requestID}`);
            // Clear the form
            document.getElementById('customPartName').value = '';
            document.getElementById('customPartLink').value = '';
            document.getElementById('customPartCost').value = '';
            document.getElementById('customPartJustification').value = '';
          } else {
            showAlert('order', 'error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading('order', false);
          showAlert('order', 'error', 'Failed to submit custom request: ' + error.message);
        })
        .submitCustomRequest(requestData);
    }

    /**
     * Handles category change in add part form
     */
    function handleAddPartCategoryChange() {
      const category = document.getElementById('addCategory').value;
      const subcategorySelect = document.getElementById('addSubcategory');
      const typeSelect = document.getElementById('addType');

      clearDynamicSpecFields();

      if (!category) {
        subcategorySelect.disabled = true;
        subcategorySelect.innerHTML = '<option value="">Select category first...</option>';
        typeSelect.disabled = true;
        typeSelect.innerHTML = '<option value="">Select subcategory first...</option>';
        return;
      }

      subcategorySelect.disabled = false;
      subcategorySelect.innerHTML = '<option value="">Loading subcategories...</option>';
      typeSelect.disabled = true;
      typeSelect.innerHTML = '<option value="">Select subcategory first...</option>';

      google.script.run
        .withSuccessHandler(function(subcategories) {
          subcategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
          subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            subcategorySelect.appendChild(option);
          });

          const createNewOption = document.createElement('option');
          createNewOption.value = '__CREATE_NEW__';
          createNewOption.textContent = '+ Create New Subcategory...';
          subcategorySelect.appendChild(createNewOption);
        })
        .withFailureHandler(function(error) {
          subcategorySelect.innerHTML = '<option value="">Error loading subcategories</option>';
          console.error('Failed to load subcategories:', error);
        })
        .getSubcategories(category);
    }

    /**
     * Handles subcategory change in add part form - loads types
     */
    function handleAddPartSubcategoryChange() {
      const category = document.getElementById('addCategory').value;
      const subcategory = document.getElementById('addSubcategory').value;
      const typeSelect = document.getElementById('addType');

      clearDynamicSpecFields();

      if (!category || !subcategory) {
        typeSelect.disabled = true;
        typeSelect.innerHTML = '<option value="">Select subcategory first...</option>';
        return;
      }

      typeSelect.disabled = false;
      typeSelect.innerHTML = '<option value="">Loading types...</option>';

      google.script.run
        .withSuccessHandler(function(types) {
          typeSelect.innerHTML = '<option value="">Select type...</option>';
          types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
          });

          const createNewOption = document.createElement('option');
          createNewOption.value = '__CREATE_NEW__';
          createNewOption.textContent = '+ Create New Type...';
          typeSelect.appendChild(createNewOption);
        })
        .withFailureHandler(function(error) {
          typeSelect.innerHTML = '<option value="">Error loading types</option>';
          console.error('Failed to load types:', error);
        })
        .getTypes(category, subcategory);
    }

    /**
     * Handles type change in add part form - loads spec fields
     */
    function handleAddPartTypeChange() {
      const category = document.getElementById('addCategory').value;
      const subcategory = document.getElementById('addSubcategory').value;
      const type = document.getElementById('addType').value;

      if (!category || !subcategory || !type) {
        clearDynamicSpecFields();
        return;
      }

      google.script.run
        .withSuccessHandler(handleAddPartSpecConfig)
        .withFailureHandler(function(error) {
          console.error('Failed to load spec config:', error);
          clearDynamicSpecFields();
        })
        .getSpecConfig(category, subcategory, type);
    }

    /**
     * Clears dynamic spec fields
     */
    function clearDynamicSpecFields() {
      const container = document.getElementById('dynamicSpecFields');
      container.innerHTML = '';
      addPartSpecConfig = null;
    }

    /**
     * Handles spec configuration for add part form - UPDATED to support 5 specs
     */
    function handleAddPartSpecConfig(config) {
      addPartSpecConfig = config;
      const container = document.getElementById('dynamicSpecFields');
      container.innerHTML = '';

      const category = document.getElementById('addCategory').value;
      const subcategory = document.getElementById('addSubcategory').value;
      const type = document.getElementById('addType').value;

      // UPDATED loop from 4 to 5
      for (let i = 1; i <= 5; i++) {
        const labelKey = `spec${i}Label`;
        const label = config[labelKey];

        if (label && label !== '-') {
          const formGroup = document.createElement('div');
          formGroup.className = 'form-group';
          formGroup.id = `specField${i}Group`;

          formGroup.innerHTML = `
            <label for="addPartSpec${i}">
              ${label}
              <span class="required">*</span>
            </label>
            <select id="addPartSpec${i}" class="form-control" onchange="handleSpecChange(${i})">
              <option value="">Select ${label}...</option>
              <option value="__ADD_NEW__">Add New...</option>
            </select>
            <input type="text" id="addPartSpec${i}Custom" class="form-control"
                   style="display:none;" placeholder="Enter new ${label}">
          `;

          container.appendChild(formGroup);

          // UPDATED getSpecValues call to include type parameter
          google.script.run
            .withSuccessHandler(function(values) {
              populateAddPartSpec(i, label, values);
            })
            .withFailureHandler(function(error) {
              console.error(`Failed to load values for spec ${i}:`, error);
            })
            .getSpecValues(category, subcategory, type, i);
        }
      }
    }

    /**
     * Populates a spec dropdown for add part form
     */
    function populateAddPartSpec(specNum, label, values) {
      const dropdown = document.getElementById(`addPartSpec${specNum}`);
      if (!dropdown) return;

      const filteredValues = values.filter(v => v && v.trim() !== '' && v !== '-');

      dropdown.innerHTML = `<option value="">Select ${label}...</option>`;

      filteredValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        dropdown.appendChild(option);
      });

      const addNewOption = document.createElement('option');
      addNewOption.value = '__ADD_NEW__';
      addNewOption.textContent = 'Add New...';
      dropdown.appendChild(addNewOption);
    }

    /**
     * Handles spec dropdown change for "Add New..." functionality
     */
    function handleSpecChange(specNum) {
      const dropdown = document.getElementById(`addPartSpec${specNum}`);
      const customInput = document.getElementById(`addPartSpec${specNum}Custom`);

      if (dropdown.value === '__ADD_NEW__') {
        dropdown.style.display = 'none';
        customInput.style.display = 'block';
        customInput.focus();
        customInput.required = dropdown.hasAttribute('required');
      }
    }

    /**
     * Collects spec values from form (either dropdown or custom input) - UPDATED to support 5 specs
     */
    function collectSpecValues() {
      const specs = {};
      // UPDATED loop from 4 to 5
      for (let i = 1; i <= 5; i++) {
        const dropdown = document.getElementById(`addPartSpec${i}`);
        const customInput = document.getElementById(`addPartSpec${i}Custom`);

        if (customInput && customInput.style.display !== 'none' && customInput.value) {
          specs[`spec${i}`] = customInput.value.trim();
        } else if (dropdown && dropdown.value && dropdown.value !== '__ADD_NEW__') {
          specs[`spec${i}`] = dropdown.value;
        } else {
          specs[`spec${i}`] = '-';
        }
      }
      return specs;
    }

    /**
     * Handles subcategory dropdown change for "Create New..." functionality
     */
    function handleSubcategoryChange() {
      const dropdown = document.getElementById('addSubcategory');
      const customInput = document.getElementById('addSubcategoryCustom');
      const typeSelect = document.getElementById('addType');

      if (dropdown.value === '__CREATE_NEW__') {
        dropdown.style.display = 'none';
        customInput.style.display = 'block';
        customInput.focus();
        customInput.required = true;

        typeSelect.disabled = true;
        typeSelect.innerHTML = '<option value="">Enter subcategory first...</option>';
        clearDynamicSpecFields();
      }
    }

    /**
     * Handles type dropdown change for "Create New..." functionality
     */
    function handleTypeChange() {
      const dropdown = document.getElementById('addType');
      const customInput = document.getElementById('addTypeCustom');

      if (dropdown.value === '__CREATE_NEW__') {
        dropdown.style.display = 'none';
        customInput.style.display = 'block';
        customInput.focus();
        customInput.required = true;
        clearDynamicSpecFields();
      }
    }

    /**
     * Resets subcategory custom input
     */
    function resetSubcategoryInput() {
      const dropdown = document.getElementById('addSubcategory');
      const customInput = document.getElementById('addSubcategoryCustom');

      dropdown.style.display = 'block';
      dropdown.value = '';
      customInput.style.display = 'none';
      customInput.value = '';
      customInput.required = false;
    }

    /**
     * Resets type custom input
     */
    function resetTypeInput() {
      const dropdown = document.getElementById('addType');
      const customInput = document.getElementById('addTypeCustom');

      dropdown.style.display = 'block';
      dropdown.value = '';
      customInput.style.display = 'none';
      customInput.value = '';
      customInput.required = false;
    }

    /**
     * Validates the access password
     */
    function validatePassword() {
      const password = document.getElementById('accessPassword').value;

      if (!password) {
        alert('Please enter a password');
        return;
      }

      showLoading('addPart', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('addPart', false);
          if (result.isValid) {
            isFormUnlocked = true;
            document.querySelector('.password-section').style.display = 'none';
            document.getElementById('addPartFormContainer').style.display = 'block';
            showAlert('addPart', 'success', 'Access granted. You can now add parts to the directory.');
            setTimeout(() => hideAlert('addPart'), 3000);

            loadSeasonsList();
          } else {
            showAlert('addPart', 'error', 'Invalid password. Access denied.');
          }
        })
        .withFailureHandler(function(error) {
          showLoading('addPart', false);
          showAlert('addPart', 'error', 'Failed to validate password: ' + error.message);
        })
        .validateAccess(password);
    }

    /**
     * Submits a new part - UPDATED to include type and spec5
     */
    function submitNewPart() {
      if (!isFormUnlocked) {
        showAlert('addPart', 'error', 'Please unlock the form first');
        return;
      }

      // Collect spec values
      const specValues = collectSpecValues();

      // Get subcategory - either from dropdown or custom input
      const subcategoryDropdown = document.getElementById('addSubcategory');
      const subcategoryCustom = document.getElementById('addSubcategoryCustom');
      let subcategory = subcategoryDropdown.value;
      if (subcategoryCustom.style.display !== 'none' && subcategoryCustom.value) {
        subcategory = subcategoryCustom.value.trim();
      }

      // Get type - either from dropdown or custom input
      const typeDropdown = document.getElementById('addType');
      const typeCustom = document.getElementById('addTypeCustom');
      let type = typeDropdown.value;
      if (typeCustom.style.display !== 'none' && typeCustom.value) {
        type = typeCustom.value.trim();
      }

      // Get inventory checkbox
      const inventory = document.getElementById('addInventoryCheckbox').checked;

      // Get selected seasons
      const seasonsSelect = document.getElementById('addPartSeasons');
      const selectedSeasons = Array.from(seasonsSelect.selectedOptions)
        .map(opt => opt.value)
        .join(', ');

      const partData = {
        category: document.getElementById('addCategory').value,
        subcategory: subcategory,
        type: type,
        partName: document.getElementById('addPartName').value,
        productCode: document.getElementById('addProductCode').value.trim(),
        spec1: specValues.spec1,
        spec2: specValues.spec2,
        spec3: specValues.spec3,
        spec4: specValues.spec4,
        spec5: specValues.spec5,
        quantity: document.getElementById('addQuantity').value,
        unitCost: document.getElementById('addUnitCost').value,
        storageLocation: document.getElementById('addStorageLocation').value,
        supplier: document.getElementById('addSupplier').value,
        supplierPartNumber: document.getElementById('addSupplierPartNumber').value,
        notes: document.getElementById('addNotes').value,
        inventory: inventory,
        seasons: selectedSeasons
      };

      // Validate required fields
      if (!partData.category || !partData.subcategory || !partData.type || !partData.partName) {
        showAlert('addPart', 'warning', 'Please fill in all required fields');
        return;
      }

      // Validate required specs
      if (addPartSpecConfig) {
        for (let i = 1; i <= 5; i++) {
          const labelKey = `spec${i}Label`;
          const specValue = partData[`spec${i}`];

          if (addPartSpecConfig[labelKey] && (!specValue || specValue === '-')) {
            const label = addPartSpecConfig[labelKey];
            showAlert('addPart', 'warning', `Error: ${label} is required`);
            return;
          }
        }
      }

      if (!confirm('Add this part to the directory?')) {
        return;
      }

      showLoading('addPart', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('addPart', false);
          if (result.success) {
            showAlert('addPart', 'success', result.message);
            resetAddPartForm();
          } else {
            if (result.isDuplicate) {
              showAlert('addPart', 'warning', result.message);
            } else {
              showAlert('addPart', 'error', result.message);
            }
          }
        })
        .withFailureHandler(function(error) {
          showLoading('addPart', false);
          showAlert('addPart', 'error', 'Failed to add part: ' + error.message);
        })
        .submitNewPartRequest(partData);
    }

    /**
     * Resets the add part form
     */
    function resetAddPartForm() {
      document.getElementById('addPartForm').reset();
      document.getElementById('addSubcategory').disabled = true;
      document.getElementById('addSubcategory').innerHTML = '<option value="">Select category first...</option>';
      document.getElementById('addType').disabled = true;
      document.getElementById('addType').innerHTML = '<option value="">Select subcategory first...</option>';
      clearDynamicSpecFields();
      resetSubcategoryInput();
      resetTypeInput();

      document.getElementById('addInventoryCheckbox').checked = false;
      const seasonsSelect = document.getElementById('addPartSeasons');
      if (seasonsSelect) {
        Array.from(seasonsSelect.options).forEach(opt => opt.selected = false);
      }
    }

    /**
     * Shows an alert message
     */
    function showAlert(section, type, message) {
      const alertDiv = document.getElementById(section + 'Alert');
      alertDiv.className = 'alert alert-' + type + ' show';
      alertDiv.textContent = message;
    }

    /**
     * Hides an alert message
     */
    function hideAlert(section) {
      const alertDiv = document.getElementById(section + 'Alert');
      alertDiv.classList.remove('show');
    }

    /**
     * Shows/hides loading indicator
     */
    function showLoading(section, show, message) {
      const loadingDiv = document.getElementById(section + 'Loading');
      const loadingText = document.getElementById(section + 'LoadingText');

      if (show) {
        loadingDiv.classList.add('show');
        if (message && loadingText) {
          loadingText.textContent = message;
        }
      } else {
        loadingDiv.classList.remove('show');
        // Reset to default message
        if (loadingText) {
          loadingText.textContent = 'Loading parts catalog...';
        }
      }
    }

    // ===== SEARCH MODE MANAGEMENT =====

    /**
     * Toggles between search modes (simple, advanced, browse)
     */
    function toggleSearchMode() {
      const mode = document.querySelector('input[name="searchMode"]:checked').value;

      const simpleSection = document.getElementById('simpleSearchSection');
      const advancedSection = document.getElementById('advancedSearchSection');
      const browseSection = document.getElementById('browseInventorySection');

      simpleSection.style.display = 'none';
      advancedSection.style.display = 'none';
      browseSection.style.display = 'none';

      if (mode === 'simple') {
        simpleSection.style.display = 'block';
      } else if (mode === 'advanced') {
        advancedSection.style.display = 'block';
      } else if (mode === 'browse') {
        browseSection.style.display = 'block';
      }
    }

    /**
     * Toggles the season filter dropdown
     */
    function toggleSeasonFilter() {
      const checkbox = document.getElementById('seasonOnlyFilter');
      const seasonGroup = document.getElementById('seasonFilterGroup');
      const seasonSelect = document.getElementById('seasonFilterSelect');

      if (checkbox.checked) {
        seasonGroup.style.display = 'block';
        seasonSelect.disabled = false;
      } else {
        seasonGroup.style.display = 'none';
        seasonSelect.disabled = true;
        seasonSelect.value = '';
        handleFilterChange();
      }
    }

    /**
     * Handles filter changes (inventory only, season filter)
     */
    function handleFilterChange() {
      if (availableParts.length > 0) {
        applyFiltersToResults();
      }
    }

    // ===== SEARCH EXECUTION =====

    /**
     * Executes simple search across all fields
     */
    function executeSimpleSearch() {
      const searchTerm = document.getElementById('simpleSearchInput').value.trim();

      if (!searchTerm) {
        showAlert('order', 'warning', 'Please enter a search term');
        return;
      }

      showLoading('order', true, 'Searching all fields...');
      hideParts();

      const fields = ['name', 'id', 'code', 'specs'];

      google.script.run
        .withSuccessHandler(handleSearchResults)
        .withFailureHandler(handleSearchError)
        .searchPartsByText(searchTerm, fields);
    }

    /**
     * Executes advanced search with selected fields
     */
    function executeAdvancedSearch() {
      const searchTerm = document.getElementById('advancedSearchInput').value.trim();

      if (!searchTerm) {
        showAlert('order', 'warning', 'Please enter a search term');
        return;
      }

      const fields = [];
      if (document.getElementById('searchPartName').checked) fields.push('name');
      if (document.getElementById('searchPartID').checked) fields.push('id');
      if (document.getElementById('searchProductCode').checked) fields.push('code');
      if (document.getElementById('searchSpecifications').checked) fields.push('specs');

      if (fields.length === 0) {
        showAlert('order', 'warning', 'Please select at least one field to search');
        return;
      }

      showLoading('order', true, 'Searching selected fields...');
      hideParts();

      google.script.run
        .withSuccessHandler(handleSearchResults)
        .withFailureHandler(handleSearchError)
        .searchPartsByText(searchTerm, fields);
    }

    /**
     * Views all inventory parts
     */
    function viewAllInventory() {
      showLoading('order', true, 'Loading inventory parts...');
      hideParts();

      google.script.run
        .withSuccessHandler(handleSearchResults)
        .withFailureHandler(handleSearchError)
        .getInventoryParts();
    }

    /**
     * Views parts for a specific season
     */
    function viewSeasonParts() {
      const modal = document.getElementById('viewSeasonModal');
      modal.style.display = 'flex';
    }

    function closeViewSeasonModal() {
      const modal = document.getElementById('viewSeasonModal');
      modal.style.display = 'none';
      document.getElementById('viewSeasonSelect').value = '';
    }

    function confirmViewSeasonParts() {
      const season = document.getElementById('viewSeasonSelect').value;

      if (!season) {
        alert('Please select a season');
        return;
      }

      closeViewSeasonModal();
      showLoading('order', true, 'Loading season parts...');
      hideParts();

      google.script.run
        .withSuccessHandler(handleSearchResults)
        .withFailureHandler(handleSearchError)
        .getSeasonParts(season);
    }

    /**
     * Handles search results from backend
     */
    function handleSearchResults(parts) {
      console.log('[DEBUG] Backend returned ' + parts.length + ' parts');
      availableParts = parts;
      console.log('[DEBUG] Calling applyFiltersToResults...');
      applyFiltersToResults();
      showLoading('order', false);
    }

    /**
     * Applies inventory and season filters to current results
     */
    function applyFiltersToResults() {
      console.log('[DEBUG] Starting with ' + availableParts.length + ' parts');
      let filteredParts = [...availableParts];

      const inventoryOnlyElement = document.getElementById('inventoryOnlyFilter');
      const seasonOnlyElement = document.getElementById('seasonOnlyFilter');
      const seasonSelectElement = document.getElementById('seasonFilterSelect');

      const inventoryOnly = inventoryOnlyElement ? inventoryOnlyElement.checked : false;
      const seasonOnly = seasonOnlyElement ? seasonOnlyElement.checked : false;
      const selectedSeason = seasonSelectElement ? seasonSelectElement.value : '';

      console.log('[DEBUG] Filters - Inventory: ' + inventoryOnly + ', Season: ' + seasonOnly + ' (' + selectedSeason + ')');

      if (inventoryOnly) {
        filteredParts = filteredParts.filter(part => part.inventory === 'Yes');
        console.log('[DEBUG] After inventory filter: ' + filteredParts.length + ' parts');
      }

      if (seasonOnly && selectedSeason) {
        filteredParts = filteredParts.filter(part => {
          if (!part.seasons) return false;
          const seasonsList = part.seasons.split(',').map(s => s.trim());
          return seasonsList.includes(selectedSeason);
        });
        console.log('[DEBUG] After season filter: ' + filteredParts.length + ' parts');
      }

      console.log('[DEBUG] Final results: ' + filteredParts.length + ' parts');
      displayParts(filteredParts);
    }

    /**
     * Handles search errors
     */
    function handleSearchError(error) {
      showAlert('order', 'error', 'Search failed: ' + error.message);
      showLoading('order', false);
    }

    /**
     * Clears search inputs
     */
    function clearSearch() {
      document.getElementById('simpleSearchInput').value = '';
      document.getElementById('advancedSearchInput').value = '';
      document.getElementById('searchPartName').checked = true;
      document.getElementById('searchPartID').checked = false;
      document.getElementById('searchProductCode').checked = false;
      document.getElementById('searchSpecifications').checked = false;
      hideParts();
      availableParts = [];
      hideAlert('order');
    }

    /**
     * Resets all filters and view
     */
    function resetToOriginal() {
      clearSearch();
      document.getElementById('inventoryOnlyFilter').checked = false;
      document.getElementById('seasonOnlyFilter').checked = false;
      document.getElementById('seasonFilterSelect').value = '';
      toggleSeasonFilter();
      hideParts();
      availableParts = [];
      hideAlert('order');
    }

    // ===== ADD TO MENU =====

    let currentOpenMenu = null;

    /**
     * Toggles the Add To dropdown menu
     */
    function toggleAddToMenu(index, partID) {
      const menu = document.getElementById('addToMenu' + index);

      console.log('[DEBUG] toggleAddToMenu called with index:', index, 'partID:', partID);
      console.log('[DEBUG] Looking for element with ID: addToMenu' + index);
      console.log('[DEBUG] Menu element found:', menu);

      if (!menu) {
        console.error('[ERROR] Menu element not found for index:', index);
        return;
      }

      if (currentOpenMenu && currentOpenMenu !== menu) {
        currentOpenMenu.style.display = 'none';
      }

      if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
        currentOpenMenu = menu;
      } else {
        menu.style.display = 'none';
        currentOpenMenu = null;
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.dropdown-container')) {
        if (currentOpenMenu) {
          currentOpenMenu.style.display = 'none';
          currentOpenMenu = null;
        }
      }
    });

    // ===== INVENTORY MANAGEMENT =====

    /**
     * Adds part to inventory
     */
    function handleAddToInventory(partID, index) {
      if (!partID) {
        showAlert('order', 'error', 'Invalid part ID');
        return;
      }

      showLoading('order', true, 'Adding to inventory...');

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('order', false);
          if (result.success) {
            showAlert('order', 'success', 'Part added to inventory');
            setTimeout(() => hideAlert('order'), 3000);

            if (availableParts[index]) {
              availableParts[index].inventory = 'Yes';
              applyFiltersToResults();
            }
          } else {
            showAlert('order', 'error', result.message || 'Failed to add to inventory');
          }
        })
        .withFailureHandler(function(error) {
          showLoading('order', false);
          showAlert('order', 'error', 'Error: ' + error.message);
        })
        .updatePartInventory(partID, true);

      if (currentOpenMenu) {
        currentOpenMenu.style.display = 'none';
        currentOpenMenu = null;
      }
    }

    /**
     * Removes part from inventory
     */
    function handleRemoveFromInventory(partID, index) {
      if (!partID) {
        showAlert('order', 'error', 'Invalid part ID');
        return;
      }

      if (!confirm('Remove this part from inventory?')) {
        return;
      }

      showLoading('order', true, 'Removing from inventory...');

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('order', false);
          if (result.success) {
            showAlert('order', 'success', 'Part removed from inventory');
            setTimeout(() => hideAlert('order'), 3000);

            if (availableParts[index]) {
              availableParts[index].inventory = 'No';
              applyFiltersToResults();
            }
          } else {
            showAlert('order', 'error', result.message || 'Failed to remove from inventory');
          }
        })
        .withFailureHandler(function(error) {
          showLoading('order', false);
          showAlert('order', 'error', 'Error: ' + error.message);
        })
        .updatePartInventory(partID, false);

      if (currentOpenMenu) {
        currentOpenMenu.style.display = 'none';
        currentOpenMenu = null;
      }
    }

    // ===== SEASON MANAGEMENT =====

    let seasonModalContext = {
      action: null,
      partID: null,
      index: null
    };

    /**
     * Shows the season modal
     */
    function showSeasonModal(action, partID, index) {
      seasonModalContext = { action, partID, index };

      const modal = document.getElementById('seasonModal');
      modal.style.display = 'flex';

      if (currentOpenMenu) {
        currentOpenMenu.style.display = 'none';
        currentOpenMenu = null;
      }
    }

    /**
     * Closes the season modal
     */
    function closeSeasonModal() {
      const modal = document.getElementById('seasonModal');
      modal.style.display = 'none';
      seasonModalContext = { action: null, partID: null, index: null };
      document.getElementById('seasonModalSelect').value = '';
    }

    /**
     * Confirms season action (add or remove)
     */
    function confirmSeasonAction() {
      const season = document.getElementById('seasonModalSelect').value;

      if (!season) {
        alert('Please select a season');
        return;
      }

      const { action, partID, index } = seasonModalContext;

      if (!action || !partID) {
        showAlert('order', 'error', 'Invalid operation');
        closeSeasonModal();
        return;
      }

      closeSeasonModal();
      showLoading('order', true, action === 'add' ? 'Adding to season...' : 'Removing from season...');

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('order', false);
          if (result.success) {
            showAlert('order', 'success', result.message || 'Season updated successfully');
            setTimeout(() => hideAlert('order'), 3000);

            if (availableParts[index] && result.seasons !== undefined) {
              // Update seasons string from backend response
              availableParts[index].seasons = result.seasons;
              applyFiltersToResults();
            }
          } else {
            showAlert('order', 'error', result.message || 'Failed to update season');
          }
        })
        .withFailureHandler(function(error) {
          showLoading('order', false);
          showAlert('order', 'error', 'Error: ' + error.message);
        })
        .updatePartSeasons(partID, action, season);
    }

    // ===== DATA LOADING =====

    /**
     * Loads seasons list for all dropdowns
     */
    function loadSeasonsList() {
      google.script.run
        .withSuccessHandler(function(seasons) {
          populateDropdown('seasonFilterSelect', seasons);
          populateDropdown('seasonModalSelect', seasons);
          populateDropdown('viewSeasonSelect', seasons);

          const addPartSeasonsSelect = document.getElementById('addPartSeasons');
          if (addPartSeasonsSelect) {
            addPartSeasonsSelect.innerHTML = '';
            seasons.forEach(season => {
              const option = document.createElement('option');
              option.value = season;
              option.textContent = season;
              addPartSeasonsSelect.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load seasons:', error);
        })
        .getSeasonsList();
    }

    // Load seasons on page load
    window.addEventListener('load', function() {
      loadSeasonsList();
    });

  </script>

  <!-- SEASON MODAL -->
  <div id="seasonModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3 style="color: var(--lsu-purple); margin-bottom: 20px;">Select Season</h3>

      <div class="form-group">
        <label for="seasonModalSelect">Season <span class="required">*</span></label>
        <select id="seasonModalSelect" style="width: 100%; padding: 10px; font-size: 1em;">
          <option value="">Select season...</option>
        </select>
      </div>

      <div class="button-group" style="margin-top: 20px;">
        <button type="button" class="button button-secondary" onclick="closeSeasonModal()">Cancel</button>
        <button type="button" class="button button-primary" onclick="confirmSeasonAction()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- VIEW SEASON PARTS MODAL -->
  <div id="viewSeasonModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3 style="color: var(--lsu-purple); margin-bottom: 20px;">View Season Parts</h3>

      <div class="form-group">
        <label for="viewSeasonSelect">Select Season <span class="required">*</span></label>
        <select id="viewSeasonSelect" style="width: 100%; padding: 10px; font-size: 1em;">
          <option value="">Select season...</option>
        </select>
      </div>

      <div class="button-group" style="margin-top: 20px;">
        <button type="button" class="button button-secondary" onclick="closeViewSeasonModal()">Cancel</button>
        <button type="button" class="button button-primary" onclick="confirmViewSeasonParts()">View Parts</button>
      </div>
    </div>
  </div>

  <!-- ADMIN: Manual Monday Sync (Password Protected) -->
  <div style="position: fixed; bottom: 10px; right: 10px; font-size: 11px;">
    <button onclick="promptMondaySync()" style="background: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">
      Admin: Manual Sync
    </button>
    <div id="adminSyncResult" style="font-size: 10px; margin-top: 3px; color: #666;"></div>
  </div>

  <script>
  function promptMondaySync() {
    const password = prompt('Enter admin password:');
    if (!password) return;

    const resultDiv = document.getElementById('adminSyncResult');
    resultDiv.textContent = 'Syncing...';
    resultDiv.style.color = '#666';

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          resultDiv.textContent = 'Created: ' + result.created + ', Updated: ' + result.updated;
          resultDiv.style.color = '#28a745';
          setTimeout(() => { resultDiv.textContent = ''; }, 5000);
        } else {
          resultDiv.textContent = result.message || 'Sync failed';
          resultDiv.style.color = '#dc3545';
        }
      })
      .withFailureHandler(function(error) {
        resultDiv.textContent = 'Error: ' + error.message;
        resultDiv.style.color = '#dc3545';
      })
      .syncToMondayWithPassword(password);
  }
  </script>
</body>
</html>
