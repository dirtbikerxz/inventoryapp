<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Denham Venom Parts System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --lsu-purple: #461D7C;
      --lsu-gold: #FDD023;
      --white: #FFFFFF;
      --light-gray: #F5F5F5;
      --medium-gray: #E0E0E0;
      --dark-gray: #333333;
      --success-green: #28a745;
      --error-red: #dc3545;
      --warning-orange: #ffc107;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--lsu-purple) 0%, #5a2a8f 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark-gray);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: var(--white);
      padding: 25px;
      border-radius: 10px 10px 0 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      border-bottom: 4px solid var(--lsu-gold);
    }

    .header h1 {
      color: var(--lsu-purple);
      font-size: 2em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      color: var(--dark-gray);
      font-size: 1.1em;
    }

    .tab-navigation {
      display: flex;
      background: var(--white);
      border-bottom: 2px solid var(--medium-gray);
    }

    .tab-button {
      flex: 1;
      padding: 18px;
      background: var(--light-gray);
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      color: var(--dark-gray);
      transition: all 0.3s ease;
      border-right: 1px solid var(--medium-gray);
    }

    .tab-button:last-child {
      border-right: none;
    }

    .tab-button:hover {
      background: var(--medium-gray);
    }

    .tab-button.active {
      background: var(--lsu-purple);
      color: var(--white);
    }

    .content-area {
      background: var(--white);
      padding: 30px;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-height: 500px;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark-gray);
      font-size: 0.95em;
    }

    .required {
      color: var(--error-red);
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--medium-gray);
      border-radius: 5px;
      font-size: 1em;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--lsu-purple);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .button {
      padding: 14px 28px;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .button-primary {
      background: var(--lsu-purple);
      color: var(--white);
    }

    .button-primary:hover {
      background: #5a2a8f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(70, 29, 124, 0.3);
    }

    .button-secondary {
      background: var(--lsu-gold);
      color: var(--dark-gray);
    }

    .button-secondary:hover {
      background: #f4c700;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(253, 208, 35, 0.3);
    }

    .button:disabled {
      background: var(--medium-gray);
      color: var(--dark-gray);
      cursor: not-allowed;
      transform: none;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: flex-end;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .alert.show {
      display: block;
    }

    .alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--lsu-purple);
      font-weight: 600;
    }

    .loading.show {
      display: block;
    }

    .loading-spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid var(--medium-gray);
      border-top-color: var(--lsu-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .cart-container {
      margin-top: 30px;
      padding: 20px;
      background: var(--light-gray);
      border-radius: 5px;
      border: 2px solid var(--medium-gray);
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--medium-gray);
    }

    .cart-header h3 {
      color: var(--lsu-purple);
      font-size: 1.3em;
    }

    .cart-empty {
      text-align: center;
      padding: 30px;
      color: var(--dark-gray);
      font-style: italic;
    }

    .cart-item {
      background: var(--white);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid var(--medium-gray);
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 15px;
      align-items: center;
    }

    .cart-item-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .cart-item-name {
      font-weight: 600;
      color: var(--lsu-purple);
    }

    .cart-item-details {
      font-size: 0.9em;
      color: var(--dark-gray);
    }

    .cart-item-price {
      font-weight: 700;
      color: var(--lsu-purple);
      font-size: 1.1em;
    }

    .remove-button {
      padding: 8px 16px;
      background: var(--error-red);
      color: var(--white);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    .remove-button:hover {
      background: #c82333;
    }

    .cart-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 3px solid var(--lsu-purple);
      font-size: 1.4em;
      font-weight: 700;
      color: var(--lsu-purple);
    }

    .part-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
      border: 2px solid var(--medium-gray);
      border-radius: 5px;
    }

    .part-item {
      padding: 12px 15px;
      border-bottom: 1px solid var(--medium-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .part-item:last-child {
      border-bottom: none;
    }

    .part-item-name {
      font-weight: 600;
      color: var(--lsu-purple);
    }

    .part-item-stock {
      color: var(--dark-gray);
      font-size: 0.9em;
    }

    .part-item.out-of-stock {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .password-section {
      background: var(--warning-orange);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 25px;
      border: 2px solid #f4c700;
    }

    .password-section p {
      margin-bottom: 10px;
      font-weight: 600;
    }

    .info-box {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .info-box h4 {
      color: #1976d2;
      margin-bottom: 8px;
    }

    .info-box p {
      color: var(--dark-gray);
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header h1 {
        font-size: 1.5em;
      }

      .header p {
        font-size: 0.95em;
      }

      .tab-button {
        padding: 12px;
        font-size: 0.95em;
      }

      .content-area {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .button {
        width: 100%;
      }

      .cart-item {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .cart-item-price,
      .remove-button {
        justify-self: start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Denham Venom Parts Management System</h1>
      <p>Team 8044 - Parts Directory and Ordering</p>
    </div>

    <div class="tab-navigation">
      <button class="tab-button active" onclick="switchTab('order')">Order Parts</button>
      <button class="tab-button" onclick="switchTab('addPart')">Add Part to Directory</button>
    </div>

    <div class="content-area">
      <!-- ORDER PARTS FORM -->
      <div id="orderSection" class="form-section active">
        <div class="info-box">
          <h4>How to Order Parts</h4>
          <p>Select your name, choose a category and subcategory to view available parts, then add items to your cart. Review your order and submit when ready.</p>
        </div>

        <div class="button-group" style="margin-bottom: 20px;">
          <button type="button" id="browseModeBtn" class="button button-primary" onclick="showBrowseInventory()">Browse Inventory</button>
          <button type="button" id="customModeBtn" class="button button-secondary" onclick="showCustomRequest()">Request Custom Part</button>
        </div>

        <div id="orderAlert" class="alert"></div>
        <div id="orderLoading" class="loading">
          <span class="loading-spinner"></span>
          <span id="orderLoadingText">Loading parts catalog...</span>
        </div>

        <form id="orderForm" onsubmit="return false;">
          <div class="form-group">
            <label for="studentName">Student Name <span class="required">*</span></label>
            <select id="studentName" required>
              <option value="">Select your name...</option>
            </select>
          </div>

          <!-- BROWSE INVENTORY SECTION -->
          <div id="browseInventorySection">
          <div class="form-group">
            <label for="productCodeSearch">Quick Search by Product Code (Optional)</label>
            <input type="text" id="productCodeSearch" placeholder="e.g., WCP-0448" style="width: 100%; padding: 10px; font-size: 1em;">
            <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Enter manufacturer product code to find specific parts. Leave blank to browse by category.</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="orderCategory">Category <span class="required">*</span></label>
              <select id="orderCategory" required>
                <option value="">Select category...</option>
              </select>
            </div>

            <div class="form-group">
              <label for="orderSubcategory">Subcategory <span class="required">*</span></label>
              <select id="orderSubcategory" required disabled>
                <option value="">Select category first...</option>
              </select>
            </div>
          </div>

          <!-- Dynamic Spec Filter Dropdowns -->
          <div id="specFilters"></div>

          <div class="button-group">
            <button type="button" class="button button-secondary" onclick="searchParts()">Search Parts</button>
          </div>

          <div id="partsListContainer" style="display: none;">
            <h3 style="margin-top: 30px; margin-bottom: 10px; color: var(--lsu-purple);">Available Parts</h3>
            <div id="partsList" class="part-list"></div>
          </div>

          <!-- ORDER DETAIL PAGE -->
          <div id="orderDetailPage" style="display: none;">
            <h3 style="margin-top: 30px; margin-bottom: 20px; color: var(--lsu-purple);">Order Details</h3>

            <div class="info-box" style="background: var(--light-gray); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
              <div style="margin-bottom: 10px;">
                <strong>Student:</strong> <span id="orderDetailStudent"></span>
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Part:</strong> <span id="orderDetailPartName"></span>
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Part ID:</strong> <span id="orderDetailPartID"></span>
              </div>
              <div>
                <strong>Specifications:</strong> <span id="orderDetailSpecs"></span>
              </div>
            </div>

            <div class="form-group">
              <label for="orderDetailQuantity">Quantity to Order <span class="required">*</span></label>
              <input type="number" id="orderDetailQuantity" min="1" value="1" style="width: 100%; padding: 10px; font-size: 1em;" oninput="updateOrderCalculation()">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">How many units do you want to order?</small>
            </div>

            <div class="info-box" style="border-left: 4px solid var(--lsu-gold); background: #fffef0; padding: 15px; margin: 20px 0;">
              <div style="margin-bottom: 10px; font-size: 1.1em;">
                <strong>You are ordering:</strong> <span id="orderDetailTotalItems" style="color: var(--lsu-purple); font-weight: 600;">0</span> items
              </div>
              <div style="font-size: 0.9em; color: var(--dark-gray);">
                <span id="orderDetailCalcExplanation"></span>
              </div>
              <div style="margin-top: 10px; font-size: 1.2em;">
                <strong>Total Cost:</strong> <span id="orderDetailTotalCost" style="color: var(--lsu-purple); font-weight: 600;">$0.00</span>
              </div>
            </div>

            <div class="button-group" style="margin-top: 20px;">
              <button type="button" class="button button-secondary" onclick="cancelOrder()">Cancel</button>
              <button type="button" class="button button-primary" onclick="addOrderToCart()">Add to Cart</button>
            </div>
          </div>
          </div>
          <!-- END BROWSE INVENTORY SECTION -->

          <!-- CUSTOM REQUEST SECTION -->
          <div id="customRequestSection" style="display: none;">
            <h3 style="margin-top: 20px; margin-bottom: 20px; color: var(--lsu-purple);">Request Custom Part</h3>

            <div class="form-group">
              <label for="customPartName">Part Name/Description <span class="required">*</span></label>
              <input type="text" id="customPartName" placeholder="Enter the name or description of the part..." required style="width: 100%; padding: 10px; font-size: 1em;">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">What is the part called or what does it do?</small>
            </div>

            <div class="form-group">
              <label for="customPartLink">Product Link/URL <span class="required">*</span></label>
              <input type="url" id="customPartLink" placeholder="https://example.com/product" required style="width: 100%; padding: 10px; font-size: 1em;">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Where can we order this part online?</small>
            </div>

            <div class="form-group">
              <label for="customPartCost">Estimated Cost (Optional)</label>
              <input type="number" id="customPartCost" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; font-size: 1em;">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">If known, approximately how much does this part cost?</small>
            </div>

            <div class="form-group">
              <label for="customPartJustification">Justification/Use Case <span class="required">*</span></label>
              <textarea id="customPartJustification" rows="4" placeholder="Explain why you need this part and what you plan to use it for..." required style="width: 100%; padding: 10px; font-size: 1em;"></textarea>
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Why do you need this part? What will you use it for?</small>
            </div>

            <div class="button-group">
              <button type="button" class="button button-primary" onclick="submitCustomRequest()">Submit Custom Request</button>
            </div>
          </div>
          <!-- END CUSTOM REQUEST SECTION -->

          <div id="cartContainer" class="cart-container" style="display: none;">
            <div class="cart-header">
              <h3>Your Order</h3>
              <button type="button" class="button button-secondary" style="padding: 8px 16px; font-size: 0.9em;" onclick="clearCart()">Clear All</button>
            </div>
            <div id="cartItems"></div>
            <div class="cart-total">
              <span>Total Cost:</span>
              <span id="cartTotal">$0.00</span>
            </div>

            <div class="form-group" style="margin-top: 20px;">
              <label for="orderPriority">Priority <span class="required">*</span></label>
              <select id="orderPriority" required>
                <option value="">Select priority...</option>
                <option value="High">High - Needed immediately</option>
                <option value="Medium">Medium - Needed within a week</option>
                <option value="Low">Low - Needed when available</option>
              </select>
            </div>

            <div class="form-group">
              <label for="orderNotes">Notes (Optional)</label>
              <textarea id="orderNotes" rows="3" placeholder="Add any special instructions or notes about this order..."></textarea>
            </div>

            <div class="button-group">
              <button type="button" class="button button-primary" onclick="submitOrder()">Submit Order</button>
            </div>
          </div>
        </form>
      </div>

      <!-- ADD PART FORM -->
      <div id="addPartSection" class="form-section">
        <div class="password-section">
          <p>Access Control: Enter password to unlock form</p>
          <input type="password" id="accessPassword" placeholder="Enter password...">
          <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="validatePassword()">Unlock Form</button>
        </div>

        <div id="addPartFormContainer" style="display: none;">
          <div class="info-box">
            <h4>Adding New Parts</h4>
            <p>Use this form to add new parts to the inventory directory. All fields marked with an asterisk are required. The system will check for duplicate parts before adding.</p>
          </div>

          <div id="addPartAlert" class="alert"></div>
          <div id="addPartLoading" class="loading">
            <span class="loading-spinner"></span>
            <span>Processing your request...</span>
          </div>

          <form id="addPartForm" onsubmit="return false;">
            <div class="form-row">
              <div class="form-group">
                <label for="addCategory">Category <span class="required">*</span></label>
                <select id="addCategory" required>
                  <option value="">Select category...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="addSubcategory">Subcategory <span class="required">*</span></label>
                <select id="addSubcategory" disabled>
                  <option value="">Select category first...</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="addPartName">Part Name <span class="required">*</span></label>
              <input type="text" id="addPartName" placeholder="Enter part name..." required>
            </div>

            <div class="form-group">
              <label for="addProductCode">Product Code (Optional)</label>
              <input type="text" id="addProductCode" placeholder="e.g., WCP-0448">
              <small style="color: var(--dark-gray); display: block; margin-top: 5px;">Manufacturer's product/part number (if applicable)</small>
            </div>

            <!-- Dynamic Spec Fields Container -->
            <div id="dynamicSpecFields"></div>

            <div class="form-row">
              <div class="form-group">
                <label for="addQuantity">Initial Quantity <span class="required">*</span></label>
                <input type="number" id="addQuantity" min="0" value="0" required>
              </div>

              <div class="form-group">
                <label for="addUnitCost">Unit Cost ($) <span class="required">*</span></label>
                <input type="number" id="addUnitCost" step="0.01" min="0" value="0.00" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="addStorageLocation">Storage Location</label>
                <input type="text" id="addStorageLocation" placeholder="e.g., Bin A3, Shelf 2">
              </div>

              <div class="form-group">
                <label for="addSupplier">Supplier</label>
                <input type="text" id="addSupplier" placeholder="e.g., McMaster-Carr, AndyMark">
              </div>
            </div>

            <div class="form-group">
              <label for="addSupplierPartNumber">Supplier Part Number</label>
              <input type="text" id="addSupplierPartNumber" placeholder="Enter supplier's part number...">
            </div>

            <div class="form-group">
              <label for="addNotes">Additional Notes</label>
              <textarea id="addNotes" placeholder="Enter any additional information..."></textarea>
            </div>

            <div class="button-group">
              <button type="button" class="button button-secondary" onclick="resetAddPartForm()">Reset Form</button>
              <button type="button" class="button button-primary" onclick="submitNewPart()">Add Part to Directory</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentCart = [];
    let availableParts = [];
    let currentOrderPart = null;
    let isFormUnlocked = false;
    let currentSpecConfig = null;
    let addPartSpecConfig = null;

    // Initialize application
    document.addEventListener('DOMContentLoaded', function() {
      loadInitialData();
    });

    /**
     * Loads initial data for the application
     */
    function loadInitialData() {
      showLoading('order', true);

      // Load categories for order form
      google.script.run
        .withSuccessHandler(function(categories) {
          populateDropdown('orderCategory', categories);
          showLoading('order', false);
        })
        .withFailureHandler(function(error) {
          showAlert('order', 'error', 'Failed to load categories: ' + error.message);
          showLoading('order', false);
        })
        .getCategories();

      // Load students
      google.script.run
        .withSuccessHandler(function(students) {
          populateDropdown('studentName', students);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load students:', error);
        })
        .getStudents();

      // Load categories for add part form
      google.script.run
        .withSuccessHandler(function(categories) {
          populateDropdown('addCategory', categories);
          setupAddPartEventHandlers();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load categories for add form:', error);
        })
        .getCategories();
    }

    /**
     * Sets up event handlers for add part form
     */
    function setupAddPartEventHandlers() {
      document.getElementById('addCategory').addEventListener('change', handleAddPartCategoryChange);
      document.getElementById('addSubcategory').addEventListener('change', handleAddPartSubcategoryChange);
    }

    /**
     * Switches between tabs
     */
    function switchTab(tabName) {
      // Update tab buttons
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Update content sections
      const sections = document.querySelectorAll('.form-section');
      sections.forEach(section => section.classList.remove('active'));

      if (tabName === 'order') {
        document.getElementById('orderSection').classList.add('active');
      } else if (tabName === 'addPart') {
        document.getElementById('addPartSection').classList.add('active');
      }
    }

    /**
     * Populates a dropdown with options
     */
    function populateDropdown(elementId, options) {
      const select = document.getElementById(elementId);
      const currentValue = select.value;

      // Keep first option (placeholder)
      while (select.options.length > 1) {
        select.remove(1);
      }

      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });

      // Restore previous selection if it still exists
      if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
      }
    }

    /**
     * Handles category change for order form
     */
    document.getElementById('orderCategory').addEventListener('change', function() {
      const category = this.value;
      const subcategorySelect = document.getElementById('orderSubcategory');

      if (!category) {
        subcategorySelect.disabled = true;
        subcategorySelect.innerHTML = '<option value="">Select category first...</option>';
        clearSpecFilters();
        hideParts();
        return;
      }

      showLoading('order', true);
      subcategorySelect.disabled = true;
      subcategorySelect.innerHTML = '<option value="">Loading...</option>';
      clearSpecFilters();

      google.script.run
        .withSuccessHandler(function(subcategories) {
          subcategorySelect.disabled = false;
          subcategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
          populateDropdown('orderSubcategory', subcategories);
          showLoading('order', false);
        })
        .withFailureHandler(function(error) {
          showAlert('order', 'error', 'Failed to load subcategories: ' + error.message);
          subcategorySelect.disabled = true;
          showLoading('order', false);
        })
        .getSubcategories(category);
    });

    /**
     * Handles subcategory change for order form - loads spec filters
     */
    document.getElementById('orderSubcategory').addEventListener('change', function() {
      const category = document.getElementById('orderCategory').value;
      const subcategory = this.value;

      clearSpecFilters();
      hideParts();

      if (!category || !subcategory) {
        return;
      }

      showLoading('order', true, 'Loading filter options...');

      google.script.run
        .withSuccessHandler(handleSpecConfig)
        .withFailureHandler(function(error) {
          console.error('Failed to load spec config:', error);
          showLoading('order', false);
        })
        .getSpecConfig(category, subcategory);
    });

    /**
     * Clears spec filter dropdowns
     */
    function clearSpecFilters() {
      const specFiltersDiv = document.getElementById('specFilters');
      specFiltersDiv.innerHTML = '';
      currentSpecConfig = null;
    }

    /**
     * Handles spec configuration response from backend
     */
    function handleSpecConfig(config) {
      currentSpecConfig = config;
      const category = document.getElementById('orderCategory').value;
      const subcategory = document.getElementById('orderSubcategory').value;
      const specFiltersDiv = document.getElementById('specFilters');

      specFiltersDiv.innerHTML = '';

      // Create container for spec filters with grid layout
      const filterRow = document.createElement('div');
      filterRow.className = 'form-row';
      filterRow.id = 'specFilterRow';

      let hasVisibleSpecs = false;

      // Create dropdowns for each spec (1-4)
      for (let specNum = 1; specNum <= 4; specNum++) {
        const labelKey = 'spec' + specNum + 'Label';
        const label = config[labelKey];

        if (label && label !== '-' && label.trim() !== '') {
          hasVisibleSpecs = true;

          // Create form group
          const formGroup = document.createElement('div');
          formGroup.className = 'form-group';
          formGroup.id = 'specFilter' + specNum + 'Group';

          // Create label
          const labelElement = document.createElement('label');
          labelElement.setAttribute('for', 'specFilter' + specNum);
          labelElement.textContent = label;
          formGroup.appendChild(labelElement);

          // Create select
          const select = document.createElement('select');
          select.id = 'specFilter' + specNum;
          select.className = 'form-control';
          select.innerHTML = '<option value="">All ' + label + '...</option>';
          formGroup.appendChild(select);

          filterRow.appendChild(formGroup);

          // Load values for this spec
          google.script.run
            .withSuccessHandler(function(values) {
              populateSpecDropdown(specNum, label, values);
            })
            .withFailureHandler(function(error) {
              console.error('Failed to load spec values for ' + label + ':', error);
            })
            .getSpecValues(category, subcategory, specNum);
        }
      }

      if (hasVisibleSpecs) {
        specFiltersDiv.appendChild(filterRow);
      }

      showLoading('order', false);
    }

    /**
     * Populates a spec filter dropdown with values
     */
    function populateSpecDropdown(specNum, label, values) {
      const select = document.getElementById('specFilter' + specNum);
      if (!select) return;

      // Keep the "All" option and add the values
      const currentValue = select.value;
      select.innerHTML = '<option value="">All ' + label + '...</option>';

      values.forEach(function(value) {
        if (value && value !== '-' && value.trim() !== '') {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        }
      });

      // Restore previous selection if it exists
      if (currentValue && values.includes(currentValue)) {
        select.value = currentValue;
      }
    }

    /**
     * Searches for parts based on filters
     */
    function searchParts() {
      // Check if product code search is being used
      const productCode = document.getElementById('productCodeSearch').value.trim();

      if (productCode) {
        // Search by product code instead
        showLoading('order', true, 'Searching by product code...');
        hideParts();

        google.script.run
          .withSuccessHandler(function(parts) {
            availableParts = parts;
            displayParts(parts);
            showLoading('order', false);
          })
          .withFailureHandler(function(error) {
            showAlert('order', 'error', 'Failed to search: ' + error.message);
            showLoading('order', false);
          })
          .getPartsByProductCode(productCode);
        return;
      }

      // Otherwise, proceed with category/subcategory/spec filtering
      const category = document.getElementById('orderCategory').value;
      const subcategory = document.getElementById('orderSubcategory').value;

      if (!category || !subcategory) {
        showAlert('order', 'warning', 'Please select both category and subcategory');
        return;
      }

      // Collect spec filter values
      const filters = {
        category: category,
        subcategory: subcategory,
        spec1: getSpecFilterValue(1),
        spec2: getSpecFilterValue(2),
        spec3: getSpecFilterValue(3),
        spec4: getSpecFilterValue(4)
      };

      showLoading('order', true, 'Searching for parts...');
      hideParts();

      google.script.run
        .withSuccessHandler(function(parts) {
          availableParts = parts;
          displayParts(parts);
          showLoading('order', false);
        })
        .withFailureHandler(function(error) {
          showAlert('order', 'error', 'Failed to search parts: ' + error.message);
          showLoading('order', false);
        })
        .getPartsByFilters(filters);
    }

    /**
     * Gets the value of a spec filter dropdown
     */
    function getSpecFilterValue(specNum) {
      const select = document.getElementById('specFilter' + specNum);
      return select ? select.value : '';
    }

    /**
     * Displays parts in the list
     */
    function displayParts(parts) {
      const container = document.getElementById('partsListContainer');
      const list = document.getElementById('partsList');

      list.innerHTML = '';

      if (parts.length === 0) {
        list.innerHTML = '<div class="cart-empty">No parts found matching filters</div>';
      } else {
        parts.forEach((part, index) => {
          const item = document.createElement('div');
          item.className = 'part-item';

          const quantityPer = part.quantityPer || part.quantity || 0;
          const unitCost = part.unitCost || 0;

          if (quantityPer === 0) {
            item.classList.add('out-of-stock');
          }

          // Build spec display with dynamic labels
          let specDisplay = formatSpecDisplay(part);

          item.innerHTML = `
            <div style="flex: 1;">
              <div class="part-item-name">${part.partName || 'Unknown Part'}</div>
              <div class="part-item-details">${part.partID || 'N/A'}${specDisplay ? ' - ' + specDisplay : ''}</div>
              ${part.productCode ? '<div class="part-item-details" style="color: var(--lsu-gold);">Product Code: ' + part.productCode + '</div>' : ''}
              <div class="part-item-stock">Quantity Per: ${quantityPer} | Unit Cost: $${unitCost.toFixed(2)}</div>
            </div>
            ${quantityPer > 0 ? '<button class="button button-primary" onclick="showOrderPage(' + index + '); event.stopPropagation();" style="margin-left: 10px; padding: 10px 20px;">Order</button>' : '<span style="color: #999; margin-left: 10px;">Out of Stock</span>'}
          `;

          // No longer using click event on entire item

          list.appendChild(item);
        });
      }

      container.style.display = 'block';
    }

    /**
     * Formats spec display with dynamic labels
     */
    function formatSpecDisplay(part) {
      if (!currentSpecConfig) {
        // Fallback to generic display if config not loaded
        const specs = [];
        if (part.spec1 && part.spec1 !== '-') specs.push(part.spec1);
        if (part.spec2 && part.spec2 !== '-') specs.push(part.spec2);
        if (part.spec3 && part.spec3 !== '-') specs.push(part.spec3);
        if (part.spec4 && part.spec4 !== '-') specs.push(part.spec4);
        return specs.join(' | ');
      }

      // Use dynamic labels from config
      const specs = [];
      for (let i = 1; i <= 4; i++) {
        const label = currentSpecConfig['spec' + i + 'Label'];
        const value = part['spec' + i];

        if (label && label !== '-' && value && value !== '-') {
          specs.push(label + ': ' + value);
        }
      }

      return specs.join(' | ');
    }

    /**
     * Hides the parts list
     */
    function hideParts() {
      document.getElementById('partsListContainer').style.display = 'none';
    }

    /**
     * Updates the cart display
     */
    function updateCartDisplay() {
      const container = document.getElementById('cartContainer');
      const itemsDiv = document.getElementById('cartItems');
      const totalSpan = document.getElementById('cartTotal');

      if (currentCart.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      itemsDiv.innerHTML = '';

      let total = 0;
      currentCart.forEach((item, index) => {
        total += item.totalCost;

        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';

        // Show specs if available, otherwise show simple message
        const specText = item.specifications && item.specifications.trim() ? item.specifications : 'Standard part';

        // Calculate total items (quantity × quantityPer)
        const totalItems = item.quantity * (item.quantityPer || 1);

        cartItem.innerHTML = `
          <div class="cart-item-info">
            <div class="cart-item-name">${item.partName}</div>
            <div class="cart-item-details">
              ${item.partID} - ${specText}<br>
              Quantity: ${item.quantity} units (${totalItems} items total) x $${item.unitCost.toFixed(2)}
            </div>
          </div>
          <div class="cart-item-price">$${item.totalCost.toFixed(2)}</div>
          <button class="remove-button" onclick="removeFromCart(${index})">Remove</button>
        `;
        itemsDiv.appendChild(cartItem);
      });

      totalSpan.textContent = '$' + total.toFixed(2);
    }

    /**
     * Removes an item from the cart
     */
    function removeFromCart(index) {
      currentCart.splice(index, 1);
      updateCartDisplay();
      showAlert('order', 'success', 'Item removed from cart');
      setTimeout(() => hideAlert('order'), 3000);
    }

    /**
     * Shows the order detail page for a selected part
     */
    function showOrderPage(index) {
      const part = availableParts[index];
      if (!part) return;

      const studentName = document.getElementById('studentName').value;
      if (!studentName) {
        showAlert('order', 'warning', 'Please select your name first');
        return;
      }

      // Store current part
      currentOrderPart = part;

      // Populate order detail page
      document.getElementById('orderDetailStudent').textContent = studentName;
      document.getElementById('orderDetailPartName').textContent = part.partName || 'Unknown Part';
      document.getElementById('orderDetailPartID').textContent = part.partID || 'N/A';
      document.getElementById('orderDetailSpecs').textContent = formatSpecDisplay(part) || 'No specifications';

      // Reset quantity to 1
      document.getElementById('orderDetailQuantity').value = 1;

      // Update calculation
      updateOrderCalculation();

      // Hide parts list, show order detail page
      document.getElementById('partsListContainer').style.display = 'none';
      document.getElementById('orderDetailPage').style.display = 'block';

      // Scroll to top
      window.scrollTo(0, 0);
    }

    /**
     * Updates the order calculation display
     */
    function updateOrderCalculation() {
      if (!currentOrderPart) return;

      const quantity = parseInt(document.getElementById('orderDetailQuantity').value) || 1;
      const quantityPer = currentOrderPart.quantityPer || currentOrderPart.quantity || 1;
      const unitCost = currentOrderPart.unitCost || 0;

      const totalItems = quantity * quantityPer;
      const totalCost = quantity * unitCost;

      // Update display
      document.getElementById('orderDetailTotalItems').textContent = totalItems;
      document.getElementById('orderDetailCalcExplanation').textContent =
        `(${quantity} units × ${quantityPer} per unit)`;
      document.getElementById('orderDetailTotalCost').textContent = '$' + totalCost.toFixed(2);
    }

    /**
     * Cancels the current order and returns to parts list
     */
    function cancelOrder() {
      currentOrderPart = null;
      document.getElementById('orderDetailPage').style.display = 'none';
      document.getElementById('partsListContainer').style.display = 'block';
    }

    /**
     * Adds the configured order to the cart
     */
    function addOrderToCart() {
      if (!currentOrderPart) return;

      const quantity = parseInt(document.getElementById('orderDetailQuantity').value) || 1;

      if (quantity <= 0) {
        showAlert('order', 'warning', 'Please enter a valid quantity');
        return;
      }

      const quantityPer = currentOrderPart.quantityPer || currentOrderPart.quantity || 1;
      const unitCost = currentOrderPart.unitCost || 0;
      const totalCost = quantity * unitCost;

      // Add to cart with all necessary fields
      const cartItem = {
        partID: currentOrderPart.partID,
        partName: currentOrderPart.partName,
        category: currentOrderPart.category,
        subcategory: currentOrderPart.subcategory,
        specifications: formatSpecDisplay(currentOrderPart),
        quantity: quantity,
        quantityPer: quantityPer,
        unitCost: unitCost,
        totalCost: totalCost
      };

      currentCart.push(cartItem);
      updateCartDisplay();

      // Show success message
      showAlert('order', 'success', `Added ${currentOrderPart.partName} to cart`);
      setTimeout(() => hideAlert('order'), 3000);

      // Return to parts list
      cancelOrder();
    }

    /**
     * Clears all items from the cart
     */
    function clearCart() {
      if (currentCart.length === 0) return;

      if (confirm('Are you sure you want to clear all items from your cart?')) {
        currentCart = [];
        updateCartDisplay();
        showAlert('order', 'success', 'Cart cleared');
        setTimeout(() => hideAlert('order'), 3000);
      }
    }

    /**
     * Submits the order
     */
    function submitOrder() {
      const studentName = document.getElementById('studentName').value;
      const priority = document.getElementById('orderPriority').value;
      const notes = document.getElementById('orderNotes').value.trim();

      if (!studentName) {
        showAlert('order', 'warning', 'Please select your name');
        return;
      }

      if (currentCart.length === 0) {
        showAlert('order', 'warning', 'Your cart is empty');
        return;
      }

      if (!priority) {
        showAlert('order', 'warning', 'Please select a priority level for this order');
        return;
      }

      // Require team leader password approval
      const password = prompt('Team Leader Approval Required\n\nEnter leadership password to approve this order:');

      if (!password) {
        showAlert('order', 'warning', 'Order submission cancelled - no password entered');
        return;
      }

      if (password !== 'venom8044') {
        showAlert('order', 'error', 'Incorrect password - order not submitted');
        return;
      }

      if (!confirm('Submit this order? This action cannot be undone.')) {
        return;
      }

      const totalCost = currentCart.reduce((sum, item) => sum + item.totalCost, 0);

      const orderData = {
        studentName: studentName,
        items: currentCart,
        totalCost: totalCost,
        priority: priority,
        notes: notes || ''
      };

      showLoading('order', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('order', false);
          if (result.success) {
            showAlert('order', 'success',
              `Order ${result.orderNumber} submitted successfully! Total: $${totalCost.toFixed(2)}`);
            currentCart = [];
            updateCartDisplay();
            resetOrderForm();
          } else {
            showAlert('order', 'error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading('order', false);
          showAlert('order', 'error', 'Failed to submit order: ' + error.message);
        })
        .submitOrder(orderData);
    }

    /**
     * Resets the order form
     */
    function resetOrderForm() {
      document.getElementById('orderForm').reset();
      document.getElementById('orderSubcategory').disabled = true;
      document.getElementById('orderSubcategory').innerHTML = '<option value="">Select category first...</option>';
      document.getElementById('orderPriority').value = '';
      document.getElementById('orderNotes').value = '';
      hideParts();
      availableParts = [];
    }

    /**
     * Shows the browse inventory mode
     */
    function showBrowseInventory() {
      document.getElementById('browseInventorySection').style.display = 'block';
      document.getElementById('customRequestSection').style.display = 'none';
      document.getElementById('browseModeBtn').className = 'button button-primary';
      document.getElementById('customModeBtn').className = 'button button-secondary';
    }

    /**
     * Shows the custom request mode
     */
    function showCustomRequest() {
      document.getElementById('browseInventorySection').style.display = 'none';
      document.getElementById('customRequestSection').style.display = 'block';
      document.getElementById('browseModeBtn').className = 'button button-secondary';
      document.getElementById('customModeBtn').className = 'button button-primary';
    }

    /**
     * Submits a custom part request
     */
    function submitCustomRequest() {
      const studentName = document.getElementById('studentName').value;
      const partName = document.getElementById('customPartName').value.trim();
      const partLink = document.getElementById('customPartLink').value.trim();
      const estimatedCost = parseFloat(document.getElementById('customPartCost').value) || 0;
      const justification = document.getElementById('customPartJustification').value.trim();

      // Validate required fields
      if (!studentName) {
        showAlert('order', 'warning', 'Please select your name');
        return;
      }

      if (!partName) {
        showAlert('order', 'warning', 'Please enter the part name or description');
        return;
      }

      if (!partLink) {
        showAlert('order', 'warning', 'Please provide a product link');
        return;
      }

      if (!justification) {
        showAlert('order', 'warning', 'Please explain why you need this part');
        return;
      }

      // Require team leader password approval
      const password = prompt('Team Leader Approval Required\n\nEnter leadership password to approve this custom request:');

      if (!password) {
        showAlert('order', 'warning', 'Request cancelled - no password entered');
        return;
      }

      if (password !== 'venom8044') {
        showAlert('order', 'error', 'Incorrect password - request not submitted');
        return;
      }

      // Prepare custom request data
      const requestData = {
        studentName: studentName,
        partName: partName,
        partLink: partLink,
        estimatedCost: estimatedCost,
        justification: justification,
        priority: 'Medium' // Default priority for custom requests
      };

      showLoading('order', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('order', false);
          if (result.success) {
            showAlert('order', 'success',
              `Custom request submitted successfully! Request ID: ${result.requestID}`);
            // Clear the form
            document.getElementById('customPartName').value = '';
            document.getElementById('customPartLink').value = '';
            document.getElementById('customPartCost').value = '';
            document.getElementById('customPartJustification').value = '';
          } else {
            showAlert('order', 'error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading('order', false);
          showAlert('order', 'error', 'Failed to submit custom request: ' + error.message);
        })
        .submitCustomRequest(requestData);
    }

    /**
     * Handles category change in add part form
     */
    function handleAddPartCategoryChange() {
      const category = document.getElementById('addCategory').value;
      const subcategorySelect = document.getElementById('addSubcategory');

      clearDynamicSpecFields();

      if (!category) {
        subcategorySelect.disabled = true;
        subcategorySelect.innerHTML = '<option value="">Select category first...</option>';
        return;
      }

      subcategorySelect.disabled = false;
      subcategorySelect.innerHTML = '<option value="">Loading subcategories...</option>';

      google.script.run
        .withSuccessHandler(function(subcategories) {
          subcategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
          subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            subcategorySelect.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          subcategorySelect.innerHTML = '<option value="">Error loading subcategories</option>';
          console.error('Failed to load subcategories:', error);
        })
        .getSubcategories(category);
    }

    /**
     * Handles subcategory change in add part form
     */
    function handleAddPartSubcategoryChange() {
      const category = document.getElementById('addCategory').value;
      const subcategory = document.getElementById('addSubcategory').value;

      if (!category || !subcategory) {
        clearDynamicSpecFields();
        return;
      }

      google.script.run
        .withSuccessHandler(handleAddPartSpecConfig)
        .withFailureHandler(function(error) {
          console.error('Failed to load spec config:', error);
          clearDynamicSpecFields();
        })
        .getSpecConfig(category, subcategory);
    }

    /**
     * Clears dynamic spec fields
     */
    function clearDynamicSpecFields() {
      const container = document.getElementById('dynamicSpecFields');
      container.innerHTML = '';
      addPartSpecConfig = null;
    }

    /**
     * Handles spec configuration for add part form
     */
    function handleAddPartSpecConfig(config) {
      addPartSpecConfig = config;
      const container = document.getElementById('dynamicSpecFields');
      container.innerHTML = '';

      const category = document.getElementById('addCategory').value;
      const subcategory = document.getElementById('addSubcategory').value;

      for (let i = 1; i <= 4; i++) {
        const labelKey = `spec${i}Label`;
        const requiredKey = `spec${i}Required`;
        const label = config[labelKey];

        if (label && label !== '-') {
          const isRequired = config[requiredKey] === 'Y';
          const formGroup = document.createElement('div');
          formGroup.className = 'form-group';
          formGroup.id = `specField${i}Group`;

          formGroup.innerHTML = `
            <label for="addPartSpec${i}">
              ${label}
              ${isRequired ? '<span class="required">*</span>' : ''}
            </label>
            <select id="addPartSpec${i}" class="form-control" onchange="handleSpecChange(${i})">
              <option value="">Select ${label}...</option>
              <option value="__ADD_NEW__">Add New...</option>
            </select>
            <input type="text" id="addPartSpec${i}Custom" class="form-control"
                   style="display:none;" placeholder="Enter new ${label}">
          `;

          container.appendChild(formGroup);

          google.script.run
            .withSuccessHandler(function(values) {
              populateAddPartSpec(i, label, values);
            })
            .withFailureHandler(function(error) {
              console.error(`Failed to load values for spec ${i}:`, error);
            })
            .getSpecValues(category, subcategory, i);
        }
      }
    }

    /**
     * Populates a spec dropdown for add part form
     */
    function populateAddPartSpec(specNum, label, values) {
      const dropdown = document.getElementById(`addPartSpec${specNum}`);
      if (!dropdown) return;

      const filteredValues = values.filter(v => v && v.trim() !== '' && v !== '-');

      dropdown.innerHTML = `<option value="">Select ${label}...</option>`;

      filteredValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        dropdown.appendChild(option);
      });

      const addNewOption = document.createElement('option');
      addNewOption.value = '__ADD_NEW__';
      addNewOption.textContent = 'Add New...';
      dropdown.appendChild(addNewOption);
    }

    /**
     * Handles spec dropdown change for "Add New..." functionality
     */
    function handleSpecChange(specNum) {
      const dropdown = document.getElementById(`addPartSpec${specNum}`);
      const customInput = document.getElementById(`addPartSpec${specNum}Custom`);

      if (dropdown.value === '__ADD_NEW__') {
        dropdown.style.display = 'none';
        customInput.style.display = 'block';
        customInput.focus();
        customInput.required = dropdown.hasAttribute('required');
      }
    }

    /**
     * Collects spec values from form (either dropdown or custom input)
     */
    function collectSpecValues() {
      const specs = {};
      for (let i = 1; i <= 4; i++) {
        const dropdown = document.getElementById(`addPartSpec${i}`);
        const customInput = document.getElementById(`addPartSpec${i}Custom`);

        if (customInput && customInput.style.display !== 'none' && customInput.value) {
          specs[`spec${i}`] = customInput.value.trim();
        } else if (dropdown && dropdown.value && dropdown.value !== '__ADD_NEW__') {
          specs[`spec${i}`] = dropdown.value;
        } else {
          specs[`spec${i}`] = '-';
        }
      }
      return specs;
    }

    /**
     * Validates the access password
     */
    function validatePassword() {
      const password = document.getElementById('accessPassword').value;

      if (!password) {
        alert('Please enter a password');
        return;
      }

      showLoading('addPart', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('addPart', false);
          if (result.isValid) {
            isFormUnlocked = true;
            document.querySelector('.password-section').style.display = 'none';
            document.getElementById('addPartFormContainer').style.display = 'block';
            showAlert('addPart', 'success', 'Access granted. You can now add parts to the directory.');
            setTimeout(() => hideAlert('addPart'), 3000);
          } else {
            showAlert('addPart', 'error', 'Invalid password. Access denied.');
          }
        })
        .withFailureHandler(function(error) {
          showLoading('addPart', false);
          showAlert('addPart', 'error', 'Failed to validate password: ' + error.message);
        })
        .validateAccess(password);
    }

    /**
     * Submits a new part
     */
    function submitNewPart() {
      if (!isFormUnlocked) {
        showAlert('addPart', 'error', 'Please unlock the form first');
        return;
      }

      // Collect spec values
      const specValues = collectSpecValues();

      const partData = {
        category: document.getElementById('addCategory').value,
        subcategory: document.getElementById('addSubcategory').value,
        partName: document.getElementById('addPartName').value,
        productCode: document.getElementById('addProductCode').value.trim(),
        spec1: specValues.spec1,
        spec2: specValues.spec2,
        spec3: specValues.spec3,
        spec4: specValues.spec4,
        quantity: document.getElementById('addQuantity').value,
        unitCost: document.getElementById('addUnitCost').value,
        storageLocation: document.getElementById('addStorageLocation').value,
        supplier: document.getElementById('addSupplier').value,
        supplierPartNumber: document.getElementById('addSupplierPartNumber').value,
        notes: document.getElementById('addNotes').value
      };

      // Validate required fields
      if (!partData.category || !partData.subcategory || !partData.partName) {
        showAlert('addPart', 'warning', 'Please fill in all required fields');
        return;
      }

      // Validate required specs
      if (addPartSpecConfig) {
        for (let i = 1; i <= 4; i++) {
          const requiredKey = `spec${i}Required`;
          const labelKey = `spec${i}Label`;
          const specValue = partData[`spec${i}`];

          if (addPartSpecConfig[requiredKey] === 'Y' && (!specValue || specValue === '-')) {
            const label = addPartSpecConfig[labelKey];
            showAlert('addPart', 'warning', `Error: ${label} is required`);
            return;
          }
        }
      }

      if (!confirm('Add this part to the directory?')) {
        return;
      }

      showLoading('addPart', true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading('addPart', false);
          if (result.success) {
            showAlert('addPart', 'success', result.message);
            resetAddPartForm();
          } else {
            if (result.isDuplicate) {
              showAlert('addPart', 'warning', result.message);
            } else {
              showAlert('addPart', 'error', result.message);
            }
          }
        })
        .withFailureHandler(function(error) {
          showLoading('addPart', false);
          showAlert('addPart', 'error', 'Failed to add part: ' + error.message);
        })
        .submitNewPartRequest(partData);
    }

    /**
     * Resets the add part form
     */
    function resetAddPartForm() {
      document.getElementById('addPartForm').reset();
      document.getElementById('addSubcategory').disabled = true;
      document.getElementById('addSubcategory').innerHTML = '<option value="">Select category first...</option>';
      clearDynamicSpecFields();
    }

    /**
     * Shows an alert message
     */
    function showAlert(section, type, message) {
      const alertDiv = document.getElementById(section + 'Alert');
      alertDiv.className = 'alert alert-' + type + ' show';
      alertDiv.textContent = message;
    }

    /**
     * Hides an alert message
     */
    function hideAlert(section) {
      const alertDiv = document.getElementById(section + 'Alert');
      alertDiv.classList.remove('show');
    }

    /**
     * Shows/hides loading indicator
     */
    function showLoading(section, show, message) {
      const loadingDiv = document.getElementById(section + 'Loading');
      const loadingText = document.getElementById(section + 'LoadingText');

      if (show) {
        loadingDiv.classList.add('show');
        if (message && loadingText) {
          loadingText.textContent = message;
        }
      } else {
        loadingDiv.classList.remove('show');
        // Reset to default message
        if (loadingText) {
          loadingText.textContent = 'Loading parts catalog...';
        }
      }
    }
  </script>
</body>
</html>
