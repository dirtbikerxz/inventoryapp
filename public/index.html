<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Venom Parts</title>
  <link rel="icon" type="image/png" href="/branding/logo.png" />
  <style>
    @font-face {
      font-family: 'Nasalization';
      src: url('/branding/Nasalization.ttf') format('truetype');
      font-display: swap;
    }
    :root {
      color-scheme: dark;
      --purple: #461d7c;
      --gold: #fdd023;
      --bg: radial-gradient(circle at top, rgba(70, 29, 124, 0.18), transparent 55%), #141414;
      --panel: rgba(34, 34, 34, 0.92);
      --panel-2: rgba(34, 34, 34, 0.98);
      --accent: #461d7c;
      --accent-2: #fdd023;
      --text: #f2f4f8;
      --muted: #c8c1dd;
      --border: rgba(253, 208, 35, 0.25);
      --danger: #ff5565;
      --success: #4ad28f;
      --warning: var(--gold);
      --card-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    h1, h2, h3, h4, .brand, .page-title { font-family: 'Nasalization', 'Inter', system-ui, sans-serif; letter-spacing: 0.4px; }
    a { color: inherit; text-decoration: none; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: linear-gradient(120deg, rgba(34,34,34,0.95), rgba(40,30,60,0.95));
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .brand {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--gold);
      text-shadow: 0 2px 10px rgba(253,208,35,0.2);
    }
    .brand img { height: 36px; width: 36px; border-radius: 50%; object-fit: contain; }
    .brand-text { display:flex; flex-direction:column; line-height:1.15; gap: 3px; }
    .brand-title { font-size: 22px; font-family:'Nasalization', 'Inter', sans-serif; font-weight: 700; }
    .brand-subtitle { font-size: 12px; font-weight: 500; letter-spacing: 0.5px; color: var(--gold); text-transform: uppercase; }
    .search {
      flex: 1;
      max-width: 400px;
      margin: 0 16px;
      position: relative;
    }
    .search input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
    }
    .toolbar {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    .toolbar-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn {
      border: 1px solid var(--border);
      background: var(--accent);
      color: var(--gold);
      border-radius: 12px;
      padding: 9px 14px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 30px rgba(70, 29, 124, 0.25); }
    .btn.primary {
      background: var(--gold);
      color: #1a1000;
      border-color: var(--gold);
      box-shadow: 0 12px 28px rgba(253,208,35,0.25);
    }
    .btn.ghost {
      background: transparent;
      color: var(--text);
    }
    main { padding: 24px; }
    .page-title { font-size: 32px; font-weight: 800; margin: 0 0 4px; color: var(--gold); }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .view-toggle {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--panel);
    }
    .view-toggle button {
      border: none;
      background: transparent;
      color: #f7f8fb;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      min-width: 100px;
    }
    .view-toggle button.active {
      background: var(--accent);
      color: #f7f8fb;
    }
    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    /* Board */
    .board {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      margin-top: 16px;
    }
    .column {
      background: var(--panel-2);
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 12px;
      min-height: 300px;
      position: relative;
    }
    .column h3 {
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
    }
    .pill {
      background: #1f2a44;
      color: var(--text);
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
    }
    .board-drop {
      min-height: 320px;
      padding-bottom: 60px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      cursor: grab;
      transition: transform 0.1s ease, border-color 0.1s ease, box-shadow 0.15s ease;
    }
    .card:hover { border-color: var(--gold); box-shadow: 0 10px 28px rgba(253,208,35,0.2); }
    .card h4 { margin: 0 0 6px; font-size: 15px; }
    .meta {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1b2440;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .tag.supplier { background: rgba(79,180,255,0.12); color: var(--accent-2); }
    .tag.priority { background: rgba(248,197,82,0.16); color: var(--gold); }
    .tag.group { background: rgba(74,210,143,0.16); color: var(--success); }
    .tag.tracking { background: rgba(79,180,255,0.14); color: var(--accent-2); cursor: pointer; }
    .tag.tracking.pending { background: rgba(255,85,101,0.18); color: #ff8b95; border-color: rgba(255,85,101,0.5); }
    .tag.tracking.intransit { background: rgba(79,180,255,0.18); color: #9bd0ff; border-color: rgba(79,180,255,0.5); }
    .tag.tracking.delivered { background: rgba(74,210,143,0.2); color: #7be0b4; border-color: rgba(74,210,143,0.5); }
    .tag.tracking.unknown { background: rgba(200,193,221,0.18); color: #d1cbe2; border-color: rgba(200,193,221,0.5); }
    .tracking-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tracking-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tracking-row select { min-width:120px; }
    .tracking-list { display:flex; flex-direction:column; gap:6px; }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .checkbox {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
    }
    .card.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(79,180,255,0.25); }
    /* Table */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .input {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      width: 100%;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 13px;
    }
    th { color: var(--muted); font-weight: 600; }
    tr:hover td { background: rgba(79,180,255,0.05); }
    .status-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .status-Requested { background: rgba(253,208,35,0.18); color: var(--gold); }
    .status-Ordered { background: rgba(253,208,35,0.28); color: #1f1a00; }
    .status-Received { background: rgba(74,210,143,0.16); color: var(--success); }
    .status-Cancelled { background: rgba(255,85,101,0.16); color: var(--danger); }
    .selection-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
      margin: 12px 0;
    }
    .input-inline {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--text);
    }
    .small { font-size: 12px; color: var(--muted); }
    select { max-width: 100%; }
    select option { white-space: normal; }
    .empty {
      border: 1px dashed var(--border);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
      background: var(--panel-2);
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="/branding/logo.png" alt="Venom Parts logo" />
      <div class="brand-text">
        <span class="brand-title">Venom Parts</span>
        <span class="brand-subtitle">FRC 8044 - Parts Ordering System</span>
      </div>
    </div>
    <div class="search">
      <input id="global-search" placeholder="Search parts, students, suppliers..." />
    </div>
    <div class="toolbar">
      <div class="toolbar-buttons">
        <div id="user-chip" class="pill" style="background: var(--panel); border:1px solid var(--border);"></div>
        <button class="btn ghost" id="login-btn">Login</button>
        <button class="btn ghost" id="logout-btn" style="display:none;">Logout</button>
        <button class="btn ghost" id="account-btn">Account</button>
        <button class="btn ghost" id="admin-btn" style="display:none;">Admin</button>
        <button class="btn ghost" id="refresh-btn">Refresh</button>
        <button class="btn primary" id="new-order-btn">New order</button>
      </div>
      <div id="tracking-updated" class="small" style="color: var(--muted);"></div>
    </div>
  </header>

  <main>
    <div class="flex-between">
      <div>
        <div class="page-title">Orders</div>
        <div class="subtitle">Track parts from request to delivery.</div>
      </div>
      <div class="view-toggle">
        <button id="board-view-btn" class="active">Board</button>
        <button id="table-view-btn">Table</button>
      </div>
    </div>

    <div id="selection-bar" class="selection-bar">
      <div style="display:flex; flex-direction:column; gap:4px; min-width:180px;">
        <div id="selection-count"></div>
        <div id="group-vendor-note" class="small">Vendor: auto from selection</div>
      </div>
      <div class="flex-between selection-actions" style="gap:8px;">
        <button class="btn primary" id="group-btn">Create group</button>
        <button class="btn ghost" id="delete-selected" style="color: var(--danger);">Delete selected</button>
      </div>
    </div>

    <section id="board-section">
      <div class="board" id="board"></div>
    </section>

    <section id="table-section" style="display:none;">
      <div class="filters">
        <div><label class="small">Start date</label><input id="start-date" class="input" type="date" /></div>
        <div><label class="small">End date</label><input id="end-date" class="input" type="date" /></div>
        <div><label class="small">Status</label><select id="status-filter" class="input"></select></div>
        <div><label class="small">Vendor</label><select id="vendor-filter" class="input"></select></div>
      </div>
      <div id="table-container"></div>
    </section>
  </main>

  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:50; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">New Order</div>
          <div class="subtitle" style="margin-bottom:12px;">Provide a vendor link or part number. We’ll fetch details when supported; otherwise enter manually.</div>
        </div>
        <button class="btn ghost" id="close-modal">Close</button>
      </div>
      <form id="order-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:12px;">
        <div>
          <label class="small">Vendor</label>
          <input name="vendor" class="input" placeholder="WCP, AM, McMaster, DigiKey..." />
        </div>
        <div>
          <label class="small">Product number</label>
          <input name="vendorPartNumber" class="input" placeholder="e.g., WCP-0921" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Product link</label>
          <input name="partLink" class="input" placeholder="https://vendor.com/product/..." />
        </div>
        <div style="grid-column: span 2;">
          <button type="button" class="btn primary" id="fetch-product">Fetch details</button>
          <span class="small">Supported vendors: WCP (beta). Others: fill manually.</span>
        </div>
        <div>
          <label class="small">Part name</label>
          <input name="partName" class="input" required />
        </div>
        <div>
          <label class="small">Unit price</label>
          <input name="unitCost" class="input" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label class="small">Quantity</label>
          <input name="quantityRequested" class="input" type="number" min="1" value="1" required />
        </div>
        <div>
          <label class="small">Priority</label>
          <select name="priority" class="input">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tracking numbers</label>
          <div id="order-tracking-list" class="tracking-list"></div>
          <div class="flex-between" style="margin-top:6px; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn ghost" id="add-order-tracking" style="padding:6px 10px;">Add tracking</button>
            <div class="small">Add one or more tracking numbers with carrier.</div>
          </div>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea name="notes" class="input" rows="3" placeholder="Justification, sizing details, links, etc."></textarea>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="order-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-order">Cancel</button>
            <button type="submit" class="btn primary">Submit order</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="group-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:55; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:520px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Edit Group</div>
          <div class="subtitle" style="margin-bottom:12px;">Update group title or tracking.</div>
        </div>
        <button class="btn ghost" id="close-group">Close</button>
      </div>
      <form id="group-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Group title</label>
          <input name="title" class="input" placeholder="Vendor - mm/dd/yy" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tracking numbers</label>
          <div id="group-modal-tracking-list" class="tracking-list"></div>
          <button type="button" class="btn ghost" id="add-group-modal-tracking" style="padding:6px 10px; margin-top:4px;">Add tracking</button>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea name="notes" class="input" rows="3" placeholder="Optional notes for this order group"></textarea>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="group-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-group">Cancel</button>
            <button type="submit" class="btn primary">Save group</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="login-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:70; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:420px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:22px;">Sign In</div>
      <div class="subtitle" style="margin-bottom:12px;">Use your team-issued account.</div>
      <form id="login-form" class="grid" style="grid-template-columns:1fr; gap:12px;">
        <div>
          <label class="small">Username</label>
          <input name="username" class="input" required />
        </div>
        <div>
          <label class="small">Password</label>
          <input name="password" class="input" type="password" required />
        </div>
        <div class="flex-between">
          <div id="login-message" class="small"></div>
          <button type="submit" class="btn primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <div id="account-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:65; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:500px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:22px;">My Account</div>
      <div class="subtitle" style="margin-bottom:12px;">Update your password.</div>
      <form id="password-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:8px;">
        <div>
          <label class="small">Old password</label>
          <input name="oldPassword" class="input" type="password" required />
        </div>
        <div>
          <label class="small">New password</label>
          <input name="newPassword" class="input" type="password" required />
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="password-message" class="small"></div>
          <button type="submit" class="btn primary">Update password</button>
        </div>
      </form>
    </div>
  </div>

  <div id="admin-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:60; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Admin Panel</div>
          <div class="subtitle" style="margin-bottom:12px;">Manage users and role permissions.</div>
        </div>
        <button class="btn ghost" id="close-admin">Close</button>
      </div>

      <div class="flex-between" style="margin-top:12px; gap:8px;">
        <div class="flex-between" style="gap:6px;">
          <button class="btn ghost" id="admin-tab-users" style="padding:6px 12px;">Users</button>
          <button class="btn ghost" id="admin-tab-tracking" style="padding:6px 12px;">Tracking</button>
          <button class="btn ghost" id="admin-tab-vendors" style="padding:6px 12px;">Vendors</button>
        </div>
      </div>

      <div id="admin-users-section" style="display:block;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
        <div class="page-title" style="font-size:18px;">User Management</div>
        <div id="user-list" class="small" style="margin-top:8px;">Loading users...</div>
        <form id="user-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:10px;">
          <input type="hidden" name="id" />
          <div>
            <label class="small">Username</label>
            <input name="username" class="input" required />
          </div>
          <div>
            <label class="small">Name</label>
            <input name="name" class="input" required />
          </div>
          <div>
            <label class="small">Role</label>
            <select name="role" class="input">
              <option>admin</option>
              <option>mentor</option>
              <option>student</option>
            </select>
          </div>
          <div>
            <label class="small">Password (set/reset)</label>
            <input name="password" class="input" type="password" placeholder="Leave blank to keep existing" />
          </div>
          <div>
            <label class="small">Active</label>
            <select name="active" class="input">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
            <div id="user-message" class="small"></div>
            <div class="flex-between" style="gap:8px;">
              <button type="button" class="btn ghost" id="clear-user">Clear</button>
              <button type="submit" class="btn primary">Save user</button>
            </div>
          </div>
        </form>
      </div>

      <div class="card" style="background:var(--panel-2); margin-top:12px;">
        <div class="page-title" style="font-size:18px;">Role Permissions</div>
        <div class="subtitle">Toggle what each role can do.</div>
        <div id="role-list" style="margin-top:8px;"></div>
      </div>
      </div>

      <div id="admin-tracking-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
        <div class="page-title" style="font-size:18px;">Tracking Settings</div>
        <div class="subtitle">Carrier API keys, refresh cadence, and manual refresh.</div>
        <form id="tracking-settings-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:10px;">
          <div>
            <label class="small">UPS Client ID</label>
            <input name="upsClientId" class="input" placeholder="UPS OAuth client id" />
          </div>
          <div>
            <label class="small">UPS Client Secret</label>
            <input name="upsClientSecret" class="input" placeholder="UPS OAuth client secret" />
          </div>
          <div>
            <label class="small">USPS User ID</label>
            <input name="uspsUserId" class="input" placeholder="USPS WebTools user id" />
          </div>
          <div>
            <label class="small">FedEx Client ID</label>
            <input name="fedexClientId" class="input" placeholder="FedEx API key" />
          </div>
          <div>
            <label class="small">FedEx Client Secret</label>
            <input name="fedexClientSecret" class="input" placeholder="FedEx API secret" />
          </div>
          <div>
            <label class="small">Tracking Refresh Interval (minutes)</label>
            <input name="refreshMinutes" class="input" type="number" min="1" value="30" />
          </div>
        </form>
        <div class="flex-between" style="grid-column: span 2; margin-top:8px; flex-wrap:wrap; gap:8px;">
          <div id="tracking-settings-message" class="small"></div>
          <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn ghost" id="refresh-tracking-now">Manual refresh</button>
            <button type="submit" form="tracking-settings-form" class="btn primary">Save settings</button>
          </div>
        </div>
      </div>
      </div>

      <div id="admin-vendors-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
          <div class="page-title" style="font-size:18px;">Vendor Extraction Settings</div>
          <div class="subtitle" style="margin-bottom:12px;">Configure how to pull product details from each vendor.</div>
          <form id="vendor-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px;">
            <input type="hidden" name="id" />
            <div>
              <label class="small">Vendor name</label>
              <input name="vendor" class="input" placeholder="e.g., WCP" required />
            </div>
            <div>
              <label class="small">Base URL</label>
              <input name="baseUrl" class="input" placeholder="https://wcproducts.com" />
            </div>
            <div>
              <label class="small">Product URL template</label>
              <input name="productUrlTemplate" class="input" placeholder="https://wcproducts.com/products/{partNumber}" />
              <div class="small">Use {partNumber} where the SKU goes, e.g. https://vendor.com/products/{partNumber}</div>
            </div>
            <div>
              <label class="small">Part # example</label>
              <input name="partNumberExample" class="input" placeholder="WCP-0921" />
            </div>
            <div>
              <label class="small">Part # regex</label>
              <input name="partNumberPattern" class="input" placeholder="^WCP-\\d+$" />
              <div class="small">Auto-filled from example; edit to tighten/loosen validation.</div>
            </div>
            <div>
              <label class="small">Name selector</label>
              <input name="nameSelector" class="input" placeholder=".product-title" />
            </div>
            <div>
              <label class="small">Price selector</label>
              <input name="priceSelector" class="input" placeholder=".price" />
            </div>
            <div style="grid-column: span 2;">
              <label class="small">Paste copied selector or JS path</label>
              <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px;">
                <textarea id="selector-snippet" class="input" rows="2" placeholder="Right-click → Copy selector or Copy JS path"></textarea>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap:6px;">
                  <select id="selector-target" class="input">
                    <option value="nameSelector">Apply to Name</option>
                    <option value="priceSelector">Apply to Price</option>
                  </select>
                  <button type="button" class="btn ghost" id="apply-selector">Apply</button>
                </div>
              </div>
              <div class="small">Tip: Use “Copy selector” or “Copy JS path” from DevTools.</div>
            </div>
            <div style="grid-column: span 2;">
              <label class="small">Notes / headers JSON (optional)</label>
              <textarea name="notes" class="input" rows="2" placeholder="Headers: {\"User-Agent\":\"...\"}"></textarea>
            </div>
            <div style="grid-column: span 2;">
              <div class="small" style="margin-bottom:6px;">Test extraction (paste a product URL)</div>
              <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:8px;">
                <input id="test-url" class="input" placeholder="https://vendor.com/product/123" />
                <button type="button" class="btn primary" id="test-extract">Test</button>
              </div>
              <div id="extract-results" class="small" style="margin-top:8px;"></div>
              <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px;">
                <div>
                  <label class="small">Pick name</label>
                  <select id="pick-name" class="input"></select>
                  <div id="preview-name" class="small"></div>
                </div>
                <div>
                  <label class="small">Pick price</label>
                  <select id="pick-price" class="input"></select>
                  <div id="preview-price" class="small"></div>
                </div>
              </div>
            </div>
            <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
              <div id="vendor-message" class="small"></div>
              <div class="flex-between" style="gap:8px;">
                <button type="button" class="btn ghost" id="clear-vendor">Clear</button>
                <button type="submit" class="btn primary">Save vendor</button>
              </div>
            </div>
          </form>
        </div>
        <div id="vendor-list" style="margin-top:14px;"></div>
      </div>
    </div>
  </div>

  <script>
    const boardEl = document.getElementById('board');
    const boardBtn = document.getElementById('board-view-btn');
    const tableBtn = document.getElementById('table-view-btn');
    const boardSection = document.getElementById('board-section');
    const tableSection = document.getElementById('table-section');
    const refreshBtn = document.getElementById('refresh-btn');
    const globalSearch = document.getElementById('global-search');
    const statusFilter = document.getElementById('status-filter');
    const vendorFilter = document.getElementById('vendor-filter');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const tableContainer = document.getElementById('table-container');
    const selectionBar = document.getElementById('selection-bar');
    const selectionCount = document.getElementById('selection-count');
    const groupBtn = document.getElementById('group-btn');
    const groupVendorNote = document.getElementById('group-vendor-note');
    const deleteSelectedBtn = document.getElementById('delete-selected');
    const undoBtn = document.createElement('button');
    undoBtn.className = 'btn ghost';
    undoBtn.id = 'undo-btn';
    undoBtn.textContent = 'Undo';
    const redoBtn = document.createElement('button');
    redoBtn.className = 'btn ghost';
    redoBtn.id = 'redo-btn';
    redoBtn.textContent = 'Redo';
    const selectionControls = selectionBar.querySelector('.selection-actions');
    if (selectionControls) {
      selectionControls.appendChild(undoBtn);
      selectionControls.appendChild(redoBtn);
    }
    const boardMessage = document.createElement('div');
    boardMessage.id = 'board-message';
    boardMessage.style.position = 'fixed';
    boardMessage.style.right = '16px';
    boardMessage.style.bottom = '16px';
    boardMessage.style.background = 'var(--panel)';
    boardMessage.style.border = '1px solid var(--border)';
    boardMessage.style.padding = '10px 14px';
    boardMessage.style.borderRadius = '10px';
    boardMessage.style.boxShadow = 'var(--card-shadow)';
    boardMessage.style.display = 'none';
    boardMessage.style.zIndex = '80';
    document.body.appendChild(boardMessage);
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('close-modal');
    const cancelOrder = document.getElementById('cancel-order');
    const orderForm = document.getElementById('order-form');
    const orderTrackingList = document.getElementById('order-tracking-list');
    const addOrderTracking = document.getElementById('add-order-tracking');
    const orderMessage = document.getElementById('order-message');
    const fetchProduct = document.getElementById('fetch-product');
    const newOrderBtn = document.getElementById('new-order-btn');
    const adminBtn = document.getElementById('admin-btn');
    const adminModal = document.getElementById('admin-modal');
    const closeAdmin = document.getElementById('close-admin');
    const accountBtn = document.getElementById('account-btn');
    const accountModal = document.getElementById('account-modal');
    const groupModal = document.getElementById('group-modal');
    const closeGroup = document.getElementById('close-group');
    const cancelGroup = document.getElementById('cancel-group');
    const groupForm = document.getElementById('group-form');
    const groupModalTrackingList = document.getElementById('group-modal-tracking-list');
    const addGroupModalTracking = document.getElementById('add-group-modal-tracking');
    const groupMessage = document.getElementById('group-message');
    const vendorForm = document.getElementById('vendor-form');
    const vendorMessage = document.getElementById('vendor-message');
    const clearVendor = document.getElementById('clear-vendor');
    const vendorList = document.getElementById('vendor-list');
    const testUrl = document.getElementById('test-url');
    const testExtract = document.getElementById('test-extract');
    const pickName = document.getElementById('pick-name');
    const pickPrice = document.getElementById('pick-price');
    const previewName = document.getElementById('preview-name');
    const previewPrice = document.getElementById('preview-price');
    const selectorSnippet = document.getElementById('selector-snippet');
    const selectorTarget = document.getElementById('selector-target');
    const applySelector = document.getElementById('apply-selector');
    const partExample = vendorForm.elements.partNumberExample;
    const partPattern = vendorForm.elements.partNumberPattern;
    let editingOrderId = null;
    let editingGroupId = null;
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('login-form');
    const loginMessage = document.getElementById('login-message');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userChip = document.getElementById('user-chip');
    const userList = document.getElementById('user-list');
    const userForm = document.getElementById('user-form');
    const userMessage = document.getElementById('user-message');
    const clearUser = document.getElementById('clear-user');
    const passwordForm = document.getElementById('password-form');
    const passwordMessage = document.getElementById('password-message');
    const roleList = document.getElementById('role-list');
    const trackingSettingsForm = document.getElementById('tracking-settings-form');
    const trackingSettingsMessage = document.getElementById('tracking-settings-message');
    const refreshTrackingNow = document.getElementById('refresh-tracking-now');
    const adminTabUsers = document.getElementById('admin-tab-users');
    const adminTabTracking = document.getElementById('admin-tab-tracking');
    const adminTabVendors = document.getElementById('admin-tab-vendors');
    const adminUsersSection = document.getElementById('admin-users-section');
    const adminTrackingSection = document.getElementById('admin-tracking-section');
    const adminVendorsSection = document.getElementById('admin-vendors-section');
    let vendorConfigs = [];
    let currentUser = null;
    function detectVendor(partNum, link) {
      if (!vendorConfigs?.length) return null;
      const candidates = vendorConfigs.filter(v => {
        const regex = v.partNumberPattern ? new RegExp(v.partNumberPattern) : null;
        const baseMatch = v.baseUrl && link && link.toLowerCase().includes(v.baseUrl.toLowerCase());
        const patternMatch = regex && partNum && regex.test(partNum);
        return baseMatch || patternMatch;
      });
      if (candidates.length === 1) return candidates[0];
      return null;
    }

    const statuses = [
      { label: 'To order', status: 'Requested', hint: 'Parts requests - awaiting purchase' },
      { label: 'Ordered', status: 'Ordered', hint: 'Placed orders - awaiting arrival' },
      { label: 'Arrived', status: 'Received', hint: 'Items received' }
    ];
    const carrierOptions = [
      { value: 'ups', label: 'UPS' },
      { value: 'usps', label: 'USPS' },
      { value: 'fedex', label: 'FedEx' },
      { value: 'other', label: 'Other/Unknown' }
    ];

    const DEFAULT_TRACKING_POLL_MINUTES = 1;
    let trackingPollTimer = null;
    let trackingPollMinutes = DEFAULT_TRACKING_POLL_MINUTES;
    function startTrackingAutoRefresh(minutes = trackingPollMinutes) {
      const next = Math.max(1, Number(minutes) || DEFAULT_TRACKING_POLL_MINUTES);
      trackingPollMinutes = next;
      const ms = next * 60 * 1000;
      if (trackingPollTimer) clearInterval(trackingPollTimer);
      trackingPollTimer = setInterval(() => {
        if (!currentUser) return;
        fetchOrders();
      }, ms);
    }

    const emptyParts = [];
    setTrackingRows(orderTrackingList, [], emptyParts);
    setTrackingRows(groupModalTrackingList, [], emptyParts);
    addOrderTracking?.addEventListener('click', () => createTrackingRow(orderTrackingList, {}, emptyParts));
    addGroupModalTracking?.addEventListener('click', () => createTrackingRow(groupModalTrackingList, {}, emptyParts));

    let orders = [];
    let selected = new Set();
    let expandedGroups = new Set();
    const undoStack = [];
    const redoStack = [];

    function updateUndoRedoUI() {
      if (undoBtn) undoBtn.disabled = undoStack.length === 0;
      if (redoBtn) redoBtn.disabled = redoStack.length === 0;
    }

    function recordAction(record) {
      undoStack.push(record);
      redoStack.length = 0;
      updateUndoRedoUI();
    }
    function getOrderById(id) {
      return orders.find(o => o._id === id);
    }
    function getOrderVendor(order) {
      return (order?.supplier || order?.vendor || '').toLowerCase();
    }
    function snapshotOrder(id) {
      return orders.find(o => o._id === id);
    }
    function sanitizeOrderForCreate(order) {
      if (!order) return null;
      const allowed = [
        'category','csvFileLink','department','fetchedName','fetchedPrice','groupId','justification','notes',
        'partCode','partId','partLink','partName','priority','productCode','quantityRequested','status','studentId',
        'studentName','supplier','supplierLink','totalCost','tracking','trackingNumber','unitCost','vendor','vendorPartNumber','requestedDisplayAt'
      ];
      const clean = {};
      allowed.forEach(k => {
        if (order[k] !== undefined) clean[k] = order[k];
      });
      if (order.requestedAt && !clean.requestedDisplayAt) clean.requestedDisplayAt = order.requestedAt;
      if (Array.isArray(clean.tracking)) {
        clean.tracking = clean.tracking.map(t => {
          const { carrier, trackingNumber, status, eta, trackingUrl, lastCheckedAt, lastUpdated, lastEvent, delivered } = t || {};
          if (!trackingNumber) return null;
          return { carrier: carrier || 'other', trackingNumber, status, eta, trackingUrl, lastCheckedAt, lastUpdated, lastEvent, delivered };
        }).filter(Boolean);
      }
      clean.quantityRequested = Number(clean.quantityRequested || 1);
      clean.unitCost = clean.unitCost !== undefined ? Number(clean.unitCost) : clean.unitCost;
      clean.totalCost = clean.totalCost !== undefined ? Number(clean.totalCost) : clean.totalCost;
      if (!clean.partName) clean.partName = 'Restored order';
      clean.studentName = clean.studentName || 'Restored';
      clean.status = clean.status || 'Requested';
      return clean;
    }

    async function applyStep(step, counterpart) {
      switch (step.type) {
        case 'deleteOrder': {
          await fetch(`/api/orders/${step.payload.orderId}`, { method: 'DELETE' });
          break;
        }
        case 'restoreOrder': {
          const o = sanitizeOrderForCreate(step.payload.order);
          if (!o) break;
          if (step.payload.order?.requestedDisplayAt || step.payload.order?.requestedAt) {
            o.requestedDisplayAt = step.payload.order.requestedDisplayAt || step.payload.order.requestedAt;
          }
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...o,
              groupId: undefined // will reassign after
            })
          });
          const data = await res.json();
          const newId = data.order?.orderId || data.orderId || data.order?._id;
          if (step.payload.groupId && newId) {
            await assignGroup(newId, step.payload.groupId);
          }
          if (counterpart && counterpart.type === 'deleteOrder') {
            counterpart.payload.orderId = newId;
          }
          break;
        }
        case 'updateOrder': {
          await fetch(`/api/orders/${step.payload.orderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(step.payload.data)
          });
          break;
        }
        case 'updateStatus': {
          await patchStatusOnly(step.payload.orderId, step.payload.status, step.payload.trackingNumber);
          if (step.payload.groupId !== undefined) {
            await assignGroup(step.payload.orderId, step.payload.groupId);
          }
          break;
        }
        case 'assignGroup': {
          await assignGroup(step.payload.orderId, step.payload.groupId);
          break;
        }
        case 'createGroup': {
          const res = await fetch('/api/order-groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title: step.payload.title,
              supplier: step.payload.supplier,
              orderIds: step.payload.orderIds
            })
          });
          const data = await res.json();
          const newGroupId = data.groupId || data._id;
          if (counterpart && counterpart.type === 'deleteGroup') {
            counterpart.payload.groupId = newGroupId;
          }
          break;
        }
        case 'deleteGroup': {
          await fetch(`/api/order-groups/${step.payload.groupId}`, { method: 'DELETE' });
          break;
        }
        case 'updateGroup': {
          await fetch(`/api/order-groups/${step.payload.groupId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(step.payload.data)
          });
          break;
        }
        default:
          break;
      }
    }

    async function doUndo() {
      const record = undoStack.pop();
      if (!record) return;
      await applyStep(record.undo, record.redo);
      redoStack.push(record);
      updateUndoRedoUI();
      await fetchOrders();
    }

    async function doRedo() {
      const record = redoStack.pop();
      if (!record) return;
      await applyStep(record.redo, record.undo);
      undoStack.push(record);
      updateUndoRedoUI();
      await fetchOrders();
    }

    function fmtDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleString();
    }
    function formatShortDate(date = new Date()) {
      return `${date.getMonth() + 1}/${date.getDate()}/${String(date.getFullYear()).slice(-2)}`;
    }
    function formatDateOnly(input) {
      if (!input) return '';
      // If we get an ISO-ish string, parse the date portion explicitly to avoid TZ shifts.
      if (typeof input === 'string') {
        const match = input.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          const y = Number(match[1]);
          const m = Number(match[2]);
          const d = Number(match[3]);
          if (y && m && d) return `${m}/${d}/${String(y).slice(-2)}`;
        }
      }
      const date = new Date(input);
      if (Number.isNaN(date.getTime())) return '';
      // Use UTC components to avoid local TZ shifting ETA dates.
      const m = date.getUTCMonth() + 1;
      const d = date.getUTCDate();
      const y = String(date.getUTCFullYear()).slice(-2);
      return `${m}/${d}/${y}`;
    }
    function formatDateMaybe(value) {
      if (!value) return '';
      if (typeof value === 'number') return formatDateOnly(value);
      const parsed = Date.parse(value);
      if (!Number.isNaN(parsed)) return formatDateOnly(parsed);
      return value;
    }
    function escapeHtml(str = '') {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function createTrackingRow(container, data = {}, partsOptions = []) {
      if (!container) return;
      const row = document.createElement('div');
      row.className = 'tracking-row';
      row.innerHTML = `
        <select class="input tracking-carrier">
          ${carrierOptions.map(c => `<option value="${c.value}">${c.label}</option>`).join('')}
        </select>
        <input class="input tracking-number" placeholder="Tracking number" value="${data.trackingNumber || data.number || ''}" />
        <button type="button" class="btn ghost remove-tracking" style="padding:6px 10px;">Remove</button>
        <div class="small" style="width:100%;">Parts in this shipment (optional)</div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px; width:100%;">
          <select class="input tracking-parts" multiple size="${Math.min(Math.max(partsOptions.length, 2), 6)}">
            ${partsOptions.map(p => `<option value="${p.id}">${escapeHtml(p.label)}</option>`).join('')}
          </select>
          <button type="button" class="btn ghost select-all-parts" style="padding:6px 10px;">Select all</button>
        </div>
      `;
      const select = row.querySelector('.tracking-carrier');
      const carrier = (data.carrier || '').toLowerCase();
      if (carrier) select.value = carrier;
      row.querySelector('.remove-tracking').addEventListener('click', () => {
        row.remove();
        if (!container.querySelector('.tracking-row')) {
          createTrackingRow(container, {}, partsOptions);
        }
      });
      const partsSelect = row.querySelector('.tracking-parts');
      const selectAllBtn = row.querySelector('.select-all-parts');
      if (partsSelect && Array.isArray(data.parts)) {
        Array.from(partsSelect.options).forEach(opt => {
          if (data.parts.includes(opt.value)) opt.selected = true;
        });
      }
      selectAllBtn?.addEventListener('click', () => {
        Array.from(partsSelect.options).forEach(opt => { opt.selected = true; });
      });
      container.appendChild(row);
    }

    function setTrackingRows(container, entries = [], partsOptions = []) {
      if (!container) return;
      container.innerHTML = '';
      const list = Array.isArray(entries) && entries.length ? entries : [];
      if (!list.length) {
        createTrackingRow(container, {}, partsOptions);
        return;
      }
      list.forEach(entry => createTrackingRow(container, entry, partsOptions));
    }

    function collectTrackingRows(container) {
      if (!container) return [];
      const rows = Array.from(container.querySelectorAll('.tracking-row'));
      return rows.map(row => {
        const number = row.querySelector('.tracking-number')?.value.trim();
        const carrier = row.querySelector('.tracking-carrier')?.value || 'other';
        if (!number) return null;
        const partsSel = row.querySelector('.tracking-parts');
        const parts = partsSel ? Array.from(partsSel.selectedOptions).map(o => o.value) : undefined;
        return { carrier, trackingNumber: number, parts: parts && parts.length ? parts : undefined };
      }).filter(Boolean);
    }

    function trackingFromOrder(order) {
      if (!order) return [];
      if (Array.isArray(order.tracking) && order.tracking.length) return order.tracking;
      if (order.trackingNumber) return [{ carrier: order.carrier || 'unknown', trackingNumber: order.trackingNumber }];
      return [];
    }

    function trackingLink(carrier, num, fallback) {
      if (fallback) return fallback;
      if (!num) return '';
      const c = (carrier || '').toLowerCase();
      if (c === 'ups') return `https://www.ups.com/track?tracknum=${encodeURIComponent(num)}`;
      if (c === 'usps') return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${encodeURIComponent(num)}`;
      if (c === 'fedex') return `https://www.fedex.com/fedextrack/?tracknumbers=${encodeURIComponent(num)}`;
      return '';
    }

    function attachBackdropClose(el, handler) {
      if (!el || typeof handler !== 'function') return;
      let downOnBackdrop = false;
      el.addEventListener('pointerdown', (e) => {
        downOnBackdrop = e.target === el;
      });
      el.addEventListener('pointerup', (e) => {
        if (downOnBackdrop && e.target === el) handler();
        downOnBackdrop = false;
      });
    }

    function trackingPhase(tracking) {
      const carrierSupported = ['ups','usps','fedex'].includes((tracking.carrier || '').toLowerCase());
      if (tracking.delivered || tracking.cache?.delivered) return 'delivered';
      const statusText = (tracking.status || tracking.cache?.status || tracking.cache?.summary || '').toLowerCase();
      if (!carrierSupported) return 'unknown';
      if (/label|pending|ready for shipment|not shipped|waiting|created/i.test(statusText)) return 'pending';
      return 'intransit';
    }

    function renderTrackingBadges(tracking = []) {
      const list = Array.isArray(tracking) ? tracking.filter(t => t && t.trackingNumber) : [];
      if (!list.length) return '';
      return `<div class="tracking-badges">${
        list.map(t => {
          const url = trackingLink(t.carrier, t.trackingNumber, t.trackingUrl || t.cache?.trackingUrl);
          const label = `${(t.carrier || 'TRACK').toUpperCase()} ${t.trackingNumber}`;
          const status = t.cache?.status || t.cache?.summary || t.status || '';
          const delivered = Boolean(t.cache?.delivered);
          const deliveredOn = delivered
            ? (t.cache?.lastEventTime || t.cache?.deliveredTime || t.deliveredTime || t.lastUpdated || t.lastEvent || t.lastUpdatedAt || t.lastCheckedAt || t.cache?.lastCheckedAt)
            : undefined;
          const etaText = !delivered ? (t.cache?.eta || t.eta) : undefined;
          const subtitleParts = [];
          if (delivered) {
            subtitleParts.push(`Delivered${deliveredOn ? ' on ' + formatDateOnly(deliveredOn) : ''}`);
          } else if (etaText) {
            const etaFmt = formatDateMaybe(etaText);
            subtitleParts.push(`ETA ${etaFmt || etaText}`);
          } else if (status) {
            subtitleParts.push(status);
          } else {
            subtitleParts.push('Refreshing status…');
          }
          const subtitle = subtitleParts.filter(Boolean).join(' · ');
          const safeSubtitle = escapeHtml(subtitle || '');
          const safeLabel = escapeHtml(label || '');
          const phase = trackingPhase(t);
          const badge = `<span class="tag tracking ${phase}" title="${safeSubtitle || 'Open tracking'}">${safeLabel}${subtitle ? ' · ' + safeSubtitle : ''}</span>`;
          return url ? `<a href="${url}" target="_blank" rel="noopener noreferrer">${badge}</a>` : badge;
        }).join('')
      }</div>`;
    }
    function showBoardMessage(text, type = 'info', timeout = 3500) {
      boardMessage.textContent = text;
      boardMessage.style.borderColor = type === 'error' ? 'var(--danger)' : 'var(--border)';
      boardMessage.style.color = type === 'error' ? 'var(--danger)' : 'var(--text)';
      boardMessage.style.display = 'block';
      if (showBoardMessage._t) clearTimeout(showBoardMessage._t);
      showBoardMessage._t = setTimeout(() => { boardMessage.style.display = 'none'; }, timeout);
    }

    function matchesSearch(order, term) {
      if (!term) return true;
      const trackingText = (order.tracking || []).map(t => [t.trackingNumber, t.carrier, t.cache?.status, t.cache?.summary].filter(Boolean).join(' ')).join(' ');
      const groupTrackingText = (order.group?.tracking || []).map(t => [t.trackingNumber, t.carrier, t.cache?.status, t.cache?.summary].filter(Boolean).join(' ')).join(' ');
      const hay = [
        order.partName,
        order.vendorPartNumber,
        order.partLink,
        order.studentName,
        order.supplier,
        order.productCode,
        order.orderNumber,
        order.category,
        order.priority,
        order.group && order.group.title,
        order.group && order.group.trackingNumber,
        trackingText,
        groupTrackingText
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(term.toLowerCase());
    }

    function withinDate(order, start, end) {
      if (!start && !end) return true;
      const ts = order.requestedDisplayAt || order.requestedAt || Date.parse(order.createdAt || '') || 0;
      if (start && ts < start) return false;
      if (end && ts > end) return false;
      return true;
    }

    function filteredOrders() {
      const term = globalSearch.value.trim();
      const s = statusFilter.value;
      const v = vendorFilter.value;
      const start = startDate.value ? Date.parse(startDate.value) : null;
      const end = endDate.value ? Date.parse(endDate.value) + 24*60*60*1000 : null; // inclusive
      return orders.filter(o =>
        matchesSearch(o, term) &&
        (!s || o.status === s) &&
        (!v || (o.supplier || '').toLowerCase() === v.toLowerCase()) &&
        withinDate(o, start, end)
      );
    }

    async function fetchOrders() {
      if (!currentUser) return;
      const res = await fetch('/api/orders');
      const data = await res.json();
      orders = (data.orders || []).map(o => ({
        ...o,
        tracking: o.tracking || [],
        group: o.group ? { ...o.group, tracking: o.group.tracking || [] } : null,
        _id: o._id || o.id || o.orderNumber
      }));
      // Debug tracking payloads for visibility
      console.log('[tracking] orders loaded', orders.map(o => ({
        id: o._id,
        tracking: o.tracking,
        groupTracking: o.group?.tracking
      })));
      const allTracking = [];
      orders.forEach(o => {
        (o.tracking || []).forEach(t => allTracking.push(t));
        (o.group?.tracking || []).forEach(t => allTracking.push(t));
      });
      const lastChecked = allTracking
        .map(t => t.lastCheckedAt || t.cache?.lastCheckedAt || t.cache?.lastEventTime || t.lastUpdated)
        .filter(Boolean)
        .sort((a, b) => b - a)[0];
      const trackingErrors = allTracking
        .map(t => t.cache?.summary || t.cache?.status || t.status)
        .filter(msg => msg && /error|missing|invalid|unauthorized|fail/i.test(msg));
      const trackingUpdatedEl = document.getElementById('tracking-updated');
      if (trackingUpdatedEl) {
        const errText = trackingErrors.length ? ` · Tracking error: ${trackingErrors[0]}` : '';
        trackingUpdatedEl.textContent = (lastChecked ? `Tracking updated ${fmtDate(lastChecked)}` : '') + errText;
      }
      buildFilters();
      renderBoard();
      renderTable();
      updateSelectionBar();
      updateUndoRedoUI();
    }

    function buildFilters() {
      const statusesUnique = Array.from(new Set(orders.map(o => o.status).filter(Boolean)));
      statusFilter.innerHTML = ['<option value="">All statuses</option>', ...statusesUnique.map(s => `<option>${s}</option>`)].join('');
      const vendors = Array.from(new Set(orders.map(o => (o.supplier || '').trim()).filter(Boolean)));
      vendorFilter.innerHTML = ['<option value="">All vendors</option>', ...vendors.map(v => `<option>${v}</option>`)].join('');
    }

    function openEdit(order) {
      editingOrderId = order._id;
      orderForm.elements.vendor.value = order.vendor || order.supplier || '';
      orderForm.elements.vendorPartNumber.value = order.vendorPartNumber || '';
      orderForm.elements.partLink.value = order.partLink || '';
      orderForm.elements.partName.value = order.partName || '';
      orderForm.elements.unitCost.value = order.unitCost || order.fetchedPrice || '';
      orderForm.elements.quantityRequested.value = order.quantityRequested || 1;
      orderForm.elements.priority.value = order.priority || 'Medium';
      setTrackingRows(orderTrackingList, order.group ? [] : trackingFromOrder(order));
      addOrderTracking.disabled = !!order.group;
      orderTrackingList.style.display = order.group ? 'none' : 'block';
      orderMessage.textContent = order.group ? 'Tracking managed at group level.' : '';
      orderForm.elements.notes.value = order.notes || '';
      modal.style.display = 'flex';
    }

    function createCard(order) {
      const card = document.createElement('div');
      card.className = 'card';
      card.draggable = true;
      card.dataset.id = order._id;
      if (selected.has(order._id)) card.classList.add('selected');

      card.innerHTML = `
        <div class="flex-between" style="gap:8px;">
          <div>
            <h4>${order.partName || 'Untitled part'}</h4>
            <div class="meta">Requested by ${order.studentName || 'Unknown'} · ${fmtDate(order.requestedDisplayAt || order.requestedAt)}</div>
          </div>
        </div>
          <div class="meta">
          ${(() => {
            const unit = order.unitCost ?? order.fetchedPrice;
            const qty = order.quantityRequested || 1;
            const total = order.totalCost ?? (unit !== undefined ? Number((unit * qty).toFixed(2)) : undefined);
            return total !== undefined ? '$' + total : (unit !== undefined ? '$'+unit : '');
          })()}
          ${order.quantityRequested ? ' · x' + order.quantityRequested : ''}
        </div>
        <div class="meta" style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-wrap:wrap;">
          <div style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:200px;">
            <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
              ${order.supplier || order.vendor ? `<span class="tag supplier">${order.supplier || order.vendor}</span>` : ''}
              ${order.vendorPartNumber ? `<span class="tag">${order.vendorPartNumber}</span>` : ''}
              ${order.priority ? `<span class="tag priority">${order.priority}</span>` : ''}
              ${order.group ? `<span class="tag group">Group: ${order.group.title || order.group.supplier || 'Grouped'}</span>` : ''}
            </div>
            ${renderTrackingBadges(order.tracking || [])}
          </div>
          <div class="row-actions" style="display:flex; gap:6px; align-self:flex-end;">
            ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="edit" style="padding:4px 8px;">Edit</button>` : ''}
            ${currentUser?.permissions?.canDeleteOrders ? `<button class="btn ghost" data-action="delete" style="padding:4px 8px; color: var(--danger);">Delete</button>` : ''}
          </div>
        </div>
      `;
      card.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        toggleSelect(order._id);
      });

      card.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openEdit(order);
        });
      });

      card.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (!confirm('Delete this order?')) return;
          const snapshot = snapshotOrder(order._id);
          await fetch(`/api/orders/${order._id}`, { method: 'DELETE' });
          if (snapshot) {
            recordAction({
              undo: { type: 'restoreOrder', payload: { order: snapshot, groupId: snapshot.groupId || snapshot.group?._id } },
              redo: { type: 'deleteOrder', payload: { orderId: order._id } }
            });
          }
          fetchOrders();
        });
      });

      card.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', order._id);
        card.style.opacity = '0.6';
      });
      card.addEventListener('dragend', () => { card.style.opacity = '1'; });
      return card;
    }

    function renderBoard() {
      const fo = filteredOrders();
      const groupedByStatus = {};
      const groupMap = {};

      fo.forEach(order => {
        if (order.groupId || order.group?._id) {
          const gid = order.groupId || order.group?._id;
          if (!groupMap[gid]) groupMap[gid] = [];
          groupMap[gid].push(order);
        } else {
          groupedByStatus[order.status] = groupedByStatus[order.status] || [];
          groupedByStatus[order.status].push(order);
        }
      });

      boardEl.innerHTML = '';
      statuses.forEach(col => {
        const column = document.createElement('div');
        column.className = 'column';
        column.dataset.status = col.status;
        column.innerHTML = `
          <h3>${col.label} <span class="pill">${(groupedByStatus[col.status] || []).length + Object.values(groupMap).filter(items => (items[0]?.status === col.status)).length}</span></h3>
          <div class="small" style="margin-bottom:6px;">${col.hint}</div>
          <div class="board-drop"></div>
        `;
        const dropArea = column.querySelector('.board-drop');

        const onDropTarget = async (e) => {
          e.preventDefault();
          dropArea.style.border = 'none';
          const id = e.dataTransfer.getData('text/plain');
          if (!id) return;
          if (id.startsWith('group:')) {
            const gid = id.replace('group:', '');
            updateGroupStatus(gid, col.status);
          } else {
            moveOrderToStatus(id, col.status);
          }
        };
        const onDragOver = (e) => { e.preventDefault(); dropArea.style.border = '1px dashed var(--accent)'; };
        const onDragLeave = () => { dropArea.style.border = 'none'; };

        dropArea.addEventListener('dragover', onDragOver);
        dropArea.addEventListener('dragleave', onDragLeave);
        dropArea.addEventListener('drop', onDropTarget);
        column.addEventListener('dragover', onDragOver);
        column.addEventListener('dragleave', onDragLeave);
        column.addEventListener('drop', onDropTarget);

        (groupedByStatus[col.status] || []).forEach(order => {
          dropArea.appendChild(createCard(order));
        });

        Object.entries(groupMap).forEach(([gid, items]) => {
          const first = items[0];
          const status = first.status;
          if (status !== col.status) return;
          const card = document.createElement('div');
          card.className = 'card';
          card.style.display = 'flex';
          card.style.flexDirection = 'column';
          card.style.gap = '8px';
          card.draggable = true;
          card.dataset.groupId = gid;
          const vendor = first.supplier || first.vendor || '';
          const total = items.reduce((sum, o) => sum + (o.totalCost || 0), 0);
          const trackingList = (first.group?.tracking && first.group.tracking.length ? first.group.tracking : trackingFromOrder(first));
          const groupedAt = first.group?.updatedAt || first.group?.createdAt || Date.now();
          const timePart = new Date(groupedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const groupTitle = first.group?.title || `${vendor || 'Grouped Order'} - ${formatShortDate(new Date(groupedAt))} ${timePart}`;
          card.innerHTML = `
            <div class="flex-between" style="gap:8px;">
              <div>
                <h4>${groupTitle}</h4>
                <div class="meta">Items in order: ${items.length}</div>
              </div>
              <div class="row-actions" style="display:flex; gap:6px;">
                ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="edit-group" style="padding:4px 8px;">Edit</button>` : ''}
                ${currentUser?.permissions?.canDeleteOrders ? `<button class="btn ghost" data-action="delete-group" style="padding:4px 8px; color: var(--danger);">Delete</button>` : ''}
              </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div>${vendor ? `<span class="tag supplier">${vendor}</span>` : ''}</div>
                ${renderTrackingBadges(trackingList)}
              </div>
              <div class="muted" style="min-width:80px; text-align:right; align-self:flex-end;">${total ? '$'+total.toFixed(2) : ''}</div>
            </div>
            <div class="group-items-container" style="margin-top:6px; display:${expandedGroups.has(gid) ? 'block' : 'none'};">
              ${items.map(o => `
                <div class="small group-item" data-id="${o._id}" draggable="true" style="display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; margin-top:4px; flex-wrap:wrap;">
                  <span style="font-weight:700;">${o.partName || ''}</span>
                  ${o.vendorPartNumber ? `<span class="tag">${o.vendorPartNumber}</span>` : ''}
                  ${o.priority ? `<span class="tag priority">${o.priority}</span>` : ''}
                  ${o.supplier || o.vendor ? `<span class="tag supplier">${o.supplier || o.vendor}</span>` : ''}
                  ${o.studentName ? `<span class="tag">${o.studentName}</span>` : ''}
                  <span class="muted">${o.quantityRequested ? 'x'+o.quantityRequested : ''}</span>
                  ${renderTrackingBadges(o.tracking || [])}
                  ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="edit-part" style="padding:2px 6px;">Edit</button>` : ''}
                  ${currentUser?.permissions?.canDeleteOrders ? `<button class="btn ghost" data-action="delete-part" style="padding:2px 6px; color:var(--danger);">Delete</button>` : ''}
                </div>
              `).join('')}
            </div>
          `;
          card.addEventListener('dragstart', (e) => {
            if (e.target.closest('.group-item')) {
              e.preventDefault();
              return;
            }
            e.dataTransfer.setData('text/plain', `group:${gid}`);
            card.style.opacity = '0.6';
          });
          card.addEventListener('dragend', () => { card.style.opacity = '1'; });

          card.addEventListener('dragover', (e) => { e.preventDefault(); card.style.borderColor = 'var(--accent)'; });
          card.addEventListener('dragleave', () => { card.style.borderColor = 'var(--border)'; });
          card.addEventListener('drop', (e) => {
            e.preventDefault();
            card.style.borderColor = 'var(--border)';
            const id = e.dataTransfer.getData('text/plain');
            if (!id || id.startsWith('group:')) return;
            (async () => {
              const draggedOrder = getOrderById(id);
              const targetVendor = getOrderVendor(first);
              const dragVendor = getOrderVendor(draggedOrder);
              if (dragVendor && targetVendor && dragVendor !== targetVendor) {
                showBoardMessage('Cannot assign part to an order from a different vendor', 'error', 4000);
                return;
              }
              const prev = snapshotOrder(id);
              const res = await assignGroup(id, gid);
              if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                showBoardMessage(data.error || 'Cannot assign part to an order from a different vendor', 'error');
                return;
              }
              recordAction({
                undo: { type: 'assignGroup', payload: { orderId: id, groupId: prev?.groupId || prev?.group?._id || undefined } },
                redo: { type: 'assignGroup', payload: { orderId: id, groupId: gid } }
              });
              await patchStatusOnly(id, status);
              await fetchOrders();
            })();
          });

          card.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('.group-item')) return;
            if (expandedGroups.has(gid)) expandedGroups.delete(gid); else expandedGroups.add(gid);
            const container = card.querySelector('.group-items-container');
            if (container) container.style.display = expandedGroups.has(gid) ? 'block' : 'none';
          });

          card.querySelectorAll('.group-item').forEach(el => {
            const oid = el.dataset.id;
            el.addEventListener('dragstart', (e) => {
              e.stopPropagation();
              e.dataTransfer.setData('text/plain', oid);
            });
          });

          card.querySelectorAll('button[data-action="edit-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              openGroupModal({
                id: gid,
                title: first.group?.title || groupTitle,
                tracking: trackingList,
                notes: first.group?.notes || ''
              });
            });
          });

          card.querySelectorAll('button[data-action="delete-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (!confirm('Delete this group? Orders will be ungrouped.')) return;
              const orderIds = items.map(o => o._id);
              await fetch(`/api/order-groups/${gid}`, { method: 'DELETE' });
              recordAction({
                undo: { type: 'createGroup', payload: { title: groupTitle, supplier: vendor || undefined, orderIds } },
                redo: { type: 'deleteGroup', payload: { groupId: gid } }
              });
              fetchOrders();
            });
          });

          card.querySelectorAll('button[data-action="edit-part"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              const order = orders.find(o => o._id === oid);
              if (order) openEdit(order);
            });
          });
          card.querySelectorAll('button[data-action="delete-part"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              if (!confirm('Delete this order?')) return;
              await fetch(`/api/orders/${oid}`, { method: 'DELETE' });
              fetchOrders();
            });
          });

          dropArea.appendChild(card);
        });

        const hasSingles = (groupedByStatus[col.status] || []).length > 0;
        const hasGroups = Object.values(groupMap).some(items => items[0]?.status === col.status);
        if (!hasSingles && !hasGroups) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'Drag an order here or create a new one.';
          dropArea.appendChild(empty);
        }

        boardEl.appendChild(column);
      });
    }

    function renderTable() {
      const rows = filteredOrders();
      if (!rows.length) {
        tableContainer.innerHTML = '<div class="empty">No orders found.</div>';
        return;
      }

      const header = `
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>Part</th>
              <th>Status</th>
              <th>Tracking</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Total</th>
              <th>Vendor</th>
              <th>Requested by</th>
            <th>Order placed</th>
            </tr>
          </thead>
          <tbody>
      `;
      const body = rows.map(o => `
        <tr data-id="${o._id}">
          <td><input type="checkbox" class="row-check" ${selected.has(o._id) ? 'checked' : ''}></td>
          <td>
            ${o.partName || ''}
            ${o.vendorPartNumber ? `<div class="small">${o.vendorPartNumber}</div>` : ''}
            ${o.partLink ? `<div class="small"><a href="${o.partLink}" target="_blank">link</a></div>` : ''}
            ${o.group ? `<span class="tag group">Group</span>` : ''}
          </td>
          <td><span class="status-chip status-${o.status || ''}">${o.status || ''}</span></td>
          <td>${renderTrackingBadges(o.tracking?.length ? o.tracking : (o.group?.tracking || []))}</td>
          <td>${o.quantityRequested || ''}</td>
          <td>${o.unitCost ? '$'+o.unitCost : (o.fetchedPrice ? '$'+o.fetchedPrice : '')}</td>
          <td>${(() => {
            const unit = o.unitCost ?? o.fetchedPrice;
            const qty = o.quantityRequested || 1;
            const total = o.totalCost ?? (unit !== undefined ? Number((unit * qty).toFixed(2)) : undefined);
            return total !== undefined ? '$'+total : '';
          })()}</td>
          <td>${o.supplier || o.vendor || ''}</td>
          <td>${o.studentName || ''}</td>
          <td>${fmtDate(o.requestedDisplayAt || o.requestedAt)}</td>
        </tr>
      `).join('');
      tableContainer.innerHTML = header + body + '</tbody></table>';

      tableContainer.querySelector('#select-all').addEventListener('change', (e) => {
        const check = e.target.checked;
        rows.forEach(o => { if (check) selected.add(o._id); else selected.delete(o._id); });
        renderBoard(); renderTable(); updateSelectionBar();
      });
      tableContainer.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = e.target.closest('tr').dataset.id;
          if (e.target.checked) selected.add(id); else selected.delete(id);
          renderBoard(); updateSelectionBar();
        });
      });
    }

    function toggleSelect(id) {
      if (selected.has(id)) selected.delete(id);
      else selected.add(id);
      renderBoard();
      renderTable();
      updateSelectionBar();
    }

    async function updateStatus(id, status, tracking) {
      const trackingList = Array.isArray(tracking)
        ? tracking
        : (tracking ? [{ carrier: 'unknown', trackingNumber: tracking }] : undefined);
      await fetch(`/api/orders/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          tracking: trackingList,
          trackingNumber: trackingList?.[0]?.trackingNumber
        })
      });
      selected.delete(id);
      await fetchOrders();
    }

    function updateSelectionBar() {
      const selectedOrders = orders.filter(o => selected.has(o._id));
      if (selected.size === 0) {
        selectionCount.textContent = 'No parts selected';
        groupVendorNote.textContent = '';
        document.getElementById('group-btn').style.display = 'none';
        document.getElementById('delete-selected').style.display = 'none';
      } else {
      const vendor = selectedOrders[0]?.supplier || selectedOrders[0]?.vendor || 'Mixed';
      selectionCount.textContent = `${selected.size} selected`;
      groupVendorNote.textContent = `Vendor: ${vendor}${selectedOrders.every(o => (o.supplier || o.vendor) === (selectedOrders[0]?.supplier || selectedOrders[0]?.vendor)) ? '' : ' (mixed - fix selection)'}`;
      document.getElementById('group-btn').style.display = 'inline-flex';
      document.getElementById('delete-selected').style.display = 'inline-flex';
    }
    }

    async function createGroup() {
      if (selected.size === 0) return;
      const selectedOrders = orders.filter(o => selected.has(o._id));
      const baseVendor = selectedOrders[0]?.supplier || selectedOrders[0]?.vendor;
      const mixed = selectedOrders.some(o => (o.supplier || o.vendor) !== baseVendor);
      if (mixed) {
        showBoardMessage('Select orders from the same vendor to group.', 'error');
        return;
      }
      const fallbackTitle = baseVendor ? `${baseVendor} - ${formatShortDate()}` : `Group - ${formatShortDate()}`;
      const res = await fetch('/api/order-groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: fallbackTitle,
          supplier: baseVendor || undefined,
          orderIds: Array.from(selected)
        })
      });
      const data = await res.json();
      const newGroupId = data.groupId || data._id;
      recordAction({
        undo: { type: 'deleteGroup', payload: { groupId: newGroupId } },
        redo: { type: 'createGroup', payload: { title: fallbackTitle, supplier: baseVendor || undefined, orderIds: Array.from(selected) } }
      });
      selected.clear();
      groupVendorNote.textContent = 'Vendor: auto from selection';
      await fetchOrders();
    }

    // Event wiring
    boardBtn.addEventListener('click', () => {
      boardBtn.classList.add('active'); tableBtn.classList.remove('active');
      boardSection.style.display = 'block'; tableSection.style.display = 'none';
    });
    tableBtn.addEventListener('click', () => {
      tableBtn.classList.add('active'); boardBtn.classList.remove('active');
      boardSection.style.display = 'none'; tableSection.style.display = 'block';
    });
    refreshBtn.addEventListener('click', fetchOrders);
    undoBtn.addEventListener('click', doUndo);
    redoBtn.addEventListener('click', doRedo);
    globalSearch.addEventListener('input', () => { renderBoard(); renderTable(); });
    statusFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    vendorFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    startDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    endDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    groupBtn.addEventListener('click', createGroup);
    deleteSelectedBtn?.addEventListener('click', async () => {
      if (!currentUser?.permissions?.canDeleteOrders) {
        showBoardMessage('No permission to delete orders.', 'error');
        return;
      }
      if (!selected.size) return;
      if (!confirm(`Delete ${selected.size} selected item(s)?`)) return;
      for (const id of Array.from(selected)) {
        const snapshot = snapshotOrder(id);
        await fetch(`/api/orders/${id}`, { method: 'DELETE' });
        if (snapshot) {
          recordAction({
            undo: { type: 'restoreOrder', payload: { order: snapshot, groupId: snapshot.groupId || snapshot.group?._id } },
            redo: { type: 'deleteOrder', payload: { orderId: id } }
          });
        }
      }
      selected.clear();
      await fetchOrders();
    });
    document.getElementById('new-order-btn').addEventListener('click', () => {
      editingOrderId = null;
      orderForm.reset();
      orderForm.elements.quantityRequested.value = 1;
      setTrackingRows(orderTrackingList, []);
      addOrderTracking.disabled = false;
      orderTrackingList.style.display = 'block';
      orderMessage.textContent = '';
      modal.style.display = 'flex';
    });
    closeModal.addEventListener('click', () => { modal.style.display = 'none'; });
    cancelOrder.addEventListener('click', () => { modal.style.display = 'none'; });
    const resetGroupModal = () => {
      groupModal.style.display = 'none';
      groupForm.reset();
      setTrackingRows(groupModalTrackingList, []);
      editingGroupId = null;
      groupMessage.textContent = '';
    };
    closeGroup.addEventListener('click', resetGroupModal);
    cancelGroup.addEventListener('click', resetGroupModal);

    attachBackdropClose(modal, () => { modal.style.display = 'none'; });
    attachBackdropClose(groupModal, resetGroupModal);
    attachBackdropClose(loginModal, () => { loginModal.style.display = 'none'; });
    attachBackdropClose(accountModal, () => { accountModal.style.display = 'none'; });
    attachBackdropClose(adminModal, () => { adminModal.style.display = 'none'; });

    function findVendorConfig(name) {
      if (!name) return null;
      const lower = name.toLowerCase();
      return vendorConfigs.find(v => (v.vendor || '').toLowerCase() === lower) || null;
    }

    function deriveUrl(config, partNum, link) {
      if (link) return link;
      if (!config) return null;
      if (config.productUrlTemplate && partNum) {
        return config.productUrlTemplate.replace('{partNumber}', partNum);
      }
      if (config.baseUrl && partNum) {
        return `${config.baseUrl.replace(/\/$/, '')}/${partNum}`;
      }
      return null;
    }

    function parsePrice(text) {
      if (!text) return undefined;
      const num = parseFloat(text.replace(/[^0-9\\.]+/g, ''));
      return Number.isFinite(num) ? num : undefined;
    }

    async function assignGroup(orderId, groupId) {
      return fetch(`/api/orders/${orderId}/group`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupId: groupId === undefined ? undefined : groupId })
      });
    }

    async function patchStatusOnly(id, status, tracking) {
      const trackingList = Array.isArray(tracking)
        ? tracking
        : (tracking ? [{ carrier: 'unknown', trackingNumber: tracking }] : undefined);
      await fetch(`/api/orders/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          tracking: trackingList,
          trackingNumber: trackingList?.[0]?.trackingNumber
        })
      });
    }

    async function moveOrderToStatus(orderId, status) {
      const prev = snapshotOrder(orderId);
      await assignGroup(orderId, undefined);
      await patchStatusOnly(orderId, status);
      recordAction({
        undo: { type: 'updateStatus', payload: { orderId, status: prev?.status, groupId: prev?.groupId || prev?.group?._id } },
        redo: { type: 'updateStatus', payload: { orderId, status, groupId: undefined } }
      });
      await fetchOrders();
      selected.delete(orderId);
      updateSelectionBar();
    }

    async function updateGroupStatus(groupId, status) {
      const affected = orders.filter(o => (o.groupId && o.groupId === groupId) || (o.group && o.group._id === groupId));
      for (const o of affected) {
        await patchStatusOnly(o._id, status);
      }
      await fetchOrders();
    }

    fetchProduct.addEventListener('click', async () => {
      const formData = new FormData(orderForm);
      const vendor = (formData.get('vendor') || '').toString().trim();
      const vendorLower = vendor.toLowerCase();
      const partNum = (formData.get('vendorPartNumber') || '').toString().trim();
      const link = (formData.get('partLink') || '').toString().trim();
      let config = findVendorConfig(vendorLower);
      if (!config) {
        const auto = detectVendor(partNum, link);
        if (auto) {
          config = auto;
          orderForm.elements.vendor.value = auto.vendor || orderForm.elements.vendor.value;
        }
      }
      const url = deriveUrl(config, partNum, link);
      if (!url) {
        orderMessage.textContent = 'Provide a link or vendor part number.';
        orderMessage.className = 'error';
        return;
      }
      orderMessage.textContent = 'Fetching...';
      orderMessage.className = 'small';
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url,
            selectors: {
              nameSelector: config?.nameSelector,
              priceSelector: config?.priceSelector,
            }
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Fetch failed');

        const pickName = data.picks?.name || data.candidates?.titles?.[0]?.text;
        const pickPrice = data.picks?.price || data.candidates?.prices?.[0]?.text;

        if (pickName && !orderForm.elements.partName.value) orderForm.elements.partName.value = pickName;
        const priceNum = parsePrice(pickPrice);
        if (priceNum !== undefined) {
          orderForm.elements.unitCost.value = priceNum;
        }
        if (!orderForm.elements.partLink.value) orderForm.elements.partLink.value = url;

        orderMessage.textContent = 'Fetched. Verify fields before submitting.';
        orderMessage.className = 'success';
      } catch (err) {
        orderMessage.textContent = 'Fetch failed. Fill manually.';
        orderMessage.className = 'error';
      }
    });

    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(orderForm);
      const payload = Object.fromEntries(formData.entries());
      payload.quantityRequested = Number(payload.quantityRequested || 0);
      payload.unitCost = payload.unitCost ? Number(payload.unitCost) : undefined;
      payload.fetchedPrice = payload.unitCost || undefined;
      payload.tracking = collectTrackingRows(orderTrackingList);
      payload.trackingNumber = payload.tracking[0]?.trackingNumber || undefined;
      if (!payload.vendor) {
        const auto = detectVendor(payload.vendorPartNumber, payload.partLink);
        if (auto?.vendor) {
          payload.vendor = auto.vendor;
          payload.supplier = auto.vendor;
        }
      }
      payload.supplier = payload.vendor || payload.supplier;
      orderMessage.textContent = 'Submitting...';
      orderMessage.className = 'small';
      try {
        if (editingOrderId) {
          const prev = snapshotOrder(editingOrderId);
          await fetch(`/api/orders/${editingOrderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (prev) {
            recordAction({
              undo: { type: 'updateOrder', payload: { orderId: editingOrderId, data: {
                partName: prev.partName,
                quantityRequested: prev.quantityRequested,
                priority: prev.priority,
                supplier: prev.supplier,
                vendor: prev.vendor,
                partLink: prev.partLink,
                vendorPartNumber: prev.vendorPartNumber,
                trackingNumber: prev.trackingNumber,
                status: prev.status,
                unitCost: prev.unitCost,
                fetchedPrice: prev.fetchedPrice,
                notes: prev.notes
              }}},
              redo: { type: 'updateOrder', payload: { orderId: editingOrderId, data: payload } }
            });
          }
          orderMessage.textContent = 'Order updated.';
        } else {
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          const newId = data.order?.orderId || data.orderId || data.order?._id;
          recordAction({
            undo: { type: 'deleteOrder', payload: { orderId: newId } },
            redo: { type: 'restoreOrder', payload: { order: payload } }
          });
          orderMessage.textContent = 'Order created.';
        }
        orderMessage.className = 'success';
        modal.style.display = 'none';
        orderForm.reset();
        editingOrderId = null;
        setTrackingRows(orderTrackingList, []);
        await fetchOrders();
      } catch (err) {
        orderMessage.textContent = 'Failed to create order';
        orderMessage.className = 'error';
      }
    });

    adminBtn.addEventListener('click', () => {
      adminModal.style.display = 'flex';
      loadUsers();
      loadRoles();
      loadTrackingSettings();
      showAdminSection('users');
    });
    closeAdmin.addEventListener('click', () => { adminModal.style.display = 'none'; });
    accountBtn.addEventListener('click', () => {
      accountModal.style.display = 'flex';
    });
    clearVendor.addEventListener('click', () => { vendorForm.reset(); vendorForm.elements.id.value = ''; });

    function openGroupModal(data) {
      editingGroupId = data?.id || null;
      groupForm.elements.id.value = data?.id || '';
      groupForm.elements.title.value = data?.title || '';
      const parts = orders.filter(o => o.groupId === data?.id || o.group?._id === data?.id).map(o => ({ id: o._id, label: o.partName || o.vendorPartNumber || o.productCode || o._id }));
      setTrackingRows(groupModalTrackingList, data?.tracking?.length ? data.tracking : (data?.trackingNumber ? [{ carrier: 'unknown', trackingNumber: data.trackingNumber }] : []), parts);
      groupForm.elements.notes.value = data?.notes || '';
      groupMessage.textContent = '';
      groupModal.style.display = 'flex';
    }

    groupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(groupForm);
      const payload = Object.fromEntries(formData.entries());
      const tracking = collectTrackingRows(groupModalTrackingList);
      const id = payload.id;
      groupMessage.textContent = 'Saving...';
      groupMessage.className = 'small';
      try {
        await fetch(`/api/order-groups/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: payload.title || undefined,
            trackingNumber: tracking[0]?.trackingNumber || undefined,
            tracking: tracking.length ? tracking : [],
            notes: payload.notes || undefined
          })
        });
        groupMessage.textContent = 'Saved.';
        groupMessage.className = 'success';
        resetGroupModal();
        await fetchOrders();
      } catch (err) {
        groupMessage.textContent = 'Failed to save group';
        groupMessage.className = 'error';
      }
    });

    async function loadVendors() {
      if (!currentUser) return;
      vendorList.textContent = 'Loading...';
      try {
        const res = await fetch('/api/vendors/configs');
        const data = await res.json();
        vendorConfigs = data.vendors || [];
        if (!vendorConfigs.length) {
          vendorList.innerHTML = '<div class="empty">No vendor configs yet. Create one above.</div>';
          return;
        }
        vendorList.innerHTML = vendorConfigs.map(v => `
          <div class="card" data-id="${v._id}" style="margin-bottom:8px;">
            <div class="flex-between">
              <div>
                <h4 style="margin:0 0 4px;">${v.vendor}</h4>
                <div class="small">${v.baseUrl || ''}</div>
                <div class="small">Template: ${v.productUrlTemplate || ''}</div>
                <div class="small">Selectors: ${v.nameSelector || '-'} | ${v.priceSelector || '-'}</div>
              </div>
              <div class="flex-between" style="gap:8px;">
                <button class="btn ghost" data-action="edit">Edit</button>
                <button class="btn ghost" data-action="delete" style="color:var(--danger);">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        vendorList.querySelectorAll('button[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const v = vendorConfigs.find(x => x._id === id);
            if (!v) return;
            vendorForm.elements.id.value = id;
            vendorForm.elements.vendor.value = v.vendor || '';
            vendorForm.elements.baseUrl.value = v.baseUrl || '';
            vendorForm.elements.productUrlTemplate.value = v.productUrlTemplate || '';
            vendorForm.elements.partNumberExample.value = v.partNumberExample || '';
            vendorForm.elements.partNumberPattern.value = v.partNumberPattern || '';
            vendorForm.elements.nameSelector.value = v.nameSelector || '';
            vendorForm.elements.priceSelector.value = v.priceSelector || '';
            vendorForm.elements.notes.value = v.notes || '';
          });
        });

        vendorList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            if (!id) return;
            await fetch(`/api/vendors/configs/${id}`, { method: 'DELETE' });
            loadVendors();
          });
        });
      } catch (e) {
        vendorList.textContent = 'Failed to load vendors';
      }
    }

    vendorForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(vendorForm).entries());
      const id = data.id || undefined;
      if (!data.vendor) {
        vendorMessage.textContent = 'Vendor is required';
        vendorMessage.className = 'error';
        return;
      }
      vendorMessage.textContent = 'Saving...';
      vendorMessage.className = 'small';
      let headersObj;
      if (data.notes) {
        try {
          headersObj = JSON.parse(data.notes);
        } catch (e) {
          vendorMessage.textContent = 'Notes/headers not valid JSON.';
          vendorMessage.className = 'error';
          return;
        }
      }
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/vendors/configs/${id}` : '/api/vendors/configs';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vendor: data.vendor,
            baseUrl: data.baseUrl || undefined,
            productUrlTemplate: data.productUrlTemplate || undefined,
            partNumberExample: data.partNumberExample || undefined,
            partNumberPattern: data.partNumberPattern || undefined,
            nameSelector: data.nameSelector || undefined,
            priceSelector: data.priceSelector || undefined,
            platform: data.platform || undefined,
            notes: data.notes || undefined,
            headers: headersObj
          })
        });
        vendorMessage.textContent = 'Saved.';
        vendorMessage.className = 'success';
        vendorForm.reset();
        loadVendors();
      } catch (err) {
        vendorMessage.textContent = 'Failed to save vendor';
        vendorMessage.className = 'error';
      }
    });

    userForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(userForm).entries());
      const id = data.id || undefined;
      const payload = {
        username: data.username,
        name: data.name,
        role: data.role,
        active: data.active === 'true',
        permissions: undefined
      };
      if (data.password) payload.password = data.password;
      userMessage.textContent = 'Saving...';
      userMessage.className = 'small';
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/users/${id}` : '/api/users';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        userMessage.textContent = 'Saved user.';
        userMessage.className = 'success';
        userForm.reset();
        loadUsers();
      } catch (err) {
        userMessage.textContent = 'Failed to save user';
        userMessage.className = 'error';
      }
    });

    clearUser.addEventListener('click', () => {
      userForm.reset();
      userForm.elements.id.value = '';
    });

    passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(passwordForm).entries());
      passwordMessage.textContent = 'Updating...';
      passwordMessage.className = 'small';
      const res = await fetch('/api/auth/password', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const resp = await res.json();
      if (!res.ok) {
        passwordMessage.textContent = resp.error || 'Failed';
        passwordMessage.className = 'error';
        return;
      }
      passwordMessage.textContent = 'Password updated.';
      passwordMessage.className = 'success';
      passwordForm.reset();
    });

    async function testExtraction() {
      const url = testUrl.value.trim();
      if (!url) {
        vendorMessage.textContent = 'Provide a URL to test.';
        vendorMessage.className = 'error';
        return;
      }
      const selectors = {
        nameSelector: vendorForm.elements.nameSelector.value || undefined,
        priceSelector: vendorForm.elements.priceSelector.value || undefined
      };
      const headers = {};
      try {
        const notes = vendorForm.elements.notes.value;
        if (notes) {
          const parsed = JSON.parse(notes);
          Object.assign(headers, parsed);
        }
      } catch (e) {
        vendorMessage.textContent = 'Notes/headers not valid JSON.';
        vendorMessage.className = 'error';
        return;
      }

      const resultsEl = document.getElementById('extract-results');
      resultsEl.textContent = 'Testing...';
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, selectors, headers })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        resultsEl.textContent = 'Pick which value looks correct for each field. You can paste CSS selectors (e.g., span.money).';

        if (data.shopify) {
          vendorMessage.textContent = 'Shopify data detected. Name/price auto-filled. Editing selectors will override Shopify.';
          vendorMessage.className = 'small';
          if (data.shopify.vendor && !vendorForm.elements.vendor.value) {
            vendorForm.elements.vendor.value = data.shopify.vendor;
          }
          if (data.shopify.variant?.name && !vendorForm.elements.nameSelector.value) {
            previewName.textContent = data.shopify.variant.name;
          }
          if (data.shopify.variant?.price !== undefined && !vendorForm.elements.priceSelector.value) {
            previewPrice.textContent = data.shopify.variant.price.toFixed(2);
          }
        }

        const trim = (t) => (t && t.length > 120 ? t.slice(0, 120) + '…' : t || '');
        const nameOptions = (data.picks?.name ? [{ text: data.picks.name, selector: selectors.nameSelector }] : []).concat(data.candidates?.titles || []);
        const priceOptions = (data.picks?.price ? [{ text: data.picks.price, selector: selectors.priceSelector }] : []).concat(data.candidates?.prices || []);

        const makeOptions = (opts) => opts.map(c => `<option data-text="${c.text || ''}" title="${c.text || ''}" value="${c.selector || ''}">${trim(c.text)}</option>`).join('');
        pickName.innerHTML = '<option value="">-- choose name --</option>' + makeOptions(nameOptions);
        pickPrice.innerHTML = '<option value="">-- choose price --</option>' + makeOptions(priceOptions);

        const applySelection = (selectEl, fieldName, previewEl) => {
          const apply = () => {
            const selOption = selectEl.options[selectEl.selectedIndex];
            const selSelector = selOption?.value || '';
            const selText = selOption?.dataset?.text || selOption?.title || selOption?.text || '';
            if (selSelector) {
              vendorForm.elements[fieldName].value = selSelector;
            }
            if (previewEl) previewEl.textContent = selText;
          };
          selectEl.addEventListener('change', apply);
          if (selectEl.options.length > 1) {
            selectEl.selectedIndex = 1;
            apply();
          }
        };
        applySelection(pickName, 'nameSelector', previewName);
        applySelection(pickPrice, 'priceSelector', previewPrice);
      } catch (err) {
        resultsEl.textContent = 'Extraction failed. Check URL/headers.';
        vendorMessage.textContent = err.message;
        vendorMessage.className = 'error';
      }
    }

    // Live preview when selectors change (uses current test URL if present)
    const debounce = (fn, ms = 400) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    };
    const liveExtract = debounce(() => {
      if (!testUrl.value.trim()) return;
      testExtraction();
    }, 500);

    ['nameSelector', 'priceSelector'].forEach(name => {
      vendorForm.elements[name].addEventListener('input', liveExtract);
    });

    function deriveFromSnippet(snippet) {
      if (!snippet) return '';
      const text = snippet.trim().replace(/;$/, '');
      const qsMatch = text.match(/querySelector(All)?\((['"`])([^'"`]+)\2\)/i);
      if (qsMatch) {
        return qsMatch[3].trim();
      }
      // CSS selector only
      return text;
    }

    applySelector.addEventListener('click', () => {
      const sel = deriveFromSnippet(selectorSnippet.value || '');
      if (!sel) return;
      const target = selectorTarget.value;
      vendorForm.elements[target].value = sel;
      liveExtract();
    });

    function guessRegexFromExample(example) {
      if (!example) return '';
      // If looks like ABC-1234 or AM-4896
      if (/^[A-Za-z]{2,}-\d+$/i.test(example)) {
        const prefix = example.split('-')[0];
        return `^${prefix}-\\d+$`;
      }
      // Alphanumeric with dashes
      if (/^[A-Za-z0-9-]+$/.test(example)) {
        return '^[A-Za-z0-9-]+$';
      }
      return '';
    }

    partExample.addEventListener('blur', () => {
      const guess = guessRegexFromExample(partExample.value.trim());
      if (guess && !partPattern.value) {
        partPattern.value = guess;
      }
    });

    testExtract.addEventListener('click', testExtraction);

    function updateUserUI() {
      if (currentUser) {
        userChip.textContent = `${currentUser.name || currentUser.username || 'User'} · ${currentUser.role || ''}`;
        userChip.style.display = 'inline-flex';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        accountBtn.style.display = 'inline-flex';
      } else {
        userChip.textContent = '';
        userChip.style.display = 'none';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        accountBtn.style.display = 'none';
        adminBtn.style.display = 'none';
      // vendor button removed; use Admin modal tabs
    }
    // Permissions gating
    if (currentUser?.permissions?.canPlaceOrders) {
      newOrderBtn.disabled = false;
    } else {
      newOrderBtn.disabled = true;
    }
      adminBtn.style.display = currentUser?.permissions?.canManageUsers ? 'inline-flex' : 'none';
    }

    async function loadUsers() {
      if (!currentUser?.permissions?.canManageUsers) {
        userList.innerHTML = '<div class="empty">No access to manage users.</div>';
        return;
      }
      userList.textContent = 'Loading users...';
      try {
        const res = await fetch('/api/users');
        const data = await res.json();
        const users = data.users || [];
        if (!users.length) {
          userList.innerHTML = '<div class="empty">No users.</div>';
          return;
        }
        userList.innerHTML = users.map(u => `
          <div class="card" data-id="${u._id}" style="margin-bottom:6px;">
            <div class="flex-between">
              <div>
                <div><strong>${u.username}</strong> (${u.role})</div>
                <div class="small">${u.name || ''}</div>
                <div class="small">Active: ${u.active ? 'Yes' : 'No'}</div>
              </div>
              <div class="flex-between" style="gap:8px;">
                <button class="btn ghost" data-action="edit-user">Edit</button>
              </div>
            </div>
          </div>
        `).join('');

        userList.querySelectorAll('button[data-action="edit-user"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const u = users.find(x => x._id === id);
            if (!u) return;
            userForm.elements.id.value = u._id;
            userForm.elements.username.value = u.username;
            userForm.elements.name.value = u.name || '';
            userForm.elements.role.value = u.role || 'student';
            userForm.elements.active.value = u.active ? 'true' : 'false';
          });
        });
      } catch (e) {
        userList.textContent = 'Failed to load users';
      }
    }

    async function loadRoles() {
      if (!currentUser?.permissions?.canManageUsers) {
        roleList.innerHTML = '<div class="empty">No access to manage roles.</div>';
        return;
      }
      roleList.textContent = 'Loading roles...';
      try {
        const res = await fetch('/api/roles');
        const data = await res.json();
        const roles = data.roles || [];
        const combined = {
          admin: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: true },
          mentor: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: false },
          student: { canPlaceOrders: true, canMoveOrders: false, canEditOrders: false, canDeleteOrders: false, canManageVendors: false, canManageUsers: false }
        };
        roles.forEach(r => { combined[r.role] = r.permissions; });

        const renderToggle = (role, key, label) => `
          <label class="small" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" data-role="${role}" data-key="${key}" ${combined[role]?.[key] ? 'checked' : ''}/>
            ${label}
          </label>`;

        const roleCard = (role) => `
          <div class="card" style="margin-bottom:8px;">
            <div class="page-title" style="font-size:16px;">${role}</div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px;">
              ${renderToggle(role, 'canPlaceOrders', 'Can place orders')}
              ${renderToggle(role, 'canMoveOrders', 'Can move orders')}
              ${renderToggle(role, 'canEditOrders', 'Can edit orders')}
              ${renderToggle(role, 'canDeleteOrders', 'Can delete orders')}
              ${renderToggle(role, 'canManageVendors', 'Can manage vendors')}
              ${renderToggle(role, 'canManageUsers', 'Can manage users')}
            </div>
            <div class="flex-between" style="margin-top:8px;">
              <button class="btn primary" data-action="save-role" data-role="${role}">Save ${role}</button>
            </div>
          </div>`;

        roleList.innerHTML = ['admin', 'mentor', 'student'].map(roleCard).join('');

        roleList.querySelectorAll('button[data-action="save-role"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const role = e.target.dataset.role;
            const inputs = roleList.querySelectorAll(`input[data-role="${role}"]`);
            const perms = {};
            inputs.forEach(input => {
              perms[input.dataset.key] = input.checked;
            });
            await fetch(`/api/roles/${role}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ permissions: perms })
            });
          });
        });
      } catch (e) {
        roleList.textContent = 'Failed to load roles';
      }
    }

    async function syncTrackingAutoRefreshFromServer() {
      try {
        const res = await fetch('/api/tracking/settings');
        if (!res.ok) return;
        const data = await res.json();
        const minutes = Number(data.settings?.refreshMinutes);
        if (Number.isFinite(minutes) && minutes > 0) {
          startTrackingAutoRefresh(minutes);
        }
      } catch (_) {
        // ignore - auto refresh will keep existing cadence
      }
    }

    async function loadTrackingSettings() {
      if (!trackingSettingsForm) return;
      trackingSettingsMessage.textContent = 'Loading tracking settings...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/settings');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load settings');
        const settings = data.settings || {};
        ['upsClientId','upsClientSecret','uspsUserId','fedexClientId','fedexClientSecret'].forEach(key => {
          if (trackingSettingsForm.elements[key]) {
            trackingSettingsForm.elements[key].value = settings[key] || '';
          }
        });
        if (trackingSettingsForm.elements.refreshMinutes) {
          trackingSettingsForm.elements.refreshMinutes.value = settings.refreshMinutes || 30;
        }
        if (settings.refreshMinutes) {
          startTrackingAutoRefresh(settings.refreshMinutes);
        }
        trackingSettingsMessage.textContent = 'Tracking settings loaded.';
        trackingSettingsMessage.className = 'small';
      } catch (e) {
        trackingSettingsMessage.textContent = e.message || 'Failed to load tracking settings';
        trackingSettingsMessage.className = 'error';
      }
    }

    trackingSettingsForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(trackingSettingsForm).entries());
      payload.refreshMinutes = Number(payload.refreshMinutes || 30);
      if (!Number.isFinite(payload.refreshMinutes) || payload.refreshMinutes <= 0) {
        payload.refreshMinutes = 30;
      }
      trackingSettingsMessage.textContent = 'Saving...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/settings', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save settings');
        trackingSettingsMessage.textContent = 'Saved tracking settings.';
        trackingSettingsMessage.className = 'success';
        startTrackingAutoRefresh(payload.refreshMinutes);
      } catch (err) {
        trackingSettingsMessage.textContent = err.message || 'Failed to save settings';
        trackingSettingsMessage.className = 'error';
      }
    });

    refreshTrackingNow?.addEventListener('click', async () => {
      trackingSettingsMessage.textContent = 'Refreshing tracking now...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/refresh', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to refresh');
        if (data.lastError) {
          trackingSettingsMessage.textContent = `Refresh triggered, but tracking error: ${data.lastError}`;
          trackingSettingsMessage.className = 'error';
        } else {
          trackingSettingsMessage.textContent = 'Refresh triggered. Data will update shortly.';
          trackingSettingsMessage.className = 'success';
        }
        fetchOrders();
      } catch (err) {
        trackingSettingsMessage.textContent = err.message || 'Failed to refresh tracking';
        trackingSettingsMessage.className = 'error';
      }
    });

    function showAdminSection(which) {
      if (!adminUsersSection || !adminTrackingSection || !adminVendorsSection) return;
      adminUsersSection.style.display = which === 'users' ? 'block' : 'none';
      adminTrackingSection.style.display = which === 'tracking' ? 'block' : 'none';
      adminVendorsSection.style.display = which === 'vendors' ? 'block' : 'none';
      [adminTabUsers, adminTabTracking, adminTabVendors].forEach(btn => btn?.classList.remove('primary'));
      if (which === 'users') adminTabUsers?.classList.add('primary');
      if (which === 'tracking') adminTabTracking?.classList.add('primary');
      if (which === 'vendors') adminTabVendors?.classList.add('primary');
    }
    adminTabUsers?.addEventListener('click', () => showAdminSection('users'));
    adminTabTracking?.addEventListener('click', () => showAdminSection('tracking'));
    adminTabVendors?.addEventListener('click', () => { showAdminSection('vendors'); loadVendors(); });

    async function fetchMe() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) throw new Error('unauth');
        const data = await res.json();
        currentUser = data.user;
        updateUserUI();
        await syncTrackingAutoRefreshFromServer();
        fetchOrders();
        loadVendors();
        loadUsers();
      } catch {
        currentUser = null;
        updateUserUI();
      }
    }

    loginBtn.addEventListener('click', () => {
      loginModal.style.display = 'flex';
    });
    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      currentUser = null;
      updateUserUI();
      orders = [];
      renderBoard();
      renderTable();
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(loginForm);
      const payload = Object.fromEntries(formData.entries());
      loginMessage.textContent = 'Signing in...';
      loginMessage.className = 'small';
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) {
        loginMessage.textContent = data.error || 'Login failed';
        loginMessage.className = 'error';
        return;
      }
      currentUser = data.user;
      loginMessage.textContent = '';
      loginModal.style.display = 'none';
      updateUserUI();
      syncTrackingAutoRefreshFromServer();
      fetchOrders();
      loadVendors();
      loadUsers();
    });

    startTrackingAutoRefresh(DEFAULT_TRACKING_POLL_MINUTES);
    fetchMe();
  </script>
</body>
</html>
