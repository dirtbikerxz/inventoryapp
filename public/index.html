<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Venom Parts</title>
  <link rel="icon" type="image/png" href="/branding/logo.png" />
  <style>
    @font-face {
      font-family: 'Nasalization';
      src: url('/branding/Nasalization.ttf') format('truetype');
      font-display: swap;
    }
    :root {
      color-scheme: dark;
      --purple: #461d7c;
      --gold: #fdd023;
      --bg: radial-gradient(circle at top, rgba(70, 29, 124, 0.18), transparent 55%), #141414;
      --panel: rgba(34, 34, 34, 0.92);
      --panel-2: rgba(34, 34, 34, 0.98);
      --accent: #461d7c;
      --accent-2: #fdd023;
      --text: #f2f4f8;
      --muted: #c8c1dd;
      --border: rgba(253, 208, 35, 0.25);
      --danger: #ff5565;
      --success: #4ad28f;
      --warning: var(--gold);
      --card-shadow: 0 20px 50px rgba(0,0,0,0.5);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
    }
    h1, h2, h3, h4, .brand, .page-title { font-family: 'Nasalization', 'Inter', system-ui, sans-serif; letter-spacing: 0.4px; }
    a { color: inherit; text-decoration: none; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: linear-gradient(120deg, rgba(34,34,34,0.95), rgba(40,30,60,0.95));
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: var(--safe-top);
      z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .brand {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--gold);
      text-shadow: 0 2px 10px rgba(253,208,35,0.2);
    }
    .brand img { height: 36px; width: 36px; border-radius: 50%; object-fit: contain; }
    .brand-text { display:flex; flex-direction:column; line-height:1.15; gap: 3px; }
    .brand-title { font-size: 22px; font-family:'Nasalization', 'Inter', sans-serif; font-weight: 700; }
    .brand-subtitle { font-size: 12px; font-weight: 500; letter-spacing: 0.5px; color: var(--gold); text-transform: uppercase; }
    .search {
      flex: 1;
      max-width: 400px;
      margin: 0 16px;
      position: relative;
    }
    .search input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
    }
    .toolbar {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    .toolbar-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn {
      border: 1px solid var(--border);
      background: var(--accent);
      color: var(--gold);
      border-radius: 12px;
      padding: 9px 14px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      line-height: 1.2;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 30px rgba(70, 29, 124, 0.25); }
    .btn.primary {
      background: var(--gold);
      color: #1a1000;
      border-color: var(--gold);
      box-shadow: 0 12px 28px rgba(253,208,35,0.25);
    }
    .btn.ghost {
      background: transparent;
      color: var(--text);
    }
    main { padding: 24px; padding-bottom: 24px; flex:1; min-height:0; display:flex; flex-direction:column; overflow:hidden; gap:12px; }
    .page-title { font-size: 32px; font-weight: 800; margin: 0 0 4px; color: var(--gold); }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .view-toggle {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--panel);
    }
    .view-toggle button {
      border: none;
      background: transparent;
      color: #f7f8fb;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      min-width: 100px;
    }
    .view-toggle button.active {
      background: var(--accent);
      color: #f7f8fb;
    }
    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    /* Board */
    .board {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      grid-auto-rows: minmax(0, 1fr);
      margin-top: 16px;
      height: 100%;
      min-height: 0;
      padding-bottom: 12px;
      overflow: hidden;
    }
    .column {
      background: var(--panel-2);
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 12px;
      min-height: 300px;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
      min-height: 0;
    }
    .column h3 {
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
    }
    .pill {
      background: #1f2a44;
      color: var(--text);
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
    }
    .board-drop {
      min-height: 0;
      padding-bottom: 12px;
      overflow-y: auto;
      flex:1;
      padding-right: 4px;
      padding-top: 4px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      cursor: grab;
      transition: transform 0.1s ease, border-color 0.1s ease, box-shadow 0.15s ease;
    }
    .card:hover { border-color: var(--gold); box-shadow: 0 10px 28px rgba(253,208,35,0.2); }
    .card h4 { margin: 0 0 6px; font-size: 15px; }
    .meta {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1b2440;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .tag.supplier { background: rgba(79,180,255,0.12); color: var(--accent-2); }
    .tag.priority { background: rgba(248,197,82,0.16); color: var(--gold); }
    .tag.group { background: rgba(74,210,143,0.16); color: var(--success); }
    .tag.tracking { background: rgba(79,180,255,0.14); color: var(--accent-2); cursor: pointer; }
    .tag.tracking.pending { background: rgba(255,85,101,0.18); color: #ff8b95; border-color: rgba(255,85,101,0.5); }
    .tag.tracking.intransit { background: rgba(79,180,255,0.18); color: #9bd0ff; border-color: rgba(79,180,255,0.5); }
    .tag.tracking.delivered { background: rgba(74,210,143,0.2); color: #7be0b4; border-color: rgba(74,210,143,0.5); }
    .tag.tracking.unknown { background: rgba(200,193,221,0.18); color: #d1cbe2; border-color: rgba(200,193,221,0.5); }
    .tracking-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tracking-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tracking-row select { min-width:120px; }
    .tracking-list { display:flex; flex-direction:column; gap:6px; }
    .tag-dot { width:10px; height:10px; border-radius:50%; display:inline-block; background: transparent; }
    .tag-picker { position: relative; max-width: 420px; }
    .tag-picker-display { border:1px solid var(--border); background: var(--panel); padding:10px 12px; border-radius:10px; cursor:pointer; }
    .tag-picker-panel { position:absolute; top:110%; left:0; right:0; background:var(--panel-2); border:1px solid var(--border); border-radius:10px; box-shadow:var(--card-shadow); padding:8px; z-index:25; max-height:260px; display:flex; flex-direction:column; gap:8px; }
    .tag-picker-options { overflow:auto; max-height:180px; display:flex; flex-direction:column; gap:6px; }
    .tag-option { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid transparent; }
    .tag-option:hover { background: rgba(255,255,255,0.04); }
    .tag-option.selected { border-color: var(--accent); background: rgba(70,29,124,0.15); }
    .tag-manager-list { display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .tag-manager-item { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel); }
    .tag-manager-meta { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .admin-inline-form { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .tag-modal-card { background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto; }
    .inline-color { width:40px; height:40px; padding:0; border:none; border-radius:50%; background:transparent; cursor:pointer; }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .checkbox {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
    }
    .card.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(79,180,255,0.25); }
    /* Table */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .input {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      width: 100%;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 13px;
    }
    th { color: var(--muted); font-weight: 600; }
    tr:hover td { background: rgba(79,180,255,0.05); }
    .status-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .status-Requested { background: rgba(253,208,35,0.18); color: var(--gold); }
    .status-Ordered { background: rgba(253,208,35,0.28); color: #1f1a00; }
    .status-Received { background: rgba(74,210,143,0.16); color: var(--success); }
    .status-Cancelled { background: rgba(255,85,101,0.16); color: var(--danger); }
    .selection-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
      margin: 12px 0;
    }
    .input-inline {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--text);
    }
    .small { font-size: 12px; color: var(--muted); }
    select { max-width: 100%; }
    select option { white-space: normal; }
    .empty {
      border: 1px dashed var(--border);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
      background: var(--panel-2);
    }
    .stock-grid .card { cursor: default; }
    .stock-card.stock-low { border-color: var(--warning); box-shadow: 0 0 0 1px rgba(253,208,35,0.35); }
    .stock-card.stock-empty { border-color: var(--danger); box-shadow: 0 0 0 1px rgba(255,85,101,0.45); }
    .stock-grid {
      align-items: start;
      grid-auto-rows: auto;
      grid-template-columns: repeat(auto-fit, minmax(400px, 520px));
      justify-content: flex-start;
      align-content: start;
    }
    .stock-grid .card {
      width: 100%;
      max-width: 520px;
    }
    .stock-grid.grouped {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .stock-category-title {
      font-weight: 800;
      font-size: 16px;
      color: var(--gold);
      margin: 0 0 8px;
      padding: 0 2px;
    }
    .stock-category-block {
      width: 100%;
    }
    .stock-category-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(400px, 520px));
      align-items: start;
      width: 100%;
      align-content: start;
    }
    .stock-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: nowrap;
    }
    .stock-actions .btn {
      padding: 4px 8px;
      font-size: 13px;
      line-height: 1.2;
    }
    .stock-actions .btn.primary {
      padding: 4px 10px;
    }
    .stock-level {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 26px;
      font-weight: 800;
      color: var(--text);
    }
    .stock-adjust { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .stock-adjust .btn {
      min-width: 38px;
      min-height: 38px;
      border-radius: 12px;
      font-size: 16px;
      padding: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .stock-chip {
      background: #1b2440;
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 700;
    }
    .card.add-target-disabled {
      opacity: 0.35;
      pointer-events: none;
      filter: grayscale(0.3);
    }
    .card.add-target-valid {
      box-shadow: 0 0 0 1px var(--accent);
    }
    .stock-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    .stock-low-text { color: var(--warning); font-weight: 700; }
    .stock-empty-text { color: var(--danger); font-weight: 700; }
    /* Login page (VenomMCC styling) */
    .login-page {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
      z-index: 200;
    }
    .login-panel {
      width: min(420px, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .login-header h1 { margin: 0; font-size: 28px; color: var(--text); line-height: 1; }
    .login-header p { margin: 6px 0 0; color: var(--muted); }
    .login-form { display: flex; flex-direction: column; gap: 18px; }
    .login-field { display: flex; flex-direction: column; gap: 8px; }
    .login-field span { font-size: 12px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); }
    .login-field input {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      background: var(--panel-2);
      color: var(--text);
      font-size: 16px;
    }
    .login-button {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 14px 16px;
      font-weight: 700;
      background: var(--gold);
      color: #1a1000;
      cursor: pointer;
      transition: opacity 0.2s ease, transform 0.2s ease;
      box-shadow: 0 10px 30px rgba(253,208,35,0.25);
    }
    .login-button:disabled { opacity: 0.6; cursor: not-allowed; }
    .login-button:hover { transform: translateY(-1px); }
    .login-error { color: var(--danger); margin: 0; font-weight: 600; text-align: center; }
    .login-status { color: var(--muted); }
  </style>
</head>
<body>
  <div id="login-page" class="login-page" style="display:flex;">
    <section class="login-panel">
      <header class="login-header">
        <h1>Sign in</h1>
      </header>
      <form id="login-form" class="login-form">
        <label class="login-field">
          <span>Username</span>
          <input name="username" type="text" autocomplete="username" required />
        </label>
        <label class="login-field">
          <span>Password</span>
          <input name="password" type="password" autocomplete="current-password" required />
        </label>
        <button type="submit" class="login-button" id="login-submit">Sign in</button>
        <p id="login-message" class="login-error" style="display:none;"></p>
      </form>
    </section>
  </div>

  <div id="app-shell" style="display:none;">
  <header>
    <div class="brand">
      <img src="/branding/logo.png" alt="Venom Parts logo" />
      <div class="brand-text">
        <span class="brand-title">Venom Parts</span>
        <span class="brand-subtitle">FRC 8044 - Parts Ordering System</span>
      </div>
    </div>
    <div class="search">
      <input id="global-search" placeholder="Search parts, suppliers, users..." />
    </div>
    <div class="toolbar">
      <div class="toolbar-buttons">
        <button class="btn ghost" id="refresh-btn">Refresh</button>
        <button class="btn ghost" id="catalog-btn" style="display:none;">Catalog</button>
        <button class="btn ghost" id="admin-btn" style="display:none;">Admin</button>
        <button class="btn ghost" id="account-btn">Account</button>
        <button class="btn ghost" id="login-btn">Login</button>
        <button class="btn ghost" id="logout-btn" style="display:none;">Logout</button>
      </div>
      <div class="user-status">
        <span id="tracking-updated" class="small" style="color: var(--muted);"></span>
        <span id="user-chip" class="pill" style="background: var(--panel); border:1px solid var(--border);"></span>
      </div>
    </div>
  </header>

  <main>
    <div class="flex-between" style="align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <div class="page-title" id="primary-title">Orders</div>
        <div class="subtitle" id="primary-subtitle">Track parts from request to delivery.</div>
      </div>
      <div class="view-toggle" id="primary-view-toggle">
        <button id="orders-view-btn" class="active">Orders</button>
        <button id="stock-view-btn">Stock</button>
      </div>
    </div>

    <div id="orders-layout-row" class="flex-between" style="align-items:center; gap:12px; flex-wrap:wrap; margin-top:8px;">
      <div class="view-toggle" id="orders-layout-toggle">
        <button id="board-view-btn" class="active">Board</button>
        <button id="table-view-btn">Table</button>
      </div>
      <div class="flex-between" style="gap:8px; flex-wrap:wrap; margin-left:auto;">
        <button class="btn ghost" id="tags-btn" style="display:none;">Manage Tags</button>
        <button class="btn primary" id="new-order-btn">New Order</button>
      </div>
    </div>

    <div id="selection-bar" class="selection-bar">
      <div style="display:flex; flex-direction:column; gap:4px; min-width:180px;">
        <div id="selection-count"></div>
        <div id="group-vendor-note" class="small">Vendor: auto from selection</div>
      </div>
      <div class="flex-between selection-actions" style="gap:8px;"></div>
    </div>

    <section id="board-section" style="flex:1; min-height:0; overflow:hidden; display:flex; flex-direction:column; padding-bottom: 12px;">
      <div class="board" id="board"></div>
    </section>

    <section id="table-section" style="display:none; flex:1; min-height:0; overflow:hidden; flex-direction:column;">
      <div class="filters">
        <div><label class="small">Start date</label><input id="start-date" class="input" type="date" /></div>
        <div><label class="small">End date</label><input id="end-date" class="input" type="date" /></div>
        <div><label class="small">Status</label><select id="status-filter" class="input"></select></div>
        <div><label class="small">Vendor</label><select id="vendor-filter" class="input"></select></div>
      </div>
      <div id="table-container" style="overflow:auto; flex:1; min-height:0; padding-bottom: 12px;"></div>
    </section>

    <section id="stock-section" style="display:none; flex:1; min-height:0; overflow:hidden; flex-direction:column; gap:12px;">
      <div class="flex-between" style="align-items:center; gap:8px; flex-wrap:wrap;">
        <div class="flex-between" style="gap:8px; flex-wrap:wrap; align-items:center;">
          <select id="stock-subteam-filter" class="input" style="min-width:180px;"></select>
        </div>
        <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
          <button class="btn ghost" id="manage-subteams-btn" style="display:none;">Manage Locations</button>
          <button class="btn primary" id="add-stock-btn" style="display:none;">Add Stock</button>
        </div>
      </div>
      <div id="stock-grid" class="board stock-grid" style="flex:1; min-height:0; overflow:auto; padding-bottom:12px;"></div>
    </section>
  </main>

  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:50; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">New Order</div>
          <div class="subtitle" style="margin-bottom:12px;">Provide a link or PN to fetch details from supported vendors; otherwise enter manually.</div>
        </div>
      </div>
      <form id="order-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:12px;">
        <div style="grid-column: span 2;">
          <div id="order-source-toggle" style="display:inline-flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn ghost" data-source="manual" id="order-source-manual">Enter new part</button>
            <button type="button" class="btn ghost" data-source="catalog" id="order-source-catalog">Pick from catalog</button>
            <button type="button" class="btn ghost" data-source="import" id="order-source-import">Vendor import</button>
          </div>
        </div>
        <div id="order-import-fields" class="order-import-fields" style="grid-column: span 2; display:none;">
          <label class="small">Vendor import</label>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; align-items:center;">
            <select id="vendor-import-vendor" class="input">
              <option value="">Select vendor</option>
            </select>
            <div class="small" id="vendor-import-instructions">Upload a supported vendor CSV or paste part numbers and quantities.</div>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; margin-top:10px;">
            <div>
              <label class="small">Upload vendor CSV</label>
              <input type="file" id="vendor-import-file" class="input" accept=".csv,.xls,.xlsx,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
            </div>
            <div>
              <label class="small">Paste part numbers (one per line)</label>
              <textarea id="vendor-import-text" class="input" rows="4" placeholder="Qty,Part Number or Part Number,Qty"></textarea>
            </div>
          </div>
          <div class="flex-between" style="gap:8px; flex-wrap:wrap; margin-top:8px;">
            <button type="button" class="btn ghost" id="vendor-import-clear" style="padding:6px 10px;">Clear</button>
            <div style="flex:1;"></div>
            <button type="button" class="btn primary" id="vendor-import-parse" style="padding:6px 12px;">Parse input</button>
          </div>
          <div id="vendor-import-message" class="small" style="margin-top:6px;"></div>
          <div id="vendor-import-preview" class="vendor-import-preview" style="margin-top:10px;"></div>
          <div class="flex-between" id="vendor-import-actions" style="display:none; align-items:center; gap:8px; margin-top:10px;">
            <div id="vendor-import-summary" class="small"></div>
            <button type="button" class="btn primary" id="vendor-import-submit">Add items</button>
          </div>
        </div>
        <div id="order-standard-fields" style="display:contents;">
        <div class="order-manual-fields" style="grid-column: span 2;">
          <label class="small">Product Number</label>
            <input name="vendorPartNumber" class="input" placeholder="e.g., WCP-0921" />
        </div>
        <div class="order-manual-fields" style="grid-column: span 2;">
          <label class="small">Supplier Link</label>
          <input name="partLink" class="input" placeholder="https://vendor.com/product/..." />
          <div style="margin-top:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn primary" id="fetch-product" style="padding:6px 10px;">Fetch Details</button>
            <span class="small" id="fetch-supported">Supported vendors will auto-detect from link or part number.</span>
          </div>
        </div>
        <div class="order-catalog-fields" style="grid-column: span 2; display:none;">
          <label class="small">Saved catalog</label>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; align-items:center;">
            <input id="catalog-lookup" class="input" placeholder="Search saved parts..." />
            <div id="catalog-lookup-selected" class="small"></div>
          </div>
          <div id="catalog-lookup-results" class="tag-picker-options" style="display:none; margin-top:6px; max-height:180px; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:6px;"></div>
        </div>
        <div>
          <label class="small">Vendor</label>
          <input name="vendor" class="input" placeholder="Vendor" />
        </div>
        <div>
          <label class="small">Part Name</label>
          <input name="partName" class="input" required />
        </div>
        <div>
          <label class="small">Unit Cost</label>
          <input name="unitCost" class="input" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label class="small">Quantity</label>
          <input name="quantityRequested" class="input" type="number" min="1" value="1" required />
        </div>
        <div>
          <label class="small">Priority</label>
          <select name="priority" class="input">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tags</label>
          <select id="order-tags" name="tags" class="input" multiple size="4" style="min-height:90px; display:none;"></select>
          <div class="tag-picker" id="tag-picker">
            <div id="tag-picker-display" class="tag-picker-display">Select tags</div>
            <div id="tag-picker-panel" class="tag-picker-panel" style="display:none;">
              <input id="tag-picker-search" class="input tag-picker-search" placeholder="Search tags..." />
              <div id="tag-picker-options" class="tag-picker-options"></div>
            </div>
          </div>
          <div class="small" style="margin-top:8px;">Tags categorize requests. Open the Tags panel to view or manage them.</div>
        </div>
        <!-- Tracking managed at group level; no tracking fields for individual parts -->
        <div style="grid-column: span 2;">
          <label class="small" id="order-notes-label">Notes</label>
          <textarea name="notes" class="input" rows="3" placeholder="Justification, sizing details, links, etc."></textarea>
        </div>
        <div id="catalog-save-container" style="grid-column: span 2; display:none;">
          <div class="flex-between" style="align-items:center; gap:6px; flex-wrap:wrap;">
            <label class="small" style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="save-to-catalog-toggle" class="checkbox" />
              Save this part to the inventory catalog
            </label>
          </div>
          <div id="catalog-save-fields" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px; display:none;">
            <div>
              <label class="small">Category path</label>
              <select id="catalog-save-category" class="input"></select>
            </div>
            <div>
              <label class="small">Subteam</label>
              <input id="catalog-save-subteam" class="input" placeholder="Electrical" />
            </div>
            <div>
              <label class="small">Type</label>
              <input id="catalog-save-type" class="input" placeholder="Connector" />
            </div>
          </div>
          <div id="catalog-save-message" class="small" style="margin-top:6px;"></div>
        </div>
        <div id="catalog-save-status" class="small" style="grid-column: span 2;"></div>
        <div class="flex-between" id="order-submit-bar" style="grid-column: span 2; margin-top:6px;">
          <div id="order-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-order">Cancel</button>
            <button type="submit" class="btn primary">Submit order</button>
          </div>
        </div>
        </div>
      </form>
    </div>
  </div>

  <div id="group-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:55; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:520px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Edit Group</div>
          <div class="subtitle" style="margin-bottom:12px;">Update group title or tracking.</div>
        </div>
        <button class="btn ghost" id="close-group">Close</button>
      </div>
      <form id="group-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Group title</label>
          <input name="title" class="input" placeholder="Vendor - mm/dd/yy" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tracking numbers</label>
          <div id="group-modal-tracking-list" class="tracking-list"></div>
          <button type="button" class="btn ghost" id="add-group-modal-tracking" style="padding:6px 10px; margin-top:4px;">Add tracking</button>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea name="notes" class="input" rows="3" placeholder="Optional notes for this order group"></textarea>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="group-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-group">Cancel</button>
            <button type="submit" class="btn primary">Save group</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="catalog-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:58; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:1100px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:22px;">Inventory Catalog</div>
          <div class="subtitle" style="margin-bottom:12px;">Browse saved parts by category.</div>
        </div>
        <button class="btn ghost" id="close-catalog">Close</button>
      </div>
      <div class="grid" style="grid-template-columns: minmax(280px, 1fr) 2fr; gap:12px; align-items:start;">
        <div style="display:flex; flex-direction:column; gap:10px; padding-bottom:12px;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div class="page-title" style="font-size:15px;">Categories</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <button class="btn ghost" id="catalog-back" style="padding:6px 10px; display:none;">Back</button>
              <button class="btn ghost" id="refresh-catalog-categories" style="padding:6px 10px;">Refresh</button>
              <button class="btn primary" id="catalog-new-category" style="padding:6px 10px;">New Category</button>
            </div>
          </div>
          <div class="small" id="catalog-path-display"></div>
          <div id="catalog-category-list" class="empty" style="min-height:140px;">Loading categories...</div>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div class="flex-between" style="align-items:center; gap:8px; flex-wrap:wrap;">
            <div>
              <div class="page-title" style="font-size:15px;">Catalog items</div>
              <div class="small" id="catalog-item-hint">Select a category to focus results.</div>
            </div>
            <div class="flex-between" style="gap:6px; align-items:center; margin-left:auto; flex-wrap:nowrap;">
              <input id="catalog-item-search" class="input" placeholder="Search saved parts..." style="min-width:220px; flex:1;" />
              <button class="btn ghost" id="refresh-catalog-items" style="padding:6px 10px; white-space:nowrap;">Refresh</button>
              <button class="btn primary" id="new-catalog-item" style="padding:6px 10px; white-space:nowrap;">New item</button>
            </div>
          </div>
          <div id="catalog-item-list" class="empty">No catalog items yet.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="catalog-item-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:66; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:20px;">Catalog item</div>
          <div class="subtitle" id="catalog-item-modal-hint" style="margin-bottom:10px;">Create or edit a saved part.</div>
        </div>
      </div>
      <form id="catalog-item-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:4px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Product Number</label>
          <input name="vendorPartNumber" class="input" placeholder="SKU" />
        </div>
        <div>
          <label class="small">Supplier Link</label>
          <input name="supplierLink" class="input" placeholder="https://vendor.com/part" />
        </div>
        <div style="grid-column: span 2;">
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px;">
            <button type="button" class="btn primary" id="fetch-catalog-product" style="padding:6px 10px;">Fetch Details</button>
            <span class="small" id="fetch-supported-catalog">Supported vendors will auto-detect from link or part number.</span>
          </div>
        </div>
        <div>
          <label class="small">Vendor</label>
          <input name="vendor" class="input" placeholder="WCP, DigiKey..." />
        </div>
        <div>
          <label class="small">Part Name</label>
          <input name="name" class="input" required />
        </div>
        <div>
          <label class="small">Category Path</label>
          <input name="categoryPath" class="input" placeholder="Electrical/Connectors/Molex" />
        </div>
        <div>
          <label class="small">Unit Cost</label>
          <input name="unitCost" class="input" type="number" step="0.01" />
        </div>
        <div>
          <label class="small">Default Quantity</label>
          <input name="defaultQuantity" class="input" type="number" min="1" placeholder="1" />
        </div>
        <div>
          <label class="small">Subteam</label>
          <input name="subteam" class="input" placeholder="Electrical" />
        </div>
        <div>
          <label class="small">Type</label>
          <input name="type" class="input" placeholder="Connector" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Aliases (comma separated)</label>
          <input name="aliases" class="input" placeholder="crimp, molex, male" />
        </div>
        <div class="flex-between" style="grid-column: span 2; gap:8px; flex-wrap:wrap; margin-top:6px;">
          <div id="catalog-item-message" class="small"></div>
          <div class="flex-between" style="gap:6px;">
            <button type="button" class="btn ghost" id="cancel-catalog-item">Cancel</button>
            <button type="button" class="btn ghost" id="delete-catalog-item" style="color:var(--danger);">Delete</button>
            <button type="submit" class="btn primary">Save item</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="user-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:70; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:560px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:20px;">User management</div>
          <div class="subtitle" style="margin-bottom:10px;">Create or edit a user account.</div>
        </div>
        <button class="btn ghost" id="close-user-modal">Close</button>
      </div>
      <form id="user-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:10px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Username</label>
          <input name="username" class="input" required />
        </div>
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" required />
        </div>
        <div>
          <label class="small">Role</label>
          <select name="role" class="input">
            <option>admin</option>
            <option>mentor</option>
            <option>student</option>
          </select>
        </div>
        <div>
          <label class="small">Password (set/reset)</label>
          <input name="password" class="input" type="password" placeholder="Leave blank to keep existing" />
        </div>
        <div>
          <label class="small">Active</label>
          <select name="active" class="input">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="user-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-user">Cancel</button>
            <button type="submit" class="btn primary" id="save-user-btn">Create user</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="vendor-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:68; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:20px;">Vendor extraction</div>
          <div class="subtitle" style="margin-bottom:10px;">Create or edit vendor configurations.</div>
        </div>
        <button class="btn ghost" id="close-vendor-modal">Close</button>
      </div>
      <form id="vendor-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px; margin-top:10px;">
        <input type="hidden" name="id" />
        <input type="hidden" name="integrationKey" />
        <div id="vendor-builtin-panel" style="display:none; grid-column: span 2;">
          <div id="builtin-vendor-description" class="small" style="margin-bottom:6px;"></div>
          <div id="builtin-vendor-capabilities" class="small" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;"></div>
          <div id="builtin-fields" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;"></div>
        </div>
        <div id="vendor-custom-panel" style="display:contents;">
          <div>
            <label class="small">Vendor name</label>
            <input name="vendor" class="input" placeholder="e.g., WCP" />
          </div>
          <div>
            <label class="small">Base URL</label>
            <input name="baseUrl" class="input" placeholder="https://wcproducts.com" />
          </div>
          <div>
            <label class="small">Product URL template</label>
            <input name="productUrlTemplate" class="input" placeholder="https://wcproducts.com/products/{partNumber}" />
            <div class="small">Use {partNumber} where the SKU goes, e.g. https://vendor.com/products/{partNumber}</div>
          </div>
          <div>
            <label class="small">Part # example</label>
            <input name="partNumberExample" class="input" placeholder="WCP-0921" />
          </div>
          <div>
            <label class="small">Part # regex</label>
            <input name="partNumberPattern" class="input" placeholder="^WCP-\\d+$" />
            <div class="small">Auto-filled from example; edit to tighten/loosen validation.</div>
          </div>
          <div>
            <label class="small">Name selector</label>
            <input name="nameSelector" class="input" placeholder=".product-title" />
          </div>
          <div>
            <label class="small">Price selector</label>
            <input name="priceSelector" class="input" placeholder=".price" />
          </div>
          <div style="grid-column: span 2;">
            <label class="small">Paste copied selector or JS path</label>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px;">
              <textarea id="selector-snippet" class="input" rows="2" placeholder="Right-click → Copy selector or Copy JS path"></textarea>
              <div class="grid" style="grid-template-columns: 1fr 1fr; gap:6px;">
                <select id="selector-target" class="input">
                  <option value="nameSelector">Apply to Name</option>
                  <option value="priceSelector">Apply to Price</option>
                </select>
                <button type="button" class="btn ghost" id="apply-selector">Apply</button>
              </div>
            </div>
            <div class="small">Tip: Use “Copy selector” or “Copy JS path” from DevTools.</div>
          </div>
          <div style="grid-column: span 2;">
            <label class="small">Notes / headers JSON (optional)</label>
            <textarea name="notes" class="input" rows="2" placeholder="Headers: {\"User-Agent\":\"...\"}"></textarea>
          </div>
          <div style="grid-column: span 2;">
            <div class="small" style="margin-bottom:6px;">Test extraction (paste a product URL)</div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:8px;">
              <input id="test-url" class="input" placeholder="https://vendor.com/product/123" />
              <button type="button" class="btn primary" id="test-extract">Test</button>
            </div>
            <div id="extract-results" class="small" style="margin-top:8px;"></div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px;">
              <div>
                <label class="small">Pick name</label>
                <select id="pick-name" class="input"></select>
                <div id="preview-name" class="small"></div>
              </div>
              <div>
                <label class="small">Pick price</label>
                <select id="pick-price" class="input"></select>
                <div id="preview-price" class="small"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="vendor-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-vendor">Cancel</button>
            <button type="submit" class="btn primary">Save vendor</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="account-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:65; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:500px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:22px;">My Account</div>
      <div class="subtitle" style="margin-bottom:12px;">Update your password.</div>
      <form id="password-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:8px;">
        <div>
          <label class="small">Old password</label>
          <input name="oldPassword" class="input" type="password" required />
        </div>
        <div>
          <label class="small">New password</label>
          <input name="newPassword" class="input" type="password" required />
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="password-message" class="small"></div>
          <button type="submit" class="btn primary">Update password</button>
        </div>
      </form>
    </div>
  </div>

  <div id="catalog-category-new-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:420px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:20px;">New category</div>
      <div class="subtitle" id="catalog-category-new-path" style="margin-bottom:10px;"></div>
      <form id="catalog-category-new-form" class="grid" style="grid-template-columns:1fr; gap:10px; padding-bottom:6px;">
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" placeholder="Category name" required />
        </div>
        <div class="flex-between" style="gap:8px; margin-top:6px;">
          <div id="catalog-category-new-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="catalog-category-new-cancel">Cancel</button>
            <button type="submit" class="btn primary">Create</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="catalog-category-edit-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:460px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:20px;">Edit category</div>
      <div class="subtitle" id="catalog-category-edit-path" style="margin-bottom:10px;"></div>
      <form id="catalog-category-edit-form" class="grid" style="grid-template-columns:1fr; gap:10px; padding-bottom:6px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" required />
        </div>
        <div>
          <label class="small">Move to</label>
          <select name="parentId" class="input"></select>
        </div>
        <div class="flex-between" style="gap:8px; margin-top:6px;">
          <div id="catalog-category-edit-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="catalog-category-edit-cancel">Cancel</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="tags-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:62; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Tags &amp; priorities</div>
          <div class="subtitle" style="margin-bottom:12px;">View tags and priorities. Editing requires the Manage Tags permission.</div>
        </div>
        <button class="btn ghost" id="close-tags">Close</button>
      </div>
      <div class="flex-between" style="margin-top:10px; gap:8px;">
        <div class="flex-between" style="gap:6px; flex-wrap:wrap;">
          <button class="btn ghost" id="tags-tab-tags">Organization tags</button>
          <button class="btn ghost" id="tags-tab-priorities">Priority tags</button>
        </div>
      </div>
      <div id="tags-section" class="card" style="background:var(--panel-2); margin-top:10px;">
        <div class="flex-between" style="align-items:flex-start;">
          <div>
            <div class="page-title" style="font-size:18px;">Organization tags</div>
            <div class="subtitle" style="margin-bottom:12px;">Manage tags used to categorize requests.</div>
          </div>
          <div class="flex-between" style="gap:8px;">
            <button class="btn ghost" id="refresh-tags">Refresh</button>
          </div>
        </div>
        <form id="create-tag-form" class="admin-inline-form" style="margin-top:10px;">
          <input id="tag-color-input" class="inline-color" type="color" value="#fdd023" />
          <input id="tag-label-input" class="input" placeholder="New tag name" required style="flex:1; min-width:180px;" />
          <button type="submit" class="btn primary">New tag</button>
        </form>
        <div id="tags-message" class="small" style="margin-top:6px;"></div>
        <div id="tags-list" class="tag-manager-list" style="margin-top:10px;"></div>
      </div>
      <div id="priorities-section" class="card" style="background:var(--panel-2); margin-top:10px; display:none;">
        <div class="flex-between" style="align-items:flex-start;">
          <div>
            <div class="page-title" style="font-size:18px;">Priority tags</div>
            <div class="subtitle" style="margin-bottom:12px;">Customize priority labels and colors.</div>
          </div>
          <div class="flex-between" style="gap:8px;">
            <button class="btn ghost" id="refresh-priorities">Refresh</button>
          </div>
        </div>
        <form id="create-priority-form" class="admin-inline-form" style="margin-top:10px;">
          <input id="priority-color-input" class="inline-color" type="color" value="#fdd023" />
          <input id="priority-label-input" class="input" placeholder="Priority name (e.g., Medium)" required style="flex:1; min-width:180px;" />
          <input id="priority-sort-input" class="input" type="number" placeholder="Sort" style="width:80px;" />
          <button type="submit" class="btn primary">New priority</button>
        </form>
        <div id="priorities-message" class="small" style="margin-top:6px;"></div>
        <div id="priorities-list" class="tag-manager-list" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <div id="catalog-request-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:520px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:20px;">Request catalog item</div>
          <div class="subtitle" id="catalog-request-subtitle" style="margin-bottom:12px;">Choose quantity and confirm.</div>
        </div>
      </div>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
        <div>
          <label class="small">Quantity to request</label>
          <input id="catalog-request-qty" class="input" type="number" min="1" value="1" />
        </div>
        <div>
          <label class="small">Priority</label>
          <select id="catalog-request-priority" class="input">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tags</label>
          <select id="catalog-request-tags" class="input" multiple size="4" style="min-height:90px; display:none;"></select>
          <div class="tag-picker" id="catalog-request-tag-picker">
            <div id="catalog-request-tag-picker-display" class="tag-picker-display">Select tags</div>
            <div id="catalog-request-tag-picker-panel" class="tag-picker-panel" style="display:none;">
              <input id="catalog-request-tag-picker-search" class="input tag-picker-search" placeholder="Search tags..." />
              <div id="catalog-request-tag-picker-options" class="tag-picker-options"></div>
            </div>
          </div>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea id="catalog-request-notes" class="input" rows="3" placeholder="Add justification, sizing, links, etc."></textarea>
        </div>
      </div>
      <div class="flex-between" style="margin-top:10px;">
        <div id="catalog-request-message" class="small"></div>
        <div class="flex-between" style="gap:8px;">
          <button class="btn ghost" id="cancel-catalog-request">Cancel</button>
          <button class="btn primary" id="confirm-catalog-request">Add to requests</button>
        </div>
      </div>
    </div>
  </div>

  <div id="stock-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:63; align-items:center; justify-content:center; padding:16px;">
    <div class="tag-modal-card">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" id="stock-modal-title" style="font-size:20px;">Add Stock</div>
        <div class="subtitle" id="stock-modal-subtitle" style="margin-bottom:10px;">Pick a catalog part to track and set the starting quantity and location.</div>
        </div>
        <button class="btn ghost" id="close-stock-modal">Close</button>
      </div>
      <form id="stock-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:8px;">
        <input type="hidden" name="id" />
        <div style="grid-column: span 2;">
          <label class="small">Saved catalog</label>
          <input id="stock-catalog-search" class="input" placeholder="Search saved parts..." />
          <div id="stock-catalog-selected" class="small" style="margin-top:6px;"></div>
          <div id="stock-catalog-results" class="tag-picker-options" style="display:none; margin-top:6px; max-height:200px; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:6px;"></div>
        </div>
        <div>
          <label class="small">Subteam</label>
          <select id="stock-subteam-select" class="input"></select>
        </div>
        <div>
          <label class="small">Quantity on hand</label>
          <input id="stock-quantity" class="input" type="number" min="0" value="0" />
        </div>
        <div>
          <label class="small">Low stock alert at</label>
          <input id="stock-low" class="input" type="number" min="0" placeholder="e.g., 5" />
        </div>
        <div>
          <label class="small">Location</label>
          <input id="stock-location" class="input" placeholder="Bay, drawer, bin" />
        </div>
        <div>
          <label class="small">Stock category (per location)</label>
          <input id="stock-category" class="input" placeholder="e.g., Fasteners, Raw Stock" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea id="stock-notes" class="input" rows="2" placeholder="Label, kit info, etc."></textarea>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="stock-modal-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="delete-stock-btn" style="display:none; color: var(--danger);">Untrack</button>
            <button type="button" class="btn ghost" id="cancel-stock">Cancel</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="stock-delete-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div class="tag-modal-card" style="max-width:420px; width:100%;">
      <div class="page-title" style="font-size:20px;">Untrack stock item</div>
      <div class="subtitle" style="margin-bottom:12px;">This will remove the item from live stock tracking.</div>
      <div id="stock-delete-message" class="small" style="margin-bottom:12px;">Are you sure you want to untrack this item?</div>
      <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
        <button class="btn ghost" id="cancel-delete-stock">Cancel</button>
        <button class="btn primary" id="confirm-delete-stock" style="background: var(--danger); border-color: var(--danger); color: #fff;">Untrack</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:70; align-items:center; justify-content:center; padding:16px;">
    <div class="tag-modal-card" style="max-width:420px; width:100%;">
      <div class="page-title" style="font-size:20px;">Confirm action</div>
      <div id="confirm-message" class="subtitle" style="margin-bottom:12px;">Are you sure?</div>
      <div id="confirm-extra" style="margin-bottom:12px; display:none;"></div>
      <div id="confirm-status" class="small" style="margin-bottom:12px;"></div>
      <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
        <button class="btn ghost" id="confirm-cancel">Cancel</button>
        <button class="btn primary" id="confirm-ok" style="background: var(--danger); border-color: var(--danger); color: #fff;">Confirm</button>
      </div>
    </div>
  </div>

  <div id="vendor-export-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:72; align-items:center; justify-content:center; padding:16px;">
    <div class="tag-modal-card" style="max-width:520px; width:100%;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" id="vendor-export-title" style="font-size:20px;">Vendor export</div>
          <div class="subtitle" id="vendor-export-description" style="margin-top:2px;">Provide this data to the vendor’s quick order form.</div>
        </div>
        <button class="btn ghost" id="close-vendor-export">Close</button>
      </div>
      <div style="margin-top:12px;">
        <label class="small">Copy/paste list</label>
        <textarea id="vendor-export-text" class="input" rows="8" readonly style="margin-top:6px;"></textarea>
      </div>
      <div class="flex-between" style="gap:8px; flex-wrap:wrap; margin-top:12px;">
        <button class="btn ghost" id="vendor-export-copy">Copy list</button>
        <button class="btn primary" id="vendor-export-download">Download CSV</button>
      </div>
      <div id="vendor-export-message" class="small" style="margin-top:8px;"></div>
    </div>
  </div>

  <div id="action-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:80; align-items:center; justify-content:center;">
    <div style="background:rgba(0,0,0,0.65); color:var(--text); padding:14px 18px; border-radius:12px; display:flex; align-items:center; gap:10px; box-shadow:0 6px 30px rgba(0,0,0,0.45);">
      <div class="spinner" style="width:18px; height:18px; border:3px solid var(--border); border-top-color: var(--primary); border-radius:50%; animation:spin 0.8s linear infinite;"></div>
      <div id="action-overlay-text" class="small">Working…</div>
    </div>
  </div>

    <div id="stock-subteams-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:63; align-items:center; justify-content:center; padding:16px;">
      <div class="tag-modal-card">
        <div class="flex-between" style="align-items:flex-start;">
          <div>
          <div class="page-title" style="font-size:20px;">Stock locations</div>
          <div class="subtitle" style="margin-bottom:10px;">Control the location options used for stock filtering.</div>
          </div>
          <button class="btn ghost" id="close-subteams-modal">Close</button>
        </div>
      <form id="stock-subteam-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:6px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" placeholder="e.g., Electrical, Drivetrain" required />
        </div>
        <div>
          <label class="small">Description</label>
          <input name="description" class="input" placeholder="Optional context" />
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="stock-subteam-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="clear-subteam-form">New</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </div>
      </form>
      <div id="stock-subteam-list" class="tag-manager-list" style="margin-top:10px;"></div>
    </div>
  </div>

      <div id="admin-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:60; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Admin Panel</div>
          <div class="subtitle" style="margin-bottom:12px;">Manage users and role permissions.</div>
        </div>
        <button class="btn ghost" id="close-admin">Close</button>
      </div>

        <div class="flex-between" style="margin-top:12px; gap:8px;">
        <div class="flex-between" style="gap:6px;">
          <button class="btn ghost" id="admin-tab-users" style="padding:6px 12px;">Users</button>
          <button class="btn ghost" id="admin-tab-roles" style="padding:6px 12px;">Roles</button>
          <button class="btn ghost" id="admin-tab-tracking" style="padding:6px 12px;">Tracking</button>
          <button class="btn ghost" id="admin-tab-vendors" style="padding:6px 12px;">Vendors</button>
        </div>
      </div>

      <div id="admin-users-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div class="page-title" style="font-size:18px;">Users</div>
            <button class="btn primary" id="new-user-btn" style="padding:6px 10px;">New user</button>
          </div>
          <div id="user-list" class="small" style="margin-top:8px;">Loading users...</div>
        </div>
      </div>

      <div id="admin-roles-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
          <div class="page-title" style="font-size:18px;">Role Permissions</div>
          <div class="subtitle">Toggle what each role can do.</div>
          <div id="role-list" style="margin-top:8px;"></div>
          <div id="role-message" class="small" style="margin-top:6px;"></div>
        </div>
      </div>

      <div id="admin-tracking-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
        <div class="page-title" style="font-size:18px;">Tracking Settings</div>
        <div class="subtitle">Carrier API keys, refresh cadence, and manual refresh.</div>
        <form id="tracking-settings-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:10px;">
          <div>
            <label class="small">UPS Client ID</label>
            <input name="upsClientId" class="input" placeholder="UPS OAuth client id" />
          </div>
          <div>
            <label class="small">UPS Client Secret</label>
            <input name="upsClientSecret" class="input" placeholder="UPS OAuth client secret" />
          </div>
          <div>
            <label class="small">USPS User ID</label>
            <input name="uspsUserId" class="input" placeholder="USPS WebTools user id" />
          </div>
          <div>
            <label class="small">FedEx Client ID</label>
            <input name="fedexClientId" class="input" placeholder="FedEx API key" />
          </div>
          <div>
            <label class="small">FedEx Client Secret</label>
            <input name="fedexClientSecret" class="input" placeholder="FedEx API secret" />
          </div>
          <div>
            <label class="small">Tracking Refresh Interval (minutes)</label>
            <input name="refreshMinutes" class="input" type="number" min="1" value="30" />
          </div>
        </form>
        <div class="flex-between" style="grid-column: span 2; margin-top:8px; flex-wrap:wrap; gap:8px;">
          <div id="tracking-settings-message" class="small"></div>
          <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn ghost" id="refresh-tracking-now">Manual refresh</button>
            <button type="submit" form="tracking-settings-form" class="btn primary">Save settings</button>
          </div>
        </div>
      </div>
      </div>

      <div id="admin-vendors-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div>
              <div class="page-title" style="font-size:18px;">Vendor Extraction Settings</div>
              <div class="subtitle">Configure how to pull product details from each vendor.</div>
            </div>
            <button class="btn primary" id="new-vendor-btn" style="padding:6px 10px;">New vendor</button>
          </div>
          <div id="vendor-list" class="small" style="margin-top:10px;">Loading vendors...</div>
        </div>
      </div>

    </div>
  </div>

  </div> <!-- end app-shell -->

  <script>
    const boardEl = document.getElementById('board');
    const boardBtn = document.getElementById('board-view-btn');
    const tableBtn = document.getElementById('table-view-btn');
    const boardSection = document.getElementById('board-section');
    const tableSection = document.getElementById('table-section');
    const stockSection = document.getElementById('stock-section');
    const stockGrid = document.getElementById('stock-grid');
    const stockSubteamFilter = document.getElementById('stock-subteam-filter');
    const primaryTitle = document.getElementById('primary-title');
    const primarySubtitle = document.getElementById('primary-subtitle');
    const ordersViewBtn = document.getElementById('orders-view-btn');
    const stockViewBtn = document.getElementById('stock-view-btn');
    const ordersLayoutRow = document.getElementById('orders-layout-row');
    const ordersLayoutToggle = document.getElementById('orders-layout-toggle');
    const addStockBtn = document.getElementById('add-stock-btn');
    const manageSubteamsBtn = document.getElementById('manage-subteams-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const globalSearch = document.getElementById('global-search');
    const statusFilter = document.getElementById('status-filter');
    const vendorFilter = document.getElementById('vendor-filter');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const tableContainer = document.getElementById('table-container');
    const selectionBar = document.getElementById('selection-bar');
    const selectionCount = document.getElementById('selection-count');
    const groupVendorNote = document.getElementById('group-vendor-note');
    const selectAllBtn = document.createElement('button');
    selectAllBtn.id = 'select-all-btn';
    selectAllBtn.className = 'btn ghost';
    selectAllBtn.textContent = 'Select all';
    const selectSameVendorBtn = document.createElement('button');
    selectSameVendorBtn.id = 'select-same-vendor-btn';
    selectSameVendorBtn.className = 'btn ghost';
    selectSameVendorBtn.textContent = 'Select same vendor';
    const unselectAllBtn = document.createElement('button');
    unselectAllBtn.id = 'unselect-all-btn';
    unselectAllBtn.className = 'btn ghost';
    unselectAllBtn.textContent = 'Unselect all';
    const addToOrderBtn = document.createElement('button');
    addToOrderBtn.id = 'add-to-order-btn';
    addToOrderBtn.className = 'btn ghost';
    addToOrderBtn.textContent = 'Add to Order';
    const groupBtn = document.createElement('button');
    groupBtn.id = 'group-btn';
    groupBtn.className = 'btn primary';
    groupBtn.textContent = 'Create Order';
    const deleteSelectedBtn = document.createElement('button');
    deleteSelectedBtn.id = 'delete-selected';
    deleteSelectedBtn.className = 'btn ghost';
    deleteSelectedBtn.style.color = 'var(--danger)';
    deleteSelectedBtn.textContent = 'Delete selected';
    const undoBtn = document.createElement('button');
    undoBtn.className = 'btn ghost';
    undoBtn.id = 'undo-btn';
    undoBtn.textContent = 'Undo';
    const selectionControls = selectionBar.querySelector('.selection-actions');
    if (selectionControls) {
      selectionControls.appendChild(undoBtn);
    }
    const boardMessage = document.createElement('div');
    boardMessage.id = 'board-message';
    boardMessage.style.position = 'fixed';
    boardMessage.style.right = '16px';
    boardMessage.style.bottom = '16px';
    boardMessage.style.background = 'var(--panel)';
    boardMessage.style.border = '1px solid var(--border)';
    boardMessage.style.padding = '10px 14px';
    boardMessage.style.borderRadius = '10px';
    boardMessage.style.boxShadow = 'var(--card-shadow)';
    boardMessage.style.display = 'none';
    boardMessage.style.zIndex = '80';
    document.body.appendChild(boardMessage);
    const modal = document.getElementById('modal');
    const cancelOrder = document.getElementById('cancel-order');
    const orderForm = document.getElementById('order-form');
    const orderTrackingList = document.getElementById('order-tracking-list');
    const addOrderTracking = document.getElementById('add-order-tracking');
    const orderMessage = document.getElementById('order-message');
    const fetchProduct = document.getElementById('fetch-product');
    const newOrderBtn = document.getElementById('new-order-btn');
    const tagSelect = document.getElementById('order-tags');
    const tagPickerDisplay = document.getElementById('tag-picker-display');
    const tagPickerPanel = document.getElementById('tag-picker-panel');
    const tagPickerOptions = document.getElementById('tag-picker-options');
    const tagPickerSearch = document.getElementById('tag-picker-search');
    const tagPicker = document.getElementById('tag-picker');
    const refreshTagsBtn = document.getElementById('refresh-tags');
    const tagsList = document.getElementById('tags-list');
    const tagsMessage = document.getElementById('tags-message');
    const tagLabelInput = document.getElementById('tag-label-input');
    const tagColorInput = document.getElementById('tag-color-input');
    const createTagForm = document.getElementById('create-tag-form');
    const adminBtn = document.getElementById('admin-btn');
    const adminModal = document.getElementById('admin-modal');
    const closeAdmin = document.getElementById('close-admin');
    const accountBtn = document.getElementById('account-btn');
    const accountModal = document.getElementById('account-modal');
    const groupModal = document.getElementById('group-modal');
    const closeGroup = document.getElementById('close-group');
    const cancelGroup = document.getElementById('cancel-group');
    const groupForm = document.getElementById('group-form');
    const groupModalTrackingList = document.getElementById('group-modal-tracking-list');
    const addGroupModalTracking = document.getElementById('add-group-modal-tracking');
    const groupMessage = document.getElementById('group-message');
    const vendorForm = document.getElementById('vendor-form');
    const vendorMessage = document.getElementById('vendor-message');
    const vendorList = document.getElementById('vendor-list');
    const testUrl = document.getElementById('test-url');
    const vendorModal = document.getElementById('vendor-modal');
    const vendorCustomPanel = document.getElementById('vendor-custom-panel');
    const vendorBuiltinPanel = document.getElementById('vendor-builtin-panel');
    const builtinFieldsContainer = document.getElementById('builtin-fields');
    const builtinVendorDescription = document.getElementById('builtin-vendor-description');
    const builtinVendorCapabilities = document.getElementById('builtin-vendor-capabilities');
    const vendorSaveBtn = vendorForm?.querySelector('button[type="submit"]');
    const newVendorBtn = document.getElementById('new-vendor-btn');
    const closeVendorModalBtn = document.getElementById('close-vendor-modal');
    const cancelVendorBtn = document.getElementById('cancel-vendor');
    function resizeColumns() {
      window.requestAnimationFrame(() => {
        const main = document.querySelector('main');
        if (!main) return;
        const viewportH = document.documentElement.clientHeight;
        const mainRect = main.getBoundingClientRect();
        const padding = 24;
        const baseAvailable = Math.max(0, viewportH - mainRect.top - padding);
        if (boardSection) {
          const top = boardSection.getBoundingClientRect().top - mainRect.top;
          const available = Math.max(0, baseAvailable - top);
          if (available > 240) {
            boardSection.style.height = `${available}px`;
            boardSection.style.maxHeight = `${available}px`;
          }
        }
        if (tableSection) {
          const top = tableSection.getBoundingClientRect().top - mainRect.top;
          const available = Math.max(0, baseAvailable - top);
          if (available > 240) {
            tableSection.style.height = `${available}px`;
            tableSection.style.maxHeight = `${available}px`;
            const filtersEl = tableSection.querySelector('.filters');
            const filtersH = filtersEl ? filtersEl.getBoundingClientRect().height : 0;
            const tableAvail = available - filtersH - 24;
            if (tableContainer && tableAvail > 120) {
              tableContainer.style.height = `${tableAvail}px`;
              tableContainer.style.maxHeight = `${tableAvail}px`;
            }
          }
        }
        if (stockSection) {
          const top = stockSection.getBoundingClientRect().top - mainRect.top;
          const available = Math.max(0, baseAvailable - top);
          if (available > 240) {
            stockSection.style.height = `${available}px`;
            stockSection.style.maxHeight = `${available}px`;
            if (stockGrid) {
              stockGrid.style.maxHeight = `${available - 40}px`;
            }
          }
        }
      });
    }
    window.addEventListener('resize', resizeColumns);
    // Initial sizing after DOM paints
    setTimeout(resizeColumns, 0);
    const testExtract = document.getElementById('test-extract');
    const pickName = document.getElementById('pick-name');
    const pickPrice = document.getElementById('pick-price');
    const previewName = document.getElementById('preview-name');
    const previewPrice = document.getElementById('preview-price');
    const selectorSnippet = document.getElementById('selector-snippet');
    const selectorTarget = document.getElementById('selector-target');
    const applySelector = document.getElementById('apply-selector');
    const partExample = vendorForm.elements.partNumberExample;
    const partPattern = vendorForm.elements.partNumberPattern;
    let editingOrderId = null;
    let editingGroupId = null;
    const appShell = document.getElementById('app-shell');
    const loginPage = document.getElementById('login-page');
    const loginForm = document.getElementById('login-form');
    const loginMessage = document.getElementById('login-message');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userChip = document.getElementById('user-chip');
    const userList = document.getElementById('user-list');
    const userForm = document.getElementById('user-form');
    const userMessage = document.getElementById('user-message');
    const saveUserBtn = document.getElementById('save-user-btn');
    const newUserBtn = document.getElementById('new-user-btn');
    const userModal = document.getElementById('user-modal');
    const closeUserModalBtn = document.getElementById('close-user-modal');
    const cancelUserBtn = document.getElementById('cancel-user');
    const passwordForm = document.getElementById('password-form');
    const passwordMessage = document.getElementById('password-message');
    const roleList = document.getElementById('role-list');
    const roleMessage = document.getElementById('role-message');
    const trackingSettingsForm = document.getElementById('tracking-settings-form');
    const trackingSettingsMessage = document.getElementById('tracking-settings-message');
    const refreshTrackingNow = document.getElementById('refresh-tracking-now');
    const adminTabUsers = document.getElementById('admin-tab-users');
    const adminTabRoles = document.getElementById('admin-tab-roles');
    const adminTabTracking = document.getElementById('admin-tab-tracking');
    const adminTabVendors = document.getElementById('admin-tab-vendors');
    const adminUsersSection = document.getElementById('admin-users-section');
    const adminRolesSection = document.getElementById('admin-roles-section');
    const adminTrackingSection = document.getElementById('admin-tracking-section');
    const adminVendorsSection = document.getElementById('admin-vendors-section');
    const catalogModal = document.getElementById('catalog-modal');
    const closeCatalog = document.getElementById('close-catalog');
    const catalogBtn = document.getElementById('catalog-btn');
    const catalogNewCategoryBtn = document.getElementById('catalog-new-category');
    const catalogCategoryNewModal = document.getElementById('catalog-category-new-modal');
    const catalogCategoryNewForm = document.getElementById('catalog-category-new-form');
    const catalogCategoryNewMessage = document.getElementById('catalog-category-new-message');
    const catalogCategoryNewPath = document.getElementById('catalog-category-new-path');
    const catalogCategoryNewCancel = document.getElementById('catalog-category-new-cancel');
    const catalogCategoryEditModal = document.getElementById('catalog-category-edit-modal');
    const catalogCategoryEditForm = document.getElementById('catalog-category-edit-form');
    const catalogCategoryEditMessage = document.getElementById('catalog-category-edit-message');
    const catalogCategoryEditPath = document.getElementById('catalog-category-edit-path');
    const catalogCategoryEditCancel = document.getElementById('catalog-category-edit-cancel');
    const tagsBtn = document.getElementById('tags-btn');
    const tagsModal = document.getElementById('tags-modal');
    const closeTags = document.getElementById('close-tags');
    const tagsTabTags = document.getElementById('tags-tab-tags');
    const tagsTabPriorities = document.getElementById('tags-tab-priorities');
    const tagsSection = document.getElementById('tags-section');
    const prioritiesSection = document.getElementById('priorities-section');
    const catalogRequestModal = document.getElementById('catalog-request-modal');
    const cancelCatalogRequest = document.getElementById('cancel-catalog-request');
    const confirmCatalogRequest = document.getElementById('confirm-catalog-request');
    const catalogRequestQty = document.getElementById('catalog-request-qty');
    const catalogRequestPriority = document.getElementById('catalog-request-priority');
    const catalogRequestTags = document.getElementById('catalog-request-tags');
    const catalogRequestTagPicker = document.getElementById('catalog-request-tag-picker');
    const catalogRequestTagPickerDisplay = document.getElementById('catalog-request-tag-picker-display');
    const catalogRequestTagPickerPanel = document.getElementById('catalog-request-tag-picker-panel');
    const catalogRequestTagPickerOptions = document.getElementById('catalog-request-tag-picker-options');
    const catalogRequestTagPickerSearch = document.getElementById('catalog-request-tag-picker-search');
    const catalogRequestNotes = document.getElementById('catalog-request-notes');
    const catalogRequestMessage = document.getElementById('catalog-request-message');
    const catalogRequestSubtitle = document.getElementById('catalog-request-subtitle');
    const stockModal = document.getElementById('stock-modal');
    const stockForm = document.getElementById('stock-form');
    const stockCatalogSearch = document.getElementById('stock-catalog-search');
    const stockCatalogResults = document.getElementById('stock-catalog-results');
    const stockCatalogSelected = document.getElementById('stock-catalog-selected');
    const stockModalMessage = document.getElementById('stock-modal-message');
    const stockModalTitle = document.getElementById('stock-modal-title');
    const stockModalSubtitle = document.getElementById('stock-modal-subtitle');
    const deleteStockBtn = document.getElementById('delete-stock-btn');
    const cancelStockBtn = document.getElementById('cancel-stock');
    const closeStockModalBtn = document.getElementById('close-stock-modal');
    const stockSubteamSelect = document.getElementById('stock-subteam-select');
    const stockQuantityInput = document.getElementById('stock-quantity');
    const stockLowInput = document.getElementById('stock-low');
    const stockLocationInput = document.getElementById('stock-location');
    const stockCategoryInput = document.getElementById('stock-category');
    const stockNotesInput = document.getElementById('stock-notes');
    const stockSubteamsModal = document.getElementById('stock-subteams-modal');
    const stockSubteamForm = document.getElementById('stock-subteam-form');
    const stockSubteamList = document.getElementById('stock-subteam-list');
    const stockSubteamMessage = document.getElementById('stock-subteam-message');
    const clearSubteamFormBtn = document.getElementById('clear-subteam-form');
    const closeSubteamsModal = document.getElementById('close-subteams-modal');
    const stockDeleteModal = document.getElementById('stock-delete-modal');
    const stockDeleteMessage = document.getElementById('stock-delete-message');
    const cancelDeleteStock = document.getElementById('cancel-delete-stock');
    const confirmDeleteStock = document.getElementById('confirm-delete-stock');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmStatus = document.getElementById('confirm-status');
    const confirmCancel = document.getElementById('confirm-cancel');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmExtra = document.getElementById('confirm-extra');
    const vendorExportModal = document.getElementById('vendor-export-modal');
    const vendorExportTitle = document.getElementById('vendor-export-title');
    const vendorExportDescription = document.getElementById('vendor-export-description');
    const vendorExportText = document.getElementById('vendor-export-text');
    const vendorExportCopy = document.getElementById('vendor-export-copy');
    const vendorExportDownload = document.getElementById('vendor-export-download');
    const vendorExportMessage = document.getElementById('vendor-export-message');
    const closeVendorExport = document.getElementById('close-vendor-export');
    const actionOverlay = document.getElementById('action-overlay');
    const actionOverlayText = document.getElementById('action-overlay-text');
    const catalogBackBtn = document.getElementById('catalog-back');
    const catalogCategoryList = document.getElementById('catalog-category-list');
    const catalogPathDisplay = document.getElementById('catalog-path-display');
    const refreshPrioritiesBtn = document.getElementById('refresh-priorities');
    const prioritiesList = document.getElementById('priorities-list');
    const prioritiesMessage = document.getElementById('priorities-message');
    const priorityLabelInput = document.getElementById('priority-label-input');
    const priorityColorInput = document.getElementById('priority-color-input');
    const prioritySortInput = document.getElementById('priority-sort-input');
    const createPriorityForm = document.getElementById('create-priority-form');
    const orderSourceManual = document.getElementById('order-source-manual');
    const orderSourceCatalog = document.getElementById('order-source-catalog');
    const orderSourceImport = document.getElementById('order-source-import');
    const orderManualFields = document.querySelectorAll('.order-manual-fields');
    const orderCatalogFields = document.querySelectorAll('.order-catalog-fields');
    const orderImportFields = document.getElementById('order-import-fields');
    const orderStandardFields = document.getElementById('order-standard-fields');
    const orderSubmitBar = document.getElementById('order-submit-bar');
    const vendorImportSelect = document.getElementById('vendor-import-vendor');
    const vendorImportInstructions = document.getElementById('vendor-import-instructions');
    const vendorImportFile = document.getElementById('vendor-import-file');
    const vendorImportText = document.getElementById('vendor-import-text');
    const vendorImportParseBtn = document.getElementById('vendor-import-parse');
    const vendorImportClearBtn = document.getElementById('vendor-import-clear');
    const vendorImportMessage = document.getElementById('vendor-import-message');
    const vendorImportPreview = document.getElementById('vendor-import-preview');
    const vendorImportActions = document.getElementById('vendor-import-actions');
    const vendorImportSummary = document.getElementById('vendor-import-summary');
    const vendorImportSubmit = document.getElementById('vendor-import-submit');
    const catalogLookupInput = document.getElementById('catalog-lookup');
    const catalogLookupResults = document.getElementById('catalog-lookup-results');
    const catalogLookupSelected = document.getElementById('catalog-lookup-selected');
    const catalogSaveContainer = document.getElementById('catalog-save-container');
    const catalogSaveFields = document.getElementById('catalog-save-fields');
    const saveToCatalogToggle = document.getElementById('save-to-catalog-toggle');
    const catalogSaveCategory = document.getElementById('catalog-save-category');
    const catalogSaveSubteam = document.getElementById('catalog-save-subteam');
    const catalogSaveType = document.getElementById('catalog-save-type');
    const catalogSaveMessage = document.getElementById('catalog-save-message');
    const catalogSaveStatus = document.getElementById('catalog-save-status');
    const refreshCatalogCategoriesBtn = document.getElementById('refresh-catalog-categories');
    const catalogItemSearch = document.getElementById('catalog-item-search');
    const refreshCatalogItemsBtn = document.getElementById('refresh-catalog-items');
    const newCatalogItemBtn = document.getElementById('new-catalog-item');
    const catalogItemList = document.getElementById('catalog-item-list');
    const catalogItemForm = document.getElementById('catalog-item-form');
    const catalogItemMessage = document.getElementById('catalog-item-message');
    const fetchCatalogProductBtn = document.getElementById('fetch-catalog-product');
    const deleteCatalogItemBtn = document.getElementById('delete-catalog-item');
    const cancelCatalogItemBtn = document.getElementById('cancel-catalog-item');
    const catalogItemHint = document.getElementById('catalog-item-hint');
    const catalogItemModal = document.getElementById('catalog-item-modal');
    const orderNotesLabel = document.getElementById('order-notes-label');
    const catalogItemModalHint = document.getElementById('catalog-item-modal-hint');
    let activeAdminTab = null;
    const ROLE_DEFAULT_PERMS = {
      admin: { canPlacePartRequests: true, canManageOwnPartRequests: true, canManagePartRequests: true, canManageOrders: true, canManageVendors: true, canManageUsers: true, canManageTags: true, canEditInventoryCatalog: true, canEditTrackingSettings: true, canManageStock: true, canEditStock: true, notesNotRequired: true, canImportBulkOrders: true },
      mentor: { canPlacePartRequests: true, canManageOwnPartRequests: true, canManagePartRequests: true, canManageOrders: true, canManageVendors: true, canManageUsers: false, canManageTags: true, canEditInventoryCatalog: true, canEditTrackingSettings: true, canManageStock: true, canEditStock: true, notesNotRequired: true, canImportBulkOrders: false },
      student: { canPlacePartRequests: true, canManageOwnPartRequests: false, canManagePartRequests: false, canManageOrders: false, canManageVendors: false, canManageUsers: false, canManageTags: false, canEditInventoryCatalog: false, canEditTrackingSettings: false, canManageStock: false, canEditStock: false, notesNotRequired: false, canImportBulkOrders: false }
    };
    function computePerms(user) {
      const role = (user?.role || 'student').toLowerCase();
      const defaults = ROLE_DEFAULT_PERMS[role] || ROLE_DEFAULT_PERMS.student;
      const provided = user?.permissions || {};
      // Only fill missing keys with defaults; honor server-provided permissions
      const merged = { ...defaults };
      Object.keys(provided).forEach(k => { merged[k] = provided[k]; });
      return merged;
    }
    const BUILTIN_CAPABILITY_LABELS = {
      productLookup: 'API autofill',
      quickOrderImport: 'Quick order import',
      quickOrderExport: 'Quick order export',
      cartSyncPlanned: 'Cart sync (planned)'
    };
    const VENDOR_CUSTOM_DISPLAY = 'contents';
    let vendorConfigs = [];
    let customVendorConfigs = [];
    let builtinVendorConfigsState = [];
    let currentUser = null;
    let vendorFormMode = 'custom';
    let builtinFieldInputs = [];
    let activeBuiltinVendor = null;
    let vendorImportEntries = [];
    let vendorImportVendor = null;
    let orderSource = 'manual';
    let vendorExportData = null;
    let xlsxLoaderPromise = null;
    renderVendorImportPreview();
    function detectVendor(partNum, link) {
      if (!vendorConfigs?.length) return null;
      const normalizedLink = (link || '').toLowerCase();
      const candidates = vendorConfigs.filter(v => {
        let regex = null;
        if (v.partNumberPattern) {
          try {
            regex = new RegExp(v.partNumberPattern, 'i');
          } catch (e) {
            regex = null;
          }
        }
        const baseMatch = v.baseUrl && normalizedLink && normalizedLink.includes(v.baseUrl.toLowerCase());
        const patternMatch = regex && partNum && regex.test(partNum);
        const domainMatch = Array.isArray(v.detectionHints?.domains) && normalizedLink
          ? v.detectionHints.domains.some(domain => normalizedLink.includes(domain.toLowerCase()))
          : false;
        return baseMatch || patternMatch || domainMatch;
      });
      if (candidates.length === 1) return candidates[0];
      return null;
    }

    function renderVendorOptions() {
      const supported = vendorConfigs.map(v => v.vendor).filter(Boolean);
      const msg = supported.length
        ? `Supported vendors: ${supported.join(', ')}, Shopify-Based Sites`
        : 'Supported vendors: none configured yet; use manual entry';
      const fetchSupportedEl = document.getElementById('fetch-supported');
      const fetchSupportedCatalogEl = document.getElementById('fetch-supported-catalog');
      if (fetchSupportedEl) fetchSupportedEl.textContent = msg;
      if (fetchSupportedCatalogEl) fetchSupportedCatalogEl.textContent = msg;
    }

    function vendorOptionValue(v) {
      return (v?.key || v?.slug || v?.vendor || v?._id || '').toString().toLowerCase();
    }

    function renderVendorImportOptions() {
      if (!vendorImportSelect) return;
      if (!canUseVendorImport()) {
        vendorImportSelect.innerHTML = '<option value="">Select vendor</option>';
        vendorImportSelect.disabled = true;
        vendorImportVendor = null;
        updateVendorImportInstructions();
        renderVendorImportPreview();
        return;
      }
      const options = vendorConfigs.filter(v => v?.capabilities?.quickOrderImport);
      const previous = vendorImportSelect.value;
      vendorImportSelect.innerHTML = ['<option value="">Select vendor</option>']
        .concat(options.map(v => `<option value="${vendorOptionValue(v)}">${escapeHtml(v.vendor || v.slug || v.key || 'Vendor')}</option>`))
        .join('');
      if (!options.length) {
        vendorImportSelect.disabled = true;
        if (vendorImportInstructions) {
          vendorImportInstructions.textContent = 'No vendors have quick import configured yet.';
        }
      } else {
        vendorImportSelect.disabled = false;
        const match = options.find(v => vendorOptionValue(v) === previous);
        vendorImportSelect.value = match ? previous : '';
        vendorImportVendor = match || null;
        updateVendorImportInstructions();
      }
      renderVendorImportPreview();
    }

    function canUseVendorImport() {
      return Boolean(currentUser?.permissions?.canImportBulkOrders);
    }

    function requiresOrderNotes() {
      return !currentUser?.permissions?.notesNotRequired;
    }

    function syncOrderNotesRequirement() {
      const required = requiresOrderNotes();
      const notesInput = orderForm?.elements?.notes;
      if (notesInput) notesInput.required = required;
      if (orderNotesLabel) orderNotesLabel.textContent = required ? 'Notes (required)' : 'Notes';
    }

    function syncVendorImportVisibility() {
      const allowed = canUseVendorImport();
      if (orderSourceImport) orderSourceImport.style.display = allowed ? 'inline-flex' : 'none';
      if (!allowed) {
        if (orderImportFields) orderImportFields.style.display = 'none';
        if (orderSource === 'import') setOrderSource('manual');
        vendorImportVendor = null;
        if (vendorImportSelect) {
          vendorImportSelect.value = '';
          vendorImportSelect.disabled = true;
        }
        if (vendorImportInstructions) {
          vendorImportInstructions.textContent = 'Bulk vendor import is disabled for this account.';
        }
        if (vendorImportActions) vendorImportActions.style.display = 'none';
      } else {
        if (vendorImportSelect) vendorImportSelect.disabled = false;
        updateVendorImportInstructions();
      }
    }

    function updateVendorImportInstructions() {
      if (!vendorImportInstructions) return;
      if (!canUseVendorImport()) {
        vendorImportInstructions.textContent = 'Bulk vendor import is disabled for this account.';
        return;
      }
      if (!vendorImportVendor) {
        vendorImportInstructions.textContent = 'Upload a supported vendor CSV or paste part numbers and quantities.';
        return;
      }
      if (isDigikeyVendor(vendorImportVendor)) {
        vendorImportInstructions.textContent = 'For Digi-Key, download the cart CSV or paste lines like "2,WM10548-ND".';
      } else if (isMouserVendor(vendorImportVendor)) {
        vendorImportInstructions.textContent = 'For Mouser, upload the cart XLS/CSV export or paste lines like "2,595-12345".';
      } else {
        vendorImportInstructions.textContent = `Import items from ${vendorImportVendor.vendor || 'this vendor'} using a CSV or part number list.`;
      }
    }

    function setOrderSource(source) {
      const importAllowed = canUseVendorImport();
      if (source === 'import' && !importAllowed) {
        if (currentUser) {
          showBoardMessage('Bulk vendor import is disabled for this account.', 'error', 2500);
        }
        source = 'manual';
      }
      orderSource = source === 'catalog' ? 'catalog' : (source === 'import' ? 'import' : 'manual');
      const showImport = orderSource === 'import' && importAllowed;
      if (orderSourceManual) orderSourceManual.classList.toggle('primary', orderSource === 'manual');
      if (orderSourceCatalog) orderSourceCatalog.classList.toggle('primary', orderSource === 'catalog');
      if (orderSourceImport) orderSourceImport.classList.toggle('primary', showImport);
      orderManualFields?.forEach(el => { if (el) el.style.display = orderSource === 'manual' ? '' : 'none'; });
      orderCatalogFields?.forEach(el => { if (el) el.style.display = orderSource === 'catalog' ? '' : 'none'; });
      if (orderImportFields) orderImportFields.style.display = showImport ? 'block' : 'none';
      if (orderStandardFields) orderStandardFields.style.display = showImport ? 'none' : 'contents';
      if (orderSubmitBar) orderSubmitBar.style.display = showImport ? 'none' : 'flex';
      if (vendorImportActions) vendorImportActions.style.display = (showImport && vendorImportEntries.length) ? 'flex' : 'none';
      if (orderForm) orderForm.noValidate = showImport;
      if (orderSource === 'manual') {
        resetCatalogLookup();
        scheduleCatalogPresenceCheck();
      } else if (orderSource === 'catalog') {
        if (catalogLookupInput) catalogLookupInput.focus();
      } else if (showImport) {
        if (vendorImportSelect && !vendorImportSelect.value) {
          vendorImportSelect.focus();
        }
      }
    }

    orderSourceManual?.addEventListener('click', () => setOrderSource('manual'));
    orderSourceCatalog?.addEventListener('click', () => setOrderSource('catalog'));
    orderSourceImport?.addEventListener('click', () => {
      if (!canUseVendorImport()) {
        showBoardMessage('Bulk vendor import is disabled for this account.', 'error', 2500);
        return;
      }
      setOrderSource('import');
    });

    const statuses = [
      { label: 'To order', status: 'Requested', hint: 'Parts requests - awaiting purchase' },
      { label: 'Ordered', status: 'Ordered', hint: 'Placed orders - awaiting arrival' },
      { label: 'Arrived', status: 'Received', hint: 'Items received' }
    ];
    const getOrderTimestamp = (order) => {
      if (!order) return 0;
      const raw = order.requestedDisplayAt || order.requestedAt || Date.parse(order.createdAt || '') || 0;
      const num = Number(raw);
      return Number.isFinite(num) ? num : 0;
    };
    const getGroupTimestamp = (ordersInGroup = []) => {
      const first = ordersInGroup[0];
      if (!first) return 0;
      const raw = first.group?.requestedDisplayAt || first.group?.createdAt || getOrderTimestamp(first);
      const num = Number(raw);
      return Number.isFinite(num) ? num : 0;
    };
    const carrierOptions = [
      { value: 'ups', label: 'UPS' },
      { value: 'usps', label: 'USPS' },
      { value: 'fedex', label: 'FedEx' },
      { value: 'other', label: 'Other/Unknown' }
    ];

    const DEFAULT_TRACKING_POLL_MINUTES = 1;
    let trackingPollTimer = null;
    let trackingPollMinutes = DEFAULT_TRACKING_POLL_MINUTES;
    function startTrackingAutoRefresh(minutes = trackingPollMinutes) {
      const next = Math.max(1, Number(minutes) || DEFAULT_TRACKING_POLL_MINUTES);
      trackingPollMinutes = next;
      const ms = next * 60 * 1000;
      if (trackingPollTimer) clearInterval(trackingPollTimer);
      trackingPollTimer = setInterval(() => {
        if (!currentUser) return;
        fetchOrders();
      }, ms);
    }

    const emptyParts = [];
    setTrackingRows(orderTrackingList, [], emptyParts);
    setTrackingRows(groupModalTrackingList, [], emptyParts);
    addOrderTracking?.addEventListener('click', () => createTrackingRow(orderTrackingList, {}, emptyParts));
    addGroupModalTracking?.addEventListener('click', () => createTrackingRow(groupModalTrackingList, {}, emptyParts));

    let orders = [];
    let selected = new Set();
    let expandedGroups = new Set();
    const undoStack = [];
    const redoStack = [];
    let tagList = [];
    let priorityList = [];
    let catalogCategories = [];
    let catalogTree = [];
    let catalogItems = [];
    let catalogLookupMatches = [];
    let selectedCatalogMatch = null;
    let selectedCatalogCategoryId = null;
    let selectedCatalogItemId = null;
    let catalogAlreadySaved = false;
    let catalogAlreadySavedItem = null;
    let catalogPresenceTimer = null;
    let catalogLookupTimer = null;
    let catalogItemSearchTimer = null;
    let activeTagsTab = 'tags';
    let pendingCatalogRequest = null;
    const defaultPriorityLabel = () => {
      const list = priorityList && priorityList.length ? priorityList : defaultPriorities;
      return list.length ? list[0].label : 'Medium';
    };
    const defaultPriorities = [
      { label: 'Low', color: '#5aa0ff', sortOrder: 1 },
      { label: 'Medium', color: '#fdd023', sortOrder: 2 },
      { label: 'High', color: '#ff8b55', sortOrder: 3 },
      { label: 'Urgent', color: '#ff5565', sortOrder: 4 }
    ];
    let catalogNavStack = [];
    let currentCatalogCategoryId = 'root';
    let stockItems = [];
    let stockSubteams = [];
    let selectedStockSubteam = 'all';
    let activePrimaryView = 'orders';
    let selectedStockCatalogItem = null;
    let stockCatalogSearchTimer = null;
    let stockSearchTimer = null;
    let pendingDeleteStockId = null;
    let pendingConfirmAction = null;
    let pendingConfirmExtraGetter = null;
    let actionBusy = false;

    function setActionBusy(busy, text) {
      actionBusy = busy;
      if (!actionOverlay) return;
      actionOverlay.style.display = busy ? 'flex' : 'none';
      if (actionOverlayText) actionOverlayText.textContent = text || 'Working…';
    }
    function setAuthenticated(authenticated) {
      if (appShell) appShell.style.display = authenticated ? '' : 'none';
      if (loginPage) loginPage.style.display = authenticated ? 'none' : 'flex';
    }
    let addToOrderMode = false;
    let addToOrderVendor = null;
    orderSourceManual?.addEventListener('click', () => setOrderSource('manual'));
    orderSourceCatalog?.addEventListener('click', () => setOrderSource('catalog'));
    setOrderSource('manual');
    syncOrderNotesRequirement();
    syncVendorImportVisibility();

    function updateSearchPlaceholder() {
      if (!globalSearch) return;
      globalSearch.placeholder = activePrimaryView === 'stock'
        ? 'Search stock...'
        : 'Search parts, suppliers, users...';
    }

    function updateUndoRedoUI() {
      if (undoBtn) undoBtn.disabled = undoStack.length === 0;
      // redo button removed
    }

    function recordAction(record) {
      undoStack.push(record);
      redoStack.length = 0;
      updateUndoRedoUI();
    }

    async function approveOrder(id, status = 'approved') {
      await fetch(`/api/orders/${id}/approval`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ approvalStatus: status })
      });
    }
    function getOrderById(id) {
      return orders.find(o => o._id === id);
    }
    function getOrderVendor(order) {
      return (order?.supplier || order?.vendor || '').toLowerCase();
    }
    function isOwnOrder(order) {
      if (!order || !currentUser?.name) return false;
      return (order.studentName || '').toLowerCase() === currentUser.name.toLowerCase();
    }
    function snapshotOrder(id) {
      const o = orders.find(o => o._id === id);
      return o ? JSON.parse(JSON.stringify(o)) : null;
    }
    function sanitizeOrderForCreate(order) {
      if (!order) return null;
      const allowed = [
        'category','csvFileLink','department','fetchedName','fetchedPrice','groupId','justification','notes',
        'partCode','partId','partLink','partName','priority','productCode','quantityRequested','status','studentId',
        'studentName','supplier','supplierLink','totalCost','tracking','trackingNumber','unitCost','vendor','vendorPartNumber','requestedDisplayAt',
        'approvalStatus','approvedBy','approvedAt','tags'
      ];
      const clean = {};
      allowed.forEach(k => {
        if (order[k] !== undefined) clean[k] = order[k];
      });
      if (order.requestedAt && !clean.requestedDisplayAt) clean.requestedDisplayAt = order.requestedAt;
      if (Array.isArray(clean.tracking)) {
        clean.tracking = clean.tracking.map(t => {
          const { carrier, trackingNumber, status, eta, trackingUrl, lastCheckedAt, lastUpdated, lastEvent, delivered } = t || {};
          if (!trackingNumber) return null;
          return { carrier: carrier || 'other', trackingNumber, status, eta, trackingUrl, lastCheckedAt, lastUpdated, lastEvent, delivered };
        }).filter(Boolean);
      }
      clean.quantityRequested = Number(clean.quantityRequested || 1);
      clean.unitCost = clean.unitCost !== undefined ? Number(clean.unitCost) : clean.unitCost;
      clean.totalCost = clean.totalCost !== undefined ? Number(clean.totalCost) : clean.totalCost;
      if (!clean.partName) clean.partName = 'Restored order';
      clean.studentName = clean.studentName || 'Restored';
      clean.status = clean.status || 'Requested';
      return clean;
    }

    async function applyStep(step, counterpart) {
      switch (step.type) {
        case 'deleteOrder': {
          await fetch(`/api/orders/${step.payload.orderId}`, { method: 'DELETE' });
          break;
        }
        case 'restoreOrder': {
          const o = sanitizeOrderForCreate(step.payload.order);
          if (!o) break;
          if (step.payload.order?.requestedDisplayAt || step.payload.order?.requestedAt) {
            o.requestedDisplayAt = step.payload.order.requestedDisplayAt || step.payload.order.requestedAt;
          }
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...o,
              groupId: undefined // will reassign after
            })
          });
          const data = await res.json();
          const newId = data.order?.orderId || data.orderId || data.order?._id;
          if (step.payload.groupId && newId) {
            await assignGroup(newId, step.payload.groupId);
          }
          if (counterpart && counterpart.type === 'deleteOrder') {
            counterpart.payload.orderId = newId;
          }
          break;
        }
        case 'updateOrder': {
          await fetch(`/api/orders/${step.payload.orderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(step.payload.data)
          });
          break;
        }
        case 'updateStatus': {
          await patchStatusOnly(step.payload.orderId, step.payload.status, step.payload.trackingNumber);
          if (step.payload.groupId !== undefined) {
            await assignGroup(step.payload.orderId, step.payload.groupId);
          }
          break;
        }
        case 'bulkStatus': {
          if (Array.isArray(step.payload?.entries)) {
            for (const entry of step.payload.entries) {
              await patchStatusOnly(entry.orderId, entry.status, entry.trackingNumber);
              if (entry.groupId !== undefined) {
                await assignGroup(entry.orderId, entry.groupId);
              }
            }
          }
          break;
        }
        case 'assignGroup': {
          await assignGroup(step.payload.orderId, step.payload.groupId);
          break;
        }
        case 'createGroup': {
      const res = await fetch('/api/order-groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: step.payload.title,
              supplier: step.payload.supplier,
              requestedDisplayAt: step.payload.requestedDisplayAt,
              orderIds: step.payload.orderIds
            })
          });
          const data = await res.json();
          const newGroupId = data.groupId || data._id;
          if (Array.isArray(step.payload.orderIds)) {
            for (const oid of step.payload.orderIds) {
              await patchStatusOnly(oid, step.payload.status || 'Ordered');
              await assignGroup(oid, newGroupId);
            }
          }
          if (step.payload.notes || (step.payload.tracking && step.payload.tracking.length)) {
            await fetch(`/api/order-groups/${newGroupId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ notes: step.payload.notes, tracking: step.payload.tracking })
            });
          }
          if (counterpart && counterpart.type === 'deleteGroup') {
            counterpart.payload.groupId = newGroupId;
          }
          break;
        }
        case 'restoreOrders': {
          const manageOverlay = !actionBusy;
          if (manageOverlay) setActionBusy(true, 'Restoring…');
          if (Array.isArray(step.payload?.orders)) {
            let newGroupId = null;
            if (step.payload.group) {
              const g = step.payload.group;
              try {
                const res = await fetch('/api/order-groups', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    title: g.title,
                    supplier: g.supplier,
                    requestedDisplayAt: g.requestedDisplayAt,
                    status: g.status || 'Ordered',
                    tracking: g.tracking || [],
                    notes: g.notes || ''
                  })
                });
                const data = await res.json();
                newGroupId = data.groupId || data._id || null;
              } catch (err) {
                console.warn('Failed to recreate group during restore', err);
              }
            }
            for (const o of step.payload.orders) {
              const sanitized = sanitizeOrderForCreate(o);
              if (!sanitized) continue;
              const res = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  ...sanitized,
                  groupId: undefined
                })
              });
              const data = await res.json();
              const newId = data.order?.orderId || data.orderId || data.order?._id;
              const targetGroupId = newGroupId || o.groupId || null;
              if (targetGroupId && newId) {
                await assignGroup(newId, targetGroupId);
              }
              if (o.status && newId) {
                await patchStatusOnly(newId, o.status, Array.isArray(o.tracking) ? o.tracking[0]?.trackingNumber : undefined);
              }
            }
          }
          if (manageOverlay) setActionBusy(false);
          break;
        }
        case 'deleteOrders': {
          const manageOverlay = !actionBusy;
          if (manageOverlay) setActionBusy(true, 'Deleting…');
          if (Array.isArray(step.payload?.orderIds)) {
            await Promise.all(step.payload.orderIds.map(oid => fetch(`/api/orders/${oid}`, { method: 'DELETE' })));
          }
          if (manageOverlay) setActionBusy(false);
          break;
        }
        case 'deleteGroup': {
          if (Array.isArray(step.payload?.orderIds)) {
            await Promise.all(step.payload.orderIds.map(async oid => {
              await assignGroup(oid, undefined);
              await patchStatusOnly(oid, 'Requested');
            }));
          }
          await fetch(`/api/order-groups/${step.payload.groupId}`, { method: 'DELETE' });
          break;
        }
        case 'updateGroup': {
          await fetch(`/api/order-groups/${step.payload.groupId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(step.payload.data)
          });
          break;
        }
        default:
          break;
      }
    }

    async function doUndo() {
      const record = undoStack.pop();
      if (!record) return;
      if (!actionBusy) setActionBusy(true, 'Working…');
      await applyStep(record.undo, record.redo);
      updateUndoRedoUI();
      await fetchOrders();
      if (actionBusy) setActionBusy(false);
    }

    function fmtDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleString();
    }
    function formatShortDate(date = new Date()) {
      return `${date.getMonth() + 1}/${date.getDate()}/${String(date.getFullYear()).slice(-2)}`;
    }
    function formatTimeShort(date = new Date()) {
      return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    function formatDateOnly(input) {
      if (!input) return '';
      // If we get an ISO-ish string, parse the date portion explicitly to avoid TZ shifts.
      if (typeof input === 'string') {
        const match = input.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          const y = Number(match[1]);
          const m = Number(match[2]);
          const d = Number(match[3]);
          if (y && m && d) return `${m}/${d}/${String(y).slice(-2)}`;
        }
      }
      const date = new Date(input);
      if (Number.isNaN(date.getTime())) return '';
      // Use UTC components to avoid local TZ shifting ETA dates.
      const m = date.getUTCMonth() + 1;
      const d = date.getUTCDate();
      const y = String(date.getUTCFullYear()).slice(-2);
      return `${m}/${d}/${y}`;
    }
    function formatDateMaybe(value) {
      if (!value) return '';
      if (typeof value === 'number') return formatDateOnly(value);
      const parsed = Date.parse(value);
      if (!Number.isNaN(parsed)) return formatDateOnly(parsed);
      return value;
    }
    function getTagLabel(id) {
      const t = tagList.find(t => String(t._id || t.id || t.label) === String(id));
      return t ? t.label : id;
    }
    function getTagColor(id) {
      const t = tagList.find(t => String(t._id || t.id || t.label) === String(id));
      return t ? (t.color || '#fdd023') : '#fdd023';
    }
    function getPriorityColor(label) {
      const p = priorityList.find(p => (p.label || '').toLowerCase() === (label || '').toLowerCase());
      return p ? (p.color || '#fdd023') : '#fdd023';
    }
    function renderTagChips(ids = []) {
      if (!ids || !ids.length) return '';
      return ids.map(tid => {
        const label = getTagLabel(tid);
        const color = getTagColor(tid);
        return `<span class="tag" style="background:${color}22; border-color:${color}; color:${color};">${escapeHtml(label)}</span>`;
      }).join('');
    }
    function getSelectedTagIds() {
      if (!tagSelect) return [];
      return Array.from(tagSelect.selectedOptions || []).map(o => o.value);
    }
    function escapeHtml(str = '') {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function createTrackingRow(container, data = {}, partsOptions = []) {
      if (!container) return;
      const row = document.createElement('div');
      row.className = 'tracking-row';
      row.innerHTML = `
        <select class="input tracking-carrier">
          ${carrierOptions.map(c => `<option value="${c.value}">${c.label}</option>`).join('')}
        </select>
        <input class="input tracking-number" placeholder="Tracking number" value="${data.trackingNumber || data.number || ''}" />
        <button type="button" class="btn ghost remove-tracking" style="padding:6px 10px;">Remove</button>
        <div class="small" style="width:100%;">Parts in this shipment (optional)</div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px; width:100%;">
          <select class="input tracking-parts" multiple size="${Math.min(Math.max(partsOptions.length, 2), 6)}">
            ${partsOptions.map(p => `<option value="${p.id}">${escapeHtml(p.label)}</option>`).join('')}
          </select>
          <button type="button" class="btn ghost select-all-parts" style="padding:6px 10px;">Select all</button>
        </div>
      `;
      const select = row.querySelector('.tracking-carrier');
      const carrier = (data.carrier || '').toLowerCase();
      if (carrier) select.value = carrier;
      row.querySelector('.remove-tracking').addEventListener('click', () => {
        row.remove();
        if (!container.querySelector('.tracking-row')) {
          createTrackingRow(container, {}, partsOptions);
        }
      });
      const partsSelect = row.querySelector('.tracking-parts');
      const selectAllBtn = row.querySelector('.select-all-parts');
      if (partsSelect && Array.isArray(data.parts)) {
        Array.from(partsSelect.options).forEach(opt => {
          if (data.parts.includes(opt.value)) opt.selected = true;
        });
      }
      selectAllBtn?.addEventListener('click', () => {
        Array.from(partsSelect.options).forEach(opt => { opt.selected = true; });
      });
      container.appendChild(row);
    }

    function setTrackingRows(container, entries = [], partsOptions = []) {
      if (!container) return;
      container.innerHTML = '';
      const list = Array.isArray(entries) && entries.length ? entries : [];
      if (!list.length) {
        createTrackingRow(container, {}, partsOptions);
        return;
      }
      list.forEach(entry => createTrackingRow(container, entry, partsOptions));
    }

    function collectTrackingRows(container) {
      if (!container) return [];
      const rows = Array.from(container.querySelectorAll('.tracking-row'));
      return rows.map(row => {
        const number = row.querySelector('.tracking-number')?.value.trim();
        const carrier = row.querySelector('.tracking-carrier')?.value || 'other';
        if (!number) return null;
        const partsSel = row.querySelector('.tracking-parts');
        const parts = partsSel ? Array.from(partsSel.selectedOptions).map(o => o.value) : undefined;
        return { carrier, trackingNumber: number, parts: parts && parts.length ? parts : undefined };
      }).filter(Boolean);
    }

    function trackingFromOrder(order) {
      if (!order) return [];
      if (Array.isArray(order.tracking) && order.tracking.length) return order.tracking;
      if (order.trackingNumber) return [{ carrier: order.carrier || 'unknown', trackingNumber: order.trackingNumber }];
      return [];
    }

    function trackingLink(carrier, num, fallback) {
      if (fallback) return fallback;
      if (!num) return '';
      const c = (carrier || '').toLowerCase();
      if (c === 'ups') return `https://www.ups.com/track?tracknum=${encodeURIComponent(num)}`;
      if (c === 'usps') return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${encodeURIComponent(num)}`;
      if (c === 'fedex') return `https://www.fedex.com/fedextrack/?tracknumbers=${encodeURIComponent(num)}`;
      return '';
    }

    function attachBackdropClose(el, handler) {
      if (!el || typeof handler !== 'function') return;
      let downOnBackdrop = false;
      el.addEventListener('pointerdown', (e) => {
        downOnBackdrop = e.target === el;
      });
      el.addEventListener('pointerup', (e) => {
        if (downOnBackdrop && e.target === el) handler();
        downOnBackdrop = false;
      });
    }

    function trackingPhase(tracking) {
      const carrierSupported = ['ups','usps','fedex'].includes((tracking.carrier || '').toLowerCase());
      if (tracking.delivered || tracking.cache?.delivered) return 'delivered';
      const statusText = (tracking.status || tracking.cache?.status || tracking.cache?.summary || '').toLowerCase();
      if (!carrierSupported) return 'unknown';
      if (/label|pending|ready for shipment|not shipped|waiting|created/i.test(statusText)) return 'pending';
      return 'intransit';
    }

    function renderTrackingBadges(tracking = []) {
      const list = Array.isArray(tracking) ? tracking.filter(t => t && t.trackingNumber) : [];
      if (!list.length) return '';
      return `<div class="tracking-badges">${
        list.map(t => {
          const url = trackingLink(t.carrier, t.trackingNumber, t.trackingUrl || t.cache?.trackingUrl);
          const label = `${(t.carrier || 'TRACK').toUpperCase()} ${t.trackingNumber}`;
          const status = t.cache?.status || t.cache?.summary || t.status || '';
          const delivered = Boolean(t.cache?.delivered);
          const deliveredOn = delivered
            ? (t.cache?.lastEventTime || t.cache?.deliveredTime || t.deliveredTime || t.lastUpdated || t.lastEvent || t.lastUpdatedAt || t.lastCheckedAt || t.cache?.lastCheckedAt)
            : undefined;
          const etaText = !delivered ? (t.cache?.eta || t.eta) : undefined;
          const subtitleParts = [];
          if (delivered) {
            subtitleParts.push(`Delivered${deliveredOn ? ' on ' + formatDateOnly(deliveredOn) : ''}`);
          } else if (etaText) {
            const etaFmt = formatDateMaybe(etaText);
            subtitleParts.push(`ETA ${etaFmt || etaText}`);
          } else if (status) {
            subtitleParts.push(status);
          } else {
            subtitleParts.push('Refreshing status…');
          }
          const subtitle = subtitleParts.filter(Boolean).join(' · ');
          const safeSubtitle = escapeHtml(subtitle || '');
          const safeLabel = escapeHtml(label || '');
          const phase = trackingPhase(t);
          const badge = `<span class="tag tracking ${phase}" title="${safeSubtitle || 'Open tracking'}">${safeLabel}${subtitle ? ' · ' + safeSubtitle : ''}</span>`;
          return url ? `<a href="${url}" target="_blank" rel="noopener noreferrer">${badge}</a>` : badge;
        }).join('')
      }</div>`;
    }
    function showBoardMessage(text, type = 'info', timeout = 3500) {
      boardMessage.textContent = text;
      boardMessage.style.borderColor = type === 'error' ? 'var(--danger)' : 'var(--border)';
      boardMessage.style.color = type === 'error' ? 'var(--danger)' : 'var(--text)';
      boardMessage.style.display = 'block';
      if (showBoardMessage._t) clearTimeout(showBoardMessage._t);
      showBoardMessage._t = setTimeout(() => { boardMessage.style.display = 'none'; }, timeout);
    }

    function matchesSearch(order, term) {
      if (!term) return true;
      const trackingText = (order.tracking || []).map(t => [t.trackingNumber, t.carrier, t.cache?.status, t.cache?.summary].filter(Boolean).join(' ')).join(' ');
      const groupTrackingText = (order.group?.tracking || []).map(t => [t.trackingNumber, t.carrier, t.cache?.status, t.cache?.summary].filter(Boolean).join(' ')).join(' ');
      const hay = [
        order.partName,
        order.vendorPartNumber,
        order.partLink,
        order.studentName,
        order.supplier,
        order.productCode,
        order.orderNumber,
        order.category,
        order.priority,
        order.group && order.group.title,
        order.group && order.group.trackingNumber,
        trackingText,
        groupTrackingText
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(term.toLowerCase());
    }

    function withinDate(order, start, end) {
      if (!start && !end) return true;
      const ts = order.requestedDisplayAt || order.requestedAt || Date.parse(order.createdAt || '') || 0;
      if (start && ts < start) return false;
      if (end && ts > end) return false;
      return true;
    }

    function filteredOrders() {
      const term = globalSearch.value.trim();
      const s = statusFilter.value;
      const v = vendorFilter.value;
      const start = startDate.value ? Date.parse(startDate.value) : null;
      const end = endDate.value ? Date.parse(endDate.value) + 24*60*60*1000 : null; // inclusive
      return orders
        .filter(o =>
          matchesSearch(o, term) &&
          (!s || o.status === s) &&
          (!v || (o.supplier || '').toLowerCase() === v.toLowerCase()) &&
          withinDate(o, start, end)
        )
        .sort((a, b) => getOrderTimestamp(b) - getOrderTimestamp(a));
    }

    async function fetchOrders() {
      if (!currentUser) return;
      const res = await fetch('/api/orders');
      const data = await res.json();
      orders = (data.orders || []).map(o => ({
        ...o,
        tracking: o.tracking || [],
        group: o.group ? { ...o.group, tracking: o.group.tracking || [] } : null,
        _id: o._id || o.id || o.orderNumber
      }));
      // Debug tracking payloads for visibility
      console.log('[tracking] orders loaded', orders.map(o => ({
        id: o._id,
        tracking: o.tracking,
        groupTracking: o.group?.tracking
      })));
      const allTracking = [];
      orders.forEach(o => {
        (o.tracking || []).forEach(t => allTracking.push(t));
        (o.group?.tracking || []).forEach(t => allTracking.push(t));
      });
      const lastChecked = allTracking
        .map(t => t.lastCheckedAt || t.cache?.lastCheckedAt || t.cache?.lastEventTime || t.lastUpdated)
        .filter(Boolean)
        .sort((a, b) => b - a)[0];
      const trackingErrors = allTracking
        .map(t => t.cache?.summary || t.cache?.status || t.status)
        .filter(msg => msg && /error|missing|invalid|unauthorized|fail/i.test(msg));
      const trackingUpdatedEl = document.getElementById('tracking-updated');
      if (trackingUpdatedEl) {
        const errText = trackingErrors.length ? ` · Tracking error: ${trackingErrors[0]}` : '';
        trackingUpdatedEl.textContent = (lastChecked ? `Tracking updated ${fmtDate(lastChecked)}` : '') + errText;
      }
      buildFilters();
      renderBoard();
      renderTable();
      updateSelectionBar();
      updateUndoRedoUI();
    }

    function buildFilters() {
      const statusesUnique = Array.from(new Set(orders.map(o => o.status).filter(Boolean)));
      statusFilter.innerHTML = ['<option value="">All statuses</option>', ...statusesUnique.map(s => `<option>${s}</option>`)].join('');
      const vendors = Array.from(new Set(orders.map(o => (o.supplier || '').trim()).filter(Boolean)));
      vendorFilter.innerHTML = ['<option value="">All vendors</option>', ...vendors.map(v => `<option>${v}</option>`)].join('');
    }

    function openEdit(order) {
      editingOrderId = order._id;
      resetCatalogLookup();
      resetCatalogSavePanel();
      syncCatalogSaveUI();
      orderForm.elements.vendor.value = order.vendor || order.supplier || '';
      orderForm.elements.vendorPartNumber.value = order.vendorPartNumber || '';
      orderForm.elements.partLink.value = order.partLink || '';
      orderForm.elements.partName.value = order.partName || '';
      orderForm.elements.unitCost.value = order.unitCost || order.fetchedPrice || '';
      orderForm.elements.quantityRequested.value = order.quantityRequested || 1;
      orderForm.elements.priority.value = order.priority || 'Medium';
      setOrderSource('manual');
      scheduleCatalogPresenceCheck();
      if (currentUser?.permissions?.canEditInventoryCatalog && catalogSaveCategory) {
        catalogSaveCategory.value = order.category || '';
      }
      if (orderTrackingList) setTrackingRows(orderTrackingList, []);
      if (addOrderTracking) addOrderTracking.disabled = true;
      if (orderTrackingList) orderTrackingList.style.display = 'none';
      renderTagOptions(order.tags || []);
      renderPriorityOptions();
      orderForm.elements.notes.value = order.notes || '';
      modal.style.display = 'flex';
    }

    function createCard(order) {
      const card = document.createElement('div');
      card.className = 'card';
      card.draggable = false;
      card.dataset.id = order._id;
      card.dataset.vendor = getOrderVendor(order) || '';
      if (selected.has(order._id)) card.classList.add('selected');

      card.innerHTML = `
        <div class="flex-between" style="gap:8px;">
          <div>
            <h4>${order.partName || 'Untitled part'}</h4>
            <div class="meta">Requested by ${order.studentName || 'Unknown'} · ${fmtDate(order.requestedDisplayAt || order.requestedAt)}</div>
          </div>
        </div>
        <div class="meta">
          ${(() => {
            const unit = order.unitCost ?? order.fetchedPrice;
            const qty = order.quantityRequested || 1;
            const total = order.totalCost ?? (unit !== undefined ? Number((unit * qty).toFixed(2)) : undefined);
            return total !== undefined ? '$' + total : (unit !== undefined ? '$'+unit : '');
          })()}
          ${order.quantityRequested ? ' · x' + order.quantityRequested : ''}
        </div>
        ${order.notes ? `<div class="meta" style="margin-top:4px; white-space:pre-wrap;">Notes: ${escapeHtml(order.notes)}</div>` : ''}
        <div class="meta" style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-wrap:wrap;">
          <div style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:200px;">
            <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
              ${order.supplier || order.vendor ? `<span class="tag supplier">${order.supplier || order.vendor}</span>` : ''}
              ${order.vendorPartNumber ? `<span class="tag">${order.vendorPartNumber}</span>` : ''}
              ${order.priority ? `<span class="tag priority" style="border-color:${getPriorityColor(order.priority)}; color:${getPriorityColor(order.priority)};">${order.priority}</span>` : ''}
              ${order.group ? `<span class="tag group">Group: ${order.group.title || order.group.supplier || 'Grouped'}</span>` : ''}
              ${renderTagChips(order.tags || [])}
              ${order.approvalStatus === 'approved'
                ? `<span class="tag" style="background:rgba(74,210,143,0.16); color:var(--success);">Approved${order.approvedBy ? ' · ' + order.approvedBy : ''}</span>`
                : `<span class="tag" style="background:rgba(253,208,35,0.16); color:var(--gold);">Pending approval</span>`}
            </div>
            ${renderTrackingBadges((order.group?.tracking && order.group.tracking.length) ? order.group.tracking : (order.tracking || []))}
          </div>
          <div class="row-actions" style="display:flex; gap:6px; align-self:flex-end; flex-wrap:wrap;">
            ${currentUser?.permissions?.canManagePartRequests ? `<button class="btn ghost" data-action="approve" style="padding:4px 8px;">${order.approvalStatus === 'approved' ? 'Unapprove' : 'Approve'}</button>` : ''}
            ${order.partLink || order.supplierLink ? `<a class="btn ghost" data-action="link" href="${escapeHtml(order.partLink || order.supplierLink)}" target="_blank" rel="noopener noreferrer" style="padding:4px 8px;">Link</a>` : ''}
            ${supportsVendorExport(order) ? `<button class="btn ghost" data-action="export-order" style="padding:4px 8px;">Export</button>` : ''}
            ${(currentUser?.permissions?.canManagePartRequests || (currentUser?.permissions?.canManageOwnPartRequests && isOwnOrder(order))) ? `<button class="btn ghost" data-action="edit" style="padding:4px 8px;">Edit</button>` : ''}
            ${(currentUser?.permissions?.canManagePartRequests || (currentUser?.permissions?.canManageOwnPartRequests && isOwnOrder(order))) ? `<button class="btn ghost" data-action="delete" style="padding:4px 8px; color: var(--danger);">Delete</button>` : ''}
          </div>
        </div>
      `;
      card.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        if (e.target.closest('a')) return;
        if (addToOrderMode && addToOrderVendor) {
          showBoardMessage('Tap a grouped order to add these parts.', 'error', 2000);
          return;
        }
        toggleSelect(order._id);
      });

      card.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openEdit(order);
        });
      });
      card.querySelectorAll('button[data-action="approve"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const next = order.approvalStatus === 'approved' ? 'pending' : 'approved';
          await approveOrder(order._id, next);
          fetchOrders();
        });
      });
      card.querySelectorAll('button[data-action="export-order"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          exportOrdersForVendor([order]);
        });
      });

      card.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          openConfirm('Delete this order?', async () => {
            const snapshot = snapshotOrder(order._id);
            if (order.groupId || order.group?._id) {
              await assignGroup(order._id, undefined);
              await patchStatusOnly(order._id, 'Requested');
            }
            await fetch(`/api/orders/${order._id}`, { method: 'DELETE' });
            if (snapshot) {
              recordAction({
                undo: { type: 'restoreOrder', payload: { order: snapshot, groupId: snapshot.groupId || snapshot.group?._id } },
                redo: { type: 'deleteOrder', payload: { orderId: order._id } }
              });
            }
            fetchOrders();
          });
        });
      });
      card.querySelectorAll('a[data-action="link"]').forEach(anchor => {
        anchor.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      });
      return card;
    }

    function applyAddTargetStyles(el, vendor, isSelected, isGroup = false) {
      if (!el) return;
      el.classList.remove('add-target-valid', 'add-target-disabled');
      if (!addToOrderMode) return;
      if (!isGroup) {
        el.classList.add('add-target-disabled');
        return;
      }
      const canTarget = addToOrderVendor && vendor && !isSelected && vendor === addToOrderVendor;
      el.classList.add(canTarget ? 'add-target-valid' : 'add-target-disabled');
    }

    function updateToOrderActionsUI() {
      const actionsRow = document.querySelector('.column[data-status="Requested"] .to-order-actions');
      if (!actionsRow) return;
      const selectedOrders = orders.filter(o => selected.has(o._id));
      const allRequested = selectedOrders.every(o => o.status === 'Requested');
      const sameVendor = selectedOrders.length > 0 && allRequested && selectedOrders.every(o => getOrderVendor(o) === getOrderVendor(selectedOrders[0]));
      const showSelectSameVendor = sameVendor;
      const showSelectAll = selectedOrders.length === 0 || !sameVendor;
      const hasSelection = selected.size > 0;
      const canManageOrders = currentUser?.permissions?.canManageOrders;
      const canManagePartRequests = currentUser?.permissions?.canManagePartRequests;
      const canManageOwnPartRequests = currentUser?.permissions?.canManageOwnPartRequests;
      const canDeleteSelected = canManagePartRequests || (canManageOwnPartRequests && hasSelection && selectedOrders.every(isOwnOrder));
      [selectAllBtn, selectSameVendorBtn, unselectAllBtn, addToOrderBtn, groupBtn, deleteSelectedBtn].forEach(btn => {
        if (!btn) return;
        actionsRow.appendChild(btn);
      });
      if (selectAllBtn) selectAllBtn.style.display = showSelectAll ? 'inline-flex' : 'none';
      if (selectSameVendorBtn) selectSameVendorBtn.style.display = showSelectSameVendor ? 'inline-flex' : 'none';
      if (unselectAllBtn) unselectAllBtn.style.display = hasSelection ? 'inline-flex' : 'none';
      if (addToOrderBtn) addToOrderBtn.style.display = hasSelection && sameVendor && canManageOrders ? 'inline-flex' : 'none';
      if (groupBtn) groupBtn.style.display = hasSelection && sameVendor && canManageOrders ? 'inline-flex' : 'none';
      if (deleteSelectedBtn) deleteSelectedBtn.style.display = hasSelection && canDeleteSelected ? 'inline-flex' : 'none';
    }

    function refreshBoardSelectionUI() {
      if (!boardEl) return;
      boardEl.querySelectorAll('.board .card').forEach(card => {
        const id = card.dataset.id;
        if (id) card.classList.toggle('selected', selected.has(id));
        const vendor = card.dataset.vendor || '';
        const isGroup = Boolean(card.dataset.groupId);
        const isSelected = id ? selected.has(id) : false;
        applyAddTargetStyles(card, vendor, isSelected, isGroup);
      });
      updateToOrderActionsUI();
    }

    function withScrollRestoration(fn) {
      const sx = window.scrollX;
      const sy = window.scrollY;
      const bScroll = boardEl ? boardEl.scrollTop : null;
      fn();
      window.requestAnimationFrame(() => {
        if (boardEl && bScroll !== null) boardEl.scrollTop = bScroll;
        window.scrollTo(sx, sy);
      });
    }

    function renderBoard() {
      const savedScrollY = window.scrollY;
      const savedScrollX = window.scrollX;
      const savedBoardScroll = boardEl ? boardEl.scrollTop : null;
      const fo = filteredOrders();
      const groupedByStatus = {};
      const groupMap = {};
      const selectionActions = selectionBar?.querySelector('.selection-actions');
      [selectAllBtn, selectSameVendorBtn, unselectAllBtn, groupBtn, addToOrderBtn, deleteSelectedBtn].forEach(btn => {
        if (btn && selectionActions && btn.parentElement !== selectionActions) {
          selectionActions.appendChild(btn);
        }
      });

      fo.forEach(order => {
        if (order.groupId || order.group?._id) {
          const gid = order.groupId || order.group?._id;
          if (!groupMap[gid]) groupMap[gid] = [];
          groupMap[gid].push(order);
        } else {
          groupedByStatus[order.status] = groupedByStatus[order.status] || [];
          groupedByStatus[order.status].push(order);
        }
      });

      boardEl.innerHTML = '';
      statuses.forEach(col => {
        const status = col.status;
      const column = document.createElement('div');
      column.className = 'column';
      column.dataset.status = col.status;
      column.innerHTML = `
        <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
          <div>
            <h3>${col.label} <span class="pill">${(groupedByStatus[col.status] || []).length + Object.values(groupMap).filter(items => (items[0]?.status === col.status)).length}</span></h3>
            <div class="small" style="margin-bottom:6px;">${col.hint}</div>
          </div>
          ${col.status === 'Requested' ? `<div class="to-order-actions" style="display:flex; gap:8px; flex-wrap:wrap; margin-left:auto;"></div>` : ''}
        </div>
        <div class="board-drop"></div>
      `;
        const dropArea = column.querySelector('.board-drop');
        const actionsRow = column.querySelector('.to-order-actions');
        if (actionsRow && col.status === 'Requested') {
          const selectedOrders = orders.filter(o => selected.has(o._id));
          const allRequested = selectedOrders.every(o => o.status === 'Requested');
          const sameVendor = selectedOrders.length > 0 && allRequested && selectedOrders.every(o => getOrderVendor(o) === getOrderVendor(selectedOrders[0]));
          const selectAllBtnEl = selectAllBtn;
          const selectSameVendorBtnEl = selectSameVendorBtn;
          const unselectAllBtnEl = unselectAllBtn;
          const groupBtnEl = groupBtn;
          const addToOrderBtnEl = addToOrderBtn;
          const showSelectSameVendor = sameVendor;
          const showSelectAll = selectedOrders.length === 0 || !sameVendor;
          if (selectAllBtnEl) {
            selectAllBtnEl.style.display = showSelectAll ? 'inline-flex' : 'none';
            actionsRow.appendChild(selectAllBtnEl);
          }
          if (selectSameVendorBtnEl) {
            selectSameVendorBtnEl.style.display = showSelectSameVendor ? 'inline-flex' : 'none';
            actionsRow.appendChild(selectSameVendorBtnEl);
          }
          if (unselectAllBtnEl) {
            unselectAllBtnEl.style.display = selected.size ? 'inline-flex' : 'none';
            actionsRow.appendChild(unselectAllBtnEl);
          }
          if (addToOrderBtnEl) {
            addToOrderBtnEl.style.display = selected.size && sameVendor ? 'inline-flex' : 'none';
            actionsRow.appendChild(addToOrderBtnEl);
          }
          if (groupBtnEl) {
            groupBtnEl.style.display = selected.size && sameVendor ? 'inline-flex' : 'none';
            actionsRow.appendChild(groupBtnEl);
          }
          if (deleteSelectedBtn) {
            deleteSelectedBtn.style.display = selected.size ? 'inline-flex' : 'none';
            actionsRow.appendChild(deleteSelectedBtn);
          }
        }

        (groupedByStatus[col.status] || []).forEach(order => {
          const card = createCard(order);
          applyAddTargetStyles(card, getOrderVendor(order), selected.has(order._id), false);
          dropArea.appendChild(card);
        });

        const groupsForStatus = Object.entries(groupMap)
          .filter(([, items]) => items[0]?.status === col.status)
          .sort(([, a], [, b]) => getGroupTimestamp(b) - getGroupTimestamp(a));

      groupsForStatus.forEach(([gid, items]) => {
        const first = items[0];
        const card = document.createElement('div');
        card.className = 'card';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '8px';
        card.draggable = false;
        card.dataset.groupId = gid;
        card.dataset.vendor = (first.supplier || first.vendor || '').toLowerCase();
        const vendor = first.supplier || first.vendor || '';
      const total = items.reduce((sum, o) => sum + (o.totalCost || 0), 0);
          const trackingList = (first.group?.tracking && first.group.tracking.length ? first.group.tracking : trackingFromOrder(first));
      const groupedAt = first.group?.requestedDisplayAt || first.group?.createdAt || Date.now();
      const timePart = new Date(groupedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const groupTitle = first.group?.title || `${vendor || 'Grouped Order'} - ${formatShortDate(new Date(groupedAt))} ${timePart}`;
          card.innerHTML = `
            <div class="flex-between" style="gap:8px;">
              <div>
                <h4>${groupTitle}</h4>
                <div class="meta">Items in order: ${items.length}</div>
                ${first.group?.notes ? `<div class="meta" style="margin-top:4px; white-space:pre-wrap;">Notes: ${escapeHtml(first.group.notes)}</div>` : ''}
              </div>
              <div class="row-actions" style="display:flex; gap:6px;">
                ${supportsVendorExportByName(vendor) ? `<button class="btn ghost" data-action="export-group" style="padding:4px 8px;">Export</button>` : ''}
                ${currentUser?.permissions?.canManageOrders && status === 'Ordered' ? `<button class="btn ghost" data-action="advance-group" style="padding:4px 8px;">Advance</button>` : ''}
                ${currentUser?.permissions?.canManageOrders && status === 'Received' ? `<button class="btn ghost" data-action="revert-group" style="padding:4px 8px;">Revert</button>` : ''}
                ${currentUser?.permissions?.canManageOrders ? `<button class="btn ghost" data-action="edit-group" style="padding:4px 8px;">Edit</button>` : ''}
                ${currentUser?.permissions?.canManageOrders ? `<button class="btn ghost" data-action="delete-group" style="padding:4px 8px; color: var(--danger);">Delete</button>` : ''}
              </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div>${vendor ? `<span class="tag supplier">${vendor}</span>` : ''}</div>
                ${renderTrackingBadges(trackingList)}
              </div>
              <div class="muted" style="min-width:80px; text-align:right; align-self:flex-end;">${total ? '$'+total.toFixed(2) : ''}</div>
            </div>
            <div class="group-items-container" style="margin-top:6px; display:${expandedGroups.has(gid) ? 'block' : 'none'};">
              ${items.map(o => `
                <div class="small group-item" data-id="${o._id}" style="display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; margin-top:4px; flex-wrap:wrap;">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; flex:1;">
                    <span class="muted" style="font-weight:700;">${o.quantityRequested ? `${o.quantityRequested}x` : ''}</span>
                    <span style="font-weight:700;">${o.partName || ''}</span>
                    ${o.studentName ? `<span class="tag" style="background:rgba(79,180,255,0.16); color:var(--accent-2); border-color:var(--border);">${o.studentName}</span>` : ''}
                    ${renderTagChips(o.tags || [])}
                  </div>
                  <div style="display:flex; gap:6px; flex-wrap:wrap; margin-left:auto;">
                    ${o.partLink || o.supplierLink ? `<a class="btn ghost" data-action="link-part" href="${escapeHtml(o.partLink || o.supplierLink)}" target="_blank" rel="noopener noreferrer" style="padding:4px 8px;">Link</a>` : ''}
                    ${currentUser?.permissions?.canManageOrders ? `<button class="btn ghost" data-action="edit-part" style="padding:4px 8px;">Edit</button>` : ''}
                    ${currentUser?.permissions?.canManageOrders ? `<button class="btn ghost" data-action="remove-part" style="padding:4px 8px;">Remove</button>` : ''}
                    ${currentUser?.permissions?.canManageOrders ? `<button class="btn ghost" data-action="delete-part" style="padding:4px 8px; color:var(--danger);">Delete</button>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          applyAddTargetStyles(card, vendor.toLowerCase(), false, true);

          card.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('.group-item')) return;
            if (addToOrderMode && addToOrderVendor) {
              const valid = vendor && vendor.toLowerCase() === addToOrderVendor;
              if (valid) {
                addSelectedToGroup(gid, status);
                return;
              }
              showBoardMessage('Vendor mismatch. Pick a matching grouped order.', 'error', 2000);
              return;
            }
            if (expandedGroups.has(gid)) expandedGroups.delete(gid); else expandedGroups.add(gid);
            const container = card.querySelector('.group-items-container');
            if (container) container.style.display = expandedGroups.has(gid) ? 'block' : 'none';
          });
          card.querySelectorAll('button[data-action="export-group"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              exportOrdersForVendor(items, vendor);
            });
          });

          card.querySelectorAll('button[data-action="edit-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              openGroupModal({
                id: gid,
                title: first.group?.title || groupTitle,
                tracking: trackingList,
                notes: first.group?.notes || ''
              });
            });
          });

          card.querySelectorAll('button[data-action="delete-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              if (actionBusy) return;
              e.stopPropagation();
              const orderIds = items.map(o => o._id);
              openConfirm('Delete this group?', async (extra) => {
                setActionBusy(true, 'Deleting order…');
                const deleteParts = extra?.deleteParts;
                const originalStatus = first.status || 'Ordered';
                const originalTracking = trackingList || [];
                const originalNotes = first.group?.notes || '';
                if (deleteParts) {
                  const snapshots = orderIds.map(id => snapshotOrder(id)).filter(Boolean);
                  const groupSnapshot = {
                    title: groupTitle,
                    supplier: vendor || undefined,
                    requestedDisplayAt: first.group?.requestedDisplayAt || first.group?.createdAt,
                    status: originalStatus,
                    tracking: originalTracking,
                    notes: originalNotes
                  };
                  await Promise.all(orderIds.map(oid => fetch(`/api/orders/${oid}`, { method: 'DELETE' })));
                  await fetch(`/api/order-groups/${gid}`, { method: 'DELETE' });
                  recordAction({
                    undo: { type: 'restoreOrders', payload: { orders: snapshots, group: groupSnapshot } },
                    redo: { type: 'deleteOrders', payload: { orderIds } }
                  });
                  fetchOrders();
                  setActionBusy(false);
                  return;
                }
                await Promise.all(orderIds.map(async oid => {
                  await assignGroup(oid, undefined);
                  await patchStatusOnly(oid, 'Requested');
                }));
                await fetch(`/api/order-groups/${gid}`, { method: 'DELETE' });
                recordAction({
                  undo: { type: 'createGroup', payload: { title: groupTitle, supplier: vendor || undefined, requestedDisplayAt: first.group?.requestedDisplayAt || first.group?.createdAt, orderIds, status: originalStatus, tracking: originalTracking, notes: originalNotes } },
                  redo: { type: 'deleteGroup', payload: { groupId: gid, orderIds, status: originalStatus } }
                });
                fetchOrders();
                setActionBusy(false);
              }, () => {
                const checkboxId = `confirm-delete-orders-${gid}`;
                return {
                  content: `<label class="small" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="${checkboxId}"> Delete part requests instead of ungrouping</label>`,
                  getValue: () => ({ deleteParts: document.getElementById(checkboxId)?.checked })
                };
              });
            });
          });
          card.querySelectorAll('button[data-action="advance-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await updateGroupStatus(gid, 'Received');
            });
          });
          card.querySelectorAll('button[data-action="revert-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await updateGroupStatus(gid, 'Ordered');
            });
          });

          card.querySelectorAll('button[data-action="edit-part"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              const order = orders.find(o => o._id === oid);
              if (order) openEdit(order);
            });
          });
          card.querySelectorAll('button[data-action="remove-part"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              openConfirm('Remove this part from the order?', async () => {
                await removePartFromGroup(oid, gid, status);
              });
            });
          });
          card.querySelectorAll('a[data-action="link-part"]').forEach(anchor => {
            anchor.addEventListener('click', (e) => {
              e.stopPropagation();
            });
          });
          card.querySelectorAll('button[data-action="delete-part"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              openConfirm('Delete this order?', async () => {
                await fetch(`/api/orders/${oid}`, { method: 'DELETE' });
                fetchOrders();
              });
            });
          });

          dropArea.appendChild(card);
        });

        const hasSingles = (groupedByStatus[col.status] || []).length > 0;
        const hasGroups = Object.values(groupMap).some(items => items[0]?.status === col.status);
        if (!hasSingles && !hasGroups) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No Orders';
          dropArea.appendChild(empty);
        }

        boardEl.appendChild(column);
      });

      if (addToOrderMode && boardEl) {
        boardEl.querySelectorAll('.board .card').forEach(card => {
          const vendor = card.dataset.vendor || '';
          const isGroup = Boolean(card.dataset.groupId);
          const isSelected = card.dataset.id ? selected.has(card.dataset.id) : false;
          applyAddTargetStyles(card, vendor, isSelected, isGroup);
        });
      }
      window.requestAnimationFrame(() => {
        if (boardEl && savedBoardScroll !== null) boardEl.scrollTop = savedBoardScroll;
        window.scrollTo(savedScrollX, savedScrollY);
      });
      resizeColumns();
    }

    function renderStockFilters() {
      if (!stockSubteamFilter) return;
      const options = [`<option value="all">All locations</option>`, `<option value="none">Common Stock</option>`];
      (stockSubteams || []).forEach(st => {
        options.push(`<option value="${st._id}">${escapeHtml(st.name)}</option>`);
      });
      stockSubteamFilter.innerHTML = options.join('');
      const desired = selectedStockSubteam || 'all';
      const hasOption = Array.from(stockSubteamFilter.options || []).some(opt => opt.value === desired);
      stockSubteamFilter.value = hasOption ? desired : 'all';
    }

    function setSelectedStockCatalogItem(item) {
      selectedStockCatalogItem = item;
      if (stockCatalogSelected) {
        const path = item?.fullPath || item?.catalogFullPath || (item?.categoryPathLabels || []).join(' / ');
        stockCatalogSelected.textContent = item
          ? `Using catalog: ${item.name || ''}${path ? ' · ' + path : ''}`
          : 'Search for a catalog item to track.';
      }
    }

    function buildStockCard(item, canAdjustStock) {
      const qty = item.quantityOnHand ?? 0;
      const low = item.lowStockThreshold;
      const isEmpty = qty <= 0;
      const isLow = !isEmpty && low !== undefined && qty <= low;
      const card = document.createElement('div');
      card.className = 'card stock-card';
      if (isLow) card.classList.add('stock-low');
      if (isEmpty) card.classList.add('stock-empty');
      card.dataset.id = item._id;
      const subteamLabel = item.subteam || 'Common Stock';
      const statusText = isEmpty ? '<span class="stock-empty-text">Out of stock</span>' : (isLow ? '<span class="stock-low-text">Low</span>' : '');
      card.innerHTML = `
          <div class="flex-between" style="gap:8px; align-items:flex-start;">
            <div>
              <h4 style="margin:0 0 6px;">${escapeHtml(item.name)}</h4>
              <div class="meta">
                <span class="stock-chip">${escapeHtml(subteamLabel)}</span>
                ${item.category ? `<span class="stock-chip">${escapeHtml(item.category)}</span>` : ''}
                ${item.location ? `<span class="stock-chip">📍 ${escapeHtml(item.location)}</span>` : ''}
              </div>
              <div class="meta">
                ${item.vendor ? `<span class="tag supplier">${escapeHtml(item.vendor)}</span>` : ''}
                ${item.vendorPartNumber ? `<span class="tag">${escapeHtml(item.vendorPartNumber)}</span>` : ''}
              </div>
            </div>
          </div>
          <div class="stock-row">
            <div class="stock-adjust">
              ${canAdjustStock ? `<button class="btn ghost" data-action="adjust-stock" data-id="${item._id}" data-delta="-1" style="padding:6px 10px;">-</button>` : ''}
              <div class="stock-level">${qty}</div>
              ${canAdjustStock ? `<button class="btn ghost" data-action="adjust-stock" data-id="${item._id}" data-delta="1" style="padding:6px 10px;">+</button>` : ''}
              ${statusText ? `<div style="display:flex; align-items:center; gap:6px; margin-left:4px;">${statusText}</div>` : ''}
            </div>
            <div class="stock-actions" style="margin-left:auto;">
              ${item.supplierLink ? `<a class="btn ghost" href="${escapeHtml(item.supplierLink)}" target="_blank" style="padding:4px 8px;">Link</a>` : ''}
              ${currentUser?.permissions?.canManageStock ? `<button class="btn ghost" data-action="edit-stock" data-id="${item._id}" style="padding:4px 8px;">Edit</button>` : ''}
              ${currentUser?.permissions?.canManageStock ? `<button class="btn ghost" data-action="delete-stock" data-id="${item._id}" style="padding:4px 8px; color: var(--danger);">Untrack</button>` : ''}
              <button class="btn primary" data-action="request-stock" data-id="${item._id}" style="padding:4px 10px;">Request</button>
            </div>
          </div>
        `;
      return card;
    }

    function mergeStockItem(id, changes) {
      const idx = stockItems.findIndex(s => s._id === id);
      if (idx === -1) return false;
      stockItems[idx] = { ...stockItems[idx], ...changes };
      renderStockGrid();
      return true;
    }

    function openDeleteStockModal(id) {
      pendingDeleteStockId = id;
      if (stockDeleteMessage) stockDeleteMessage.textContent = 'Are you sure you want to untrack this item?';
      if (stockDeleteModal) stockDeleteModal.style.display = 'flex';
    }

    function openConfirm(message, action, renderExtra) {
      if (!confirmModal) return action?.();
      pendingConfirmAction = action;
      pendingConfirmExtraGetter = null;
      if (confirmMessage) confirmMessage.textContent = message || 'Are you sure?';
      if (confirmStatus) { confirmStatus.textContent = ''; confirmStatus.className = 'small'; }
      if (confirmExtra) {
        confirmExtra.style.display = 'none';
        confirmExtra.innerHTML = '';
      }
      if (renderExtra && confirmExtra) {
        const res = renderExtra();
        if (res?.content) {
          confirmExtra.innerHTML = res.content;
          confirmExtra.style.display = 'block';
        }
        if (typeof res?.getValue === 'function') {
          pendingConfirmExtraGetter = res.getValue;
        }
      }
      confirmModal.style.display = 'flex';
    }

    function openVendorExportModal(config = {}) {
      vendorExportData = config;
      if (vendorExportTitle) vendorExportTitle.textContent = config.vendorName ? `Export to ${config.vendorName}` : 'Vendor export';
      if (vendorExportDescription) vendorExportDescription.textContent = config.description || 'Copy the list or download the CSV for the vendor quick order form.';
      if (vendorExportText) vendorExportText.value = config.text || '';
      if (vendorExportMessage) {
        const message = config.message !== undefined
          ? config.message
          : (config.text ? 'Copy the lines into the vendor quick order form.' : '');
        vendorExportMessage.textContent = message;
        vendorExportMessage.className = config.messageType ? `small ${config.messageType}` : 'small';
      }
      if (vendorExportModal) vendorExportModal.style.display = 'flex';
    }

    function closeVendorExportModal() {
      vendorExportData = null;
      if (vendorExportMessage) {
        vendorExportMessage.textContent = '';
        vendorExportMessage.className = 'small';
      }
      if (vendorExportModal) vendorExportModal.style.display = 'none';
    }

    function renderStockGrid() {
      if (!stockGrid) return;
      if (!currentUser) {
        stockGrid.innerHTML = '<div class="empty">Login to view stock.</div>';
        return;
      }
      if (!stockItems.length) {
        stockGrid.innerHTML = '<div class="empty">No stock tracked yet. Add items to start tracking.</div>';
        return;
      }
      stockGrid.innerHTML = '';
      const canAdjustStock = currentUser?.permissions?.canEditStock || currentUser?.permissions?.canManageStock;
      const isGrouped = selectedStockSubteam && selectedStockSubteam !== 'all';
      stockGrid.classList.toggle('grouped', isGrouped);

      const buildCategoryLabel = (item) => {
        return (item.category || '').trim() ||
          'Uncategorized';
      };

      if (isGrouped) {
        const groups = new Map();
        stockItems.forEach(item => {
          const label = buildCategoryLabel(item);
          if (!groups.has(label)) groups.set(label, []);
          groups.get(label).push(item);
        });
        const sortedLabels = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b));
        sortedLabels.forEach(label => {
          const wrapper = document.createElement('div');
          wrapper.className = 'stock-category-block';
          const title = document.createElement('div');
          title.className = 'stock-category-title';
          title.textContent = label;
          const grid = document.createElement('div');
          grid.className = 'stock-category-grid';
          const items = groups.get(label) || [];
          items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          items.forEach(item => grid.appendChild(buildStockCard(item, canAdjustStock)));
          wrapper.appendChild(title);
          wrapper.appendChild(grid);
          stockGrid.appendChild(wrapper);
        });
      } else {
        stockItems
          .slice()
          .sort((a, b) => (a.subteam || '').localeCompare(b.subteam || '') || (a.name || '').localeCompare(b.name || ''))
          .forEach(item => stockGrid.appendChild(buildStockCard(item, canAdjustStock)));
      }

      stockGrid.querySelectorAll('button[data-action="adjust-stock"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          const delta = Number(e.target.dataset.delta);
          if (!id || !Number.isFinite(delta)) return;
          await adjustStockQuantity(id, delta);
        });
      });
      stockGrid.querySelectorAll('button[data-action="request-stock"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const item = stockItems.find(s => s._id === id);
          if (!item) return;
          if (!currentUser?.permissions?.canPlacePartRequests) {
            showBoardMessage('No permission to place part requests.', 'error');
            return;
          }
          const requestItem = item.catalogItem || {
            name: item.name,
            vendor: item.vendor,
            vendorPartNumber: item.vendorPartNumber,
            supplierLink: item.supplierLink,
            unitCost: item.unitCost,
            defaultQuantity: 1,
            fullPath: item.catalogFullPath
          };
          openCatalogRequestModal(requestItem);
        });
      });
      stockGrid.querySelectorAll('button[data-action="edit-stock"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const item = stockItems.find(s => s._id === id);
          if (item) openStockModal(item);
        });
      });
      stockGrid.querySelectorAll('button[data-action="delete-stock"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          if (!id) return;
          openDeleteStockModal(id);
        });
      });
    }

    async function loadStock() {
      if (!stockGrid) return;
      if (!currentUser) {
        stockGrid.innerHTML = '<div class="empty">Login to view stock.</div>';
        return;
      }
      const params = new URLSearchParams();
      const searchTerm = (globalSearch?.value || '').trim();
      if (searchTerm) params.set('search', searchTerm);
      if (selectedStockSubteam && selectedStockSubteam !== 'all' && selectedStockSubteam !== 'none') {
        params.set('subteamId', selectedStockSubteam);
      }
      const qs = params.toString() ? `?${params.toString()}` : '';
      stockGrid.innerHTML = '<div class="empty">Loading stock...</div>';
      try {
        const res = await fetch(`/api/stock${qs}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load stock');
        const incoming = data.items || [];
        stockSubteams = data.subteams || stockSubteams;
        renderStockFilters();
        stockItems = selectedStockSubteam === 'none'
          ? incoming.filter(i => !i.subteamId)
          : incoming;
        renderStockGrid();
      } catch (err) {
        stockGrid.innerHTML = `<div class="empty">${escapeHtml(err.message || 'Failed to load stock')}</div>`;
      }
    }

    function resetStockModal() {
      if (!stockForm) return;
      stockForm.reset();
      if (stockForm.elements.id) stockForm.elements.id.value = '';
      setSelectedStockCatalogItem(null);
      if (stockCatalogSearch) { stockCatalogSearch.value = ''; stockCatalogSearch.disabled = false; }
      if (stockCatalogResults) { stockCatalogResults.innerHTML = ''; stockCatalogResults.style.display = 'none'; }
      if (stockModalMessage) { stockModalMessage.textContent = ''; stockModalMessage.className = 'small'; }
      if (deleteStockBtn) deleteStockBtn.style.display = 'none';
      if (stockModalTitle) stockModalTitle.textContent = 'Add Stock';
      if (stockModalSubtitle) stockModalSubtitle.textContent = 'Pick a catalog part to track and set the starting quantity.';
      if (stockCategoryInput) stockCategoryInput.value = '';
      if (stockCatalogSelected) stockCatalogSelected.textContent = 'Search for a catalog item to track.';
    }

    function openStockModal(item = null) {
      if (!currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to configure stock.', 'error');
        return;
      }
      if (!stockForm) return;
      resetStockModal();
      renderStockFilters();
      if (stockSubteamSelect) {
        const opts = [`<option value="">Common Stock</option>`].concat(
          (stockSubteams || []).map(st => `<option value="${st._id}">${escapeHtml(st.name)}</option>`)
        );
        stockSubteamSelect.innerHTML = opts.join('');
      }
      if (item) {
        stockForm.elements.id.value = item._id || '';
        if (stockQuantityInput) stockQuantityInput.value = item.quantityOnHand ?? 0;
        if (stockLowInput) stockLowInput.value = item.lowStockThreshold ?? '';
        if (stockLocationInput) stockLocationInput.value = item.location || '';
        if (stockCategoryInput) stockCategoryInput.value = item.category || '';
        if (stockNotesInput) stockNotesInput.value = item.notes || '';
        if (stockSubteamSelect) stockSubteamSelect.value = item.subteamId ? item.subteamId.toString() : '';
        setSelectedStockCatalogItem(item.catalogItem || item);
        if (stockCatalogSearch) stockCatalogSearch.disabled = true;
        if (stockModalTitle) stockModalTitle.textContent = 'Edit stock item';
        if (stockModalSubtitle) stockModalSubtitle.textContent = 'Update location, thresholds, or counts.';
        if (deleteStockBtn) deleteStockBtn.style.display = 'inline-flex';
      } else {
        if (stockSubteamSelect) stockSubteamSelect.value = selectedStockSubteam && selectedStockSubteam !== 'all' ? selectedStockSubteam : '';
        setSelectedStockCatalogItem(null);
      }
      if (stockModal) stockModal.style.display = 'flex';
    }

    async function saveStockForm(e) {
      e.preventDefault();
      if (!stockForm) return;
      const id = stockForm.elements.id.value || null;
      const quantity = Number(stockQuantityInput?.value || 0);
      const low = stockLowInput?.value === '' ? undefined : Number(stockLowInput?.value);
      const subteamId = stockSubteamSelect ? stockSubteamSelect.value : '';
      const location = stockLocationInput?.value?.trim() || undefined;
      const category = stockCategoryInput?.value?.trim() || undefined;
      const notes = stockNotesInput?.value?.trim() || undefined;
      const targetLocationName = subteamId
        ? (stockSubteams?.find?.(s => s._id === subteamId)?.name || 'Selected location')
        : 'Common Stock';
      const finalizeSuccess = () => {
        if (stockModal) stockModal.style.display = 'none';
        showBoardMessage('Stock saved.', 'info');
        resetStockModal();
      };
      if (!id && !selectedStockCatalogItem) {
        stockModalMessage.textContent = 'Select a catalog item first.';
        stockModalMessage.className = 'error';
        return;
      }
      if (stockModalMessage) { stockModalMessage.textContent = 'Saving...'; stockModalMessage.className = 'small'; }
      try {
        if (id) {
          const res = await fetch(`/api/stock/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subteamId: subteamId === '' ? null : subteamId,
              quantityOnHand: Number.isFinite(quantity) ? quantity : undefined,
              lowStockThreshold: Number.isFinite(low) ? low : undefined,
              location,
              category,
              notes
            })
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'Failed to update stock');
          }
          const subteamName = subteamId && stockSubteams?.find?.(s => s._id === subteamId)?.name;
          const moveOutOfView = selectedStockSubteam && selectedStockSubteam !== 'all' && selectedStockSubteam !== subteamId && !(selectedStockSubteam === 'none' && !subteamId);
          if (moveOutOfView) {
            stockItems = stockItems.filter(s => s._id !== id);
          } else {
            mergeStockItem(id, {
              subteamId: subteamId || undefined,
              subteam: subteamId ? subteamName || undefined : 'Common Stock',
              quantityOnHand: Number.isFinite(quantity) ? quantity : undefined,
              lowStockThreshold: Number.isFinite(low) ? low : undefined,
              location,
              category,
              notes
            });
          }
          finalizeSuccess();
        } else {
          if (!selectedStockCatalogItem?._id && !selectedStockCatalogItem?.id) {
            if (stockModalMessage) { stockModalMessage.textContent = 'Select a catalog item first.'; stockModalMessage.className = 'error'; }
            return;
          }
          const payload = {
            catalogItemId: selectedStockCatalogItem?._id || selectedStockCatalogItem?.id,
            subteamId: subteamId === '' ? undefined : subteamId,
            quantityOnHand: Number.isFinite(quantity) ? quantity : 0,
            lowStockThreshold: Number.isFinite(low) ? low : undefined,
            location,
            category,
            notes
          };
          const execCreate = async () => {
            const res = await fetch('/api/stock', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Failed to create stock');
            await loadStock();
          };
          try {
            const checkUrl = `/api/stock?catalogItemId=${encodeURIComponent(payload.catalogItemId)}`;
            const dupRes = await fetch(checkUrl);
            if (dupRes.ok) {
              const dupData = await dupRes.json();
              const items = dupData.items || [];
              const norm = (val) => (val ? val.toString() : '');
              const targetId = norm(subteamId || undefined);
              const sameLocation = items.find(i => norm(i.subteamId) === targetId);
              if (sameLocation) {
                throw new Error('Item already exists in location');
              }
              const otherLocation = items.find(i => norm(i.subteamId) !== targetId);
              if (otherLocation) {
                const otherName = otherLocation.subteam || 'Common Stock';
                openConfirm(`This item already exists in ${otherName}. Add it to ${targetLocationName} as well?`, async () => {
                  try {
                    if (stockModalMessage) { stockModalMessage.textContent = 'Saving...'; stockModalMessage.className = 'small'; }
                    await execCreate();
                    finalizeSuccess();
                  } catch (err) {
                    if (stockModalMessage) {
                      stockModalMessage.textContent = err.message || 'Failed to save stock';
                      stockModalMessage.className = 'error';
                    }
                  }
                });
                if (stockModalMessage) { stockModalMessage.textContent = 'Awaiting confirmation...'; stockModalMessage.className = 'small'; }
                return;
              }
            }
          } catch (err) {
            if (err?.message === 'Item already exists in location') throw err;
            // If the duplicate check fails for network/other reasons, fall through to attempt creation
          }
          await execCreate();
          finalizeSuccess();
        }
      } catch (err) {
        if (stockModalMessage) {
          stockModalMessage.textContent = err.message || 'Failed to save stock';
          stockModalMessage.className = 'error';
        }
      }
    }

    async function adjustStockQuantity(id, delta, absolute) {
      if (!currentUser?.permissions?.canEditStock && !currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to edit stock.', 'error');
        return;
      }
      try {
        const res = await fetch(`/api/stock/${id}/adjust`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            delta: absolute === undefined ? delta : undefined,
            quantityOnHand: absolute
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to update stock');
        const nextQty = data.quantityOnHand;
        if (!mergeStockItem(id, { quantityOnHand: nextQty })) {
          await loadStock();
        }
      } catch (err) {
        showBoardMessage(err.message || 'Failed to update stock', 'error');
      }
    }

    async function saveStockThreshold(id, value) {
      if (!currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to configure stock.', 'error');
        return;
      }
      try {
        await fetch(`/api/stock/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lowStockThreshold: value })
        });
        await loadStock();
      } catch (err) {
        showBoardMessage(err.message || 'Failed to save threshold', 'error');
      }
    }

    async function deleteStockItem(id) {
      if (!currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to untrack stock.', 'error');
        return;
      }
      if (actionBusy) return;
      setActionBusy(true, 'Deleting stock…');
      try {
        await fetch(`/api/stock/${id}`, { method: 'DELETE' });
        await loadStock();
        showBoardMessage('Stock entry removed.', 'info');
      } catch (err) {
        showBoardMessage(err.message || 'Failed to remove stock', 'error');
      } finally {
        setActionBusy(false);
      }
    }

    function renderSubteamList() {
      if (!stockSubteamList) return;
      if (!stockSubteams.length) {
        stockSubteamList.innerHTML = '<div class="empty">No locations yet.</div>';
        return;
      }
      stockSubteamList.innerHTML = stockSubteams.map(st => `
        <div class="tag-manager-item" data-id="${st._id}">
          <div class="tag-manager-meta" style="flex-wrap:wrap; gap:6px;">
            <div style="font-weight:700;">${escapeHtml(st.name)}</div>
            ${st.description ? `<div class="small">${escapeHtml(st.description)}</div>` : ''}
          </div>
          <div class="flex-between" style="gap:6px;">
            <button class="btn ghost" data-action="edit-subteam" style="padding:6px 10px;">Edit</button>
            <button class="btn ghost" data-action="delete-subteam" style="padding:6px 10px; color: var(--danger);">Delete</button>
          </div>
        </div>
      `).join('');
      stockSubteamList.querySelectorAll('button[data-action="edit-subteam"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.closest('.tag-manager-item')?.dataset.id;
          const st = stockSubteams.find(s => s._id === id);
          if (!st || !stockSubteamForm) return;
          stockSubteamForm.elements.id.value = st._id;
          stockSubteamForm.elements.name.value = st.name || '';
          stockSubteamForm.elements.description.value = st.description || '';
        });
      });
      stockSubteamList.querySelectorAll('button[data-action="delete-subteam"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.closest('.tag-manager-item')?.dataset.id;
          if (!id) return;
          openConfirm('Delete this location? Items will become unassigned.', async () => {
            await removeSubteam(id);
          });
        });
      });
    }

    async function loadSubteams() {
      if (!currentUser) return;
      try {
        const res = await fetch('/api/stock/subteams');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load locations');
        stockSubteams = data.subteams || [];
        renderSubteamList();
        renderStockFilters();
      } catch (err) {
        if (stockSubteamMessage) {
          stockSubteamMessage.textContent = err.message || 'Failed to load locations';
          stockSubteamMessage.className = 'error';
        }
      }
    }

    function openSubteamsModal() {
      if (!currentUser?.permissions?.canManageStock) return;
      if (stockSubteamMessage) { stockSubteamMessage.textContent = ''; stockSubteamMessage.className = 'small'; }
      stockSubteamForm?.reset();
      renderSubteamList();
      if (stockSubteamsModal) stockSubteamsModal.style.display = 'flex';
    }

    async function saveSubteam(e) {
      e.preventDefault();
      if (!stockSubteamForm) return;
      const id = stockSubteamForm.elements.id.value || null;
      const name = stockSubteamForm.elements.name.value?.trim();
      const description = stockSubteamForm.elements.description.value?.trim();
      if (!name) return;
      if (stockSubteamMessage) { stockSubteamMessage.textContent = 'Saving...'; stockSubteamMessage.className = 'small'; }
      try {
        const url = id ? `/api/stock/subteams/${id}` : '/api/stock/subteams';
        const method = id ? 'PATCH' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save location');
        stockSubteamForm.reset();
        await loadSubteams();
        await loadStock();
        if (stockSubteamMessage) { stockSubteamMessage.textContent = 'Saved.'; stockSubteamMessage.className = 'success'; }
      } catch (err) {
        if (stockSubteamMessage) { stockSubteamMessage.textContent = err.message || 'Failed to save location'; stockSubteamMessage.className = 'error'; }
      }
    }

    async function removeSubteam(id) {
      if (!currentUser?.permissions?.canManageStock) return;
      openConfirm('Delete this location? Items will become unassigned.', async () => {
        await fetch(`/api/stock/subteams/${id}`, { method: 'DELETE' });
        await loadSubteams();
        await loadStock();
      });
    }

    async function searchStockCatalog(term) {
      if (!stockCatalogResults) return;
      const q = (term || '').trim();
      if (q.length < 2) {
        stockCatalogResults.style.display = 'none';
        stockCatalogResults.innerHTML = '';
        return;
      }
      stockCatalogResults.style.display = 'block';
      stockCatalogResults.innerHTML = '<div class="small" style="padding:8px 10px;">Searching...</div>';
      try {
        const res = await fetch(`/api/catalog/items?search=${encodeURIComponent(q)}&includeDescendants=true`);
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) {
          stockCatalogResults.innerHTML = '<div class="small" style="padding:8px 10px;">No matches</div>';
          return;
        }
        stockCatalogResults.innerHTML = items.slice(0, 30).map(item => `
          <div class="tag-picker-option" data-id="${item._id}" style="padding:6px 8px; cursor:pointer; border:1px solid var(--border); border-radius:8px; margin-bottom:4px;">
            <div style="font-weight:700;">${escapeHtml(item.name)}</div>
            <div class="small">${escapeHtml(item.fullPath || (item.categoryPathLabels || []).join(' / ') || '')}${item.vendor ? ' · ' + escapeHtml(item.vendor) : ''}${item.vendorPartNumber ? ' · ' + escapeHtml(item.vendorPartNumber) : ''}</div>
          </div>
        `).join('');
        stockCatalogResults.querySelectorAll('.tag-picker-option').forEach(row => {
          row.addEventListener('click', () => {
            const id = row.dataset.id;
            const found = items.find(i => i._id === id);
            if (found) {
              setSelectedStockCatalogItem(found);
              stockCatalogResults.style.display = 'none';
              stockCatalogSearch.value = found.name || '';
            }
          });
        });
      } catch (err) {
        stockCatalogResults.innerHTML = '<div class="small" style="padding:8px 10px;">Failed to search catalog</div>';
      }
    }

    function renderTable() {
      const rows = filteredOrders();
      if (!rows.length) {
        tableContainer.innerHTML = '<div class="empty">No orders found.</div>';
        return;
      }

      const header = `
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>Part</th>
              <th>Status</th>
              <th>Tracking</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Total</th>
              <th>Vendor</th>
              <th>Requested by</th>
            <th>Order placed</th>
            </tr>
          </thead>
          <tbody>
      `;
      const body = rows.map(o => `
        <tr data-id="${o._id}">
          <td><input type="checkbox" class="row-check" ${selected.has(o._id) ? 'checked' : ''}></td>
          <td>
            <div>${o.partName || ''}</div>
            ${o.vendorPartNumber ? `<div class="small">${o.vendorPartNumber}</div>` : ''}
            ${o.partLink ? `<div class="small"><a href="${o.partLink}" target="_blank">link</a></div>` : ''}
            ${(o.tags && o.tags.length) ? `<div class="small" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">${renderTagChips(o.tags)}</div>` : ''}
            <div class="small" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
              ${o.approvalStatus === 'approved'
                ? `<span class="tag" style="background:rgba(74,210,143,0.16); color:var(--success);">Approved${o.approvedBy ? ' · ' + o.approvedBy : ''}</span>`
                : `<span class="tag" style="background:rgba(253,208,35,0.16); color:var(--gold);">Pending approval</span>`}
              ${o.group ? `<span class="tag group">Group</span>` : ''}
            </div>
          </td>
          <td><span class="status-chip status-${o.status || ''}">${o.status || ''}</span></td>
          <td>${renderTrackingBadges(o.group?.tracking || [])}</td>
          <td>${o.quantityRequested || ''}</td>
          <td>${o.unitCost ? '$'+o.unitCost : (o.fetchedPrice ? '$'+o.fetchedPrice : '')}</td>
          <td>${(() => {
            const unit = o.unitCost ?? o.fetchedPrice;
            const qty = o.quantityRequested || 1;
            const total = o.totalCost ?? (unit !== undefined ? Number((unit * qty).toFixed(2)) : undefined);
            return total !== undefined ? '$'+total : '';
          })()}</td>
          <td>${o.supplier || o.vendor || ''}</td>
          <td>${o.studentName || ''}</td>
          <td>${fmtDate(o.group?.requestedDisplayAt || o.group?.createdAt || o.requestedDisplayAt || o.requestedAt)}</td>
        </tr>
      `).join('');
      tableContainer.innerHTML = header + body + '</tbody></table>';

      tableContainer.querySelector('#select-all').addEventListener('change', (e) => {
        const check = e.target.checked;
        rows.forEach(o => { if (check) selected.add(o._id); else selected.delete(o._id); });
        refreshBoardSelectionUI();
        renderTable(); updateSelectionBar();
      });
      tableContainer.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = e.target.closest('tr').dataset.id;
          if (e.target.checked) selected.add(id); else selected.delete(id);
          refreshBoardSelectionUI();
          updateSelectionBar();
        });
      });
      resizeColumns();
    }

    function toggleSelect(id) {
      withScrollRestoration(() => {
        if (selected.has(id)) selected.delete(id);
        else selected.add(id);
        refreshBoardSelectionUI();
        if (tableSection && tableSection.style.display !== 'none') renderTable();
        updateSelectionBar();
      });
    }

    const canLeaveRequested = (order) => Boolean(order?.groupId || order?.group);
    const isGroupOrder = (order) => Boolean(order?.groupId || order?.group);

    async function updateStatus(id, status, tracking) {
      const order = getOrderById(id);
      if (!order) return;
      if (status !== 'Requested' && !canLeaveRequested(order)) {
        showBoardMessage('Move the part into an order first.', 'error');
        return;
      }
      const trackingList = Array.isArray(tracking)
        ? tracking
        : (tracking ? [{ carrier: 'unknown', trackingNumber: tracking }] : undefined);
      await fetch(`/api/orders/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          tracking: trackingList,
          trackingNumber: trackingList?.[0]?.trackingNumber
        })
      });
      selected.delete(id);
      await fetchOrders();
    }

    function updateSelectionBar() {
      const selectedOrders = orders.filter(o => selected.has(o._id));
      if (selected.size === 0) {
        selectionCount.textContent = 'No parts selected';
        groupVendorNote.textContent = '';
        if (deleteSelectedBtn) deleteSelectedBtn.style.display = 'none';
        addToOrderMode = false;
        addToOrderVendor = null;
      } else {
        const vendor = selectedOrders[0]?.supplier || selectedOrders[0]?.vendor || 'Mixed';
        selectionCount.textContent = `${selected.size} selected`;
        groupVendorNote.textContent = `Vendor: ${vendor}${selectedOrders.every(o => (o.supplier || o.vendor) === (selectedOrders[0]?.supplier || selectedOrders[0]?.vendor)) ? '' : ' (mixed - fix selection)'}`;
        if (deleteSelectedBtn) deleteSelectedBtn.style.display = 'inline-flex';
        if (addToOrderMode && addToOrderVendor && selectedOrders.some(o => getOrderVendor(o) !== addToOrderVendor)) {
          resetAddToOrderMode();
        }
      }
    }

    async function createGroup() {
      if (actionBusy) return;
      if (!currentUser?.permissions?.canManageOrders) {
        showBoardMessage('No permission to manage orders.', 'error');
        return;
      }
      if (selected.size === 0) return;
      const selectedOrders = orders.filter(o => selected.has(o._id));
      const baseVendor = selectedOrders[0]?.supplier || selectedOrders[0]?.vendor;
      const mixed = selectedOrders.some(o => (o.supplier || o.vendor) !== baseVendor);
      if (mixed) {
        showBoardMessage('Select orders from the same vendor to group.', 'error');
        return;
      }
      const now = new Date();
      const fallbackTitle = baseVendor ? `${baseVendor} - ${formatShortDate(now)} ${formatTimeShort(now)}` : `Group - ${formatShortDate(now)} ${formatTimeShort(now)}`;
      setActionBusy(true, 'Creating order…');
      try {
        const res = await fetch('/api/order-groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: fallbackTitle,
            supplier: baseVendor || undefined,
            requestedDisplayAt: now.getTime(),
            orderIds: Array.from(selected)
          })
        });
        const data = await res.json();
        const newGroupId = data.groupId || data._id;
        await Promise.all(Array.from(selected).map(id => patchStatusOnly(id, 'Ordered')));
        recordAction({
          undo: { type: 'deleteGroup', payload: { groupId: newGroupId } },
          redo: { type: 'createGroup', payload: { title: fallbackTitle, supplier: baseVendor || undefined, requestedDisplayAt: now.getTime(), orderIds: Array.from(selected) } }
        });
        selected.clear();
        groupVendorNote.textContent = 'Vendor: auto from selection';
        await fetchOrders();
      } finally {
        setActionBusy(false);
      }
    }

    function resetAddToOrderMode() {
      addToOrderMode = false;
      addToOrderVendor = null;
      refreshBoardSelectionUI();
    }

    function startAddToOrderMode() {
      if (!currentUser?.permissions?.canManageOrders) {
        showBoardMessage('No permission to manage orders.', 'error');
        return;
      }
      if (!selected.size) return;
      withScrollRestoration(() => {
        const selectedOrders = orders.filter(o => selected.has(o._id));
        const vendor = getOrderVendor(selectedOrders[0]);
        const mixed = selectedOrders.some(o => getOrderVendor(o) !== vendor);
        if (!vendor || mixed) {
          showBoardMessage('Select parts from the same vendor to add to an order.', 'error');
          return;
        }
        addToOrderVendor = vendor;
        addToOrderMode = true;
        refreshBoardSelectionUI();
      });
      showBoardMessage('Tap an existing order with the same vendor to add the selected parts.', 'info', 3000);
    }

    async function addSelectedToGroup(groupId, targetStatus) {
      if (!currentUser?.permissions?.canManageOrders) {
        showBoardMessage('No permission to manage orders.', 'error');
        return;
      }
      if (!selected.size) return;
      const ids = Array.from(selected);
      for (const id of ids) {
        await assignGroup(id, groupId);
        if (targetStatus) await patchStatusOnly(id, targetStatus);
      }
      selected.clear();
      updateSelectionBar();
      resetAddToOrderMode();
      await fetchOrders();
    }

    async function addSelectedToOrder(order) {
      if (!currentUser?.permissions?.canManageOrders) {
        showBoardMessage('No permission to manage orders.', 'error');
        return;
      }
      if (!order || !selected.size) return;
      const targetVendor = getOrderVendor(order);
      if (addToOrderVendor && targetVendor !== addToOrderVendor) {
        showBoardMessage('Select an order with the same vendor.', 'error');
        return;
      }
      const targetStatus = order.status;
      let groupId = order.groupId || order.group?._id;
      if (!groupId) {
        const now = new Date();
        const title = `${order.supplier || order.vendor || 'Order'} - ${formatShortDate(now)} ${formatTimeShort(now)}`;
        const payloadIds = [order._id, ...Array.from(selected)];
        const res = await fetch('/api/order-groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            supplier: order.supplier || order.vendor || undefined,
            requestedDisplayAt: now.getTime(),
            orderIds: payloadIds
          })
        });
        const data = await res.json();
        groupId = data.groupId || data._id;
        for (const id of Array.from(selected)) {
          if (targetStatus) await patchStatusOnly(id, targetStatus);
        }
      } else {
        for (const id of Array.from(selected)) {
          await assignGroup(id, groupId);
          if (targetStatus) await patchStatusOnly(id, targetStatus);
        }
      }
      selected.clear();
      updateSelectionBar();
      resetAddToOrderMode();
      await fetchOrders();
    }

    async function removePartFromGroup(orderId, fromGroupId, fromStatus) {
      const snapshot = snapshotOrder(orderId);
      await assignGroup(orderId, undefined);
      await patchStatusOnly(orderId, 'Requested');
      if (snapshot) {
        recordAction({
          undo: { type: 'updateStatus', payload: { orderId, status: fromStatus || 'Ordered', groupId: fromGroupId } },
          redo: { type: 'updateStatus', payload: { orderId, status: 'Requested', groupId: undefined } }
        });
      }
      await fetchOrders();
    }

    function selectSameVendorRequested() {
      const current = orders.find(o => selected.has(o._id));
      if (!current) return;
      const vendor = getOrderVendor(current);
      if (!vendor) return;
      withScrollRestoration(() => {
        orders.forEach(o => {
          if (o.status === 'Requested' && getOrderVendor(o) === vendor) {
            selected.add(o._id);
          }
        });
        updateSelectionBar();
        refreshBoardSelectionUI();
      });
    }

    // Event wiring
    function showOrdersView() {
      activePrimaryView = 'orders';
      ordersViewBtn?.classList.add('active');
      stockViewBtn?.classList.remove('active');
      if (ordersLayoutRow) ordersLayoutRow.style.display = 'flex';
      if (ordersLayoutToggle) ordersLayoutToggle.style.display = 'inline-flex';
      if (selectionBar) selectionBar.style.display = '';
      if (stockSection) stockSection.style.display = 'none';
      boardSection.style.display = boardBtn.classList.contains('active') ? 'flex' : 'none';
      tableSection.style.display = tableBtn.classList.contains('active') ? 'flex' : 'none';
      if (primaryTitle) primaryTitle.textContent = 'Orders';
      if (primarySubtitle) primarySubtitle.textContent = 'Track parts from request to delivery.';
      updateSearchPlaceholder();
      updateSelectionBar();
      resizeColumns();
      setTimeout(resizeColumns, 30);
    }

    function showStockView() {
      resetAddToOrderMode();
      activePrimaryView = 'stock';
      stockViewBtn?.classList.add('active');
      ordersViewBtn?.classList.remove('active');
      if (ordersLayoutRow) ordersLayoutRow.style.display = 'none';
      if (ordersLayoutToggle) ordersLayoutToggle.style.display = 'none';
      if (selectionBar) selectionBar.style.display = 'none';
      boardSection.style.display = 'none';
      tableSection.style.display = 'none';
      if (stockSection) stockSection.style.display = 'flex';
      if (primaryTitle) primaryTitle.textContent = 'Stock';
      if (primarySubtitle) primarySubtitle.textContent = 'Live view of parts on-hand by location.';
      loadStock();
      updateSearchPlaceholder();
      resizeColumns();
      setTimeout(resizeColumns, 30);
    }

    const switchToBoard = () => {
      if (activePrimaryView !== 'orders') showOrdersView();
      boardBtn.classList.add('active'); tableBtn.classList.remove('active');
      boardSection.style.display = 'flex'; tableSection.style.display = 'none';
      refreshBoardSelectionUI();
      resizeColumns();
      setTimeout(resizeColumns, 30);
    };
    const switchToTable = () => {
      if (activePrimaryView !== 'orders') showOrdersView();
      tableBtn.classList.add('active'); boardBtn.classList.remove('active');
      boardSection.style.display = 'none'; tableSection.style.display = 'flex';
      resizeColumns();
      setTimeout(resizeColumns, 30);
    };
    ordersViewBtn?.addEventListener('click', showOrdersView);
    stockViewBtn?.addEventListener('click', showStockView);
    boardBtn.addEventListener('click', switchToBoard);
    tableBtn.addEventListener('click', switchToTable);
    selectSameVendorBtn?.addEventListener('click', selectSameVendorRequested);
    boardEl?.addEventListener('click', (e) => {
      if (!addToOrderMode) return;
      if (e.target.closest('.to-order-actions') || e.target.closest('.selection-actions')) return;
      if (!e.target.closest('.card')) {
        resetAddToOrderMode();
        refreshBoardSelectionUI();
      }
    });
    refreshBtn.addEventListener('click', () => {
      if (activePrimaryView === 'stock') loadStock(); else fetchOrders();
    });
    undoBtn.addEventListener('click', doUndo);
    globalSearch.addEventListener('input', () => {
      if (activePrimaryView === 'stock') {
        clearTimeout(stockSearchTimer);
        stockSearchTimer = setTimeout(() => loadStock(), 250);
      } else {
        renderBoard(); renderTable();
      }
    });
    statusFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    vendorFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    startDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    endDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    stockSubteamFilter?.addEventListener('change', () => { selectedStockSubteam = stockSubteamFilter.value; loadStock(); });
      addStockBtn?.addEventListener('click', () => openStockModal());
      manageSubteamsBtn?.addEventListener('click', async () => { await loadSubteams(); openSubteamsModal(); });
      stockForm?.addEventListener('submit', saveStockForm);
    addToOrderBtn?.addEventListener('click', () => {
      if (addToOrderMode) resetAddToOrderMode(); else startAddToOrderMode();
    });
    selectAllBtn?.addEventListener('click', () => {
      withScrollRestoration(() => {
        orders.filter(o => o.status === 'Requested').forEach(o => selected.add(o._id));
        updateSelectionBar();
        refreshBoardSelectionUI();
        if (tableSection && tableSection.style.display !== 'none') renderTable();
      });
    });
    unselectAllBtn?.addEventListener('click', () => {
      withScrollRestoration(() => {
        selected.clear();
        updateSelectionBar();
        refreshBoardSelectionUI();
        if (tableSection && tableSection.style.display !== 'none') renderTable();
      });
    });
      deleteStockBtn?.addEventListener('click', async () => {
        const id = stockForm?.elements?.id?.value;
        if (id) {
          if (stockModal) stockModal.style.display = 'none';
          openDeleteStockModal(id);
      }
    });
    cancelStockBtn?.addEventListener('click', () => { if (stockModal) stockModal.style.display = 'none'; resetStockModal(); });
    closeStockModalBtn?.addEventListener('click', () => { if (stockModal) stockModal.style.display = 'none'; resetStockModal(); });
    stockCatalogSearch?.addEventListener('input', () => {
      clearTimeout(stockCatalogSearchTimer);
      stockCatalogSearchTimer = setTimeout(() => searchStockCatalog(stockCatalogSearch.value || ''), 220);
    });
    stockSubteamForm?.addEventListener('submit', saveSubteam);
    clearSubteamFormBtn?.addEventListener('click', () => { stockSubteamForm?.reset(); });
    closeSubteamsModal?.addEventListener('click', () => { if (stockSubteamsModal) stockSubteamsModal.style.display = 'none'; });
    cancelDeleteStock?.addEventListener('click', () => {
      pendingDeleteStockId = null;
      if (stockDeleteModal) stockDeleteModal.style.display = 'none';
    });
    confirmDeleteStock?.addEventListener('click', async () => {
      if (!pendingDeleteStockId) return;
      const id = pendingDeleteStockId;
      pendingDeleteStockId = null;
      if (stockDeleteModal) stockDeleteModal.style.display = 'none';
      await deleteStockItem(id);
    });
    confirmCancel?.addEventListener('click', () => {
      pendingConfirmAction = null;
      if (confirmModal) confirmModal.style.display = 'none';
    });
    confirmOk?.addEventListener('click', async () => {
      if (!pendingConfirmAction) {
        if (confirmModal) confirmModal.style.display = 'none';
        return;
      }
      try {
      const extra = pendingConfirmExtraGetter ? pendingConfirmExtraGetter() : undefined;
      const result = pendingConfirmAction(extra);
        if (result instanceof Promise) await result;
        if (confirmStatus) confirmStatus.textContent = '';
        if (confirmModal) confirmModal.style.display = 'none';
      } catch (err) {
        if (confirmStatus) {
          confirmStatus.textContent = err.message || 'Action failed';
          confirmStatus.className = 'error';
        }
      } finally {
        pendingConfirmAction = null;
      }
    });
    groupBtn.addEventListener('click', createGroup);
    deleteSelectedBtn?.addEventListener('click', async () => {
      const selectedOrders = orders.filter(o => selected.has(o._id));
      const hasGlobal = currentUser?.permissions?.canManagePartRequests;
      const hasOwn = currentUser?.permissions?.canManageOwnPartRequests && selectedOrders.length > 0 && selectedOrders.every(isOwnOrder);
      if (!hasGlobal && !hasOwn) {
        showBoardMessage('No permission to manage these part requests.', 'error');
        return;
      }
      if (!selected.size) return;
      openConfirm(`Delete ${selected.size} selected item(s)?`, async () => {
        for (const id of Array.from(selected)) {
          const snapshot = snapshotOrder(id);
          await fetch(`/api/orders/${id}`, { method: 'DELETE' });
          if (snapshot) {
            recordAction({
              undo: { type: 'restoreOrder', payload: { order: snapshot, groupId: snapshot.groupId || snapshot.group?._id } },
              redo: { type: 'deleteOrder', payload: { orderId: id } }
            });
          }
        }
        selected.clear();
        await fetchOrders();
      });
    });
    document.getElementById('new-order-btn').addEventListener('click', () => {
      editingOrderId = null;
      orderForm.reset();
      orderForm.elements.quantityRequested.value = 1;
      renderTagOptions([]);
      renderPriorityOptions();
      resetCatalogLookup();
      resetCatalogSavePanel();
      syncCatalogSaveUI();
      resetVendorImportState(false);
      updateVendorImportInstructions();
      setOrderSource('manual');
      if (orderTrackingList) setTrackingRows(orderTrackingList, []);
      if (addOrderTracking) addOrderTracking.disabled = true;
      if (orderTrackingList) orderTrackingList.style.display = 'none';
      modal.style.display = 'flex';
    });
    cancelOrder.addEventListener('click', () => { modal.style.display = 'none'; resetCatalogLookup(); resetCatalogSavePanel(); resetVendorImportState(false); updateVendorImportInstructions(); setOrderSource('manual'); });
    const resetGroupModal = () => {
      groupModal.style.display = 'none';
      groupForm.reset();
      setTrackingRows(groupModalTrackingList, []);
      editingGroupId = null;
      groupMessage.textContent = '';
    };
    closeGroup.addEventListener('click', resetGroupModal);
    cancelGroup.addEventListener('click', resetGroupModal);

    function resetUserForm() {
      userForm?.reset();
      if (userForm?.elements?.id) userForm.elements.id.value = '';
      if (userMessage) {
        userMessage.textContent = '';
        userMessage.className = 'small';
      }
      if (saveUserBtn) saveUserBtn.textContent = 'Create user';
    }

    function closeUserModal() {
      if (userModal) userModal.style.display = 'none';
      resetUserForm();
    }

    function openUserModal(user) {
      resetUserForm();
      if (user) {
        if (userForm?.elements?.id) userForm.elements.id.value = user._id || '';
        if (userForm?.elements?.username) userForm.elements.username.value = user.username || '';
        if (userForm?.elements?.name) userForm.elements.name.value = user.name || '';
        if (userForm?.elements?.role) userForm.elements.role.value = user.role || 'student';
        if (userForm?.elements?.active) userForm.elements.active.value = user.active ? 'true' : 'false';
        if (saveUserBtn) saveUserBtn.textContent = 'Update user';
      }
      if (userModal) userModal.style.display = 'flex';
    }

    newUserBtn?.addEventListener('click', () => openUserModal());
    closeUserModalBtn?.addEventListener('click', closeUserModal);
    cancelUserBtn?.addEventListener('click', closeUserModal);

    function setVendorFormMode(mode) {
      vendorFormMode = mode === 'builtin' ? 'builtin' : 'custom';
      if (vendorForm) vendorForm.dataset.mode = vendorFormMode;
      if (vendorCustomPanel) vendorCustomPanel.style.display = vendorFormMode === 'custom' ? VENDOR_CUSTOM_DISPLAY : 'none';
      if (vendorBuiltinPanel) vendorBuiltinPanel.style.display = vendorFormMode === 'builtin' ? 'block' : 'none';
      if (vendorSaveBtn) vendorSaveBtn.textContent = vendorFormMode === 'builtin' ? 'Save settings' : 'Save vendor';
    }

    function renderBuiltinCapabilities(vendor) {
      if (!builtinVendorCapabilities) return;
      const caps = Object.entries(vendor?.capabilities || {}).filter(([, enabled]) => enabled);
      if (!caps.length) {
        builtinVendorCapabilities.innerHTML = '';
        return;
      }
      builtinVendorCapabilities.innerHTML = caps
        .map(([key]) => `<span style="padding:2px 8px; border-radius:999px; background:var(--border); font-size:12px;">${BUILTIN_CAPABILITY_LABELS[key] || key}</span>`)
        .join('');
    }

    function renderBuiltinFields(vendor) {
      builtinFieldInputs = [];
      if (!builtinFieldsContainer) return;
      const fields = vendor?.integrationFields || [];
      if (!fields.length) {
        builtinFieldsContainer.innerHTML = '<div class="small">No configuration required for this vendor.</div>';
        return;
      }
      builtinFieldsContainer.innerHTML = '';
      fields.forEach(field => {
        const labelText = field.label || field.key;
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        label.className = 'small';
        label.textContent = labelText;
        const input = document.createElement('input');
        input.className = 'input';
        input.type = field.type === 'password' ? 'password' : 'text';
        input.placeholder = field.placeholder || '';
        if (field.value) input.value = field.value;
        input.required = Boolean(field.required);
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        builtinFieldsContainer.appendChild(wrapper);
        builtinFieldInputs.push({ key: field.key, input, required: Boolean(field.required), label: labelText });
      });
    }

    function populateBuiltinVendor(vendor) {
      activeBuiltinVendor = vendor || null;
      if (!vendorForm?.elements?.integrationKey) return;
      vendorForm.elements.integrationKey.value = vendor?.key || vendor?.slug || '';
      if (!vendor) return;
      setVendorFormMode('builtin');
      if (builtinVendorDescription) {
        const status = vendor.requiresCredentials
          ? (vendor.hasCredentialsConfigured ? 'Configured' : 'Missing credentials')
          : 'No configuration required';
        builtinVendorDescription.textContent = `${vendor.description || ''} ${status ? `(${status})` : ''}`.trim();
      }
      renderBuiltinCapabilities(vendor);
      renderBuiltinFields(vendor);
    }

    function resetVendorForm() {
      vendorForm?.reset();
      if (vendorForm?.elements?.id) vendorForm.elements.id.value = '';
      if (vendorForm?.elements?.integrationKey) vendorForm.elements.integrationKey.value = '';
      if (vendorMessage) {
        vendorMessage.textContent = '';
        vendorMessage.className = 'small';
      }
      builtinFieldInputs = [];
      activeBuiltinVendor = null;
      setVendorFormMode('custom');
      if (builtinFieldsContainer) builtinFieldsContainer.innerHTML = '';
      if (builtinVendorDescription) builtinVendorDescription.textContent = '';
      if (builtinVendorCapabilities) builtinVendorCapabilities.innerHTML = '';
      const resultsEl = document.getElementById('extract-results');
      if (resultsEl) resultsEl.textContent = '';
      const previewNameEl = document.getElementById('preview-name');
      const previewPriceEl = document.getElementById('preview-price');
      const pickNameEl = document.getElementById('pick-name');
      const pickPriceEl = document.getElementById('pick-price');
      const selectorSnippetEl = document.getElementById('selector-snippet');
      if (previewNameEl) previewNameEl.textContent = '';
      if (previewPriceEl) previewPriceEl.textContent = '';
      if (pickNameEl) pickNameEl.innerHTML = '';
      if (pickPriceEl) pickPriceEl.innerHTML = '';
      if (selectorSnippetEl) selectorSnippetEl.value = '';
      if (testUrl) testUrl.value = '';
    }

    function closeVendorModal() {
      if (vendorModal) vendorModal.style.display = 'none';
      resetVendorForm();
    }

    function openVendorModal(vendor) {
      resetVendorForm();
      if (vendor?.source === 'builtin') {
        populateBuiltinVendor(vendor);
      } else if (vendor) {
        setVendorFormMode('custom');
        if (vendorForm?.elements?.id) vendorForm.elements.id.value = vendor._id || '';
        vendorForm.elements.vendor.value = vendor.vendor || '';
        vendorForm.elements.baseUrl.value = vendor.baseUrl || '';
        vendorForm.elements.productUrlTemplate.value = vendor.productUrlTemplate || '';
        vendorForm.elements.partNumberExample.value = vendor.partNumberExample || '';
        vendorForm.elements.partNumberPattern.value = vendor.partNumberPattern || '';
        vendorForm.elements.nameSelector.value = vendor.nameSelector || '';
        vendorForm.elements.priceSelector.value = vendor.priceSelector || '';
        vendorForm.elements.notes.value = vendor.notes || '';
      } else {
        setVendorFormMode('custom');
      }
      if (vendorModal) vendorModal.style.display = 'flex';
    }

    newVendorBtn?.addEventListener('click', () => openVendorModal());
    closeVendorModalBtn?.addEventListener('click', closeVendorModal);
    cancelVendorBtn?.addEventListener('click', closeVendorModal);

    attachBackdropClose(modal, () => { modal.style.display = 'none'; });
    attachBackdropClose(groupModal, resetGroupModal);
    attachBackdropClose(accountModal, () => { accountModal.style.display = 'none'; });
    attachBackdropClose(tagsModal, () => { tagsModal.style.display = 'none'; });
    attachBackdropClose(adminModal, () => { adminModal.style.display = 'none'; });
    attachBackdropClose(catalogModal, () => { catalogModal.style.display = 'none'; if (catalogItemModal) catalogItemModal.style.display = 'none'; });
    attachBackdropClose(catalogCategoryNewModal, () => { catalogCategoryNewModal.style.display = 'none'; });
    attachBackdropClose(catalogCategoryEditModal, () => { catalogCategoryEditModal.style.display = 'none'; });
    attachBackdropClose(catalogItemModal, () => { catalogItemModal.style.display = 'none'; resetCatalogItemForm(); });
    attachBackdropClose(catalogRequestModal, () => { catalogRequestModal.style.display = 'none'; pendingCatalogRequest = null; });
    attachBackdropClose(stockModal, () => { if (stockModal) stockModal.style.display = 'none'; resetStockModal(); });
    attachBackdropClose(stockSubteamsModal, () => { if (stockSubteamsModal) stockSubteamsModal.style.display = 'none'; });
    attachBackdropClose(stockDeleteModal, () => { if (stockDeleteModal) stockDeleteModal.style.display = 'none'; pendingDeleteStockId = null; });
    attachBackdropClose(confirmModal, () => { if (confirmModal) confirmModal.style.display = 'none'; pendingConfirmAction = null; });
    attachBackdropClose(vendorModal, closeVendorModal);
    attachBackdropClose(userModal, closeUserModal);

    function findVendorConfig(name) {
      if (!name) return null;
      const lower = name.toLowerCase();
      return vendorConfigs.find(v => {
        return (v.vendor || '').toLowerCase() === lower
          || (v.slug || '').toLowerCase() === lower
          || (v.key || '').toLowerCase() === lower;
      }) || null;
    }

    function deriveUrl(config, partNum, link) {
      if (link) return link;
      if (!config) return null;
      if (config.productUrlTemplate && partNum) {
        return config.productUrlTemplate.replace('{partNumber}', partNum);
      }
      if (config.baseUrl && partNum) {
        return `${config.baseUrl.replace(/\/$/, '')}/${partNum}`;
      }
      return null;
    }

    function extractPartNumberFromUrl(config, link) {
      if (!config || !link) return null;
      const vendorKey = (config.key || config.slug || '').toLowerCase();
      const vendorName = (config.vendor || '').toLowerCase();
      const isDigikey = vendorKey === 'digikey' || vendorName.includes('digi-key') || vendorName.includes('digikey');
      const isMouser = vendorKey === 'mouser' || vendorName.includes('mouser');
      const normalized = /^https?:\/\//i.test(link) ? link : `https://${link}`;
      if (isDigikey) {
        try {
          const urlObj = new URL(normalized);
          const segments = urlObj.pathname.split('/').filter(Boolean);
          const detailIdx = segments.findIndex(p => p.toLowerCase() === 'detail');
          if (detailIdx !== -1 && segments.length > detailIdx + 2) {
            const partSegment = segments[detailIdx + 2];
            if (partSegment) return decodeURIComponent(partSegment);
          }
        } catch (err) {
          // ignore parse issues; fall through to returning null
        }
        return null;
      }
      if (isMouser) {
        try {
          const urlObj = new URL(normalized);
          const segments = urlObj.pathname.split('/').filter(Boolean);
          const detailIdx = segments.findIndex(p => p.toLowerCase() === 'productdetail');
          if (detailIdx !== -1) {
            if (segments.length > detailIdx + 2) {
              const partSegment = segments[detailIdx + 2];
              if (partSegment) return decodeURIComponent(partSegment);
            } else if (segments.length > detailIdx + 1) {
              const partSegment = segments[detailIdx + 1];
              if (partSegment) return decodeURIComponent(partSegment);
            }
          }
          const partParam = urlObj.searchParams.get('partnumber') || urlObj.searchParams.get('partnumberlist');
          if (partParam) return partParam;
        } catch (err) {
          // ignore parse issues
        }
        return null;
      }
      const cleanLink = normalized.replace(/\/+$/, '');
      if (config.productUrlTemplate && config.productUrlTemplate.includes('{partNumber}')) {
        // Escape the template and swap the placeholder with a capture group.
        const pattern = config.productUrlTemplate
          .replace(/\{partNumber\}/g, '__PART__')
          .replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')
          .replace(/__PART__/g, '([^/?#]+)');
        const regex = new RegExp('^' + pattern.replace(/\\\/+$/, '') + '\\/?$', 'i');
        const m = cleanLink.match(regex);
        if (m && m[1]) return decodeURIComponent(m[1]);
      }
      if (config.partNumberPattern) {
        const regex = new RegExp(config.partNumberPattern, 'i');
        const m = cleanLink.match(regex);
        if (m && m[1]) return m[1];
      }
      const parts = cleanLink.split('/').filter(Boolean);
      return parts[parts.length - 1] || null;
    }

    async function resolveBuiltinVendorPart(config, link) {
      if (!config || config.source !== 'builtin' || !link) return null;
      const vendorKey = config.key || config.slug || config.vendor;
      if (!vendorKey) return null;
      try {
        const res = await fetch('/api/vendors/resolve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vendorKey, url: link })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to resolve vendor link');
        return data;
      } catch (err) {
        console.warn('Failed to resolve vendor link', err);
        return null;
      }
    }

    function parsePrice(text) {
      if (!text) return undefined;
      const num = parseFloat(text.replace(/[^0-9\\.]+/g, ''));
      return Number.isFinite(num) ? num : undefined;
    }

    function generateId(prefix = 'id') {
      return `${prefix}-${Math.random().toString(36).slice(2, 9)}-${Date.now().toString(36)}`;
    }

    function copyTextToClipboard(text) {
      if (!text) return Promise.resolve();
      if (navigator.clipboard?.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise((resolve, reject) => {
        try {
          const temp = document.createElement('textarea');
          temp.value = text;
          temp.style.position = 'fixed';
          temp.style.opacity = '0';
          document.body.appendChild(temp);
          temp.select();
          document.execCommand('copy');
          document.body.removeChild(temp);
          resolve();
        } catch (err) {
          reject(err);
        }
      });
    }

    function ensureXlsxLibrary() {
      if (window.XLSX) return Promise.resolve(window.XLSX);
      if (!xlsxLoaderPromise) {
        xlsxLoaderPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
          script.onload = () => {
            if (window.XLSX) resolve(window.XLSX);
            else {
              xlsxLoaderPromise = null;
              reject(new Error('Failed to load XLSX parser'));
            }
          };
          script.onerror = () => {
            xlsxLoaderPromise = null;
            reject(new Error('Failed to load XLSX parser'));
          };
          document.head.appendChild(script);
        });
      }
      return xlsxLoaderPromise;
    }

    async function readWorkbookFromFile(file) {
      const XLSX = await ensureXlsxLibrary();
      const buffer = await file.arrayBuffer();
      return XLSX.read(buffer, { type: 'array' });
    }

    function resetVendorImportState(clearVendor = false) {
      vendorImportEntries = [];
      if (clearVendor && vendorImportSelect) {
        vendorImportSelect.value = '';
        vendorImportVendor = null;
        updateVendorImportInstructions();
      }
      if (vendorImportFile) vendorImportFile.value = '';
      if (vendorImportText) vendorImportText.value = '';
      if (vendorImportMessage) {
        vendorImportMessage.textContent = '';
        vendorImportMessage.className = 'small';
      }
      renderVendorImportPreview();
    }

    function renderVendorImportPreview() {
      if (!vendorImportPreview) return;
      if (!vendorImportEntries.length) {
        vendorImportPreview.innerHTML = '<div class="empty">No vendor items parsed yet.</div>';
      } else {
        vendorImportPreview.innerHTML = vendorImportEntries.map((entry) => {
          const vendorTags = [];
          if (entry.digiKeyPartNumber) vendorTags.push(`Digi-Key: ${escapeHtml(entry.digiKeyPartNumber)}`);
          if (entry.mouserPartNumber) vendorTags.push(`Mouser: ${escapeHtml(entry.mouserPartNumber)}`);
          if (entry.manufacturerPartNumber) vendorTags.push(`MPN: ${escapeHtml(entry.manufacturerPartNumber)}`);
          return `
          <div class="card" data-import-id="${entry.id}" style="margin-bottom:8px; padding:10px;">
            <div class="flex-between" style="gap:8px; flex-wrap:wrap; align-items:flex-start;">
              <div style="flex:1; min-width:160px;">
                <div style="font-weight:600;">${escapeHtml(entry.description || entry.manufacturerPartNumber || entry.digiKeyPartNumber || entry.mouserPartNumber || 'Part')}</div>
                <div class="small">Qty: ${entry.quantity || 1}${vendorTags.length ? ' · ' + vendorTags.join(' · ') : ''}</div>
                ${entry.customerReference ? `<div class="small">Ref: ${escapeHtml(entry.customerReference)}</div>` : ''}
              </div>
              <button class="btn ghost" data-action="remove-import-entry" data-index="${entry.id}" style="padding:4px 8px; color:var(--danger);">Remove</button>
            </div>
          </div>
        `;
        }).join('');
      }
      if (vendorImportSummary) {
        vendorImportSummary.textContent = vendorImportEntries.length
          ? `Ready to import ${vendorImportEntries.length} item(s) from ${vendorImportVendor?.vendor || 'vendor'}.`
          : '';
      }
      if (vendorImportActions) {
        vendorImportActions.style.display = (orderSource === 'import' && canUseVendorImport() && vendorImportEntries.length) ? 'flex' : 'none';
      }
    }

    function isDigikeyVendorName(name = '') {
      const lower = (name || '').toLowerCase();
      return lower.includes('digikey') || lower.includes('digi-key');
    }

    function isDigikeyVendor(vendor) {
      if (!vendor) return false;
      if (typeof vendor === 'string') return isDigikeyVendorName(vendor);
      const key = (vendor.key || vendor.slug || '').toLowerCase();
      if (key === 'digikey') return true;
      return isDigikeyVendorName(vendor.vendor || vendor.supplier || '');
    }

    function isMouserVendorName(name = '') {
      const lower = (name || '').toLowerCase();
      return lower.includes('mouser');
    }

    function isMouserVendor(vendor) {
      if (!vendor) return false;
      if (typeof vendor === 'string') return isMouserVendorName(vendor);
      const key = (vendor.key || vendor.slug || '').toLowerCase();
      if (key === 'mouser') return true;
      return isMouserVendorName(vendor.vendor || vendor.supplier || '');
    }

    function supportsVendorExport(order) {
      if (!order) return false;
      const vendorName = order.vendor || order.supplier || '';
      if (isDigikeyVendorName(vendorName) || isMouserVendorName(vendorName)) return true;
      const config = findVendorConfig(vendorName);
      return Boolean(config?.capabilities?.quickOrderExport);
    }

    function supportsVendorExportByName(name) {
      if (!name) return false;
      if (isDigikeyVendorName(name) || isMouserVendorName(name)) return true;
      const config = findVendorConfig(name);
      return Boolean(config?.capabilities?.quickOrderExport);
    }

    function parseVendorCsv(vendor, text) {
      if (!text) return [];
      if (isDigikeyVendor(vendor)) return parseDigikeyCartCsv(text);
      if (isMouserVendor(vendor)) return parseMouserCartCsv(text);
      throw new Error(`CSV import is not implemented for ${vendor.vendor || 'this vendor'}.`);
    }

    function parseVendorQuickText(vendor, text) {
      if (!text) return [];
      if (isDigikeyVendor(vendor)) return parseDigikeyQuickText(text);
      if (isMouserVendor(vendor)) return parseMouserQuickText(text);
      throw new Error(`Quick entry import is not implemented for ${vendor.vendor || 'this vendor'}.`);
    }

    function parseCsvText(text) {
      if (!text) return [];
      const rows = [];
      let current = '';
      let row = [];
      let inQuotes = false;
      const pushValue = () => {
        row.push(current);
        current = '';
      };
      const pushRow = () => {
        if (row.length && row.some(cell => (cell || '').length)) rows.push(row);
        row = [];
      };
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '"') {
          if (inQuotes && text[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          pushValue();
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          if (char === '\r' && text[i + 1] === '\n') i++;
          pushValue();
          pushRow();
        } else {
          current += char;
        }
      }
      pushValue();
      pushRow();
      if (rows.length && rows[0].length && rows[0][0] && rows[0][0].charCodeAt(0) === 0xfeff) {
        rows[0][0] = rows[0][0].substring(1);
      }
      return rows;
    }

    function parseDigikeyCartCsv(text) {
      const rows = parseCsvText(text);
      if (!rows.length) return [];
      const normalizeHeader = (cell = '') => cell.replace(/\ufeff/g, '').trim().toLowerCase().replace(/[^a-z0-9]/g, '');
      const headerRow = rows.shift().map(normalizeHeader);
      const headerMap = {};
      headerRow.forEach((name, idx) => {
        if (name) headerMap[name] = idx;
      });
      const quantityIdx = headerMap.quantity;
      const digiKeyPartIdx = headerMap.partnumber;
      const manufacturerIdx = headerMap.manufacturerpartnumber;
      const descriptionIdx = headerMap.description;
      const customerRefIdx = headerMap.customerreference;
      const unitPriceIdx = headerMap.unitprice;
      if (quantityIdx === undefined || digiKeyPartIdx === undefined) {
        throw new Error('Unrecognized Digi-Key cart CSV format.');
      }
      const entries = [];
      rows.forEach((row) => {
        const qtyRaw = row[quantityIdx];
        const quantity = Number((qtyRaw || '').replace(/[^0-9.]/g, '')) || 0;
        if (!quantity) return;
        const digiKeyPartNumber = (row[digiKeyPartIdx] || '').trim();
        if (!digiKeyPartNumber) return;
        const manufacturerPartNumber = (row[manufacturerIdx] || '').trim() || '';
        const description = (row[descriptionIdx] || '').trim();
        const customerReference = (row[customerRefIdx] || '').trim();
        const unitPrice = unitPriceIdx !== undefined
          ? parseFloat((row[unitPriceIdx] || '').replace(/[^0-9.]/g, '')) : undefined;
        entries.push({
          id: generateId('import'),
          vendorKey: 'digikey',
          quantity,
          digiKeyPartNumber,
          manufacturerPartNumber: manufacturerPartNumber || digiKeyPartNumber,
          description,
          customerReference,
          unitPrice: Number.isFinite(unitPrice) ? unitPrice : undefined,
          productUrl: buildDigikeySearchUrl(digiKeyPartNumber),
          source: 'csv'
        });
      });
      if (!entries.length) throw new Error('No items found in the CSV file.');
      return entries;
    }

    function parseDigikeyQuickText(text) {
      return text
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(Boolean)
        .map(line => {
          const tokens = line.split(/[\s,;\t]+/).filter(Boolean);
          if (!tokens.length) return null;
          const firstIsQty = /^[0-9]+$/.test(tokens[0]);
          const lastIsQty = /^[0-9]+$/.test(tokens[tokens.length - 1]);
          let quantity = 1;
          let partNumber = '';
          if (firstIsQty && tokens.length > 1) {
            quantity = Number(tokens[0]) || 1;
            partNumber = tokens.slice(1).join(' ');
          } else if (lastIsQty && tokens.length > 1) {
            quantity = Number(tokens[tokens.length - 1]) || 1;
            partNumber = tokens.slice(0, -1).join(' ');
          } else if (tokens.length >= 2) {
            partNumber = tokens[0];
            quantity = Number(tokens[1]) || 1;
          } else {
            partNumber = tokens[0];
          }
          partNumber = partNumber.trim();
          if (!partNumber) return null;
          return {
            id: generateId('import'),
            vendorKey: 'digikey',
            quantity: quantity || 1,
            digiKeyPartNumber: partNumber,
            manufacturerPartNumber: '',
            description: '',
            customerReference: '',
            unitPrice: undefined,
            productUrl: buildDigikeySearchUrl(partNumber),
            source: 'text'
          };
        })
        .filter(Boolean);
    }

    function parseVendorWorkbook(vendor, workbook) {
      if (!vendor || !workbook) return [];
      if (isMouserVendor(vendor)) return parseMouserWorkbook(workbook);
      throw new Error(`Excel import is not implemented for ${vendor.vendor || 'this vendor'}.`);
    }

    function parseMouserWorkbook(workbook) {
      if (!workbook?.SheetNames?.length || !window.XLSX) {
        throw new Error('Unable to read the spreadsheet file.');
      }
      const XLSX = window.XLSX;
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      if (!sheet) {
        throw new Error('The spreadsheet does not contain any sheets.');
      }
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });
      if (!rows.length) {
        throw new Error('The spreadsheet is empty.');
      }
      const { header, data } = splitMouserHeader(rows);
      if (!header) {
        throw new Error('Unable to locate the Mouser header row.');
      }
      const normalizedHeader = header.map((cell, idx) => {
        return (cell || `Column${idx}`).toString().replace(/\ufeff/g, '').trim();
      });
      const entries = data
        .map(row => {
          if (!row || !row.length) return null;
          const record = {};
          normalizedHeader.forEach((key, idx) => {
            record[key] = row[idx];
          });
          return buildMouserEntryFromRecord(record, 'xls');
        })
        .filter(Boolean);
      if (!entries.length) throw new Error('No items found in the Mouser spreadsheet.');
      return entries;
    }

    function splitMouserHeader(rows) {
      const clone = [...rows];
      while (clone.length) {
        const candidate = (clone.shift() || []).map(cell => cell ?? '');
        if (rowLooksLikeMouserHeader(candidate)) {
          return { header: candidate, data: clone };
        }
      }
      return { header: null, data: [] };
    }

    function rowLooksLikeMouserHeader(row) {
      if (!Array.isArray(row)) return false;
      const normalized = row.map(cell => String(cell || '').toLowerCase());
      const joined = normalized.join(' ');
      return (joined.includes('mouser') || joined.includes('manufacturer') || joined.includes('mfr')) && joined.includes('qty');
    }

    function normalizeRecordKey(key) {
      return String(key || '').trim().toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function cleanRecordValue(value) {
      if (value === undefined || value === null) return '';
      return String(value).trim();
    }

    function getRecordValue(record, candidates = []) {
      const normalizedTargets = candidates.map(c => c.toLowerCase());
      for (const key of Object.keys(record || {})) {
        const slug = normalizeRecordKey(key);
        if (!slug) continue;
        if (normalizedTargets.some(target => slug.includes(target))) {
          const val = record[key];
          if (val !== undefined && val !== null && String(val).toString().trim() !== '') {
            return val;
          }
        }
      }
      return undefined;
    }

    function buildMouserEntryFromRecord(record, source = 'csv') {
      if (!record) return null;
      const qtyRaw = getRecordValue(record, ['orderqty', 'qty', 'quantity']);
      const mouserPart = cleanRecordValue(getRecordValue(record, ['mouserpart', 'mousernumber', 'mouser']));
      const manufacturerPart = cleanRecordValue(getRecordValue(record, ['manufacturerpart', 'mfrpart', 'mfrnumber']));
      const description = cleanRecordValue(getRecordValue(record, ['description']));
      const priceRaw = getRecordValue(record, ['priceusd', 'price']);
      const customerRef = cleanRecordValue(getRecordValue(record, ['customerreference', 'customerref', 'custref', 'customer']));
      const qtyNumber = Number(String(qtyRaw || '').replace(/[^0-9.]/g, ''));
      const quantity = Number.isFinite(qtyNumber) ? Math.max(1, Math.round(qtyNumber)) : 0;
      if (!quantity || (!mouserPart && !manufacturerPart)) return null;
      return {
        id: generateId('import'),
        vendorKey: 'mouser',
        quantity,
        mouserPartNumber: mouserPart || undefined,
        manufacturerPartNumber: manufacturerPart || mouserPart || undefined,
        description: description || manufacturerPart || mouserPart || '',
        customerReference: customerRef || '',
        unitPrice: priceRaw ? parsePriceNumber(priceRaw) : undefined,
        productUrl: buildMouserSearchUrl(mouserPart || manufacturerPart),
        source
      };
    }

    function parseMouserCartCsv(text) {
      const rows = parseCsvText(text);
      if (!rows.length) return [];
      const working = [...rows];
      let header = null;
      while (working.length && !header) {
        const candidate = working.shift().map(cell => cell ?? '');
        if (rowLooksLikeMouserHeader(candidate)) {
          header = candidate;
        }
      }
      if (!header) throw new Error('Unable to locate the header row in the Mouser CSV.');
      const headerMap = header.map((cell, idx) => (cell || `Column${idx}`)).map(cell => cell.replace(/\ufeff/g, '').trim());
      const entries = working
        .map(row => {
          if (!row || !row.length || !row.some(cell => (cell || '').toString().trim().length)) return null;
          const record = {};
          headerMap.forEach((key, idx) => {
            record[key] = row[idx];
          });
          return buildMouserEntryFromRecord(record, 'csv');
        })
        .filter(Boolean);
      if (!entries.length) throw new Error('No items found in the CSV file.');
      return entries;
    }

    function parseMouserQuickText(text) {
      return text
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(Boolean)
        .map(line => {
          const tokens = line.split(/[\s,;\t]+/).filter(Boolean);
          if (!tokens.length) return null;
          const firstIsQty = /^[0-9]+$/.test(tokens[0]);
          const lastIsQty = /^[0-9]+$/.test(tokens[tokens.length - 1]);
          let quantity = 1;
          let partNumber = '';
          if (firstIsQty && tokens.length > 1) {
            quantity = Number(tokens[0]) || 1;
            partNumber = tokens.slice(1).join(' ');
          } else if (lastIsQty && tokens.length > 1) {
            quantity = Number(tokens[tokens.length - 1]) || 1;
            partNumber = tokens.slice(0, -1).join(' ');
          } else if (tokens.length >= 2) {
            partNumber = tokens[0];
            quantity = Number(tokens[1]) || 1;
          } else {
            partNumber = tokens[0];
          }
          partNumber = partNumber.trim();
          if (!partNumber) return null;
          return {
            id: generateId('import'),
            vendorKey: 'mouser',
            quantity: quantity || 1,
            mouserPartNumber: partNumber,
            manufacturerPartNumber: '',
            description: '',
            customerReference: '',
            unitPrice: undefined,
            productUrl: buildMouserSearchUrl(partNumber),
            source: 'text'
          };
        })
        .filter(Boolean);
    }

    function buildDigikeySearchUrl(partNumber) {
      if (!partNumber) return undefined;
      return `https://www.digikey.com/en/products/search?keywords=${encodeURIComponent(partNumber)}`;
    }

    function buildMouserSearchUrl(partNumber) {
      if (!partNumber) return undefined;
      return `https://www.mouser.com/ProductDetail/${encodeURIComponent(partNumber)}`;
    }

    function buildVendorProductSearchUrl(vendorKey, partNumber) {
      const key = (vendorKey || '').toLowerCase();
      if (key === 'digikey') return buildDigikeySearchUrl(partNumber);
      if (key === 'mouser') return buildMouserSearchUrl(partNumber);
      return undefined;
    }

    function isDigikeySearchUrl(url) {
      if (!url) return false;
      try {
        const parsed = new URL(url);
        const host = (parsed.hostname || '').toLowerCase();
        const path = (parsed.pathname || '').toLowerCase();
        if (!host.includes('digikey')) return false;
        return path.includes('/products/search') || path.startsWith('/short/');
      } catch (err) {
        const lower = String(url).toLowerCase();
        return lower.includes('digikey.com/en/products/search') || lower.includes('digikey.com/short/');
      }
    }

    function isMouserSearchUrl(url) {
      if (!url) return false;
      try {
        const parsed = new URL(url);
        const host = (parsed.hostname || '').toLowerCase();
        if (!host.includes('mouser')) return false;
        const path = (parsed.pathname || '').toLowerCase();
        return path.includes('/productdetail');
      } catch (err) {
        const lower = String(url).toLowerCase();
        return lower.includes('mouser.com/productdetail');
      }
    }

    function shouldReplaceVendorImportUrl(currentUrl, vendorKey) {
      if (!currentUrl) return true;
      const key = (vendorKey || '').toLowerCase();
      if (key === 'digikey') return isDigikeySearchUrl(currentUrl);
      if (key === 'mouser') return isMouserSearchUrl(currentUrl);
      return false;
    }

    function buildImportPayload(entry, vendor) {
      const vendorName = vendor?.vendor || vendor?.slug || vendor?.key || 'Vendor';
      const vendorKey = (vendor?.key || vendor?.slug || '').toLowerCase();
      const vendorSku = entry.productCode || entry.digiKeyPartNumber || entry.mouserPartNumber || '';
      const manufacturerPart = entry.manufacturerPartNumber || vendorSku || '';
      const partName = entry.description || manufacturerPart || vendorSku || 'Imported Part';
      const searchUrl = buildVendorProductSearchUrl(vendorKey, vendorSku || manufacturerPart);
      const partLink = entry.productUrl || searchUrl;
      const noteParts = ['Vendor import'];
      if (vendorKey === 'digikey' && (entry.digiKeyPartNumber || vendorSku)) {
        noteParts.push(`Digi-Key #: ${entry.digiKeyPartNumber || vendorSku}`);
      }
      if (vendorKey === 'mouser' && (entry.mouserPartNumber || vendorSku)) {
        noteParts.push(`Mouser #: ${entry.mouserPartNumber || vendorSku}`);
      }
      if (entry.customerReference) noteParts.push(`Ref: ${entry.customerReference}`);
      return {
        vendor: vendorName,
        supplier: vendorName,
        vendorPartNumber: manufacturerPart || vendorSku,
        productCode: vendorSku || undefined,
        partName,
        quantityRequested: entry.quantity || 1,
        unitCost: entry.unitPrice !== undefined ? entry.unitPrice : undefined,
        priority: defaultPriorityLabel(),
        tags: [],
        notes: noteParts.join(' · '),
        partLink
      };
    }

    async function fetchVendorProductDetails(vendorKey, partNumber) {
      if (!vendorKey || !partNumber) return null;
      const body = {
        vendorKey,
        partNumber: partNumber.trim()
      };
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Vendor lookup failed');
        return data;
      } catch (err) {
        console.warn('Vendor lookup failed', err);
        return null;
      }
    }

    function parsePriceNumber(text) {
      if (!text) return undefined;
      const num = parseFloat(String(text).replace(/[^0-9\\.]+/g, ''));
      return Number.isFinite(num) ? num : undefined;
    }

    async function enrichVendorImportEntries(entries) {
      if (!entries?.length || !vendorImportVendor) return;
      const vendorKey = (vendorImportVendor.key || vendorImportVendor.slug || vendorImportVendor.vendor || '').toLowerCase();
      if (!vendorKey || !['digikey', 'mouser'].includes(vendorKey)) return;
      for (const entry of entries) {
        const candidatePart = entry.productCode || entry.digiKeyPartNumber || entry.mouserPartNumber || entry.manufacturerPartNumber;
        if (!candidatePart) continue;
        const details = await fetchVendorProductDetails(vendorKey, candidatePart);
        if (!details) continue;
        if (!entry.description && details.picks?.name) entry.description = details.picks.name;
        if (details.productUrl && shouldReplaceVendorImportUrl(entry.productUrl, vendorKey)) {
          entry.productUrl = details.productUrl;
        }
        if (!entry.unitPrice) {
          const price = parsePriceNumber(details.picks?.price);
          if (price !== undefined) entry.unitPrice = price;
        }
        if (!entry.manufacturerPartNumber && details.meta?.manufacturerPartNumber) {
          entry.manufacturerPartNumber = details.meta.manufacturerPartNumber;
        }
        if (vendorKey === 'digikey' && !entry.digiKeyPartNumber && details.meta?.digiKeyProductNumber) {
          entry.digiKeyPartNumber = details.meta.digiKeyProductNumber;
        }
        if (vendorKey === 'mouser' && !entry.mouserPartNumber && details.meta?.mouserPartNumber) {
          entry.mouserPartNumber = details.meta.mouserPartNumber;
        }
        if (!entry.productCode) {
          entry.productCode = entry.digiKeyPartNumber || entry.mouserPartNumber || undefined;
        }
      }
    }

    async function handleVendorImportParse() {
      if (!canUseVendorImport()) {
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'You do not have permission to import vendor orders.';
          vendorImportMessage.className = 'small error';
        }
        return;
      }
      if (!vendorImportVendor) {
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'Select a vendor before parsing.';
          vendorImportMessage.className = 'small error';
        }
        return;
      }
      const file = vendorImportFile?.files?.[0];
      const pasted = vendorImportText?.value?.trim();
      if (!file && !pasted) {
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'Choose a CSV file or paste part numbers first.';
          vendorImportMessage.className = 'small error';
        }
        return;
      }
      try {
        let parsed = [];
        if (file) {
          const ext = (file.name.split('.').pop() || '').toLowerCase();
          if (ext === 'xls' || ext === 'xlsx') {
            const workbook = await readWorkbookFromFile(file);
            parsed = parseVendorWorkbook(vendorImportVendor, workbook);
          } else {
            const text = await file.text();
            parsed = parseVendorCsv(vendorImportVendor, text);
          }
        } else if (pasted) {
          parsed = parseVendorQuickText(vendorImportVendor, pasted);
        }
        vendorImportEntries = parsed;
        if (!parsed.length) throw new Error('No valid items were found.');
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'Parsed items. Looking up product details...';
          vendorImportMessage.className = 'small';
        }
        await enrichVendorImportEntries(vendorImportEntries);
        if (vendorImportMessage) {
          vendorImportMessage.textContent = `Parsed ${parsed.length} item(s).`;
          vendorImportMessage.className = 'small success';
        }
        if (vendorImportFile) vendorImportFile.value = '';
        if (vendorImportText && pasted) vendorImportText.value = '';
      } catch (err) {
        vendorImportEntries = [];
        if (vendorImportMessage) {
          vendorImportMessage.textContent = err.message || 'Failed to parse vendor input.';
          vendorImportMessage.className = 'small error';
        }
      }
      renderVendorImportPreview();
    }

    async function submitVendorImportEntries() {
      if (!canUseVendorImport()) {
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'You do not have permission to import vendor orders.';
          vendorImportMessage.className = 'small error';
        }
        return;
      }
      if (!vendorImportVendor) {
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'Select a vendor to import from.';
          vendorImportMessage.className = 'small error';
        }
        return;
      }
      if (!vendorImportEntries.length) {
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'No parsed items to import yet.';
          vendorImportMessage.className = 'small error';
        }
        return;
      }
      if (vendorImportMessage) {
        vendorImportMessage.textContent = 'Adding items...';
        vendorImportMessage.className = 'small';
      }
      let success = 0;
      const failed = [];
      for (const entry of vendorImportEntries) {
        const payload = buildImportPayload(entry, vendorImportVendor);
        try {
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Failed to create order');
          success++;
        } catch (err) {
          failed.push(entry);
        }
      }
      if (failed.length) {
        vendorImportEntries = failed;
        if (vendorImportMessage) {
          vendorImportMessage.textContent = `Added ${success} item(s). ${failed.length} item(s) need attention.`;
          vendorImportMessage.className = 'small error';
        }
        renderVendorImportPreview();
        fetchOrders();
        return;
      }
      vendorImportEntries = [];
      renderVendorImportPreview();
      if (vendorImportMessage) {
        vendorImportMessage.textContent = `Added ${success} item(s) from ${vendorImportVendor.vendor}.`;
        vendorImportMessage.className = 'small success';
      }
      modal.style.display = 'none';
      orderForm.reset();
      if (orderForm.elements.quantityRequested) orderForm.elements.quantityRequested.value = 1;
      resetCatalogLookup();
      resetCatalogSavePanel();
      editingOrderId = null;
      if (orderTrackingList) setTrackingRows(orderTrackingList, []);
      setOrderSource('manual');
      fetchOrders();
      showBoardMessage(`Imported ${success} request(s) from ${vendorImportVendor.vendor}.`, 'success', 2500);
    }

    function csvQuote(value) {
      const str = value === undefined || value === null ? '' : String(value);
      return `"${str.replace(/"/g, '""')}"`;
    }

    function buildDigikeyCartCsv(orders) {
      const header = ['Index','Quantity','Part Number','Manufacturer Part Number','Description','Customer Reference','Available','Backorder','Unit Price','Extended Price USD'];
      const lines = [header].concat(orders.map((order, idx) => {
        const quantity = Number(order.quantityRequested) || 1;
        const unitPrice = Number(order.unitCost ?? order.fetchedPrice);
        const extended = Number.isFinite(unitPrice) ? unitPrice * quantity : undefined;
        const digiKeyNumber = order.productCode || order.digiKeyPartNumber || '';
        const manufacturerPart = order.vendorPartNumber || '';
        return [
          idx + 1,
          quantity,
          digiKeyNumber || manufacturerPart,
          manufacturerPart || digiKeyNumber,
          order.partName || '',
          '',
          '',
          '',
          Number.isFinite(unitPrice) ? unitPrice.toFixed(5) : '',
          Number.isFinite(extended) ? extended.toFixed(2) : ''
        ];
      }));
      return '\ufeff' + lines.map(row => row.map(csvQuote).join(',')).join('\r\n');
    }

    function buildMouserQuickOrderCsv(orders) {
      const header = ['Order Qty','Mouser Part Number'];
      const rows = [];
      orders.forEach(order => {
        const mouserNumber = order.productCode || order.vendorPartNumber || '';
        if (!mouserNumber) return;
        const quantity = Number(order.quantityRequested) || 1;
        rows.push([quantity, mouserNumber]);
      });
      const lines = [header].concat(rows);
      return '\ufeff' + lines.map(row => row.map(csvQuote).join(',')).join('\r\n');
    }

    function buildMouserQuickOrderLines(orders) {
      return orders
        .map(order => {
          const quantity = Number(order.quantityRequested) || 1;
          const mouserNumber = order.productCode || order.vendorPartNumber || '';
          if (!mouserNumber) return null;
          return `${quantity},${mouserNumber}`;
        })
        .filter(Boolean);
    }

    function formatFilenameDate(date = new Date()) {
      const pad = (n) => String(n).padStart(2, '0');
      return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}_${pad(date.getHours())}${pad(date.getMinutes())}`;
    }

    function downloadTextFile(filename, text, mime = 'text/plain;charset=utf-8;') {
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }

    function exportOrdersForVendor(orderList, vendorNameHint) {
      if (!orderList || !orderList.length) {
        showBoardMessage('No items to export.', 'error', 2500);
        return;
      }
      const vendorName = vendorNameHint || orderList[0]?.vendor || orderList[0]?.supplier || '';
      if (isDigikeyVendorName(vendorName)) {
        const csv = buildDigikeyCartCsv(orderList);
        downloadTextFile(`digikey-cart-${formatFilenameDate()}.csv`, csv, 'text/csv;charset=utf-8;');
        showBoardMessage('Digi-Key cart CSV downloaded.', 'info', 2200);
        return;
      }
      if (isMouserVendorName(vendorName)) {
        const csv = buildMouserQuickOrderCsv(orderList);
        const lines = buildMouserQuickOrderLines(orderList);
        const skipped = orderList.length - lines.length;
        openVendorExportModal({
          vendorName: 'Mouser Electronics',
          description: 'Download the CSV or copy the Qty,PartNumber list for Mouser’s quick order form.',
          text: lines.join('\n'),
          csv,
          filename: `mouser-quick-order-${formatFilenameDate()}.csv`,
          message: skipped
            ? `${skipped} item(s) were skipped because they do not have Mouser part numbers.`
            : undefined,
          messageType: skipped ? 'error' : undefined
        });
        return;
      }
      showBoardMessage('Export not available for this vendor yet.', 'error', 2500);
    }

    async function fetchCatalogDetails() {
      if (!currentUser) return;
      const vendorInput = catalogItemForm?.elements?.vendor;
      const partInput = catalogItemForm?.elements?.vendorPartNumber;
      const linkInput = catalogItemForm?.elements?.supplierLink;
      const nameInput = catalogItemForm?.elements?.name;
      const priceInput = catalogItemForm?.elements?.unitCost;
      const vendor = vendorInput?.value?.trim();
      let partNumber = partInput?.value?.trim();
      const link = linkInput?.value?.trim();
      const config = detectVendor(partNumber, link) || findVendorConfig(vendor);
      if (!partNumber && config && link) {
        const extracted = extractPartNumberFromUrl(config, link);
        if (extracted && partInput) {
          partInput.value = extracted;
          partNumber = extracted;
        }
      }
      if (!partNumber && config?.source === 'builtin' && link) {
        const resolved = await resolveBuiltinVendorPart(config, link);
        if (resolved?.partNumber && partInput) {
          partInput.value = resolved.partNumber;
          partNumber = resolved.partNumber;
        }
        if (resolved?.productUrl && linkInput && !linkInput.value) {
          linkInput.value = resolved.productUrl;
        }
      }
      if (config?.vendor && vendorInput) vendorInput.value = config.vendor;
      const isBuiltin = config?.source === 'builtin';
      if (isBuiltin && !partNumber) {
        catalogItemMessage.textContent = `Enter a part number to fetch from ${config.vendor}.`;
        catalogItemMessage.className = 'error';
        return;
      }
      const url = isBuiltin ? null : (deriveUrl(config, partNumber, link) || link);
      catalogItemMessage.textContent = 'Fetching...';
      catalogItemMessage.className = 'small';
      if (!isBuiltin && !url) {
        catalogItemMessage.textContent = 'Provide a vendor link or part number first.';
        catalogItemMessage.className = 'error';
        return;
      }
      if (!config && !url) {
        catalogItemMessage.textContent = 'Provide a link or pick a supported vendor.';
        catalogItemMessage.className = 'error';
        return;
      }
      const body = isBuiltin
        ? { vendorKey: config.key, partNumber }
        : {
            url,
            selectors: {
              nameSelector: config?.nameSelector,
              priceSelector: config?.priceSelector
            }
          };
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Fetch failed');

        const pickName = data.picks?.name || data.candidates?.titles?.[0]?.text;
        const pickPrice = data.picks?.price || data.candidates?.prices?.[0]?.text;
        if (data.message && !pickName && (pickPrice === undefined || pickPrice === null)) {
          throw new Error(data.message);
        }

        if (pickName && nameInput && !nameInput.value) nameInput.value = pickName;
        const priceNum = parsePrice(pickPrice);
        if (priceNum !== undefined && priceInput) {
          priceInput.value = priceNum;
        }
        if (isBuiltin && data.productUrl && linkInput && !linkInput.value) {
          linkInput.value = data.productUrl;
        } else if (!isBuiltin && linkInput && !linkInput.value) {
          linkInput.value = url;
        }
        if (config?.vendor && vendorInput) vendorInput.value = config.vendor;

        catalogItemMessage.textContent = 'Fetched. Verify fields before saving.';
        catalogItemMessage.className = 'success';
      } catch (err) {
        catalogItemMessage.textContent = err.message || 'Fetch failed. Fill manually.';
        catalogItemMessage.className = 'error';
      }
    }

    async function assignGroup(orderId, groupId) {
      return fetch(`/api/orders/${orderId}/group`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupId: groupId === undefined ? undefined : groupId })
      });
    }

    async function patchStatusOnly(id, status, tracking) {
      const trackingList = Array.isArray(tracking)
        ? tracking
        : (tracking ? [{ carrier: 'unknown', trackingNumber: tracking }] : undefined);
      await fetch(`/api/orders/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          tracking: trackingList,
          trackingNumber: trackingList?.[0]?.trackingNumber
        })
      });
    }

    async function moveOrderToStatus(orderId, status) {
      const prev = snapshotOrder(orderId);
      if (!prev) return;
      if (status !== 'Requested' && !canLeaveRequested(prev)) {
        showBoardMessage('Create an order first. Drag into a group to move it.', 'error');
        return;
      }
      if (status === prev.status) return;
      await assignGroup(orderId, undefined);
      await patchStatusOnly(orderId, status);
      recordAction({
        undo: { type: 'updateStatus', payload: { orderId, status: prev?.status, groupId: prev?.groupId || prev?.group?._id } },
        redo: { type: 'updateStatus', payload: { orderId, status, groupId: undefined } }
      });
      await fetchOrders();
      selected.delete(orderId);
      updateSelectionBar();
    }

    async function updateGroupStatus(groupId, status) {
      const affected = orders.filter(o => (o.groupId && o.groupId === groupId) || (o.group && o.group._id === groupId));
      const snapshot = affected.map(o => ({
        orderId: o._id,
        status: o.status,
        groupId: o.groupId || o.group?._id
      }));
      for (const o of affected) {
        await patchStatusOnly(o._id, status);
      }
      if (snapshot.length) {
        recordAction({
          undo: { type: 'bulkStatus', payload: { entries: snapshot } },
          redo: { type: 'bulkStatus', payload: { entries: affected.map(o => ({ orderId: o._id, status, groupId: o.groupId || o.group?._id })) } }
        });
      }
      await fetchOrders();
    }

    function fetchOrderDetails(configHint) {
      return async () => {
        const formData = new FormData(orderForm);
        const partInput = orderForm.elements.vendorPartNumber;
        const linkInput = orderForm.elements.partLink;
        const vendorInput = orderForm.elements.vendor;
        let partNum = (formData.get('vendorPartNumber') || '').toString().trim();
        const link = (formData.get('partLink') || '').toString().trim();
        const vendorName = (formData.get('vendor') || '').toString().trim();
        let config = configHint || findVendorConfig(vendorName) || detectVendor(partNum, link);
        if (!config && vendorName) config = findVendorConfig(vendorName);
        if (!partNum && config && link) {
          const extracted = extractPartNumberFromUrl(config, link);
          if (extracted && partInput) {
            partInput.value = extracted;
            partNum = extracted;
          }
        }
        if (!partNum && config?.source === 'builtin' && link) {
          const resolved = await resolveBuiltinVendorPart(config, link);
          if (resolved?.partNumber && partInput) {
            partInput.value = resolved.partNumber;
            partNum = resolved.partNumber;
          }
          if (resolved?.productUrl && linkInput && !linkInput.value) {
            linkInput.value = resolved.productUrl;
          }
        }
        if (config?.vendor && vendorInput) vendorInput.value = config.vendor;
        const isBuiltin = config?.source === 'builtin';
        if (isBuiltin && !partNum) {
          orderMessage.textContent = `Enter a part number to fetch from ${config.vendor}.`;
          orderMessage.className = 'error';
          return;
        }
        const url = isBuiltin ? null : (deriveUrl(config, partNum, link) || link);
        if (!isBuiltin && !url) {
          orderMessage.textContent = 'Provide a link or part number (for vendors with part number templates).';
          orderMessage.className = 'error';
          return;
        }
        if (!isBuiltin && config && !config.productUrlTemplate && !link) {
          orderMessage.textContent = 'This vendor needs a link to fetch details.';
          orderMessage.className = 'error';
          return;
        }
        orderMessage.textContent = 'Fetching...';
        orderMessage.className = 'small';
        const body = isBuiltin
          ? { vendorKey: config.key, partNumber: partNum }
          : {
              url,
              selectors: {
                nameSelector: config?.nameSelector,
                priceSelector: config?.priceSelector
              }
            };
        try {
          const res = await fetch('/api/vendors/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Fetch failed');

          const pickName = data.picks?.name || data.candidates?.titles?.[0]?.text;
          const pickPrice = data.picks?.price || data.candidates?.prices?.[0]?.text;
          if (data.message && !pickName && (pickPrice === undefined || pickPrice === null)) {
            throw new Error(data.message);
          }

          if (pickName && !orderForm.elements.partName.value) orderForm.elements.partName.value = pickName;
          const priceNum = parsePrice(pickPrice);
          if (priceNum !== undefined) {
            orderForm.elements.unitCost.value = priceNum;
          }
          if (isBuiltin && data.productUrl && !orderForm.elements.partLink.value) {
            orderForm.elements.partLink.value = data.productUrl;
          } else if (!orderForm.elements.partLink.value && url) {
            orderForm.elements.partLink.value = url;
          }
          if (config?.vendor && orderForm.elements.vendor && !orderForm.elements.vendor.value) {
            orderForm.elements.vendor.value = config.vendor;
          }

          orderMessage.textContent = 'Fetched. Verify fields before submitting.';
          orderMessage.className = 'success';
          await checkCatalogPresence();
        } catch (err) {
          orderMessage.textContent = err.message || 'Fetch failed. Fill manually.';
          orderMessage.className = 'error';
        }
      };
    }

    fetchProduct.addEventListener('click', fetchOrderDetails());

    function flattenCatalogMatches(items = []) {
      return items.map(item => ({
        id: item._id || item.id,
        label: item.name,
        partName: item.name,
        path: item.fullPath || (item.categoryPathLabels || []).join(' / '),
        vendor: item.vendor,
        vendorPartNumber: item.vendorPartNumber,
        supplierLink: item.supplierLink,
        unitCost: item.unitCost,
        defaultQuantity: item.defaultQuantity
      })).slice(0, 40);
    }

    function renderCatalogLookupList() {
      if (!catalogLookupResults) return;
      if (!catalogLookupMatches.length) {
        catalogLookupResults.innerHTML = '<div class="small" style="padding:6px 8px;">No matches yet.</div>';
        catalogLookupResults.style.display = 'block';
        return;
      }
      catalogLookupResults.innerHTML = catalogLookupMatches.map((m, idx) => `
        <div class="tag-picker-option" data-idx="${idx}" style="padding:6px 8px; cursor:pointer; border:1px solid var(--border); border-radius:8px; margin-bottom:4px;">
          <div style="font-weight:700;">${escapeHtml(m.label)}</div>
          <div class="small">${escapeHtml(m.path || '')}${m.vendor ? ' · ' + escapeHtml(m.vendor) : ''}${m.vendorPartNumber ? ' · ' + escapeHtml(m.vendorPartNumber) : ''}</div>
        </div>
      `).join('');
      catalogLookupResults.style.display = 'block';
      catalogLookupResults.querySelectorAll('.tag-picker-option').forEach(el => {
        el.addEventListener('click', () => {
          const idx = Number(el.dataset.idx);
          const match = catalogLookupMatches[idx];
          if (match) applyCatalogSelection(match);
        });
      });
    }

    async function performCatalogLookup(term) {
      const q = (term || '').trim();
      if (!q) {
        if (catalogLookupResults) catalogLookupResults.style.display = 'none';
        return;
      }
      try {
        const res = await fetch(`/api/catalog/items?search=${encodeURIComponent(q)}&includeDescendants=true`);
        const data = await res.json();
        catalogLookupMatches = flattenCatalogMatches(data.items || []);
        renderCatalogLookupList();
      } catch (err) {
        console.warn('Catalog lookup failed', err);
      }
    }

    function applyCatalogSelection(match) {
      if (!match || !orderForm) return;
      selectedCatalogMatch = match;
      if (orderForm.elements.partName && !orderForm.elements.partName.value) orderForm.elements.partName.value = match.partName || match.label || '';
      if (orderForm.elements.vendor && match.vendor) orderForm.elements.vendor.value = match.vendor;
      if (orderForm.elements.vendorPartNumber && match.vendorPartNumber) orderForm.elements.vendorPartNumber.value = match.vendorPartNumber;
      if (orderForm.elements.partLink && match.supplierLink) orderForm.elements.partLink.value = match.supplierLink;
      if (orderForm.elements.unitCost && match.unitCost !== undefined) orderForm.elements.unitCost.value = match.unitCost;
      if (orderForm.elements.quantityRequested && match.defaultQuantity) orderForm.elements.quantityRequested.value = match.defaultQuantity;
      if (catalogLookupSelected) catalogLookupSelected.textContent = `Using catalog: ${match.label}${match.path ? ' · ' + match.path : ''}`;
      if (catalogLookupResults) catalogLookupResults.style.display = 'none';
      if (catalogSaveCategory && match.path) catalogSaveCategory.value = match.path;
      setOrderSource('catalog');
      catalogAlreadySaved = true;
      catalogAlreadySavedItem = match;
      syncCatalogSaveUI();
      scheduleCatalogPresenceCheck();
      renderCatalogRequestTagOptions(getCatalogRequestTagIds());
    }

    function resetCatalogLookup() {
      catalogLookupMatches = [];
      selectedCatalogMatch = null;
      catalogAlreadySaved = false;
      catalogAlreadySavedItem = null;
      if (catalogLookupResults) {
        catalogLookupResults.style.display = 'none';
        catalogLookupResults.innerHTML = '';
      }
      if (catalogLookupSelected) catalogLookupSelected.textContent = '';
      if (catalogLookupInput) catalogLookupInput.value = '';
      syncCatalogSaveUI();
    }

    function toggleCatalogSaveFields(show) {
      if (!catalogSaveFields) return;
      const open = show !== undefined ? show : saveToCatalogToggle?.checked;
      catalogSaveFields.style.display = open ? 'grid' : 'none';
    }

    function resetCatalogSavePanel(clearStatus = true) {
      if (saveToCatalogToggle) saveToCatalogToggle.checked = false;
      if (catalogSaveCategory) catalogSaveCategory.value = '';
      if (catalogSaveSubteam) catalogSaveSubteam.value = '';
      if (catalogSaveType) catalogSaveType.value = '';
      if (catalogSaveMessage) { catalogSaveMessage.textContent = ''; catalogSaveMessage.className = 'small'; }
      if (clearStatus) {
        catalogAlreadySaved = false;
        catalogAlreadySavedItem = null;
        if (catalogSaveStatus) { catalogSaveStatus.textContent = ''; catalogSaveStatus.className = 'small'; }
      }
      toggleCatalogSaveFields(false);
    }

    function syncCatalogSaveUI() {
      const canEdit = currentUser?.permissions?.canEditInventoryCatalog;
      const showToggle = canEdit && !catalogAlreadySaved;
      if (catalogSaveContainer) catalogSaveContainer.style.display = showToggle ? 'block' : 'none';
      if (catalogSaveStatus) {
        if (catalogAlreadySaved) {
          const name = catalogAlreadySavedItem?.name || 'catalog item';
          const path = catalogAlreadySavedItem?.fullPath || (catalogAlreadySavedItem?.categoryPathLabels || []).join(' / ');
          const detail = path ? ` (${path})` : '';
          catalogSaveStatus.textContent = `Already in catalog: ${name}${detail}`;
          catalogSaveStatus.className = 'success small';
        } else {
          catalogSaveStatus.textContent = '';
          catalogSaveStatus.className = 'small';
        }
      }
      if (!showToggle) {
        if (saveToCatalogToggle) saveToCatalogToggle.checked = false;
        toggleCatalogSaveFields(false);
      }
    }

    function normalizeLink(link) {
      return (link || '').trim().replace(/\/+$/, '');
    }

    async function checkCatalogPresence() {
      if (!orderForm || !currentUser) {
        catalogAlreadySaved = false;
        catalogAlreadySavedItem = null;
        syncCatalogSaveUI();
        return;
      }
      const partNum = (orderForm.elements.vendorPartNumber?.value || '').trim();
      const link = (orderForm.elements.partLink?.value || '').trim();
      if (selectedCatalogMatch) {
        catalogAlreadySaved = true;
        catalogAlreadySavedItem = selectedCatalogMatch;
        syncCatalogSaveUI();
        return;
      }
      if (!partNum && !link) {
        catalogAlreadySaved = false;
        catalogAlreadySavedItem = null;
        syncCatalogSaveUI();
        return;
      }
      const terms = [partNum, link].filter(Boolean);
      let found = null;
      for (const term of terms) {
        try {
          const res = await fetch(`/api/catalog/items?search=${encodeURIComponent(term)}&includeDescendants=true`);
          const data = await res.json();
          const items = data.items || [];
          const linkNorm = normalizeLink(link);
          const match = items.find(i => {
            const skuMatch = partNum && (i.vendorPartNumber || '').toLowerCase() === partNum.toLowerCase();
            const linkMatch = linkNorm && normalizeLink(i.supplierLink || '') === linkNorm;
            return skuMatch || linkMatch;
          });
          if (match) {
            found = match;
            break;
          }
        } catch (err) {
          console.warn('catalog presence check failed', err);
        }
      }
      catalogAlreadySaved = Boolean(found);
      catalogAlreadySavedItem = found;
      syncCatalogSaveUI();
    }

    function scheduleCatalogPresenceCheck() {
      clearTimeout(catalogPresenceTimer);
      catalogPresenceTimer = setTimeout(checkCatalogPresence, 250);
    }

    async function saveCurrentOrderToCatalog(force = false) {
      if (!currentUser?.permissions?.canEditInventoryCatalog) return { skipped: true };
      if (!force && !saveToCatalogToggle?.checked) return { skipped: true };
      const name = orderForm?.elements?.partName?.value?.trim();
      if (!name) {
        if (catalogSaveMessage) {
          catalogSaveMessage.textContent = 'Enter a part name before saving to catalog.';
          catalogSaveMessage.className = 'error';
        }
        return { error: 'missing name' };
      }
      const path = (catalogSaveCategory?.value || selectedCatalogMatch?.path || '').split('/').map(p => p.trim()).filter(Boolean);
      const payload = {
        name,
        categoryPath: path,
        subteam: catalogSaveSubteam?.value?.trim() || undefined,
        type: catalogSaveType?.value?.trim() || undefined,
        vendor: orderForm?.elements?.vendor?.value || undefined,
        vendorPartNumber: orderForm?.elements?.vendorPartNumber?.value || undefined,
        supplierLink: orderForm?.elements?.partLink?.value || undefined,
        unitCost: orderForm?.elements?.unitCost?.value ? Number(orderForm.elements.unitCost.value) : undefined,
        aliases: []
      };
      try {
        const res = await fetch('/api/catalog/items', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save');
        if (catalogSaveMessage) {
          catalogSaveMessage.textContent = 'Saved to catalog.';
          catalogSaveMessage.className = 'success';
        }
        if (currentUser?.permissions?.canEditInventoryCatalog) {
          refreshCatalogView();
        }
        await checkCatalogPresence();
        return { ok: true, id: data.id };
      } catch (err) {
        if (catalogSaveMessage) {
          catalogSaveMessage.textContent = err.message || 'Failed to save to catalog.';
          catalogSaveMessage.className = 'error';
        }
        return { error: err.message };
      }
    }

    saveToCatalogToggle?.addEventListener('change', () => toggleCatalogSaveFields());
    catalogLookupInput?.addEventListener('input', () => {
      clearTimeout(catalogLookupTimer);
      catalogLookupTimer = setTimeout(() => performCatalogLookup(catalogLookupInput.value), 200);
    });
    catalogLookupInput?.addEventListener('focus', () => {
      if (catalogLookupInput.value) performCatalogLookup(catalogLookupInput.value);
    });
    document.addEventListener('click', (e) => {
      if (!catalogLookupResults || !catalogLookupInput) return;
      if (!catalogLookupResults.contains(e.target) && e.target !== catalogLookupInput) {
        catalogLookupResults.style.display = 'none';
      }
    });
    orderForm?.elements?.vendorPartNumber?.addEventListener('input', scheduleCatalogPresenceCheck);
    orderForm?.elements?.partLink?.addEventListener('input', scheduleCatalogPresenceCheck);

    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (orderSource === 'import') {
        if (vendorImportMessage) {
          vendorImportMessage.textContent = 'Use the vendor import controls below to add items.';
          vendorImportMessage.className = 'small error';
        }
        return;
      }
      const formData = new FormData(orderForm);
      const payload = Object.fromEntries(formData.entries());
      payload.quantityRequested = Number(payload.quantityRequested || 0);
      payload.unitCost = payload.unitCost ? Number(payload.unitCost) : undefined;
      payload.fetchedPrice = payload.unitCost || undefined;
      payload.tracking = [];
      payload.trackingNumber = undefined;
      payload.tags = tagSelect ? Array.from(tagSelect.selectedOptions).map(o => o.value) : [];
      const notesInput = orderForm.elements.notes;
      const notesValue = (notesInput?.value || '').trim();
      if (requiresOrderNotes() && !notesValue) {
        orderMessage.textContent = 'Add notes/justification before submitting.';
        orderMessage.className = 'error';
        notesInput?.focus();
        return;
      }
      payload.notes = notesValue || undefined;
      if (!payload.vendor) {
        const auto = detectVendor(payload.vendorPartNumber, payload.partLink);
        if (auto?.vendor) {
          payload.vendor = auto.vendor;
          if (orderForm?.elements?.vendor) orderForm.elements.vendor.value = auto.vendor;
        }
      }
      payload.supplier = payload.vendor || payload.supplier;
      orderMessage.textContent = 'Submitting...';
      orderMessage.className = 'small';
      try {
        if (editingOrderId) {
          const prev = snapshotOrder(editingOrderId);
          await fetch(`/api/orders/${editingOrderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (prev) {
            recordAction({
              undo: { type: 'updateOrder', payload: { orderId: editingOrderId, data: {
                partName: prev.partName,
                quantityRequested: prev.quantityRequested,
                priority: prev.priority,
                supplier: prev.supplier,
                vendor: prev.vendor,
                partLink: prev.partLink,
                vendorPartNumber: prev.vendorPartNumber,
                trackingNumber: prev.trackingNumber,
                status: prev.status,
                unitCost: prev.unitCost,
                fetchedPrice: prev.fetchedPrice,
                notes: prev.notes
              }}},
              redo: { type: 'updateOrder', payload: { orderId: editingOrderId, data: payload } }
            });
          }
          orderMessage.textContent = 'Order updated.';
        } else {
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          const newId = data.order?.orderId || data.orderId || data.order?._id;
          recordAction({
            undo: { type: 'deleteOrder', payload: { orderId: newId } },
            redo: { type: 'restoreOrder', payload: { order: payload } }
          });
          orderMessage.textContent = 'Order created.';
        }
        if (currentUser?.permissions?.canEditInventoryCatalog && saveToCatalogToggle?.checked) {
          await saveCurrentOrderToCatalog(true);
        }
        orderMessage.className = 'success';
        modal.style.display = 'none';
        orderForm.reset();
        resetCatalogLookup();
        resetCatalogSavePanel();
        editingOrderId = null;
        if (orderTrackingList) setTrackingRows(orderTrackingList, []);
        await fetchOrders();
      } catch (err) {
        orderMessage.textContent = 'Failed to create order';
        orderMessage.className = 'error';
      }
    });

    adminBtn.addEventListener('click', () => {
      adminModal.style.display = 'flex';
      updateAdminTabsVisibility();
      const allowed = allowedAdminTabs();
      if (!allowed.length) { adminModal.style.display = 'none'; return; }
      const target = allowed[0];
      if (allowed.includes('users')) {
        loadUsers();
      }
      if (allowed.includes('roles')) loadRoles();
      if (allowed.includes('tracking')) loadTrackingSettings();
      if (allowed.includes('vendors')) loadVendors();
      showAdminSection(target);
    });
    tagsBtn?.addEventListener('click', () => {
      if (!currentUser) return;
      tagsModal.style.display = 'flex';
      syncTagEditUI();
      loadTags();
      loadPriorityTags();
      showTagsModalTab('tags');
    });
    tagsTabTags?.addEventListener('click', () => showTagsModalTab('tags'));
    tagsTabPriorities?.addEventListener('click', () => showTagsModalTab('priorities'));
    closeTags?.addEventListener('click', () => { tagsModal.style.display = 'none'; });
    closeAdmin.addEventListener('click', () => { adminModal.style.display = 'none'; resetCatalogItemForm(); closeVendorModal(); });
    function updateCatalogEditVisibility() {
      const canEdit = currentUser?.permissions?.canEditInventoryCatalog;
      if (catalogItemForm) catalogItemForm.style.display = canEdit ? catalogItemForm.style.display : 'none';
      if (newCatalogItemBtn) newCatalogItemBtn.style.display = canEdit ? 'inline-flex' : 'none';
      if (deleteCatalogItemBtn) deleteCatalogItemBtn.style.display = canEdit ? 'inline-flex' : 'none';
      if (fetchCatalogProductBtn) fetchCatalogProductBtn.style.display = canEdit ? 'inline-flex' : 'none';
      if (catalogNewCategoryBtn) catalogNewCategoryBtn.style.display = canEdit ? 'inline-flex' : 'none';
    }

    function openCatalogModal() {
      if (!currentUser) return;
      resetCatalogItemForm();
      currentCatalogCategoryId = 'root';
      selectedCatalogCategoryId = null;
      catalogNavStack = [];
      updateCatalogEditVisibility();
      updateCatalogItemHint();
      catalogModal.style.display = 'flex';
      refreshCatalogCategories();
      refreshCatalogItems();
      renderCatalogSaveCategoryOptions();
    }

    catalogBtn.addEventListener('click', openCatalogModal);
    closeCatalog?.addEventListener('click', () => { catalogModal.style.display = 'none'; if (catalogItemModal) catalogItemModal.style.display = 'none'; });
    accountBtn.addEventListener('click', () => {
      accountModal.style.display = 'flex';
    });

    function openGroupModal(data) {
      editingGroupId = data?.id || null;
      groupForm.elements.id.value = data?.id || '';
      groupForm.elements.title.value = data?.title || '';
      const parts = orders.filter(o => o.groupId === data?.id || o.group?._id === data?.id).map(o => ({ id: o._id, label: o.partName || o.vendorPartNumber || o.productCode || o._id }));
      setTrackingRows(groupModalTrackingList, data?.tracking?.length ? data.tracking : (data?.trackingNumber ? [{ carrier: 'unknown', trackingNumber: data.trackingNumber }] : []), parts);
      groupForm.elements.notes.value = data?.notes || '';
      groupMessage.textContent = '';
      groupModal.style.display = 'flex';
    }

    groupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(groupForm);
      const payload = Object.fromEntries(formData.entries());
      const tracking = collectTrackingRows(groupModalTrackingList);
      const id = payload.id;
      groupMessage.textContent = 'Saving...';
      groupMessage.className = 'small';
      try {
        await fetch(`/api/order-groups/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: payload.title || undefined,
            trackingNumber: tracking[0]?.trackingNumber || undefined,
            tracking: tracking.length ? tracking : [],
            notes: payload.notes || undefined
          })
        });
        groupMessage.textContent = 'Saved.';
        groupMessage.className = 'success';
        resetGroupModal();
        await fetchOrders();
      } catch (err) {
        groupMessage.textContent = 'Failed to save group';
        groupMessage.className = 'error';
      }
    });

    function renderCustomVendorCard(v) {
      return `
        <div class="card" data-id="${v._id}" data-source="custom" style="margin-bottom:8px;">
          <div class="flex-between">
            <div>
              <h4 style="margin:0 0 4px;">${escapeHtml(v.vendor || '')}</h4>
              <div class="small">${escapeHtml(v.baseUrl || '')}</div>
              <div class="small">Template: ${escapeHtml(v.productUrlTemplate || '')}</div>
              <div class="small">Selectors: ${escapeHtml(v.nameSelector || '-')} | ${escapeHtml(v.priceSelector || '-')}</div>
            </div>
            <div class="flex-between" style="gap:8px;">
              <button class="btn ghost" data-action="edit">Edit</button>
              <button class="btn ghost" data-action="delete" style="color:var(--danger);">Delete</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderBuiltinVendorCard(v) {
      const status = v.requiresCredentials
        ? (v.hasCredentialsConfigured ? 'Configured' : 'Needs credentials')
        : 'Ready';
      return `
        <div class="card" data-key="${v.key}" data-source="builtin" style="margin-bottom:8px;">
          <div class="flex-between" style="gap:8px;">
            <div>
              <h4 style="margin:0 0 4px;">${escapeHtml(v.vendor || '')}</h4>
              <div class="small">${escapeHtml(v.description || '')}</div>
              <div class="small">Status: ${status}</div>
            </div>
            <div class="flex-between" style="gap:8px;">
              <button class="btn ghost" data-action="configure">Configure</button>
            </div>
          </div>
        </div>
      `;
    }

    async function loadVendors() {
      if (!currentUser) return;
      vendorList.textContent = 'Loading...';
      try {
        const res = await fetch('/api/vendors/configs');
        const data = await res.json();
        customVendorConfigs = (data.custom || data.vendors || []).map(v => ({ ...v, source: 'custom' }));
        builtinVendorConfigsState = (data.builtin || []).map(v => ({ ...v, source: 'builtin' }));
        vendorConfigs = customVendorConfigs.concat(builtinVendorConfigsState);
        renderVendorOptions();
        renderVendorImportOptions();
        const builtinCards = builtinVendorConfigsState.length
          ? builtinVendorConfigsState.map(renderBuiltinVendorCard).join('')
          : '<div class="small">No built-in integrations available yet.</div>';
        const customCards = customVendorConfigs.length
          ? customVendorConfigs.map(renderCustomVendorCard).join('')
          : '<div class="empty">No custom vendor configs yet. Click "New vendor" to add one.</div>';
        vendorList.innerHTML = `
          <div style="margin-bottom:12px;">
            <div class="small" style="text-transform:uppercase; font-weight:700; margin-bottom:4px;">Built-in integrations</div>
            ${builtinCards}
          </div>
          <div>
            <div class="small" style="text-transform:uppercase; font-weight:700; margin-bottom:4px;">Custom scrapers</div>
            ${customCards}
          </div>
        `;

        vendorList.querySelectorAll('button[data-action="configure"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const key = card?.dataset?.key;
            if (!key) return;
            const v = builtinVendorConfigsState.find(x => x.key === key);
            if (!v) return;
            openVendorModal(v);
          });
        });

        vendorList.querySelectorAll('button[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const v = customVendorConfigs.find(x => x._id === id);
            if (!v) return;
            openVendorModal(v);
          });
        });

        vendorList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            if (!id) return;
            openConfirm('Delete this vendor config?', async () => {
              await fetch(`/api/vendors/configs/${id}`, { method: 'DELETE' });
              loadVendors();
            });
          });
        });
      } catch (e) {
        vendorList.textContent = 'Failed to load vendors';
      }
    }

    function categoryPathLabel(cat) {
      if (!cat) return '';
      const path = cat.path || [];
      return path.length ? path.join(' / ') : cat.name || '';
    }

    function currentCategory() {
      if (!currentCatalogCategoryId || currentCatalogCategoryId === 'root') return null;
      return catalogCategories.find(c => String(c._id) === String(currentCatalogCategoryId)) || null;
    }
    function renderCatalogSaveCategoryOptions() {
      if (!catalogSaveCategory) return;
      const options = ['<option value="">Select category</option>'].concat(
        catalogCategories
          .slice()
          .sort((a, b) => (a.path || []).join(' / ').localeCompare((b.path || []).join(' / ')))
          .map(c => `<option value="${(c.path || []).join('/')}">${escapeHtml((c.path || []).join(' / '))}</option>`)
      );
      catalogSaveCategory.innerHTML = options.join('');
    }

    function getDescendantIds(rootId) {
      const set = new Set();
      const walk = (pid) => {
        catalogCategories.filter(c => String(c.parentId || '') === String(pid)).forEach(child => {
          const cid = child._id?.toString();
          if (cid && !set.has(cid)) {
            set.add(cid);
            walk(cid);
          }
        });
      };
      walk(rootId);
      return set;
    }

    function renderEditCategoryParentOptions(cat) {
      if (!catalogCategoryEditForm) return;
      const select = catalogCategoryEditForm.elements.parentId;
      if (!select) return;
      const exclude = new Set([cat?._id?.toString()]);
      getDescendantIds(cat?._id)?.forEach(id => exclude.add(id));
      const options = ['<option value="">(Root)</option>'].concat(
        catalogCategories
          .filter(c => !exclude.has(c._id?.toString()))
          .slice()
          .sort((a, b) => (a.path || []).join(' / ').localeCompare((b.path || []).join(' / ')))
          .map(c => `<option value="${c._id}" ${String(cat?.parentId || '') === String(c._id) ? 'selected' : ''}>${escapeHtml((c.path || []).join(' / ') || c.name || '')}</option>`)
      );
      select.innerHTML = options.join('');
    }

    function renderCatalogCategoriesList() {
      if (!catalogCategoryList) return;
      const cat = currentCategory();
      const parentId = cat?.parentId ? cat.parentId.toString() : null;
      const children = catalogCategories.filter(c => {
        const pid = c.parentId ? c.parentId.toString() : null;
        return pid === (currentCatalogCategoryId === 'root' ? null : currentCatalogCategoryId.toString());
      });
      const pathLabels = cat?.path || [];
      catalogPathDisplay.textContent = pathLabels.length ? pathLabels.join(' / ') : 'Top level';
      catalogBackBtn.style.display = cat ? 'inline-flex' : 'none';
      if (!children.length) {
        catalogCategoryList.className = 'empty';
        catalogCategoryList.textContent = 'No subcategories here.';
        return;
      }
      catalogCategoryList.className = '';
      catalogCategoryList.innerHTML = children.map(c => `
        <div class="card" data-id="${c._id}" style="margin-bottom:6px; cursor:pointer;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div>
              <div style="font-weight:700;">${escapeHtml(c.name)}</div>
              <div class="small">${escapeHtml((c.path || []).join(' / '))}</div>
            </div>
            ${currentUser?.permissions?.canEditInventoryCatalog ? `<div class="flex-between" style="gap:6px;">
              <button class="btn ghost" data-action="edit" style="padding:6px 10px;">Edit</button>
              <button class="btn ghost" data-action="delete" style="color:var(--danger); padding:6px 10px;">Delete</button>
            </div>` : ''}
          </div>
        </div>
      `).join('');
      catalogCategoryList.querySelectorAll('.card').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.dataset.id;
          if (!id) return;
          selectCatalogCategory(id);
        });
        el.querySelectorAll('button[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = el.dataset.id;
            const cat = catalogCategories.find(c => String(c._id) === String(id));
            if (cat) openEditCategoryModal(cat);
          });
        });
        el.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const id = el.dataset.id;
            if (!id) return;
            openConfirm('Delete this category? Subcategories will also be removed if cascade is allowed.', async () => {
              await fetch(`/api/catalog/categories/${id}?cascade=true`, { method: 'DELETE' });
              await refreshCatalogCategories();
              await refreshCatalogItems();
            });
          });
        });
      });
    }

    function openNewCategoryModal() {
      if (!currentUser?.permissions?.canEditInventoryCatalog) return;
      if (catalogCategoryNewForm) catalogCategoryNewForm.reset();
      if (catalogCategoryNewMessage) { catalogCategoryNewMessage.textContent = ''; catalogCategoryNewMessage.className = 'small'; }
      const cat = currentCategory();
      const path = cat?.path?.join(' / ') || (cat?.name || '') || 'Top level';
      if (catalogCategoryNewPath) catalogCategoryNewPath.textContent = `Parent: ${path}`;
      if (catalogCategoryNewModal) catalogCategoryNewModal.style.display = 'flex';
    }

    function openEditCategoryModal(cat) {
      if (!currentUser?.permissions?.canEditInventoryCatalog || !cat) return;
      if (catalogCategoryEditForm) {
        catalogCategoryEditForm.reset();
        catalogCategoryEditForm.elements.id.value = cat._id || cat.id || '';
        catalogCategoryEditForm.elements.name.value = cat.name || '';
      }
      if (catalogCategoryEditMessage) { catalogCategoryEditMessage.textContent = ''; catalogCategoryEditMessage.className = 'small'; }
      if (catalogCategoryEditPath) catalogCategoryEditPath.textContent = (cat.path || []).join(' / ');
      renderEditCategoryParentOptions(cat);
      if (catalogCategoryEditModal) catalogCategoryEditModal.style.display = 'flex';
    }

    async function refreshCatalogCategories() {
      if (catalogCategoryList) catalogCategoryList.textContent = 'Loading categories...';
      try {
        const res = await fetch('/api/catalog/categories');
        const data = await res.json();
        catalogCategories = data.categories || [];
        catalogTree = data.tree || [];
        const exists = currentCatalogCategoryId === 'root' || catalogCategories.some(c => String(c._id) === String(currentCatalogCategoryId));
        if (!exists) {
          currentCatalogCategoryId = 'root';
          selectedCatalogCategoryId = null;
        }
        renderCatalogCategoriesList();
        renderCatalogSaveCategoryOptions();
      } catch (err) {
        if (catalogCategoryList) {
          catalogCategoryList.textContent = 'Failed to load categories';
        }
      }
    }

    function selectCatalogCategory(id) {
      currentCatalogCategoryId = id || 'root';
      selectedCatalogCategoryId = id || null;
      renderCatalogCategoriesList();
      refreshCatalogItems();
      updateCatalogItemHint();
    }
    refreshCatalogCategoriesBtn?.addEventListener('click', refreshCatalogCategories);
    catalogNewCategoryBtn?.addEventListener('click', openNewCategoryModal);
    catalogCategoryNewCancel?.addEventListener('click', () => { catalogCategoryNewModal.style.display = 'none'; });
    catalogCategoryEditCancel?.addEventListener('click', () => { catalogCategoryEditModal.style.display = 'none'; });
    catalogCategoryNewForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = catalogCategoryNewForm.elements.name.value.trim();
      if (!name) return;
      const parentId = currentCatalogCategoryId && currentCatalogCategoryId !== 'root' ? currentCatalogCategoryId : undefined;
      catalogCategoryNewMessage.textContent = 'Creating...';
      catalogCategoryNewMessage.className = 'small';
      try {
        await fetch('/api/catalog/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parentId })
        });
        catalogCategoryNewMessage.textContent = 'Created.';
        catalogCategoryNewMessage.className = 'success';
        catalogCategoryNewModal.style.display = 'none';
        await refreshCatalogCategories();
        await refreshCatalogItems();
      } catch (err) {
        catalogCategoryNewMessage.textContent = err.message || 'Failed to create category';
        catalogCategoryNewMessage.className = 'error';
      }
    });
    catalogCategoryEditForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = catalogCategoryEditForm.elements.id.value;
      const name = catalogCategoryEditForm.elements.name.value.trim();
      const parentId = catalogCategoryEditForm.elements.parentId.value || undefined;
      if (!id || !name) return;
      const invalidParents = getDescendantIds(id);
      invalidParents.add(String(id));
      if (parentId && invalidParents.has(String(parentId))) {
        catalogCategoryEditMessage.textContent = 'Cannot move a category into itself or its descendants.';
        catalogCategoryEditMessage.className = 'error';
        return;
      }
      catalogCategoryEditMessage.textContent = 'Saving...';
      catalogCategoryEditMessage.className = 'small';
      try {
        await fetch(`/api/catalog/categories/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parentId })
        });
        catalogCategoryEditMessage.textContent = 'Saved.';
        catalogCategoryEditMessage.className = 'success';
        catalogCategoryEditModal.style.display = 'none';
        await refreshCatalogCategories();
        await refreshCatalogItems();
      } catch (err) {
        catalogCategoryEditMessage.textContent = err.message || 'Failed to save category';
        catalogCategoryEditMessage.className = 'error';
      }
    });

    function updateCatalogItemHint() {
      if (!catalogItemHint) return;
      const cat = currentCategory();
      catalogItemHint.textContent = cat ? `Browsing ${categoryPathLabel(cat)}` : 'Browsing top level';
    }

    function resetCatalogItemForm(item = null, showModal = false) {
      if (!catalogItemForm) return;
      catalogItemForm.reset();
      selectedCatalogItemId = null;
      catalogItemMessage.textContent = '';
      catalogItemMessage.className = 'small';
      if (item) {
        catalogItemForm.elements.id.value = item._id || item.id || '';
        catalogItemForm.elements.name.value = item.name || '';
        const pathLabel = Array.isArray(item.categoryPathLabels)
          ? item.categoryPathLabels.join(' / ')
          : (item.fullPath || item.categoryPathLabels || '');
        catalogItemForm.elements.categoryPath.value = pathLabel || '';
        catalogItemForm.elements.subteam.value = item.subteam || '';
        catalogItemForm.elements.type.value = item.type || '';
        catalogItemForm.elements.vendor.value = item.vendor || '';
        catalogItemForm.elements.vendorPartNumber.value = item.vendorPartNumber || '';
        catalogItemForm.elements.supplierLink.value = item.supplierLink || '';
        catalogItemForm.elements.unitCost.value = item.unitCost ?? '';
        catalogItemForm.elements.defaultQuantity.value = item.defaultQuantity ?? '';
        catalogItemForm.elements.aliases.value = (item.aliases || []).join(', ');
        selectedCatalogItemId = item._id || item.id || null;
        if (catalogItemModalHint) catalogItemModalHint.textContent = 'Edit saved part';
      } else {
        if (catalogItemModalHint) catalogItemModalHint.textContent = 'Create a saved part';
      }
      if (catalogItemModal) catalogItemModal.style.display = showModal ? 'flex' : catalogItemModal.style.display;
    }

    function renderCatalogItems() {
      if (!catalogItemList) return;
      if (!catalogItems.length) {
        catalogItemList.className = 'empty';
        catalogItemList.textContent = 'No catalog items yet.';
        return;
      }
      const canEdit = currentUser?.permissions?.canEditInventoryCatalog;
      catalogItemList.className = '';
      catalogItemList.innerHTML = catalogItems.map(item => {
        const path = escapeHtml((item.fullPath || (item.categoryPathLabels || []).join(' / ')) || '');
        const vendor = escapeHtml(item.vendor || '');
        const sku = escapeHtml(item.vendorPartNumber || '');
        return `<div class="card" data-id="${item._id || item.id}" style="margin-bottom:8px;">
          <div class="flex-between" style="gap:8px; align-items:flex-start;">
            <div>
              <h4 style="margin:0 0 4px;">${escapeHtml(item.name)}</h4>
              <div class="small">${path || 'Uncategorized'}</div>
              <div class="small">${vendor || ''} ${sku ? '· ' + sku : ''}</div>
            </div>
            <div class="flex-between" style="gap:6px; flex-wrap:wrap; justify-content:flex-end;">
              ${canEdit ? `<button class="btn ghost" data-action="edit">Edit</button>` : ''}
              ${canEdit ? `<button class="btn ghost" data-action="delete" style="color:var(--danger);">Delete</button>` : ''}
              <button class="btn primary" data-action="request">Request</button>
            </div>
          </div>
        </div>`;
      }).join('');
    catalogItemList.querySelectorAll('button[data-action="request"]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.closest('.card')?.dataset.id;
        if (!id) return;
        const item = catalogItems.find(i => String(i._id || i.id) === String(id));
        if (item) openCatalogRequestModal(item);
      });
    });
    if (canEdit) {
      catalogItemList.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.closest('.card')?.dataset.id;
          if (!id) return;
          const item = catalogItems.find(i => String(i._id || i.id) === String(id));
          if (item) resetCatalogItemForm(item, true);
        });
      });
        catalogItemList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.card')?.dataset.id;
            if (!id) return;
            openConfirm('Delete this saved item?', async () => {
              await fetch(`/api/catalog/items/${id}`, { method: 'DELETE' });
              await refreshCatalogItems();
              resetCatalogItemForm();
            });
          });
        });
      }
    }

    async function refreshCatalogItems() {
      if (!currentUser) return;
      catalogItemList.textContent = 'Loading...';
      const params = new URLSearchParams();
      if (currentCatalogCategoryId) params.set('categoryId', currentCatalogCategoryId);
      params.set('includeDescendants', 'false');
      if (catalogItemSearch?.value) params.set('search', catalogItemSearch.value.trim());
      try {
        const res = await fetch(`/api/catalog/items?${params.toString()}`);
        const data = await res.json();
        catalogItems = data.items || [];
        renderCatalogItems();
      } catch (err) {
        catalogItemList.textContent = 'Failed to load catalog items';
      }
    }

    catalogItemForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(catalogItemForm).entries());
      const id = payload.id;
      const aliases = (payload.aliases || '').split(',').map(a => a.trim()).filter(Boolean);
      const body = {
        name: payload.name,
        categoryPath: (payload.categoryPath || '').split('/').map(p => p.trim()).filter(Boolean),
        subteam: payload.subteam || undefined,
        type: payload.type || undefined,
        vendor: payload.vendor || undefined,
        vendorPartNumber: payload.vendorPartNumber || undefined,
        supplierLink: payload.supplierLink || undefined,
        unitCost: payload.unitCost ? Number(payload.unitCost) : undefined,
        defaultQuantity: payload.defaultQuantity ? Number(payload.defaultQuantity) : undefined,
        aliases
      };
      catalogItemMessage.textContent = 'Saving...';
      catalogItemMessage.className = 'small';
      try {
        if (id) {
          await fetch(`/api/catalog/items/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        } else {
          await fetch('/api/catalog/items', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        }
        catalogItemMessage.textContent = 'Saved';
        catalogItemMessage.className = 'success';
        await refreshCatalogItems();
        if (catalogItemModal) catalogItemModal.style.display = 'none';
        if (!id) resetCatalogItemForm();
      } catch (err) {
        catalogItemMessage.textContent = err.message || 'Failed to save item';
        catalogItemMessage.className = 'error';
      }
    });

    cancelCatalogItemBtn?.addEventListener('click', () => { catalogItemModal.style.display = 'none'; resetCatalogItemForm(); });
    deleteCatalogItemBtn?.addEventListener('click', async () => {
      const id = catalogItemForm?.elements.id.value;
      if (!id) return;
      openConfirm('Delete this saved item?', async () => {
        await fetch(`/api/catalog/items/${id}`, { method: 'DELETE' });
        await refreshCatalogItems();
        resetCatalogItemForm();
        if (catalogItemModal) catalogItemModal.style.display = 'none';
      });
    });
    newCatalogItemBtn?.addEventListener('click', () => {
      resetCatalogItemForm({ name: '', categoryPathLabels: currentCategory() ? [categoryPathLabel(currentCategory())] : [] }, true);
    });
    refreshCatalogItemsBtn?.addEventListener('click', () => refreshCatalogItems());
    fetchCatalogProductBtn?.addEventListener('click', fetchCatalogDetails);
    catalogItemSearch?.addEventListener('input', () => {
      clearTimeout(catalogItemSearchTimer);
      catalogItemSearchTimer = setTimeout(refreshCatalogItems, 200);
    });
    catalogBackBtn?.addEventListener('click', () => {
      const cat = currentCategory();
      if (cat?.parentId) {
        selectCatalogCategory(cat.parentId.toString());
      } else {
        currentCatalogCategoryId = 'root';
        selectedCatalogCategoryId = null;
        renderCatalogCategoriesList();
        refreshCatalogItems();
        updateCatalogItemHint();
      }
    });

    function refreshCatalogView() {
      currentCatalogCategoryId = 'root';
      selectedCatalogCategoryId = null;
      renderCatalogCategoriesList();
      refreshCatalogCategories();
      refreshCatalogItems();
      updateCatalogItemHint();
      updateCatalogEditVisibility();
    }

    async function loadTags() {
      try {
        const res = await fetch('/api/tags');
        const data = await res.json();
        tagList = data.tags || [];
        renderTagOptions(getSelectedTagIds());
        renderCatalogRequestTagOptions(getCatalogRequestTagIds());
        renderTagsManager();
        renderBoard();
        renderTable();
      } catch (e) {
        console.warn('Failed to load tags', e);
      }
    }

    async function loadPriorityTags() {
      try {
        const res = await fetch('/api/priority-tags');
        const data = await res.json();
        priorityList = (data.priorities && data.priorities.length ? data.priorities : defaultPriorities) || defaultPriorities;
      renderPriorityOptions();
      renderPriorityManager();
    } catch (e) {
      console.warn('Failed to load priorities', e);
      priorityList = defaultPriorities;
      renderPriorityOptions();
      renderPriorityManager();
    }
      renderCatalogSaveCategoryOptions();
  }

    function renderTagOptions(selected = []) {
      if (!tagSelect) return;
      const selSet = new Set(selected.map(String));
      tagSelect.innerHTML = tagList.map(t => `<option value="${t._id || t.id || t.label}" ${selSet.has(String(t._id || t.id || t.label)) ? 'selected' : ''}>${t.label}</option>`).join('');
      updateTagSelection(selected);
    }

    function updateTagSelection(ids = []) {
      if (tagSelect) {
        const selSet = new Set(ids.map(String));
        Array.from(tagSelect.options || []).forEach(opt => { opt.selected = selSet.has(opt.value); });
      }
      if (tagPickerDisplay) {
        const labels = ids.map(getTagLabel).filter(Boolean);
        tagPickerDisplay.textContent = labels.length ? labels.join(', ') : 'Select tags';
      }
      renderTagDropdownList(ids);
    }

    function renderTagDropdownList(selected = getSelectedTagIds()) {
      if (!tagPickerOptions) return;
      const term = (tagPickerSearch?.value || '').toLowerCase().trim();
      const filtered = tagList.filter(t => !term || (t.label || '').toLowerCase().includes(term));
      const selSet = new Set(selected.map(String));
      tagPickerOptions.innerHTML = filtered.length ? filtered.map(t => {
        const id = String(t._id || t.id || t.label);
        const selectedCls = selSet.has(id) ? 'selected' : '';
        const color = t.color || '#fdd023';
        return `<div class="tag-option ${selectedCls}" data-id="${id}">
          <span class="tag-dot" style="background:${color};"></span>
          <span>${escapeHtml(t.label || id)}</span>
        </div>`;
      }).join('') : `<div class="small" style="padding:8px 10px;">No tags</div>`;
    }

    function toggleTagPanel(open) {
      if (!tagPickerPanel) return;
      const shouldOpen = open !== undefined ? open : tagPickerPanel.style.display !== 'block';
      tagPickerPanel.style.display = shouldOpen ? 'block' : 'none';
    }

    tagPickerDisplay?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleTagPanel(true);
    });
    document.addEventListener('click', (e) => {
      if (!tagPicker) return;
      if (!tagPicker.contains(e.target)) toggleTagPanel(false);
    });
    tagPickerSearch?.addEventListener('input', () => renderTagDropdownList(getSelectedTagIds()));
    tagPickerOptions?.addEventListener('click', (e) => {
      const row = e.target.closest('.tag-option');
      if (!row) return;
      const id = row.dataset.id;
      if (!id) return;
      const selected = new Set(getSelectedTagIds().map(String));
      if (selected.has(id)) selected.delete(id); else selected.add(id);
      updateTagSelection(Array.from(selected));
    });

    function syncTagEditUI() {
      const canManage = currentUser?.permissions?.canManageTags;
      if (createTagForm) createTagForm.style.display = canManage ? 'flex' : 'none';
      if (createPriorityForm) createPriorityForm.style.display = canManage ? 'flex' : 'none';
    }

    function showTagsModalTab(which) {
      activeTagsTab = which === 'priorities' ? 'priorities' : 'tags';
      if (tagsTabTags) tagsTabTags.classList.toggle('primary', activeTagsTab === 'tags');
      if (tagsTabPriorities) tagsTabPriorities.classList.toggle('primary', activeTagsTab === 'priorities');
      if (tagsSection) tagsSection.style.display = activeTagsTab === 'tags' ? 'block' : 'none';
      if (prioritiesSection) prioritiesSection.style.display = activeTagsTab === 'priorities' ? 'block' : 'none';
    }
    function getCatalogRequestTagIds() {
      if (!catalogRequestTags) return [];
      return Array.from(catalogRequestTags.selectedOptions || []).map(o => o.value);
    }
    function renderCatalogRequestTagOptions(selected = []) {
      if (!catalogRequestTags) return;
      const selSet = new Set(selected.map(String));
      catalogRequestTags.innerHTML = tagList.map(t => {
        const id = t._id || t.id || t.label;
        return `<option value="${id}" ${selSet.has(String(id)) ? 'selected' : ''}>${escapeHtml(t.label || '')}</option>`;
      }).join('');
      updateCatalogRequestTagSelection(selected);
    }
    function updateCatalogRequestTagSelection(ids = []) {
      if (catalogRequestTags) {
        const selSet = new Set(ids.map(String));
        Array.from(catalogRequestTags.options || []).forEach(opt => { opt.selected = selSet.has(opt.value); });
      }
      if (catalogRequestTagPickerDisplay) {
        const labels = ids.map(getTagLabel).filter(Boolean);
        catalogRequestTagPickerDisplay.textContent = labels.length ? labels.join(', ') : 'Select tags';
      }
      renderCatalogRequestTagDropdownList(ids);
    }
    function renderCatalogRequestTagDropdownList(selected = getCatalogRequestTagIds()) {
      if (!catalogRequestTagPickerOptions) return;
      const term = (catalogRequestTagPickerSearch?.value || '').toLowerCase().trim();
      const filtered = tagList.filter(t => !term || (t.label || '').toLowerCase().includes(term));
      const selSet = new Set(selected.map(String));
      catalogRequestTagPickerOptions.innerHTML = filtered.length ? filtered.map(t => {
        const id = String(t._id || t.id || t.label);
        const selectedCls = selSet.has(id) ? 'selected' : '';
        const color = t.color || '#fdd023';
        return `<div class="tag-option ${selectedCls}" data-id="${id}">
          <span class="tag-dot" style="background:${color};"></span>
          <span>${escapeHtml(t.label || id)}</span>
        </div>`;
      }).join('') : `<div class="small" style="padding:8px 10px;">No tags</div>`;
    }
    function toggleCatalogRequestTagPanel(open) {
      if (!catalogRequestTagPickerPanel) return;
      const shouldOpen = open !== undefined ? open : catalogRequestTagPickerPanel.style.display !== 'block';
      catalogRequestTagPickerPanel.style.display = shouldOpen ? 'block' : 'none';
    }

    catalogRequestTagPickerDisplay?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleCatalogRequestTagPanel(true);
    });
    document.addEventListener('click', (e) => {
      if (!catalogRequestTagPicker) return;
      if (!catalogRequestTagPicker.contains(e.target)) toggleCatalogRequestTagPanel(false);
    });
    catalogRequestTagPickerSearch?.addEventListener('input', () => renderCatalogRequestTagDropdownList(getCatalogRequestTagIds()));
    catalogRequestTagPickerOptions?.addEventListener('click', (e) => {
      const row = e.target.closest('.tag-option');
      if (!row) return;
      const id = row.dataset.id;
      if (!id) return;
      const selected = new Set(getCatalogRequestTagIds().map(String));
      if (selected.has(id)) selected.delete(id); else selected.add(id);
      updateCatalogRequestTagSelection(Array.from(selected));
    });

    function renderTagsManager() {
      if (!tagsList) return;
      syncTagEditUI();
      if (!tagList.length) {
        tagsList.innerHTML = '<div class="empty">No tags yet.</div>';
        return;
      }
      tagsList.innerHTML = tagList.map(t => {
        const id = String(t._id || t.id || t.label);
        const color = t.color || '#fdd023';
        return `<div class="tag-manager-item" data-id="${id}">
          <div class="tag-manager-meta">
            <input type="color" class="tag-color-input inline-color" value="${color}" data-id="${id}" title="Pick color" ${!currentUser?.permissions?.canManageTags ? 'disabled' : ''}/>
            <div>${escapeHtml(t.label || id)}</div>
          </div>
          ${currentUser?.permissions?.canManageTags ? `<button class="btn ghost" data-action="delete-tag" style="color: var(--danger);">Delete</button>` : ''}
        </div>`;
      }).join('');
      if (currentUser?.permissions?.canManageTags) {
        tagsList.querySelectorAll('.tag-color-input').forEach(inp => {
          inp.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            await fetch(`/api/tags/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ color: e.target.value })
            });
            await loadTags();
          });
        });
      }
      tagsList.querySelectorAll('button[data-action="delete-tag"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.closest('.tag-manager-item')?.dataset.id;
          if (!id) return;
          openConfirm('Delete this tag?', async () => {
            await fetch(`/api/tags/${id}`, { method: 'DELETE' });
            await loadTags();
          });
        });
      });
    }

      refreshTagsBtn?.addEventListener('click', () => loadTags());
    createTagForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser?.permissions?.canManageTags) return;
      const label = (tagLabelInput?.value || '').trim();
      const color = tagColorInput?.value || '#fdd023';
      if (!label) return;
      tagsMessage.textContent = 'Saving...';
      tagsMessage.className = 'small';
      try {
        const res = await fetch('/api/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, color })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create tag');
        tagLabelInput.value = '';
        tagsMessage.textContent = 'Tag created';
        tagsMessage.className = 'success';
        await loadTags();
      } catch (err) {
        tagsMessage.textContent = err.message || 'Failed to create tag';
        tagsMessage.className = 'error';
      }
    });

    function renderPriorityOptions() {
      const select = orderForm.elements.priority;
      if (!select) return;
      const list = priorityList && priorityList.length ? priorityList : defaultPriorities;
      const current = select.value || 'Medium';
      select.innerHTML = list.map(p => `<option value="${p.label}">${p.label}</option>`).join('');
      if (list.some(p => p.label === current)) {
        select.value = current;
      } else if (list.length) {
        select.value = list[0].label;
      }
      renderCatalogRequestPriorityOptions();
    }

    function renderCatalogRequestPriorityOptions() {
      if (!catalogRequestPriority) return;
      const list = priorityList && priorityList.length ? priorityList : defaultPriorities;
      const current = catalogRequestPriority.value || defaultPriorityLabel();
      catalogRequestPriority.innerHTML = list.map(p => `<option value="${p.label}">${p.label}</option>`).join('');
      if (list.some(p => p.label === current)) {
        catalogRequestPriority.value = current;
      } else if (list.length) {
        catalogRequestPriority.value = list[0].label;
      }
    }

    function renderPriorityManager() {
      if (!prioritiesList) return;
      syncTagEditUI();
      if (!priorityList.length) {
        prioritiesList.innerHTML = '<div class="empty">No priorities yet.</div>';
        return;
      }
      prioritiesList.innerHTML = priorityList.map(p => {
        const id = p._id || p.id || p.label;
        const color = p.color || '#fdd023';
        const sort = p.sortOrder ?? '';
        return `<div class="tag-manager-item" data-id="${id}">
          <div class="tag-manager-meta" style="gap:12px;">
            <input type="color" class="priority-color-input inline-color" value="${color}" data-id="${id}" title="Pick color" ${!currentUser?.permissions?.canManageTags ? 'disabled' : ''}/>
            <div style="min-width:140px;">${escapeHtml(p.label || '')}</div>
            <input type="number" class="priority-sort-input input" data-id="${id}" value="${sort}" placeholder="Sort" style="width:80px;" ${!currentUser?.permissions?.canManageTags ? 'disabled' : ''}/>
          </div>
          ${currentUser?.permissions?.canManageTags ? `<button class="btn ghost" data-action="delete-priority" style="color: var(--danger);">Delete</button>` : ''}
        </div>`;
      }).join('');
      if (currentUser?.permissions?.canManageTags) {
        prioritiesList.querySelectorAll('.priority-color-input').forEach(inp => {
          inp.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            await fetch(`/api/priority-tags/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ color: e.target.value })
            });
            await loadPriorityTags();
          });
        });
        prioritiesList.querySelectorAll('.priority-sort-input').forEach(inp => {
          inp.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            const sort = Number(e.target.value);
            await fetch(`/api/priority-tags/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sortOrder: Number.isFinite(sort) ? sort : null })
            });
            await loadPriorityTags();
          });
        });
        prioritiesList.querySelectorAll('button[data-action="delete-priority"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.tag-manager-item')?.dataset.id;
            if (!id) return;
            openConfirm('Delete this priority?', async () => {
              await fetch(`/api/priority-tags/${id}`, { method: 'DELETE' });
              await loadPriorityTags();
            });
          });
        });
      }
    }

    function openCatalogRequestModal(item) {
      pendingCatalogRequest = item;
      if (catalogRequestMessage) {
        catalogRequestMessage.textContent = '';
        catalogRequestMessage.className = 'small';
      }
      if (catalogRequestQty) {
        catalogRequestQty.value = item?.defaultQuantity || 1;
        setTimeout(() => catalogRequestQty.focus(), 50);
      }
      renderCatalogRequestPriorityOptions();
      updateCatalogRequestTagSelection([]);
      if (catalogRequestNotes) catalogRequestNotes.value = '';
      if (catalogRequestSubtitle) {
        const path = item?.fullPath || (item?.categoryPathLabels || []).join(' / ');
        catalogRequestSubtitle.textContent = item ? `${item.name}${path ? ' · ' + path : ''}` : 'Choose quantity and confirm.';
      }
      if (catalogRequestModal) catalogRequestModal.style.display = 'flex';
    }

    async function submitCatalogRequest() {
      const item = pendingCatalogRequest;
      if (!item) return;
      if (!currentUser) {
        showBoardMessage('Login to create an order.', 'error');
        return;
      }
      if (!currentUser.permissions?.canPlacePartRequests) {
        showBoardMessage('No permission to place part requests.', 'error');
        return;
      }
      const qty = Number(catalogRequestQty?.value || item.defaultQuantity || 1);
      if (!Number.isFinite(qty) || qty <= 0) {
        if (catalogRequestMessage) {
          catalogRequestMessage.textContent = 'Enter a valid quantity.';
          catalogRequestMessage.className = 'error';
        }
        return;
      }
      const priority = catalogRequestPriority?.value || defaultPriorityLabel();
      const tags = getCatalogRequestTagIds();
      const notes = catalogRequestNotes?.value?.trim();
      const payload = {
        partName: item.name,
        vendor: item.vendor,
        supplier: item.vendor,
        vendorPartNumber: item.vendorPartNumber,
        partLink: item.supplierLink,
        unitCost: item.unitCost ?? undefined,
        fetchedPrice: item.unitCost ?? undefined,
        quantityRequested: qty,
        status: 'Requested',
        priority,
        tags,
        notes: notes || (item.fullPath ? `From catalog: ${item.fullPath}` : undefined)
      };
      if (catalogRequestMessage) {
        catalogRequestMessage.textContent = 'Creating request...';
        catalogRequestMessage.className = 'small';
      }
      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create order');
        if (catalogRequestMessage) {
          catalogRequestMessage.textContent = 'Added to requests.';
          catalogRequestMessage.className = 'success';
        }
        if (catalogRequestModal) catalogRequestModal.style.display = 'none';
        pendingCatalogRequest = null;
        await fetchOrders();
        showBoardMessage('Requested from catalog.', 'info');
      } catch (err) {
        if (catalogRequestMessage) {
          catalogRequestMessage.textContent = err.message || 'Failed to create order';
          catalogRequestMessage.className = 'error';
        }
      }
    }

    refreshPrioritiesBtn?.addEventListener('click', () => loadPriorityTags());
    createPriorityForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser?.permissions?.canManageTags) return;
      const label = (priorityLabelInput?.value || '').trim();
      const color = priorityColorInput?.value || '#fdd023';
      const sortOrder = Number(prioritySortInput?.value);
      if (!label) return;
      prioritiesMessage.textContent = 'Saving...';
      prioritiesMessage.className = 'small';
      try {
        const res = await fetch('/api/priority-tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, color, sortOrder: Number.isFinite(sortOrder) ? sortOrder : undefined })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create priority');
        priorityLabelInput.value = '';
        prioritySortInput.value = '';
        prioritiesMessage.textContent = 'Priority created';
        prioritiesMessage.className = 'success';
        await loadPriorityTags();
      } catch (err) {
        prioritiesMessage.textContent = err.message || 'Failed to create priority';
        prioritiesMessage.className = 'error';
      }
    });
    confirmCatalogRequest?.addEventListener('click', submitCatalogRequest);
    cancelCatalogRequest?.addEventListener('click', () => { pendingCatalogRequest = null; catalogRequestModal.style.display = 'none'; });
    vendorForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = vendorForm.dataset.mode || 'custom';
      if (mode === 'builtin') {
        const integrationKey = vendorForm.elements.integrationKey?.value || activeBuiltinVendor?.key;
        if (!integrationKey) {
          vendorMessage.textContent = 'Missing integration key.';
          vendorMessage.className = 'error';
          return;
        }
        const settings = {};
        for (const field of builtinFieldInputs) {
          const value = field.input.value.trim();
          if (field.required && !value) {
            vendorMessage.textContent = `Enter ${field.label || field.key}`;
            vendorMessage.className = 'error';
            return;
          }
          if (value) settings[field.key] = value;
        }
        vendorMessage.textContent = 'Saving...';
        vendorMessage.className = 'small';
        try {
          await fetch(`/api/vendors/integrations/${integrationKey}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings })
          });
          vendorMessage.textContent = 'Integration saved.';
          vendorMessage.className = 'success';
          loadVendors();
          closeVendorModal();
        } catch (err) {
          vendorMessage.textContent = 'Failed to save integration';
          vendorMessage.className = 'error';
        }
        return;
      }
      const data = Object.fromEntries(new FormData(vendorForm).entries());
      const id = data.id || undefined;
      if (!data.vendor) {
        vendorMessage.textContent = 'Vendor is required';
        vendorMessage.className = 'error';
        return;
      }
      vendorMessage.textContent = 'Saving...';
      vendorMessage.className = 'small';
      let headersObj;
      if (data.notes) {
        try {
          headersObj = JSON.parse(data.notes);
        } catch (err) {
          vendorMessage.textContent = 'Notes/headers not valid JSON.';
          vendorMessage.className = 'error';
          return;
        }
      }
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/vendors/configs/${id}` : '/api/vendors/configs';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vendor: data.vendor,
            baseUrl: data.baseUrl || undefined,
            productUrlTemplate: data.productUrlTemplate || undefined,
            partNumberExample: data.partNumberExample || undefined,
            partNumberPattern: data.partNumberPattern || undefined,
            nameSelector: data.nameSelector || undefined,
            priceSelector: data.priceSelector || undefined,
            platform: data.platform || undefined,
            notes: data.notes || undefined,
            headers: headersObj
          })
        });
        vendorMessage.textContent = 'Saved.';
        vendorMessage.className = 'success';
        loadVendors();
        closeVendorModal();
      } catch (err) {
        vendorMessage.textContent = 'Failed to save vendor';
        vendorMessage.className = 'error';
      }
    });
    vendorExportCopy?.addEventListener('click', async () => {
      if (!vendorExportData?.text) {
        if (vendorExportMessage) {
          vendorExportMessage.textContent = 'Nothing to copy yet.';
          vendorExportMessage.className = 'small error';
        }
        return;
      }
      try {
        await copyTextToClipboard(vendorExportData.text);
        if (vendorExportMessage) {
          vendorExportMessage.textContent = 'Copied to clipboard.';
          vendorExportMessage.className = 'small success';
        }
      } catch (err) {
        if (vendorExportMessage) {
          vendorExportMessage.textContent = 'Copy failed. Select the text and copy manually.';
          vendorExportMessage.className = 'small error';
        }
      }
    });
    vendorExportDownload?.addEventListener('click', () => {
      if (!vendorExportData?.csv) {
        if (vendorExportMessage) {
          vendorExportMessage.textContent = 'No CSV content available.';
          vendorExportMessage.className = 'small error';
        }
        return;
      }
      downloadTextFile(vendorExportData.filename || 'vendor-export.csv', vendorExportData.csv, 'text/csv;charset=utf-8;');
      if (vendorExportMessage) {
        vendorExportMessage.textContent = 'CSV downloaded.';
        vendorExportMessage.className = 'small success';
      }
    });
    closeVendorExport?.addEventListener('click', () => closeVendorExportModal());

    vendorImportSelect?.addEventListener('change', () => {
      if (!canUseVendorImport()) return;
      const value = (vendorImportSelect.value || '').toLowerCase();
      vendorImportVendor = vendorConfigs.find(v => vendorOptionValue(v) === value) || null;
      if (vendorImportMessage) {
        vendorImportMessage.textContent = '';
        vendorImportMessage.className = 'small';
      }
      vendorImportEntries = [];
      updateVendorImportInstructions();
      renderVendorImportPreview();
    });
    vendorImportParseBtn?.addEventListener('click', () => { handleVendorImportParse(); });
    vendorImportClearBtn?.addEventListener('click', () => {
      resetVendorImportState(false);
      updateVendorImportInstructions();
    });
    vendorImportSubmit?.addEventListener('click', () => { submitVendorImportEntries(); });
    vendorImportPreview?.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action="remove-import-entry"]');
      if (!btn) return;
      const id = btn.dataset.index;
      vendorImportEntries = vendorImportEntries.filter(entry => String(entry.id) !== String(id));
      renderVendorImportPreview();
    });

    userForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(userForm).entries());
      const id = data.id || undefined;
      const payload = {
        username: data.username,
        name: data.name,
        role: data.role,
        active: data.active === 'true',
        permissions: undefined
      };
      if (data.password) payload.password = data.password;
      userMessage.textContent = 'Saving...';
      userMessage.className = 'small';
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/users/${id}` : '/api/users';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        userMessage.textContent = 'Saved user.';
        userMessage.className = 'success';
        loadUsers();
        closeUserModal();
      } catch (err) {
        userMessage.textContent = 'Failed to save user';
        userMessage.className = 'error';
      }
    });

    passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(passwordForm).entries());
      passwordMessage.textContent = 'Updating...';
      passwordMessage.className = 'small';
      const res = await fetch('/api/auth/password', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const resp = await res.json();
      if (!res.ok) {
        passwordMessage.textContent = resp.error || 'Failed';
        passwordMessage.className = 'error';
        return;
      }
      passwordMessage.textContent = 'Password updated.';
      passwordMessage.className = 'success';
      passwordForm.reset();
    });

    async function testExtraction() {
      if ((vendorForm?.dataset?.mode || 'custom') === 'builtin') {
        vendorMessage.textContent = 'Built-in vendors use their APIs directly.';
        vendorMessage.className = 'small';
        return;
      }
      const url = testUrl.value.trim();
      if (!url) {
        vendorMessage.textContent = 'Provide a URL to test.';
        vendorMessage.className = 'error';
        return;
      }
      const selectors = {
        nameSelector: vendorForm.elements.nameSelector.value || undefined,
        priceSelector: vendorForm.elements.priceSelector.value || undefined
      };
      const headers = {};
      try {
        const notes = vendorForm.elements.notes.value;
        if (notes) {
          const parsed = JSON.parse(notes);
          Object.assign(headers, parsed);
        }
      } catch (e) {
        vendorMessage.textContent = 'Notes/headers not valid JSON.';
        vendorMessage.className = 'error';
        return;
      }

      const resultsEl = document.getElementById('extract-results');
      resultsEl.textContent = 'Testing...';
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, selectors, headers })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        resultsEl.textContent = 'Pick which value looks correct for each field. You can paste CSS selectors (e.g., span.money).';

        if (data.shopify) {
          vendorMessage.textContent = 'Shopify data detected. Name/price auto-filled. Editing selectors will override Shopify.';
          vendorMessage.className = 'small';
          if (data.shopify.vendor && !vendorForm.elements.vendor.value) {
            vendorForm.elements.vendor.value = data.shopify.vendor;
          }
          if (data.shopify.variant?.name && !vendorForm.elements.nameSelector.value) {
            previewName.textContent = data.shopify.variant.name;
          }
          if (data.shopify.variant?.price !== undefined && !vendorForm.elements.priceSelector.value) {
            previewPrice.textContent = data.shopify.variant.price.toFixed(2);
          }
        }

        const trim = (t) => (t && t.length > 120 ? t.slice(0, 120) + '…' : t || '');
        const nameOptions = (data.picks?.name ? [{ text: data.picks.name, selector: selectors.nameSelector }] : []).concat(data.candidates?.titles || []);
        const priceOptions = (data.picks?.price ? [{ text: data.picks.price, selector: selectors.priceSelector }] : []).concat(data.candidates?.prices || []);

        const makeOptions = (opts) => opts.map(c => `<option data-text="${c.text || ''}" title="${c.text || ''}" value="${c.selector || ''}">${trim(c.text)}</option>`).join('');
        pickName.innerHTML = '<option value="">-- choose name --</option>' + makeOptions(nameOptions);
        pickPrice.innerHTML = '<option value="">-- choose price --</option>' + makeOptions(priceOptions);

        const applySelection = (selectEl, fieldName, previewEl) => {
          const apply = () => {
            const selOption = selectEl.options[selectEl.selectedIndex];
            const selSelector = selOption?.value || '';
            const selText = selOption?.dataset?.text || selOption?.title || selOption?.text || '';
            if (selSelector) {
              vendorForm.elements[fieldName].value = selSelector;
            }
            if (previewEl) previewEl.textContent = selText;
          };
          selectEl.addEventListener('change', apply);
          if (selectEl.options.length > 1) {
            selectEl.selectedIndex = 1;
            apply();
          }
        };
        applySelection(pickName, 'nameSelector', previewName);
        applySelection(pickPrice, 'priceSelector', previewPrice);
      } catch (err) {
        resultsEl.textContent = 'Extraction failed. Check URL/headers.';
        vendorMessage.textContent = err.message;
        vendorMessage.className = 'error';
      }
    }

    // Live preview when selectors change (uses current test URL if present)
    const debounce = (fn, ms = 400) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    };
    const liveExtract = debounce(() => {
      if (!testUrl.value.trim()) return;
      testExtraction();
    }, 500);

    ['nameSelector', 'priceSelector'].forEach(name => {
      vendorForm.elements[name].addEventListener('input', liveExtract);
    });

    function deriveFromSnippet(snippet) {
      if (!snippet) return '';
      const text = snippet.trim().replace(/;$/, '');
      const qsMatch = text.match(/querySelector(All)?\((['"`])([^'"`]+)\2\)/i);
      if (qsMatch) {
        return qsMatch[3].trim();
      }
      // CSS selector only
      return text;
    }

    applySelector.addEventListener('click', () => {
      const sel = deriveFromSnippet(selectorSnippet.value || '');
      if (!sel) return;
      const target = selectorTarget.value;
      vendorForm.elements[target].value = sel;
      liveExtract();
    });

    function guessRegexFromExample(example) {
      if (!example) return '';
      // If looks like ABC-1234 or AM-4896
      if (/^[A-Za-z]{2,}-\d+$/i.test(example)) {
        const prefix = example.split('-')[0];
        return `^${prefix}-\\d+$`;
      }
      // Alphanumeric with dashes
      if (/^[A-Za-z0-9-]+$/.test(example)) {
        return '^[A-Za-z0-9-]+$';
      }
      return '';
    }

    partExample.addEventListener('blur', () => {
      const guess = guessRegexFromExample(partExample.value.trim());
      if (guess && !partPattern.value) {
        partPattern.value = guess;
      }
    });

    testExtract.addEventListener('click', testExtraction);

    function updateUserUI() {
      if (currentUser) {
        userChip.textContent = `${currentUser.name || currentUser.username || 'User'} · ${currentUser.role || ''}`;
        userChip.style.display = 'inline-flex';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        accountBtn.style.display = 'inline-flex';
        tagsBtn.style.display = 'inline-flex';
        catalogBtn.style.display = 'inline-flex';
      } else {
        userChip.textContent = '';
        userChip.style.display = 'none';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        accountBtn.style.display = 'none';
        tagsBtn.style.display = 'none';
        catalogBtn.style.display = 'none';
        adminBtn.style.display = 'none';
      }
      const perms = computePerms(currentUser);
      if (currentUser) currentUser.permissions = perms;
      newOrderBtn.disabled = !perms.canPlacePartRequests;
      adminBtn.style.display = (perms.canManageUsers || perms.canManageVendors || perms.canEditTrackingSettings) ? 'inline-flex' : 'none';
      if (addStockBtn) addStockBtn.style.display = perms.canManageStock ? 'inline-flex' : 'none';
      if (manageSubteamsBtn) manageSubteamsBtn.style.display = perms.canManageStock ? 'inline-flex' : 'none';
      updateAdminTabsVisibility();
      syncCatalogSaveUI();
      updateCatalogEditVisibility();
      syncTagEditUI();
      syncVendorImportVisibility();
      syncOrderNotesRequirement();
    }

    async function loadUsers() {
      if (!currentUser?.permissions?.canManageUsers) {
        userList.innerHTML = '<div class="empty">No access to manage users.</div>';
        return;
      }
      userList.textContent = 'Loading users...';
      try {
        const res = await fetch('/api/users');
        const data = await res.json();
        const users = data.users || [];
        if (!users.length) {
          userList.innerHTML = '<div class="empty">No users.</div>';
          return;
        }
        userList.innerHTML = users.map(u => `
          <div class="card" data-id="${u._id}" style="margin-bottom:6px;">
            <div class="flex-between">
              <div>
                <div><strong>${u.username}</strong> (${u.role})</div>
                <div class="small">${u.name || ''}</div>
                <div class="small">Active: ${u.active ? 'Yes' : 'No'}</div>
              </div>
              <div class="flex-between" style="gap:8px;">
                <button class="btn ghost" data-action="edit-user">Edit</button>
                <button class="btn ghost" data-action="delete-user" style="color: var(--danger);">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        userList.querySelectorAll('button[data-action="edit-user"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const u = users.find(x => x._id === id);
            if (!u) return;
            openUserModal(u);
          });
        });
        userList.querySelectorAll('button[data-action="delete-user"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.card')?.dataset.id;
            if (!id) return;
            openConfirm('Delete this user?', async () => {
              await fetch(`/api/users/${id}`, { method: 'DELETE' });
              loadUsers();
            });
          });
        });
      } catch (e) {
        userList.textContent = 'Failed to load users';
      }
    }

    async function loadRoles() {
      if (!currentUser?.permissions?.canManageUsers) {
        roleList.innerHTML = '<div class="empty">No access to manage roles.</div>';
        return;
      }
      roleList.textContent = 'Loading roles...';
      try {
        const res = await fetch('/api/roles');
        const data = await res.json();
        const roles = data.roles || [];
        const combined = {
          admin: { canPlacePartRequests: true, canManageOwnPartRequests: true, canManagePartRequests: true, canManageOrders: true, canManageVendors: true, canManageUsers: true, canManageTags: true, canEditInventoryCatalog: true, canEditTrackingSettings: true, canManageStock: true, canEditStock: true, notesNotRequired: true, canImportBulkOrders: true },
          mentor: { canPlacePartRequests: true, canManageOwnPartRequests: true, canManagePartRequests: true, canManageOrders: true, canManageVendors: true, canManageUsers: false, canManageTags: true, canEditInventoryCatalog: true, canEditTrackingSettings: true, canManageStock: true, canEditStock: true, notesNotRequired: true, canImportBulkOrders: false },
          student: { canPlacePartRequests: true, canManageOwnPartRequests: false, canManagePartRequests: false, canManageOrders: false, canManageVendors: false, canManageUsers: false, canManageTags: false, canEditInventoryCatalog: false, canEditTrackingSettings: false, canManageStock: false, canEditStock: false, notesNotRequired: false, canImportBulkOrders: false }
        };
        roles.forEach(r => { combined[r.role] = { ...(combined[r.role] || {}), ...(r.permissions || {}) }; });

        const renderToggle = (role, key, label) => {
          const disabled = role === 'admin' ? 'disabled' : '';
          return `
          <label class="small" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" data-role="${role}" data-key="${key}" ${combined[role]?.[key] ? 'checked' : ''} ${disabled}/>
            ${label}
          </label>`;
        };

        const roleCard = (role) => `
          <div class="card" style="margin-bottom:8px;">
            <div class="page-title" style="font-size:16px;">${role}</div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px;">
              ${renderToggle(role, 'canEditStock', 'Manage Stock Levels')}
              ${renderToggle(role, 'canPlacePartRequests', 'Place Part Requests')}
              ${renderToggle(role, 'canManagePartRequests', 'Manage Part Requests')}
              ${renderToggle(role, 'canManageOwnPartRequests', 'Manage Own Part Requests')}
              ${renderToggle(role, 'canManageOrders', 'Create and Manage Orders')}
              ${renderToggle(role, 'canManageTags', 'Manage Tags')}
              ${renderToggle(role, 'canEditInventoryCatalog', 'Manage Inventory Catalog')}
              ${renderToggle(role, 'canManageStock', 'Manage Tracked Stock & Locations')}
              ${renderToggle(role, 'canManageVendors', 'Manage Vendors')}
              ${renderToggle(role, 'canManageUsers', 'Manage Users')}
              ${renderToggle(role, 'canEditTrackingSettings', 'Edit Tracking Settings')}
              ${renderToggle(role, 'notesNotRequired', 'Notes/Justification Not Required')}
              ${renderToggle(role, 'canImportBulkOrders', 'Can Import Bulk Orders')}
            </div>
            ${role === 'admin'
              ? `<div class="small" style="margin-top:8px;">Admin permissions are fixed and cannot be changed.</div>`
              : `<div class="flex-between" style="margin-top:8px;">
                  <button class="btn primary" data-action="save-role" data-role="${role}">Save ${role}</button>
                </div>`}
          </div>`;

        roleList.innerHTML = ['admin', 'mentor', 'student'].map(roleCard).join('');
        if (roleMessage) roleMessage.textContent = '';

        roleList.querySelectorAll('button[data-action="save-role"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const role = e.target.dataset.role;
            if (role === 'admin') {
              if (roleMessage) {
                roleMessage.textContent = 'Admin permissions are fixed and cannot be edited.';
                roleMessage.className = 'small';
              }
              return;
            }
            const inputs = roleList.querySelectorAll(`input[data-role="${role}"]`);
            const perms = {};
            inputs.forEach(input => {
              perms[input.dataset.key] = input.checked;
            });
            await fetch(`/api/roles/${role}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ permissions: perms })
            });
            if (roleMessage) {
              roleMessage.textContent = `Saved permissions for ${role}.`;
              roleMessage.className = 'success';
            }
          });
        });
      } catch (e) {
        roleList.textContent = 'Failed to load roles';
        if (roleMessage) {
          roleMessage.textContent = 'Failed to load roles.';
          roleMessage.className = 'error';
        }
      }
    }

    async function syncTrackingAutoRefreshFromServer() {
      try {
        const res = await fetch('/api/tracking/settings');
        if (!res.ok) return;
        const data = await res.json();
        const minutes = Number(data.settings?.refreshMinutes);
        if (Number.isFinite(minutes) && minutes > 0) {
          startTrackingAutoRefresh(minutes);
        }
      } catch (_) {
        // ignore - auto refresh will keep existing cadence
      }
    }

    async function loadTrackingSettings() {
      if (!trackingSettingsForm) return;
      trackingSettingsMessage.textContent = 'Loading tracking settings...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/settings');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load settings');
        const settings = data.settings || {};
        ['upsClientId','upsClientSecret','uspsUserId','fedexClientId','fedexClientSecret'].forEach(key => {
          if (trackingSettingsForm.elements[key]) {
            trackingSettingsForm.elements[key].value = settings[key] || '';
          }
        });
        if (trackingSettingsForm.elements.refreshMinutes) {
          trackingSettingsForm.elements.refreshMinutes.value = settings.refreshMinutes || 30;
        }
        if (settings.refreshMinutes) {
          startTrackingAutoRefresh(settings.refreshMinutes);
        }
        trackingSettingsMessage.textContent = 'Tracking settings loaded.';
        trackingSettingsMessage.className = 'small';
      } catch (e) {
        trackingSettingsMessage.textContent = e.message || 'Failed to load tracking settings';
        trackingSettingsMessage.className = 'error';
      }
    }

    trackingSettingsForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(trackingSettingsForm).entries());
      payload.refreshMinutes = Number(payload.refreshMinutes || 30);
      if (!Number.isFinite(payload.refreshMinutes) || payload.refreshMinutes <= 0) {
        payload.refreshMinutes = 30;
      }
      trackingSettingsMessage.textContent = 'Saving...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/settings', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save settings');
        trackingSettingsMessage.textContent = 'Saved tracking settings.';
        trackingSettingsMessage.className = 'success';
        startTrackingAutoRefresh(payload.refreshMinutes);
      } catch (err) {
        trackingSettingsMessage.textContent = err.message || 'Failed to save settings';
        trackingSettingsMessage.className = 'error';
      }
    });

    refreshTrackingNow?.addEventListener('click', async () => {
      trackingSettingsMessage.textContent = 'Refreshing tracking now...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/refresh', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to refresh');
        if (data.lastError) {
          trackingSettingsMessage.textContent = `Refresh triggered, but tracking error: ${data.lastError}`;
          trackingSettingsMessage.className = 'error';
        } else {
          trackingSettingsMessage.textContent = 'Refresh triggered. Data will update shortly.';
          trackingSettingsMessage.className = 'success';
        }
        fetchOrders();
      } catch (err) {
        trackingSettingsMessage.textContent = err.message || 'Failed to refresh tracking';
        trackingSettingsMessage.className = 'error';
      }
    });

    function allowedAdminTabs() {
      const tabs = [];
      if (currentUser?.permissions?.canManageUsers) {
        tabs.push('users', 'roles');
      }
      if (currentUser?.permissions?.canEditTrackingSettings) {
        tabs.push('tracking');
      }
      if (currentUser?.permissions?.canManageVendors) {
        tabs.push('vendors');
      }
      return tabs;
    }

    function updateAdminTabsVisibility() {
      const allowed = allowedAdminTabs();
      if (adminTabUsers) adminTabUsers.style.display = currentUser?.permissions?.canManageUsers ? 'inline-flex' : 'none';
      if (adminTabRoles) adminTabRoles.style.display = currentUser?.permissions?.canManageUsers ? 'inline-flex' : 'none';
      if (adminTabTracking) adminTabTracking.style.display = currentUser?.permissions?.canEditTrackingSettings ? 'inline-flex' : 'none';
      if (adminTabVendors) adminTabVendors.style.display = currentUser?.permissions?.canManageVendors ? 'inline-flex' : 'none';
      if (!allowed.includes(activeAdminTab)) {
        activeAdminTab = allowed[0] || null;
      }
      if (adminUsersSection) adminUsersSection.style.display = 'none';
      if (adminRolesSection) adminRolesSection.style.display = 'none';
      if (adminTrackingSection) adminTrackingSection.style.display = 'none';
      if (adminVendorsSection) adminVendorsSection.style.display = 'none';
    }

    function showAdminSection(which) {
      const allowed = allowedAdminTabs();
      if (!allowed.length) return;
      if (!allowed.includes(which)) which = allowed[0];
      activeAdminTab = which;
      adminUsersSection.style.display = which === 'users' ? 'block' : 'none';
      if (adminRolesSection) adminRolesSection.style.display = which === 'roles' ? 'block' : 'none';
      adminTrackingSection.style.display = which === 'tracking' ? 'block' : 'none';
      adminVendorsSection.style.display = which === 'vendors' ? 'block' : 'none';
      [adminTabUsers, adminTabRoles, adminTabTracking, adminTabVendors].forEach(btn => btn?.classList.remove('primary'));
      if (which === 'users') adminTabUsers?.classList.add('primary');
      if (which === 'roles') adminTabRoles?.classList.add('primary');
      if (which === 'tracking') adminTabTracking?.classList.add('primary');
      if (which === 'vendors') adminTabVendors?.classList.add('primary');
    }
    adminTabUsers?.addEventListener('click', () => showAdminSection('users'));
    adminTabRoles?.addEventListener('click', () => { showAdminSection('roles'); loadRoles(); });
    adminTabTracking?.addEventListener('click', () => showAdminSection('tracking'));
    adminTabVendors?.addEventListener('click', () => { showAdminSection('vendors'); loadVendors(); });

    async function fetchMe() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) throw new Error('unauth');
        const data = await res.json();
        currentUser = data.user;
        currentUser.permissions = computePerms(currentUser);
        setAuthenticated(true);
        updateUserUI();
        syncCatalogSaveUI();
        await syncTrackingAutoRefreshFromServer();
        await loadTags();
        await loadPriorityTags();
        fetchOrders();
        await loadStock();
        await loadSubteams();
        loadVendors();
        loadUsers();
        refreshCatalogView();
      } catch {
        currentUser = null;
        setAuthenticated(false);
        updateUserUI();
        resetCatalogSavePanel();
        resetCatalogLookup();
        stockItems = [];
        renderStockGrid();
        renderStockFilters();
      }
    }

    loginBtn.addEventListener('click', () => {
      if (loginMessage) { loginMessage.textContent = ''; loginMessage.style.display = 'none'; }
      if (loginForm) loginForm.reset();
      setAuthenticated(false);
    });
    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      currentUser = null;
      setAuthenticated(false);
      if (loginForm) loginForm.reset();
      updateUserUI();
      resetCatalogSavePanel();
      resetCatalogLookup();
      orders = [];
      renderBoard();
      renderTable();
      stockItems = [];
      renderStockGrid();
      stockSubteams = [];
      renderStockFilters();
      showOrdersView();
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(loginForm);
      const payload = Object.fromEntries(formData.entries());
      loginMessage.textContent = 'Signing in...';
      loginMessage.className = 'login-status';
      loginMessage.style.display = 'block';
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) {
        loginMessage.textContent = data.error || 'Login failed';
        loginMessage.className = 'login-error';
        loginMessage.style.display = 'block';
        return;
      }
      currentUser = data.user;
      currentUser.permissions = computePerms(currentUser);
      loginMessage.textContent = '';
      loginMessage.style.display = 'none';
      if (loginForm) loginForm.reset();
      setAuthenticated(true);
      updateUserUI();
      syncCatalogSaveUI();
      syncTrackingAutoRefreshFromServer();
      await loadTags();
      await loadPriorityTags();
      fetchOrders();
      await loadStock();
      await loadSubteams();
      loadVendors();
      loadUsers();
      refreshCatalogView();
    });

    updateSearchPlaceholder();
    startTrackingAutoRefresh(DEFAULT_TRACKING_POLL_MINUTES);
    fetchMe();
  </script>
</body>
</html>
