<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Venom Parts</title>
  <link rel="icon" type="image/png" href="/branding/logo.png" />
  <style>
    @font-face {
      font-family: 'Nasalization';
      src: url('/branding/Nasalization.ttf') format('truetype');
      font-display: swap;
    }
    :root {
      color-scheme: dark;
      --purple: #461d7c;
      --gold: #fdd023;
      --bg: radial-gradient(circle at top, rgba(70, 29, 124, 0.18), transparent 55%), #141414;
      --panel: rgba(34, 34, 34, 0.92);
      --panel-2: rgba(34, 34, 34, 0.98);
      --accent: #461d7c;
      --accent-2: #fdd023;
      --text: #f2f4f8;
      --muted: #c8c1dd;
      --border: rgba(253, 208, 35, 0.25);
      --danger: #ff5565;
      --success: #4ad28f;
      --warning: var(--gold);
      --card-shadow: 0 20px 50px rgba(0,0,0,0.5);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
    }
    h1, h2, h3, h4, .brand, .page-title { font-family: 'Nasalization', 'Inter', system-ui, sans-serif; letter-spacing: 0.4px; }
    a { color: inherit; text-decoration: none; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: linear-gradient(120deg, rgba(34,34,34,0.95), rgba(40,30,60,0.95));
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: var(--safe-top);
      z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .brand {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--gold);
      text-shadow: 0 2px 10px rgba(253,208,35,0.2);
    }
    .brand img { height: 36px; width: 36px; border-radius: 50%; object-fit: contain; }
    .brand-text { display:flex; flex-direction:column; line-height:1.15; gap: 3px; }
    .brand-title { font-size: 22px; font-family:'Nasalization', 'Inter', sans-serif; font-weight: 700; }
    .brand-subtitle { font-size: 12px; font-weight: 500; letter-spacing: 0.5px; color: var(--gold); text-transform: uppercase; }
    .search {
      flex: 1;
      max-width: 400px;
      margin: 0 16px;
      position: relative;
    }
    .search input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
    }
    .toolbar {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    .toolbar-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn {
      border: 1px solid var(--border);
      background: var(--accent);
      color: var(--gold);
      border-radius: 12px;
      padding: 9px 14px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      line-height: 1.2;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 30px rgba(70, 29, 124, 0.25); }
    .btn.primary {
      background: var(--gold);
      color: #1a1000;
      border-color: var(--gold);
      box-shadow: 0 12px 28px rgba(253,208,35,0.25);
    }
    .btn.ghost {
      background: transparent;
      color: var(--text);
    }
    main { padding: 24px; padding-bottom: 24px; flex:1; min-height:0; display:flex; flex-direction:column; overflow:hidden; gap:12px; }
    .page-title { font-size: 32px; font-weight: 800; margin: 0 0 4px; color: var(--gold); }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .view-toggle {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--panel);
    }
    .view-toggle button {
      border: none;
      background: transparent;
      color: #f7f8fb;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      min-width: 100px;
    }
    .view-toggle button.active {
      background: var(--accent);
      color: #f7f8fb;
    }
    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    /* Board */
    .board {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      grid-auto-rows: minmax(0, 1fr);
      margin-top: 16px;
      height: 100%;
      min-height: 0;
      padding-bottom: 12px;
      overflow: hidden;
    }
    .column {
      background: var(--panel-2);
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 12px;
      min-height: 300px;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
      min-height: 0;
    }
    .column h3 {
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
    }
    .pill {
      background: #1f2a44;
      color: var(--text);
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
    }
    .board-drop {
      min-height: 0;
      padding-bottom: 12px;
      overflow-y: auto;
      flex:1;
      padding-right: 4px;
      padding-top: 4px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      cursor: grab;
      transition: transform 0.1s ease, border-color 0.1s ease, box-shadow 0.15s ease;
    }
    .card:hover { border-color: var(--gold); box-shadow: 0 10px 28px rgba(253,208,35,0.2); }
    .card h4 { margin: 0 0 6px; font-size: 15px; }
    .meta {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1b2440;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .tag.supplier { background: rgba(79,180,255,0.12); color: var(--accent-2); }
    .tag.priority { background: rgba(248,197,82,0.16); color: var(--gold); }
    .tag.group { background: rgba(74,210,143,0.16); color: var(--success); }
    .tag.tracking { background: rgba(79,180,255,0.14); color: var(--accent-2); cursor: pointer; }
    .tag.tracking.pending { background: rgba(255,85,101,0.18); color: #ff8b95; border-color: rgba(255,85,101,0.5); }
    .tag.tracking.intransit { background: rgba(79,180,255,0.18); color: #9bd0ff; border-color: rgba(79,180,255,0.5); }
    .tag.tracking.delivered { background: rgba(74,210,143,0.2); color: #7be0b4; border-color: rgba(74,210,143,0.5); }
    .tag.tracking.unknown { background: rgba(200,193,221,0.18); color: #d1cbe2; border-color: rgba(200,193,221,0.5); }
    .tracking-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tracking-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tracking-row select { min-width:120px; }
    .tracking-list { display:flex; flex-direction:column; gap:6px; }
    .tag-dot { width:10px; height:10px; border-radius:50%; display:inline-block; background: transparent; }
    .tag-picker { position: relative; max-width: 420px; }
    .tag-picker-display { border:1px solid var(--border); background: var(--panel); padding:10px 12px; border-radius:10px; cursor:pointer; }
    .tag-picker-panel { position:absolute; top:110%; left:0; right:0; background:var(--panel-2); border:1px solid var(--border); border-radius:10px; box-shadow:var(--card-shadow); padding:8px; z-index:25; max-height:260px; display:flex; flex-direction:column; gap:8px; }
    .tag-picker-options { overflow:auto; max-height:180px; display:flex; flex-direction:column; gap:6px; }
    .tag-option { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid transparent; }
    .tag-option:hover { background: rgba(255,255,255,0.04); }
    .tag-option.selected { border-color: var(--accent); background: rgba(70,29,124,0.15); }
    .tag-manager-list { display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .tag-manager-item { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel); }
    .tag-manager-meta { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .admin-inline-form { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .tag-modal-card { background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto; }
    .inline-color { width:40px; height:40px; padding:0; border:none; border-radius:50%; background:transparent; cursor:pointer; }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .checkbox {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
    }
    .card.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(79,180,255,0.25); }
    /* Table */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .input {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      width: 100%;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 13px;
    }
    th { color: var(--muted); font-weight: 600; }
    tr:hover td { background: rgba(79,180,255,0.05); }
    .status-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .status-Requested { background: rgba(253,208,35,0.18); color: var(--gold); }
    .status-Ordered { background: rgba(253,208,35,0.28); color: #1f1a00; }
    .status-Received { background: rgba(74,210,143,0.16); color: var(--success); }
    .status-Cancelled { background: rgba(255,85,101,0.16); color: var(--danger); }
    .selection-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
      margin: 12px 0;
    }
    .input-inline {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--text);
    }
    .small { font-size: 12px; color: var(--muted); }
    select { max-width: 100%; }
    select option { white-space: normal; }
    .empty {
      border: 1px dashed var(--border);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
      background: var(--panel-2);
    }
    .stock-grid .card { cursor: default; }
    .stock-card.stock-low { border-color: var(--warning); box-shadow: 0 0 0 1px rgba(253,208,35,0.35); }
    .stock-card.stock-empty { border-color: var(--danger); box-shadow: 0 0 0 1px rgba(255,85,101,0.45); }
    .stock-grid {
      align-items: start;
      grid-auto-rows: auto;
      grid-template-columns: repeat(auto-fit, minmax(400px, 520px));
      justify-content: flex-start;
      align-content: start;
    }
    .stock-grid .card {
      width: 100%;
      max-width: 520px;
    }
    .stock-grid.grouped {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .stock-category-title {
      font-weight: 800;
      font-size: 16px;
      color: var(--gold);
      margin: 0 0 8px;
      padding: 0 2px;
    }
    .stock-category-block {
      width: 100%;
    }
    .stock-category-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(400px, 520px));
      align-items: start;
      width: 100%;
      align-content: start;
    }
    .stock-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: nowrap;
    }
    .stock-actions .btn {
      padding: 4px 8px;
      font-size: 13px;
      line-height: 1.2;
    }
    .stock-actions .btn.primary {
      padding: 4px 10px;
    }
    .stock-level {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 26px;
      font-weight: 800;
      color: var(--text);
    }
    .stock-adjust { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .stock-adjust .btn {
      min-width: 38px;
      min-height: 38px;
      border-radius: 12px;
      font-size: 16px;
      padding: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .stock-chip {
      background: #1b2440;
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 700;
    }
    .card.add-target-disabled {
      opacity: 0.35;
      pointer-events: none;
      filter: grayscale(0.3);
    }
    .card.add-target-valid {
      box-shadow: 0 0 0 1px var(--accent);
    }
    .stock-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    .stock-low-text { color: var(--warning); font-weight: 700; }
    .stock-empty-text { color: var(--danger); font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="/branding/logo.png" alt="Venom Parts logo" />
      <div class="brand-text">
        <span class="brand-title">Venom Parts</span>
        <span class="brand-subtitle">FRC 8044 - Parts Ordering System</span>
      </div>
    </div>
    <div class="search">
      <input id="global-search" placeholder="Search parts, suppliers, users..." />
    </div>
    <div class="toolbar">
      <div class="toolbar-buttons">
        <button class="btn ghost" id="refresh-btn">Refresh</button>
        <button class="btn ghost" id="catalog-btn" style="display:none;">Catalog</button>
        <button class="btn ghost" id="admin-btn" style="display:none;">Admin</button>
        <button class="btn ghost" id="account-btn">Account</button>
        <button class="btn ghost" id="login-btn">Login</button>
        <button class="btn ghost" id="logout-btn" style="display:none;">Logout</button>
      </div>
      <div class="user-status">
        <span id="tracking-updated" class="small" style="color: var(--muted);"></span>
        <span id="user-chip" class="pill" style="background: var(--panel); border:1px solid var(--border);"></span>
      </div>
    </div>
  </header>

  <main>
    <div class="flex-between" style="align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <div class="page-title" id="primary-title">Orders</div>
        <div class="subtitle" id="primary-subtitle">Track parts from request to delivery.</div>
      </div>
      <div class="view-toggle" id="primary-view-toggle">
        <button id="orders-view-btn" class="active">Orders</button>
        <button id="stock-view-btn">Stock</button>
      </div>
    </div>

    <div id="orders-layout-row" class="flex-between" style="align-items:center; gap:12px; flex-wrap:wrap; margin-top:8px;">
      <div class="view-toggle" id="orders-layout-toggle">
        <button id="board-view-btn" class="active">Board</button>
        <button id="table-view-btn">Table</button>
      </div>
      <div class="flex-between" style="gap:8px; flex-wrap:wrap; margin-left:auto;">
        <button class="btn ghost" id="tags-btn" style="display:none;">Manage Tags</button>
        <button class="btn primary" id="new-order-btn">New Order</button>
      </div>
    </div>

    <div id="selection-bar" class="selection-bar">
      <div style="display:flex; flex-direction:column; gap:4px; min-width:180px;">
        <div id="selection-count"></div>
        <div id="group-vendor-note" class="small">Vendor: auto from selection</div>
      </div>
      <div class="flex-between selection-actions" style="gap:8px;">
        <button class="btn ghost" id="select-all-btn">Select all</button>
        <button class="btn ghost" id="select-same-vendor-btn">Select Vendor</button>
        <button class="btn ghost" id="unselect-all-btn">Unselect all</button>
        <button class="btn primary" id="group-btn">Create Order</button>
        <button class="btn ghost" id="add-to-order-btn">Add to Order</button>
        <button class="btn ghost" id="delete-selected" style="color: var(--danger);">Delete selected</button>
      </div>
    </div>

    <section id="board-section" style="flex:1; min-height:0; overflow:hidden; display:flex; flex-direction:column; padding-bottom: 12px;">
      <div class="board" id="board"></div>
    </section>

    <section id="table-section" style="display:none; flex:1; min-height:0; overflow:hidden; flex-direction:column;">
      <div class="filters">
        <div><label class="small">Start date</label><input id="start-date" class="input" type="date" /></div>
        <div><label class="small">End date</label><input id="end-date" class="input" type="date" /></div>
        <div><label class="small">Status</label><select id="status-filter" class="input"></select></div>
        <div><label class="small">Vendor</label><select id="vendor-filter" class="input"></select></div>
      </div>
      <div id="table-container" style="overflow:auto; flex:1; min-height:0; padding-bottom: 12px;"></div>
    </section>

    <section id="stock-section" style="display:none; flex:1; min-height:0; overflow:hidden; flex-direction:column; gap:12px;">
      <div class="flex-between" style="align-items:center; gap:8px; flex-wrap:wrap;">
        <div class="flex-between" style="gap:8px; flex-wrap:wrap; align-items:center;">
          <select id="stock-subteam-filter" class="input" style="min-width:180px;"></select>
        </div>
        <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
          <button class="btn ghost" id="manage-subteams-btn" style="display:none;">Manage Locations</button>
          <button class="btn primary" id="add-stock-btn" style="display:none;">Add Stock</button>
        </div>
      </div>
      <div id="stock-grid" class="board stock-grid" style="flex:1; min-height:0; overflow:auto; padding-bottom:12px;"></div>
    </section>
  </main>

  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:50; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">New Order</div>
          <div class="subtitle" style="margin-bottom:12px;">Provide a link or PN to fetch details from supported vendors; otherwise enter manually.</div>
        </div>
      </div>
      <form id="order-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:12px;">
        <div style="grid-column: span 2;">
          <div id="order-source-toggle" style="display:inline-flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn ghost" data-source="manual" id="order-source-manual">Enter new part</button>
            <button type="button" class="btn ghost" data-source="catalog" id="order-source-catalog">Pick from catalog</button>
          </div>
        </div>
        <div class="order-manual-fields" style="grid-column: span 2;">
          <label class="small">Product Number</label>
            <input name="vendorPartNumber" class="input" placeholder="e.g., WCP-0921" />
        </div>
        <div class="order-manual-fields" style="grid-column: span 2;">
          <label class="small">Supplier Link</label>
          <input name="partLink" class="input" placeholder="https://vendor.com/product/..." />
          <div style="margin-top:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn primary" id="fetch-product" style="padding:6px 10px;">Fetch Details</button>
            <span class="small" id="fetch-supported">Supported vendors will auto-detect from link or part number.</span>
          </div>
        </div>
        <div class="order-catalog-fields" style="grid-column: span 2; display:none;">
          <label class="small">Saved catalog</label>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; align-items:center;">
            <input id="catalog-lookup" class="input" placeholder="Search saved parts..." />
            <div id="catalog-lookup-selected" class="small"></div>
          </div>
          <div id="catalog-lookup-results" class="tag-picker-options" style="display:none; margin-top:6px; max-height:180px; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:6px;"></div>
        </div>
        <div>
          <label class="small">Vendor</label>
          <input name="vendor" class="input" placeholder="Vendor" />
        </div>
        <div>
          <label class="small">Part Name</label>
          <input name="partName" class="input" required />
        </div>
        <div>
          <label class="small">Unit Cost</label>
          <input name="unitCost" class="input" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label class="small">Quantity</label>
          <input name="quantityRequested" class="input" type="number" min="1" value="1" required />
        </div>
        <div>
          <label class="small">Priority</label>
          <select name="priority" class="input">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tags</label>
          <select id="order-tags" name="tags" class="input" multiple size="4" style="min-height:90px; display:none;"></select>
          <div class="tag-picker" id="tag-picker">
            <div id="tag-picker-display" class="tag-picker-display">Select tags</div>
            <div id="tag-picker-panel" class="tag-picker-panel" style="display:none;">
              <input id="tag-picker-search" class="input tag-picker-search" placeholder="Search tags..." />
              <div id="tag-picker-options" class="tag-picker-options"></div>
            </div>
          </div>
          <div class="small" style="margin-top:8px;">Tags categorize requests. Open the Tags panel to view or manage them.</div>
        </div>
        <!-- Tracking managed at group level; no tracking fields for individual parts -->
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea name="notes" class="input" rows="3" placeholder="Justification, sizing details, links, etc."></textarea>
        </div>
        <div id="catalog-save-container" style="grid-column: span 2; display:none;">
          <div class="flex-between" style="align-items:center; gap:6px; flex-wrap:wrap;">
            <label class="small" style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="save-to-catalog-toggle" class="checkbox" />
              Save this part to the inventory catalog
            </label>
          </div>
          <div id="catalog-save-fields" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px; display:none;">
            <div>
              <label class="small">Category path</label>
              <select id="catalog-save-category" class="input"></select>
            </div>
            <div>
              <label class="small">Subteam</label>
              <input id="catalog-save-subteam" class="input" placeholder="Electrical" />
            </div>
            <div>
              <label class="small">Type</label>
              <input id="catalog-save-type" class="input" placeholder="Connector" />
            </div>
          </div>
          <div id="catalog-save-message" class="small" style="margin-top:6px;"></div>
        </div>
        <div id="catalog-save-status" class="small" style="grid-column: span 2;"></div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="order-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-order">Cancel</button>
            <button type="submit" class="btn primary">Submit order</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="group-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:55; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:520px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Edit Group</div>
          <div class="subtitle" style="margin-bottom:12px;">Update group title or tracking.</div>
        </div>
        <button class="btn ghost" id="close-group">Close</button>
      </div>
      <form id="group-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Group title</label>
          <input name="title" class="input" placeholder="Vendor - mm/dd/yy" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tracking numbers</label>
          <div id="group-modal-tracking-list" class="tracking-list"></div>
          <button type="button" class="btn ghost" id="add-group-modal-tracking" style="padding:6px 10px; margin-top:4px;">Add tracking</button>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea name="notes" class="input" rows="3" placeholder="Optional notes for this order group"></textarea>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="group-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-group">Cancel</button>
            <button type="submit" class="btn primary">Save group</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="catalog-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:58; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:1100px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:22px;">Inventory Catalog</div>
          <div class="subtitle" style="margin-bottom:12px;">Browse saved parts by category.</div>
        </div>
        <button class="btn ghost" id="close-catalog">Close</button>
      </div>
      <div class="grid" style="grid-template-columns: minmax(280px, 1fr) 2fr; gap:12px; align-items:start;">
        <div style="display:flex; flex-direction:column; gap:10px; padding-bottom:12px;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div class="page-title" style="font-size:15px;">Categories</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <button class="btn ghost" id="catalog-back" style="padding:6px 10px; display:none;">Back</button>
              <button class="btn ghost" id="refresh-catalog-categories" style="padding:6px 10px;">Refresh</button>
              <button class="btn primary" id="catalog-new-category" style="padding:6px 10px;">New Category</button>
            </div>
          </div>
          <div class="small" id="catalog-path-display"></div>
          <div id="catalog-category-list" class="empty" style="min-height:140px;">Loading categories...</div>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div class="flex-between" style="align-items:center; gap:8px; flex-wrap:wrap;">
            <div>
              <div class="page-title" style="font-size:15px;">Catalog items</div>
              <div class="small" id="catalog-item-hint">Select a category to focus results.</div>
            </div>
            <div class="flex-between" style="gap:6px; align-items:center; margin-left:auto; flex-wrap:nowrap;">
              <input id="catalog-item-search" class="input" placeholder="Search saved parts..." style="min-width:220px; flex:1;" />
              <button class="btn ghost" id="refresh-catalog-items" style="padding:6px 10px; white-space:nowrap;">Refresh</button>
              <button class="btn primary" id="new-catalog-item" style="padding:6px 10px; white-space:nowrap;">New item</button>
            </div>
          </div>
          <div id="catalog-item-list" class="empty">No catalog items yet.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="catalog-item-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:66; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:20px;">Catalog item</div>
          <div class="subtitle" id="catalog-item-modal-hint" style="margin-bottom:10px;">Create or edit a saved part.</div>
        </div>
      </div>
      <form id="catalog-item-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:4px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Product Number</label>
          <input name="vendorPartNumber" class="input" placeholder="SKU" />
        </div>
        <div>
          <label class="small">Supplier Link</label>
          <input name="supplierLink" class="input" placeholder="https://vendor.com/part" />
        </div>
        <div style="grid-column: span 2;">
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px;">
            <button type="button" class="btn primary" id="fetch-catalog-product" style="padding:6px 10px;">Fetch Details</button>
            <span class="small" id="fetch-supported-catalog">Supported vendors will auto-detect from link or part number.</span>
          </div>
        </div>
        <div>
          <label class="small">Vendor</label>
          <input name="vendor" class="input" placeholder="WCP, DigiKey..." />
        </div>
        <div>
          <label class="small">Part Name</label>
          <input name="name" class="input" required />
        </div>
        <div>
          <label class="small">Category Path</label>
          <input name="categoryPath" class="input" placeholder="Electrical/Connectors/Molex" />
        </div>
        <div>
          <label class="small">Unit Cost</label>
          <input name="unitCost" class="input" type="number" step="0.01" />
        </div>
        <div>
          <label class="small">Default Quantity</label>
          <input name="defaultQuantity" class="input" type="number" min="1" placeholder="1" />
        </div>
        <div>
          <label class="small">Subteam</label>
          <input name="subteam" class="input" placeholder="Electrical" />
        </div>
        <div>
          <label class="small">Type</label>
          <input name="type" class="input" placeholder="Connector" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Aliases (comma separated)</label>
          <input name="aliases" class="input" placeholder="crimp, molex, male" />
        </div>
        <div class="flex-between" style="grid-column: span 2; gap:8px; flex-wrap:wrap; margin-top:6px;">
          <div id="catalog-item-message" class="small"></div>
          <div class="flex-between" style="gap:6px;">
            <button type="button" class="btn ghost" id="cancel-catalog-item">Cancel</button>
            <button type="button" class="btn ghost" id="delete-catalog-item" style="color:var(--danger);">Delete</button>
            <button type="submit" class="btn primary">Save item</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="user-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:70; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:560px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:20px;">User management</div>
          <div class="subtitle" style="margin-bottom:10px;">Create or edit a user account.</div>
        </div>
        <button class="btn ghost" id="close-user-modal">Close</button>
      </div>
      <form id="user-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:10px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Username</label>
          <input name="username" class="input" required />
        </div>
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" required />
        </div>
        <div>
          <label class="small">Role</label>
          <select name="role" class="input">
            <option>admin</option>
            <option>mentor</option>
            <option>student</option>
          </select>
        </div>
        <div>
          <label class="small">Password (set/reset)</label>
          <input name="password" class="input" type="password" placeholder="Leave blank to keep existing" />
        </div>
        <div>
          <label class="small">Active</label>
          <select name="active" class="input">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="user-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-user">Cancel</button>
            <button type="submit" class="btn primary" id="save-user-btn">Create user</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="vendor-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:68; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="page-title" style="font-size:20px;">Vendor extraction</div>
          <div class="subtitle" style="margin-bottom:10px;">Create or edit vendor configurations.</div>
        </div>
        <button class="btn ghost" id="close-vendor-modal">Close</button>
      </div>
      <form id="vendor-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px; margin-top:10px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Vendor name</label>
          <input name="vendor" class="input" placeholder="e.g., WCP" required />
        </div>
        <div>
          <label class="small">Base URL</label>
          <input name="baseUrl" class="input" placeholder="https://wcproducts.com" />
        </div>
        <div>
          <label class="small">Product URL template</label>
          <input name="productUrlTemplate" class="input" placeholder="https://wcproducts.com/products/{partNumber}" />
          <div class="small">Use {partNumber} where the SKU goes, e.g. https://vendor.com/products/{partNumber}</div>
        </div>
        <div>
          <label class="small">Part # example</label>
          <input name="partNumberExample" class="input" placeholder="WCP-0921" />
        </div>
        <div>
          <label class="small">Part # regex</label>
          <input name="partNumberPattern" class="input" placeholder="^WCP-\\d+$" />
          <div class="small">Auto-filled from example; edit to tighten/loosen validation.</div>
        </div>
        <div>
          <label class="small">Name selector</label>
          <input name="nameSelector" class="input" placeholder=".product-title" />
        </div>
        <div>
          <label class="small">Price selector</label>
          <input name="priceSelector" class="input" placeholder=".price" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Paste copied selector or JS path</label>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px;">
            <textarea id="selector-snippet" class="input" rows="2" placeholder="Right-click → Copy selector or Copy JS path"></textarea>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:6px;">
              <select id="selector-target" class="input">
                <option value="nameSelector">Apply to Name</option>
                <option value="priceSelector">Apply to Price</option>
              </select>
              <button type="button" class="btn ghost" id="apply-selector">Apply</button>
            </div>
          </div>
          <div class="small">Tip: Use “Copy selector” or “Copy JS path” from DevTools.</div>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes / headers JSON (optional)</label>
          <textarea name="notes" class="input" rows="2" placeholder="Headers: {\"User-Agent\":\"...\"}"></textarea>
        </div>
        <div style="grid-column: span 2;">
          <div class="small" style="margin-bottom:6px;">Test extraction (paste a product URL)</div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:8px;">
            <input id="test-url" class="input" placeholder="https://vendor.com/product/123" />
            <button type="button" class="btn primary" id="test-extract">Test</button>
          </div>
          <div id="extract-results" class="small" style="margin-top:8px;"></div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px;">
            <div>
              <label class="small">Pick name</label>
              <select id="pick-name" class="input"></select>
              <div id="preview-name" class="small"></div>
            </div>
            <div>
              <label class="small">Pick price</label>
              <select id="pick-price" class="input"></select>
              <div id="preview-price" class="small"></div>
            </div>
          </div>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="vendor-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-vendor">Cancel</button>
            <button type="submit" class="btn primary">Save vendor</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="login-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:70; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:420px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:22px;">Sign In</div>
      <div class="subtitle" style="margin-bottom:12px;">Use your team-issued account.</div>
      <form id="login-form" class="grid" style="grid-template-columns:1fr; gap:12px;">
        <div>
          <label class="small">Username</label>
          <input name="username" class="input" required />
        </div>
        <div>
          <label class="small">Password</label>
          <input name="password" class="input" type="password" required />
        </div>
        <div class="flex-between">
          <div id="login-message" class="small"></div>
          <button type="submit" class="btn primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <div id="account-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:65; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:500px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:22px;">My Account</div>
      <div class="subtitle" style="margin-bottom:12px;">Update your password.</div>
      <form id="password-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:8px;">
        <div>
          <label class="small">Old password</label>
          <input name="oldPassword" class="input" type="password" required />
        </div>
        <div>
          <label class="small">New password</label>
          <input name="newPassword" class="input" type="password" required />
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="password-message" class="small"></div>
          <button type="submit" class="btn primary">Update password</button>
        </div>
      </form>
    </div>
  </div>

  <div id="catalog-category-new-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:420px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:20px;">New category</div>
      <div class="subtitle" id="catalog-category-new-path" style="margin-bottom:10px;"></div>
      <form id="catalog-category-new-form" class="grid" style="grid-template-columns:1fr; gap:10px; padding-bottom:6px;">
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" placeholder="Category name" required />
        </div>
        <div class="flex-between" style="gap:8px; margin-top:6px;">
          <div id="catalog-category-new-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="catalog-category-new-cancel">Cancel</button>
            <button type="submit" class="btn primary">Create</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="catalog-category-edit-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:460px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:20px;">Edit category</div>
      <div class="subtitle" id="catalog-category-edit-path" style="margin-bottom:10px;"></div>
      <form id="catalog-category-edit-form" class="grid" style="grid-template-columns:1fr; gap:10px; padding-bottom:6px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" required />
        </div>
        <div>
          <label class="small">Move to</label>
          <select name="parentId" class="input"></select>
        </div>
        <div class="flex-between" style="gap:8px; margin-top:6px;">
          <div id="catalog-category-edit-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="catalog-category-edit-cancel">Cancel</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="tags-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:62; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Tags &amp; priorities</div>
          <div class="subtitle" style="margin-bottom:12px;">View tags and priorities. Editing requires the Manage Tags permission.</div>
        </div>
        <button class="btn ghost" id="close-tags">Close</button>
      </div>
      <div class="flex-between" style="margin-top:10px; gap:8px;">
        <div class="flex-between" style="gap:6px; flex-wrap:wrap;">
          <button class="btn ghost" id="tags-tab-tags">Organization tags</button>
          <button class="btn ghost" id="tags-tab-priorities">Priority tags</button>
        </div>
      </div>
      <div id="tags-section" class="card" style="background:var(--panel-2); margin-top:10px;">
        <div class="flex-between" style="align-items:flex-start;">
          <div>
            <div class="page-title" style="font-size:18px;">Organization tags</div>
            <div class="subtitle" style="margin-bottom:12px;">Manage tags used to categorize requests.</div>
          </div>
          <div class="flex-between" style="gap:8px;">
            <button class="btn ghost" id="refresh-tags">Refresh</button>
          </div>
        </div>
        <form id="create-tag-form" class="admin-inline-form" style="margin-top:10px;">
          <input id="tag-color-input" class="inline-color" type="color" value="#fdd023" />
          <input id="tag-label-input" class="input" placeholder="New tag name" required style="flex:1; min-width:180px;" />
          <button type="submit" class="btn primary">New tag</button>
        </form>
        <div id="tags-message" class="small" style="margin-top:6px;"></div>
        <div id="tags-list" class="tag-manager-list" style="margin-top:10px;"></div>
      </div>
      <div id="priorities-section" class="card" style="background:var(--panel-2); margin-top:10px; display:none;">
        <div class="flex-between" style="align-items:flex-start;">
          <div>
            <div class="page-title" style="font-size:18px;">Priority tags</div>
            <div class="subtitle" style="margin-bottom:12px;">Customize priority labels and colors.</div>
          </div>
          <div class="flex-between" style="gap:8px;">
            <button class="btn ghost" id="refresh-priorities">Refresh</button>
          </div>
        </div>
        <form id="create-priority-form" class="admin-inline-form" style="margin-top:10px;">
          <input id="priority-color-input" class="inline-color" type="color" value="#fdd023" />
          <input id="priority-label-input" class="input" placeholder="Priority name (e.g., Medium)" required style="flex:1; min-width:180px;" />
          <input id="priority-sort-input" class="input" type="number" placeholder="Sort" style="width:80px;" />
          <button type="submit" class="btn primary">New priority</button>
        </form>
        <div id="priorities-message" class="small" style="margin-top:6px;"></div>
        <div id="priorities-list" class="tag-manager-list" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <div id="catalog-request-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:520px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:20px;">Request catalog item</div>
          <div class="subtitle" id="catalog-request-subtitle" style="margin-bottom:12px;">Choose quantity and confirm.</div>
        </div>
      </div>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
        <div>
          <label class="small">Quantity to request</label>
          <input id="catalog-request-qty" class="input" type="number" min="1" value="1" />
        </div>
        <div>
          <label class="small">Priority</label>
          <select id="catalog-request-priority" class="input">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Tags</label>
          <select id="catalog-request-tags" class="input" multiple size="4" style="min-height:90px; display:none;"></select>
          <div class="tag-picker" id="catalog-request-tag-picker">
            <div id="catalog-request-tag-picker-display" class="tag-picker-display">Select tags</div>
            <div id="catalog-request-tag-picker-panel" class="tag-picker-panel" style="display:none;">
              <input id="catalog-request-tag-picker-search" class="input tag-picker-search" placeholder="Search tags..." />
              <div id="catalog-request-tag-picker-options" class="tag-picker-options"></div>
            </div>
          </div>
          <div class="small" style="margin-top:4px;">Same tags as new order.</div>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea id="catalog-request-notes" class="input" rows="3" placeholder="Add justification, sizing, links, etc."></textarea>
        </div>
      </div>
      <div class="flex-between" style="margin-top:10px;">
        <div id="catalog-request-message" class="small"></div>
        <div class="flex-between" style="gap:8px;">
          <button class="btn ghost" id="cancel-catalog-request">Cancel</button>
          <button class="btn primary" id="confirm-catalog-request">Add to requests</button>
        </div>
      </div>
    </div>
  </div>

  <div id="stock-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:63; align-items:center; justify-content:center; padding:16px;">
    <div class="tag-modal-card">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" id="stock-modal-title" style="font-size:20px;">Add Stock</div>
        <div class="subtitle" id="stock-modal-subtitle" style="margin-bottom:10px;">Pick a catalog part to track and set the starting quantity and location.</div>
        </div>
        <button class="btn ghost" id="close-stock-modal">Close</button>
      </div>
      <form id="stock-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:8px;">
        <input type="hidden" name="id" />
        <div style="grid-column: span 2;">
          <label class="small">Catalog item</label>
          <input id="stock-catalog-search" class="input" placeholder="Search catalog by name, vendor, or part number" />
          <div id="stock-catalog-selected" class="small" style="margin-top:6px;"></div>
          <div id="stock-catalog-results" class="tag-picker-options" style="display:none; margin-top:6px; max-height:200px; overflow:auto;"></div>
        </div>
        <div>
          <label class="small">Subteam</label>
          <select id="stock-subteam-select" class="input"></select>
        </div>
        <div>
          <label class="small">Quantity on hand</label>
          <input id="stock-quantity" class="input" type="number" min="0" value="0" />
        </div>
        <div>
          <label class="small">Low stock alert at</label>
          <input id="stock-low" class="input" type="number" min="0" placeholder="e.g., 5" />
        </div>
        <div>
          <label class="small">Location</label>
          <input id="stock-location" class="input" placeholder="Bay, drawer, bin" />
        </div>
        <div>
          <label class="small">Stock category (per location)</label>
          <input id="stock-category" class="input" placeholder="e.g., Fasteners, Raw Stock" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea id="stock-notes" class="input" rows="2" placeholder="Label, kit info, etc."></textarea>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="stock-modal-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="delete-stock-btn" style="display:none; color: var(--danger);">Untrack</button>
            <button type="button" class="btn ghost" id="cancel-stock">Cancel</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="stock-delete-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:64; align-items:center; justify-content:center; padding:16px;">
    <div class="tag-modal-card" style="max-width:420px; width:100%;">
      <div class="page-title" style="font-size:20px;">Untrack stock item</div>
      <div class="subtitle" style="margin-bottom:12px;">This will remove the item from live stock tracking.</div>
      <div id="stock-delete-message" class="small" style="margin-bottom:12px;">Are you sure you want to untrack this item?</div>
      <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
        <button class="btn ghost" id="cancel-delete-stock">Cancel</button>
        <button class="btn primary" id="confirm-delete-stock" style="background: var(--danger); border-color: var(--danger); color: #fff;">Untrack</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:70; align-items:center; justify-content:center; padding:16px;">
    <div class="tag-modal-card" style="max-width:420px; width:100%;">
      <div class="page-title" style="font-size:20px;">Confirm action</div>
      <div id="confirm-message" class="subtitle" style="margin-bottom:12px;">Are you sure?</div>
      <div id="confirm-status" class="small" style="margin-bottom:12px;"></div>
      <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
        <button class="btn ghost" id="confirm-cancel">Cancel</button>
        <button class="btn primary" id="confirm-ok" style="background: var(--danger); border-color: var(--danger); color: #fff;">Confirm</button>
      </div>
    </div>
  </div>

    <div id="stock-subteams-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:63; align-items:center; justify-content:center; padding:16px;">
      <div class="tag-modal-card">
        <div class="flex-between" style="align-items:flex-start;">
          <div>
          <div class="page-title" style="font-size:20px;">Stock locations</div>
          <div class="subtitle" style="margin-bottom:10px;">Control the location options used for stock filtering.</div>
          </div>
          <button class="btn ghost" id="close-subteams-modal">Close</button>
        </div>
      <form id="stock-subteam-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:6px;">
        <input type="hidden" name="id" />
        <div>
          <label class="small">Name</label>
          <input name="name" class="input" placeholder="e.g., Electrical, Drivetrain" required />
        </div>
        <div>
          <label class="small">Description</label>
          <input name="description" class="input" placeholder="Optional context" />
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="stock-subteam-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="clear-subteam-form">New</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </div>
      </form>
      <div id="stock-subteam-list" class="tag-manager-list" style="margin-top:10px;"></div>
    </div>
  </div>

      <div id="admin-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:60; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Admin Panel</div>
          <div class="subtitle" style="margin-bottom:12px;">Manage users and role permissions.</div>
        </div>
        <button class="btn ghost" id="close-admin">Close</button>
      </div>

        <div class="flex-between" style="margin-top:12px; gap:8px;">
        <div class="flex-between" style="gap:6px;">
          <button class="btn ghost" id="admin-tab-users" style="padding:6px 12px;">Users</button>
          <button class="btn ghost" id="admin-tab-roles" style="padding:6px 12px;">Roles</button>
          <button class="btn ghost" id="admin-tab-tracking" style="padding:6px 12px;">Tracking</button>
          <button class="btn ghost" id="admin-tab-vendors" style="padding:6px 12px;">Vendors</button>
        </div>
      </div>

      <div id="admin-users-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div class="page-title" style="font-size:18px;">Users</div>
            <button class="btn primary" id="new-user-btn" style="padding:6px 10px;">New user</button>
          </div>
          <div id="user-list" class="small" style="margin-top:8px;">Loading users...</div>
        </div>
      </div>

      <div id="admin-roles-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
          <div class="page-title" style="font-size:18px;">Role Permissions</div>
          <div class="subtitle">Toggle what each role can do.</div>
          <div id="role-list" style="margin-top:8px;"></div>
          <div id="role-message" class="small" style="margin-top:6px;"></div>
        </div>
      </div>

      <div id="admin-tracking-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
        <div class="page-title" style="font-size:18px;">Tracking Settings</div>
        <div class="subtitle">Carrier API keys, refresh cadence, and manual refresh.</div>
        <form id="tracking-settings-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:10px;">
          <div>
            <label class="small">UPS Client ID</label>
            <input name="upsClientId" class="input" placeholder="UPS OAuth client id" />
          </div>
          <div>
            <label class="small">UPS Client Secret</label>
            <input name="upsClientSecret" class="input" placeholder="UPS OAuth client secret" />
          </div>
          <div>
            <label class="small">USPS User ID</label>
            <input name="uspsUserId" class="input" placeholder="USPS WebTools user id" />
          </div>
          <div>
            <label class="small">FedEx Client ID</label>
            <input name="fedexClientId" class="input" placeholder="FedEx API key" />
          </div>
          <div>
            <label class="small">FedEx Client Secret</label>
            <input name="fedexClientSecret" class="input" placeholder="FedEx API secret" />
          </div>
          <div>
            <label class="small">Tracking Refresh Interval (minutes)</label>
            <input name="refreshMinutes" class="input" type="number" min="1" value="30" />
          </div>
        </form>
        <div class="flex-between" style="grid-column: span 2; margin-top:8px; flex-wrap:wrap; gap:8px;">
          <div id="tracking-settings-message" class="small"></div>
          <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn ghost" id="refresh-tracking-now">Manual refresh</button>
            <button type="submit" form="tracking-settings-form" class="btn primary">Save settings</button>
          </div>
        </div>
      </div>
      </div>

      <div id="admin-vendors-section" style="display:none;">
        <div class="card" style="background:var(--panel-2); margin-top:12px;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div>
              <div class="page-title" style="font-size:18px;">Vendor Extraction Settings</div>
              <div class="subtitle">Configure how to pull product details from each vendor.</div>
            </div>
            <button class="btn primary" id="new-vendor-btn" style="padding:6px 10px;">New vendor</button>
          </div>
          <div id="vendor-list" class="small" style="margin-top:10px;">Loading vendors...</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const boardEl = document.getElementById('board');
    const boardBtn = document.getElementById('board-view-btn');
    const tableBtn = document.getElementById('table-view-btn');
    const boardSection = document.getElementById('board-section');
    const tableSection = document.getElementById('table-section');
    const stockSection = document.getElementById('stock-section');
    const stockGrid = document.getElementById('stock-grid');
    const stockSubteamFilter = document.getElementById('stock-subteam-filter');
    const primaryTitle = document.getElementById('primary-title');
    const primarySubtitle = document.getElementById('primary-subtitle');
    const ordersViewBtn = document.getElementById('orders-view-btn');
    const stockViewBtn = document.getElementById('stock-view-btn');
    const ordersLayoutRow = document.getElementById('orders-layout-row');
    const ordersLayoutToggle = document.getElementById('orders-layout-toggle');
    const addStockBtn = document.getElementById('add-stock-btn');
    const manageSubteamsBtn = document.getElementById('manage-subteams-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const globalSearch = document.getElementById('global-search');
    const statusFilter = document.getElementById('status-filter');
    const vendorFilter = document.getElementById('vendor-filter');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const tableContainer = document.getElementById('table-container');
    const selectionBar = document.getElementById('selection-bar');
    const selectionCount = document.getElementById('selection-count');
    const groupBtn = document.getElementById('group-btn');
    const addToOrderBtn = document.getElementById('add-to-order-btn');
    const groupVendorNote = document.getElementById('group-vendor-note');
    const deleteSelectedBtn = document.getElementById('delete-selected');
    const selectSameVendorBtn = document.getElementById('select-same-vendor-btn');
    const selectAllBtn = document.getElementById('select-all-btn');
    const unselectAllBtn = document.getElementById('unselect-all-btn');
    const undoBtn = document.createElement('button');
    undoBtn.className = 'btn ghost';
    undoBtn.id = 'undo-btn';
    undoBtn.textContent = 'Undo';
    const redoBtn = document.createElement('button');
    redoBtn.className = 'btn ghost';
    redoBtn.id = 'redo-btn';
    redoBtn.textContent = 'Redo';
    const selectionControls = selectionBar.querySelector('.selection-actions');
    if (selectionControls) {
      selectionControls.appendChild(undoBtn);
      selectionControls.appendChild(redoBtn);
    }
    const boardMessage = document.createElement('div');
    boardMessage.id = 'board-message';
    boardMessage.style.position = 'fixed';
    boardMessage.style.right = '16px';
    boardMessage.style.bottom = '16px';
    boardMessage.style.background = 'var(--panel)';
    boardMessage.style.border = '1px solid var(--border)';
    boardMessage.style.padding = '10px 14px';
    boardMessage.style.borderRadius = '10px';
    boardMessage.style.boxShadow = 'var(--card-shadow)';
    boardMessage.style.display = 'none';
    boardMessage.style.zIndex = '80';
    document.body.appendChild(boardMessage);
    const modal = document.getElementById('modal');
    const cancelOrder = document.getElementById('cancel-order');
    const orderForm = document.getElementById('order-form');
    const orderTrackingList = document.getElementById('order-tracking-list');
    const addOrderTracking = document.getElementById('add-order-tracking');
    const orderMessage = document.getElementById('order-message');
    const fetchProduct = document.getElementById('fetch-product');
    const newOrderBtn = document.getElementById('new-order-btn');
    const tagSelect = document.getElementById('order-tags');
    const tagPickerDisplay = document.getElementById('tag-picker-display');
    const tagPickerPanel = document.getElementById('tag-picker-panel');
    const tagPickerOptions = document.getElementById('tag-picker-options');
    const tagPickerSearch = document.getElementById('tag-picker-search');
    const tagPicker = document.getElementById('tag-picker');
    const refreshTagsBtn = document.getElementById('refresh-tags');
    const tagsList = document.getElementById('tags-list');
    const tagsMessage = document.getElementById('tags-message');
    const tagLabelInput = document.getElementById('tag-label-input');
    const tagColorInput = document.getElementById('tag-color-input');
    const createTagForm = document.getElementById('create-tag-form');
    const adminBtn = document.getElementById('admin-btn');
    const adminModal = document.getElementById('admin-modal');
    const closeAdmin = document.getElementById('close-admin');
    const accountBtn = document.getElementById('account-btn');
    const accountModal = document.getElementById('account-modal');
    const groupModal = document.getElementById('group-modal');
    const closeGroup = document.getElementById('close-group');
    const cancelGroup = document.getElementById('cancel-group');
    const groupForm = document.getElementById('group-form');
    const groupModalTrackingList = document.getElementById('group-modal-tracking-list');
    const addGroupModalTracking = document.getElementById('add-group-modal-tracking');
    const groupMessage = document.getElementById('group-message');
    const vendorForm = document.getElementById('vendor-form');
    const vendorMessage = document.getElementById('vendor-message');
    const vendorList = document.getElementById('vendor-list');
    const testUrl = document.getElementById('test-url');
    const vendorModal = document.getElementById('vendor-modal');
    const newVendorBtn = document.getElementById('new-vendor-btn');
    const closeVendorModalBtn = document.getElementById('close-vendor-modal');
    const cancelVendorBtn = document.getElementById('cancel-vendor');
    function resizeColumns() {
      window.requestAnimationFrame(() => {
        const main = document.querySelector('main');
        if (!main) return;
        const viewportH = document.documentElement.clientHeight;
        const mainRect = main.getBoundingClientRect();
        const padding = 24;
        const baseAvailable = Math.max(0, viewportH - mainRect.top - padding);
        if (boardSection) {
          const top = boardSection.getBoundingClientRect().top - mainRect.top;
          const available = Math.max(0, baseAvailable - top);
          if (available > 240) {
            boardSection.style.height = `${available}px`;
            boardSection.style.maxHeight = `${available}px`;
          }
        }
        if (tableSection) {
          const top = tableSection.getBoundingClientRect().top - mainRect.top;
          const available = Math.max(0, baseAvailable - top);
          if (available > 240) {
            tableSection.style.height = `${available}px`;
            tableSection.style.maxHeight = `${available}px`;
            const filtersEl = tableSection.querySelector('.filters');
            const filtersH = filtersEl ? filtersEl.getBoundingClientRect().height : 0;
            const tableAvail = available - filtersH - 24;
            if (tableContainer && tableAvail > 120) {
              tableContainer.style.height = `${tableAvail}px`;
              tableContainer.style.maxHeight = `${tableAvail}px`;
            }
          }
        }
        if (stockSection) {
          const top = stockSection.getBoundingClientRect().top - mainRect.top;
          const available = Math.max(0, baseAvailable - top);
          if (available > 240) {
            stockSection.style.height = `${available}px`;
            stockSection.style.maxHeight = `${available}px`;
            if (stockGrid) {
              stockGrid.style.maxHeight = `${available - 40}px`;
            }
          }
        }
      });
    }
    window.addEventListener('resize', resizeColumns);
    // Initial sizing after DOM paints
    setTimeout(resizeColumns, 0);
    const testExtract = document.getElementById('test-extract');
    const pickName = document.getElementById('pick-name');
    const pickPrice = document.getElementById('pick-price');
    const previewName = document.getElementById('preview-name');
    const previewPrice = document.getElementById('preview-price');
    const selectorSnippet = document.getElementById('selector-snippet');
    const selectorTarget = document.getElementById('selector-target');
    const applySelector = document.getElementById('apply-selector');
    const partExample = vendorForm.elements.partNumberExample;
    const partPattern = vendorForm.elements.partNumberPattern;
    let editingOrderId = null;
    let editingGroupId = null;
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('login-form');
    const loginMessage = document.getElementById('login-message');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userChip = document.getElementById('user-chip');
    const userList = document.getElementById('user-list');
    const userForm = document.getElementById('user-form');
    const userMessage = document.getElementById('user-message');
    const saveUserBtn = document.getElementById('save-user-btn');
    const newUserBtn = document.getElementById('new-user-btn');
    const userModal = document.getElementById('user-modal');
    const closeUserModalBtn = document.getElementById('close-user-modal');
    const cancelUserBtn = document.getElementById('cancel-user');
    const passwordForm = document.getElementById('password-form');
    const passwordMessage = document.getElementById('password-message');
    const roleList = document.getElementById('role-list');
    const roleMessage = document.getElementById('role-message');
    const trackingSettingsForm = document.getElementById('tracking-settings-form');
    const trackingSettingsMessage = document.getElementById('tracking-settings-message');
    const refreshTrackingNow = document.getElementById('refresh-tracking-now');
    const adminTabUsers = document.getElementById('admin-tab-users');
    const adminTabRoles = document.getElementById('admin-tab-roles');
    const adminTabTracking = document.getElementById('admin-tab-tracking');
    const adminTabVendors = document.getElementById('admin-tab-vendors');
    const adminUsersSection = document.getElementById('admin-users-section');
    const adminRolesSection = document.getElementById('admin-roles-section');
    const adminTrackingSection = document.getElementById('admin-tracking-section');
    const adminVendorsSection = document.getElementById('admin-vendors-section');
    const catalogModal = document.getElementById('catalog-modal');
    const closeCatalog = document.getElementById('close-catalog');
    const catalogBtn = document.getElementById('catalog-btn');
    const catalogNewCategoryBtn = document.getElementById('catalog-new-category');
    const catalogCategoryNewModal = document.getElementById('catalog-category-new-modal');
    const catalogCategoryNewForm = document.getElementById('catalog-category-new-form');
    const catalogCategoryNewMessage = document.getElementById('catalog-category-new-message');
    const catalogCategoryNewPath = document.getElementById('catalog-category-new-path');
    const catalogCategoryNewCancel = document.getElementById('catalog-category-new-cancel');
    const catalogCategoryEditModal = document.getElementById('catalog-category-edit-modal');
    const catalogCategoryEditForm = document.getElementById('catalog-category-edit-form');
    const catalogCategoryEditMessage = document.getElementById('catalog-category-edit-message');
    const catalogCategoryEditPath = document.getElementById('catalog-category-edit-path');
    const catalogCategoryEditCancel = document.getElementById('catalog-category-edit-cancel');
    const tagsBtn = document.getElementById('tags-btn');
    const tagsModal = document.getElementById('tags-modal');
    const closeTags = document.getElementById('close-tags');
    const tagsTabTags = document.getElementById('tags-tab-tags');
    const tagsTabPriorities = document.getElementById('tags-tab-priorities');
    const tagsSection = document.getElementById('tags-section');
    const prioritiesSection = document.getElementById('priorities-section');
    const catalogRequestModal = document.getElementById('catalog-request-modal');
    const cancelCatalogRequest = document.getElementById('cancel-catalog-request');
    const confirmCatalogRequest = document.getElementById('confirm-catalog-request');
    const catalogRequestQty = document.getElementById('catalog-request-qty');
    const catalogRequestPriority = document.getElementById('catalog-request-priority');
    const catalogRequestTags = document.getElementById('catalog-request-tags');
    const catalogRequestTagPicker = document.getElementById('catalog-request-tag-picker');
    const catalogRequestTagPickerDisplay = document.getElementById('catalog-request-tag-picker-display');
    const catalogRequestTagPickerPanel = document.getElementById('catalog-request-tag-picker-panel');
    const catalogRequestTagPickerOptions = document.getElementById('catalog-request-tag-picker-options');
    const catalogRequestTagPickerSearch = document.getElementById('catalog-request-tag-picker-search');
    const catalogRequestNotes = document.getElementById('catalog-request-notes');
    const catalogRequestMessage = document.getElementById('catalog-request-message');
    const catalogRequestSubtitle = document.getElementById('catalog-request-subtitle');
    const stockModal = document.getElementById('stock-modal');
    const stockForm = document.getElementById('stock-form');
    const stockCatalogSearch = document.getElementById('stock-catalog-search');
    const stockCatalogResults = document.getElementById('stock-catalog-results');
    const stockCatalogSelected = document.getElementById('stock-catalog-selected');
    const stockModalMessage = document.getElementById('stock-modal-message');
    const stockModalTitle = document.getElementById('stock-modal-title');
    const stockModalSubtitle = document.getElementById('stock-modal-subtitle');
    const deleteStockBtn = document.getElementById('delete-stock-btn');
    const cancelStockBtn = document.getElementById('cancel-stock');
    const closeStockModalBtn = document.getElementById('close-stock-modal');
    const stockSubteamSelect = document.getElementById('stock-subteam-select');
    const stockQuantityInput = document.getElementById('stock-quantity');
    const stockLowInput = document.getElementById('stock-low');
    const stockLocationInput = document.getElementById('stock-location');
    const stockCategoryInput = document.getElementById('stock-category');
    const stockNotesInput = document.getElementById('stock-notes');
    const stockSubteamsModal = document.getElementById('stock-subteams-modal');
    const stockSubteamForm = document.getElementById('stock-subteam-form');
    const stockSubteamList = document.getElementById('stock-subteam-list');
    const stockSubteamMessage = document.getElementById('stock-subteam-message');
    const clearSubteamFormBtn = document.getElementById('clear-subteam-form');
    const closeSubteamsModal = document.getElementById('close-subteams-modal');
    const stockDeleteModal = document.getElementById('stock-delete-modal');
    const stockDeleteMessage = document.getElementById('stock-delete-message');
    const cancelDeleteStock = document.getElementById('cancel-delete-stock');
    const confirmDeleteStock = document.getElementById('confirm-delete-stock');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmStatus = document.getElementById('confirm-status');
    const confirmCancel = document.getElementById('confirm-cancel');
    const confirmOk = document.getElementById('confirm-ok');
    const catalogBackBtn = document.getElementById('catalog-back');
    const catalogCategoryList = document.getElementById('catalog-category-list');
    const catalogPathDisplay = document.getElementById('catalog-path-display');
    const refreshPrioritiesBtn = document.getElementById('refresh-priorities');
    const prioritiesList = document.getElementById('priorities-list');
    const prioritiesMessage = document.getElementById('priorities-message');
    const priorityLabelInput = document.getElementById('priority-label-input');
    const priorityColorInput = document.getElementById('priority-color-input');
    const prioritySortInput = document.getElementById('priority-sort-input');
    const createPriorityForm = document.getElementById('create-priority-form');
    const orderSourceManual = document.getElementById('order-source-manual');
    const orderSourceCatalog = document.getElementById('order-source-catalog');
    const orderManualFields = document.querySelectorAll('.order-manual-fields');
    const orderCatalogFields = document.querySelectorAll('.order-catalog-fields');
    const catalogLookupInput = document.getElementById('catalog-lookup');
    const catalogLookupResults = document.getElementById('catalog-lookup-results');
    const catalogLookupSelected = document.getElementById('catalog-lookup-selected');
    const catalogSaveContainer = document.getElementById('catalog-save-container');
    const catalogSaveFields = document.getElementById('catalog-save-fields');
    const saveToCatalogToggle = document.getElementById('save-to-catalog-toggle');
    const catalogSaveCategory = document.getElementById('catalog-save-category');
    const catalogSaveSubteam = document.getElementById('catalog-save-subteam');
    const catalogSaveType = document.getElementById('catalog-save-type');
    const catalogSaveMessage = document.getElementById('catalog-save-message');
    const catalogSaveStatus = document.getElementById('catalog-save-status');
    const refreshCatalogCategoriesBtn = document.getElementById('refresh-catalog-categories');
    const catalogItemSearch = document.getElementById('catalog-item-search');
    const refreshCatalogItemsBtn = document.getElementById('refresh-catalog-items');
    const newCatalogItemBtn = document.getElementById('new-catalog-item');
    const catalogItemList = document.getElementById('catalog-item-list');
    const catalogItemForm = document.getElementById('catalog-item-form');
    const catalogItemMessage = document.getElementById('catalog-item-message');
    const fetchCatalogProductBtn = document.getElementById('fetch-catalog-product');
    const deleteCatalogItemBtn = document.getElementById('delete-catalog-item');
    const cancelCatalogItemBtn = document.getElementById('cancel-catalog-item');
    const catalogItemHint = document.getElementById('catalog-item-hint');
    const catalogItemModal = document.getElementById('catalog-item-modal');
    const catalogItemModalHint = document.getElementById('catalog-item-modal-hint');
    let activeAdminTab = null;
    const ROLE_DEFAULT_PERMS = {
      admin: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: true, canManageTags: true, canEditInventoryCatalog: true, canManageStock: true, canEditStock: true },
      mentor: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: false, canManageTags: true, canEditInventoryCatalog: true, canManageStock: true, canEditStock: true },
      student: { canPlaceOrders: true, canMoveOrders: false, canEditOrders: false, canDeleteOrders: false, canManageVendors: false, canManageUsers: false, canManageTags: false, canEditInventoryCatalog: false, canManageStock: false, canEditStock: false }
    };
    function computePerms(user) {
      const role = (user?.role || 'student').toLowerCase();
      const defaults = ROLE_DEFAULT_PERMS[role] || ROLE_DEFAULT_PERMS.student;
      const provided = user?.permissions || {};
      // Only fill missing keys with defaults; honor server-provided permissions
      const merged = { ...defaults };
      Object.keys(provided).forEach(k => { merged[k] = provided[k]; });
      return merged;
    }
    let vendorConfigs = [];
    let currentUser = null;
    function detectVendor(partNum, link) {
      if (!vendorConfigs?.length) return null;
      const candidates = vendorConfigs.filter(v => {
        const regex = v.partNumberPattern ? new RegExp(v.partNumberPattern, 'i') : null;
        const baseMatch = v.baseUrl && link && link.toLowerCase().includes(v.baseUrl.toLowerCase());
        const patternMatch = regex && partNum && regex.test(partNum);
        return baseMatch || patternMatch;
      });
      if (candidates.length === 1) return candidates[0];
      return null;
    }

    function renderVendorOptions() {
      const supported = vendorConfigs.map(v => v.vendor).filter(Boolean);
      const msg = supported.length
        ? `Supported vendors: ${supported.join(', ')}, Shopify-Based Sites`
        : 'Supported vendors: none configured yet; use manual entry';
      const fetchSupportedEl = document.getElementById('fetch-supported');
      const fetchSupportedCatalogEl = document.getElementById('fetch-supported-catalog');
      if (fetchSupportedEl) fetchSupportedEl.textContent = msg;
      if (fetchSupportedCatalogEl) fetchSupportedCatalogEl.textContent = msg;
    }

    function setOrderSource(source) {
      orderSource = source === 'catalog' ? 'catalog' : 'manual';
      if (orderSourceManual) orderSourceManual.classList.toggle('primary', orderSource === 'manual');
      if (orderSourceCatalog) orderSourceCatalog.classList.toggle('primary', orderSource === 'catalog');
      orderManualFields?.forEach(el => { if (el) el.style.display = orderSource === 'manual' ? '' : 'none'; });
      orderCatalogFields?.forEach(el => { if (el) el.style.display = orderSource === 'catalog' ? '' : 'none'; });
      if (orderSource === 'manual') {
        resetCatalogLookup();
        scheduleCatalogPresenceCheck();
      } else {
        if (catalogLookupInput) catalogLookupInput.focus();
      }
    }

    orderSourceManual?.addEventListener('click', () => setOrderSource('manual'));
    orderSourceCatalog?.addEventListener('click', () => setOrderSource('catalog'));

    const statuses = [
      { label: 'To order', status: 'Requested', hint: 'Parts requests - awaiting purchase' },
      { label: 'Ordered', status: 'Ordered', hint: 'Placed orders - awaiting arrival' },
      { label: 'Arrived', status: 'Received', hint: 'Items received' }
    ];
    const getOrderTimestamp = (order) => {
      if (!order) return 0;
      const raw = order.requestedDisplayAt || order.requestedAt || Date.parse(order.createdAt || '') || 0;
      const num = Number(raw);
      return Number.isFinite(num) ? num : 0;
    };
    const getGroupTimestamp = (ordersInGroup = []) => {
      const first = ordersInGroup[0];
      if (!first) return 0;
      const raw = first.group?.requestedDisplayAt || first.group?.createdAt || getOrderTimestamp(first);
      const num = Number(raw);
      return Number.isFinite(num) ? num : 0;
    };
    const carrierOptions = [
      { value: 'ups', label: 'UPS' },
      { value: 'usps', label: 'USPS' },
      { value: 'fedex', label: 'FedEx' },
      { value: 'other', label: 'Other/Unknown' }
    ];

    const DEFAULT_TRACKING_POLL_MINUTES = 1;
    let trackingPollTimer = null;
    let trackingPollMinutes = DEFAULT_TRACKING_POLL_MINUTES;
    function startTrackingAutoRefresh(minutes = trackingPollMinutes) {
      const next = Math.max(1, Number(minutes) || DEFAULT_TRACKING_POLL_MINUTES);
      trackingPollMinutes = next;
      const ms = next * 60 * 1000;
      if (trackingPollTimer) clearInterval(trackingPollTimer);
      trackingPollTimer = setInterval(() => {
        if (!currentUser) return;
        fetchOrders();
      }, ms);
    }

    const emptyParts = [];
    setTrackingRows(orderTrackingList, [], emptyParts);
    setTrackingRows(groupModalTrackingList, [], emptyParts);
    addOrderTracking?.addEventListener('click', () => createTrackingRow(orderTrackingList, {}, emptyParts));
    addGroupModalTracking?.addEventListener('click', () => createTrackingRow(groupModalTrackingList, {}, emptyParts));

    let orders = [];
    let selected = new Set();
    let expandedGroups = new Set();
    const undoStack = [];
    const redoStack = [];
    let tagList = [];
    let priorityList = [];
    let catalogCategories = [];
    let catalogTree = [];
    let catalogItems = [];
    let catalogLookupMatches = [];
    let selectedCatalogMatch = null;
    let selectedCatalogCategoryId = null;
    let selectedCatalogItemId = null;
    let orderSource = 'manual';
    let catalogAlreadySaved = false;
    let catalogAlreadySavedItem = null;
    let catalogPresenceTimer = null;
    let catalogLookupTimer = null;
    let catalogItemSearchTimer = null;
    let activeTagsTab = 'tags';
    let pendingCatalogRequest = null;
    const defaultPriorityLabel = () => {
      const list = priorityList && priorityList.length ? priorityList : defaultPriorities;
      return list.length ? list[0].label : 'Medium';
    };
    const defaultPriorities = [
      { label: 'Low', color: '#5aa0ff', sortOrder: 1 },
      { label: 'Medium', color: '#fdd023', sortOrder: 2 },
      { label: 'High', color: '#ff8b55', sortOrder: 3 },
      { label: 'Urgent', color: '#ff5565', sortOrder: 4 }
    ];
    let catalogNavStack = [];
    let currentCatalogCategoryId = 'root';
    let stockItems = [];
    let stockSubteams = [];
    let selectedStockSubteam = 'all';
    let activePrimaryView = 'orders';
    let selectedStockCatalogItem = null;
    let stockCatalogSearchTimer = null;
    let stockSearchTimer = null;
    let pendingDeleteStockId = null;
    let pendingConfirmAction = null;
    let addToOrderMode = false;
    let addToOrderVendor = null;
    orderSourceManual?.addEventListener('click', () => setOrderSource('manual'));
    orderSourceCatalog?.addEventListener('click', () => setOrderSource('catalog'));
    setOrderSource('manual');

    function updateSearchPlaceholder() {
      if (!globalSearch) return;
      globalSearch.placeholder = activePrimaryView === 'stock'
        ? 'Search stock...'
        : 'Search parts, suppliers, users...';
    }

    function updateUndoRedoUI() {
      if (undoBtn) undoBtn.disabled = undoStack.length === 0;
      if (redoBtn) redoBtn.disabled = redoStack.length === 0;
    }

    function recordAction(record) {
      undoStack.push(record);
      redoStack.length = 0;
      updateUndoRedoUI();
    }

    async function approveOrder(id, status = 'approved') {
      await fetch(`/api/orders/${id}/approval`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ approvalStatus: status })
      });
    }
    function getOrderById(id) {
      return orders.find(o => o._id === id);
    }
    function getOrderVendor(order) {
      return (order?.supplier || order?.vendor || '').toLowerCase();
    }
    function snapshotOrder(id) {
      return orders.find(o => o._id === id);
    }
    function sanitizeOrderForCreate(order) {
      if (!order) return null;
      const allowed = [
        'category','csvFileLink','department','fetchedName','fetchedPrice','groupId','justification','notes',
        'partCode','partId','partLink','partName','priority','productCode','quantityRequested','status','studentId',
        'studentName','supplier','supplierLink','totalCost','tracking','trackingNumber','unitCost','vendor','vendorPartNumber','requestedDisplayAt',
        'approvalStatus','approvedBy','approvedAt','tags'
      ];
      const clean = {};
      allowed.forEach(k => {
        if (order[k] !== undefined) clean[k] = order[k];
      });
      if (order.requestedAt && !clean.requestedDisplayAt) clean.requestedDisplayAt = order.requestedAt;
      if (Array.isArray(clean.tracking)) {
        clean.tracking = clean.tracking.map(t => {
          const { carrier, trackingNumber, status, eta, trackingUrl, lastCheckedAt, lastUpdated, lastEvent, delivered } = t || {};
          if (!trackingNumber) return null;
          return { carrier: carrier || 'other', trackingNumber, status, eta, trackingUrl, lastCheckedAt, lastUpdated, lastEvent, delivered };
        }).filter(Boolean);
      }
      clean.quantityRequested = Number(clean.quantityRequested || 1);
      clean.unitCost = clean.unitCost !== undefined ? Number(clean.unitCost) : clean.unitCost;
      clean.totalCost = clean.totalCost !== undefined ? Number(clean.totalCost) : clean.totalCost;
      if (!clean.partName) clean.partName = 'Restored order';
      clean.studentName = clean.studentName || 'Restored';
      clean.status = clean.status || 'Requested';
      return clean;
    }

    async function applyStep(step, counterpart) {
      switch (step.type) {
        case 'deleteOrder': {
          await fetch(`/api/orders/${step.payload.orderId}`, { method: 'DELETE' });
          break;
        }
        case 'restoreOrder': {
          const o = sanitizeOrderForCreate(step.payload.order);
          if (!o) break;
          if (step.payload.order?.requestedDisplayAt || step.payload.order?.requestedAt) {
            o.requestedDisplayAt = step.payload.order.requestedDisplayAt || step.payload.order.requestedAt;
          }
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...o,
              groupId: undefined // will reassign after
            })
          });
          const data = await res.json();
          const newId = data.order?.orderId || data.orderId || data.order?._id;
          if (step.payload.groupId && newId) {
            await assignGroup(newId, step.payload.groupId);
          }
          if (counterpart && counterpart.type === 'deleteOrder') {
            counterpart.payload.orderId = newId;
          }
          break;
        }
        case 'updateOrder': {
          await fetch(`/api/orders/${step.payload.orderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(step.payload.data)
          });
          break;
        }
        case 'updateStatus': {
          await patchStatusOnly(step.payload.orderId, step.payload.status, step.payload.trackingNumber);
          if (step.payload.groupId !== undefined) {
            await assignGroup(step.payload.orderId, step.payload.groupId);
          }
          break;
        }
        case 'bulkStatus': {
          if (Array.isArray(step.payload?.entries)) {
            for (const entry of step.payload.entries) {
              await patchStatusOnly(entry.orderId, entry.status, entry.trackingNumber);
              if (entry.groupId !== undefined) {
                await assignGroup(entry.orderId, entry.groupId);
              }
            }
          }
          break;
        }
        case 'assignGroup': {
          await assignGroup(step.payload.orderId, step.payload.groupId);
          break;
        }
    case 'createGroup': {
      const res = await fetch('/api/order-groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: step.payload.title,
          supplier: step.payload.supplier,
          requestedDisplayAt: step.payload.requestedDisplayAt,
          orderIds: step.payload.orderIds
        })
      });
          const data = await res.json();
          const newGroupId = data.groupId || data._id;
          if (counterpart && counterpart.type === 'deleteGroup') {
            counterpart.payload.groupId = newGroupId;
          }
          break;
        }
        case 'deleteGroup': {
          await fetch(`/api/order-groups/${step.payload.groupId}`, { method: 'DELETE' });
          break;
        }
        case 'updateGroup': {
          await fetch(`/api/order-groups/${step.payload.groupId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(step.payload.data)
          });
          break;
        }
        default:
          break;
      }
    }

    async function doUndo() {
      const record = undoStack.pop();
      if (!record) return;
      await applyStep(record.undo, record.redo);
      redoStack.push(record);
      updateUndoRedoUI();
      await fetchOrders();
    }

    async function doRedo() {
      const record = redoStack.pop();
      if (!record) return;
      await applyStep(record.redo, record.undo);
      undoStack.push(record);
      updateUndoRedoUI();
      await fetchOrders();
    }

    function fmtDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleString();
    }
    function formatShortDate(date = new Date()) {
      return `${date.getMonth() + 1}/${date.getDate()}/${String(date.getFullYear()).slice(-2)}`;
    }
    function formatTimeShort(date = new Date()) {
      return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    function formatDateOnly(input) {
      if (!input) return '';
      // If we get an ISO-ish string, parse the date portion explicitly to avoid TZ shifts.
      if (typeof input === 'string') {
        const match = input.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          const y = Number(match[1]);
          const m = Number(match[2]);
          const d = Number(match[3]);
          if (y && m && d) return `${m}/${d}/${String(y).slice(-2)}`;
        }
      }
      const date = new Date(input);
      if (Number.isNaN(date.getTime())) return '';
      // Use UTC components to avoid local TZ shifting ETA dates.
      const m = date.getUTCMonth() + 1;
      const d = date.getUTCDate();
      const y = String(date.getUTCFullYear()).slice(-2);
      return `${m}/${d}/${y}`;
    }
    function formatDateMaybe(value) {
      if (!value) return '';
      if (typeof value === 'number') return formatDateOnly(value);
      const parsed = Date.parse(value);
      if (!Number.isNaN(parsed)) return formatDateOnly(parsed);
      return value;
    }
    function getTagLabel(id) {
      const t = tagList.find(t => String(t._id || t.id || t.label) === String(id));
      return t ? t.label : id;
    }
    function getTagColor(id) {
      const t = tagList.find(t => String(t._id || t.id || t.label) === String(id));
      return t ? (t.color || '#fdd023') : '#fdd023';
    }
    function getPriorityColor(label) {
      const p = priorityList.find(p => (p.label || '').toLowerCase() === (label || '').toLowerCase());
      return p ? (p.color || '#fdd023') : '#fdd023';
    }
    function renderTagChips(ids = []) {
      if (!ids || !ids.length) return '';
      return ids.map(tid => {
        const label = getTagLabel(tid);
        const color = getTagColor(tid);
        return `<span class="tag" style="background:${color}22; border-color:${color}; color:${color};">${escapeHtml(label)}</span>`;
      }).join('');
    }
    function getSelectedTagIds() {
      if (!tagSelect) return [];
      return Array.from(tagSelect.selectedOptions || []).map(o => o.value);
    }
    function escapeHtml(str = '') {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function createTrackingRow(container, data = {}, partsOptions = []) {
      if (!container) return;
      const row = document.createElement('div');
      row.className = 'tracking-row';
      row.innerHTML = `
        <select class="input tracking-carrier">
          ${carrierOptions.map(c => `<option value="${c.value}">${c.label}</option>`).join('')}
        </select>
        <input class="input tracking-number" placeholder="Tracking number" value="${data.trackingNumber || data.number || ''}" />
        <button type="button" class="btn ghost remove-tracking" style="padding:6px 10px;">Remove</button>
        <div class="small" style="width:100%;">Parts in this shipment (optional)</div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px; width:100%;">
          <select class="input tracking-parts" multiple size="${Math.min(Math.max(partsOptions.length, 2), 6)}">
            ${partsOptions.map(p => `<option value="${p.id}">${escapeHtml(p.label)}</option>`).join('')}
          </select>
          <button type="button" class="btn ghost select-all-parts" style="padding:6px 10px;">Select all</button>
        </div>
      `;
      const select = row.querySelector('.tracking-carrier');
      const carrier = (data.carrier || '').toLowerCase();
      if (carrier) select.value = carrier;
      row.querySelector('.remove-tracking').addEventListener('click', () => {
        row.remove();
        if (!container.querySelector('.tracking-row')) {
          createTrackingRow(container, {}, partsOptions);
        }
      });
      const partsSelect = row.querySelector('.tracking-parts');
      const selectAllBtn = row.querySelector('.select-all-parts');
      if (partsSelect && Array.isArray(data.parts)) {
        Array.from(partsSelect.options).forEach(opt => {
          if (data.parts.includes(opt.value)) opt.selected = true;
        });
      }
      selectAllBtn?.addEventListener('click', () => {
        Array.from(partsSelect.options).forEach(opt => { opt.selected = true; });
      });
      container.appendChild(row);
    }

    function setTrackingRows(container, entries = [], partsOptions = []) {
      if (!container) return;
      container.innerHTML = '';
      const list = Array.isArray(entries) && entries.length ? entries : [];
      if (!list.length) {
        createTrackingRow(container, {}, partsOptions);
        return;
      }
      list.forEach(entry => createTrackingRow(container, entry, partsOptions));
    }

    function collectTrackingRows(container) {
      if (!container) return [];
      const rows = Array.from(container.querySelectorAll('.tracking-row'));
      return rows.map(row => {
        const number = row.querySelector('.tracking-number')?.value.trim();
        const carrier = row.querySelector('.tracking-carrier')?.value || 'other';
        if (!number) return null;
        const partsSel = row.querySelector('.tracking-parts');
        const parts = partsSel ? Array.from(partsSel.selectedOptions).map(o => o.value) : undefined;
        return { carrier, trackingNumber: number, parts: parts && parts.length ? parts : undefined };
      }).filter(Boolean);
    }

    function trackingFromOrder(order) {
      if (!order) return [];
      if (Array.isArray(order.tracking) && order.tracking.length) return order.tracking;
      if (order.trackingNumber) return [{ carrier: order.carrier || 'unknown', trackingNumber: order.trackingNumber }];
      return [];
    }

    function trackingLink(carrier, num, fallback) {
      if (fallback) return fallback;
      if (!num) return '';
      const c = (carrier || '').toLowerCase();
      if (c === 'ups') return `https://www.ups.com/track?tracknum=${encodeURIComponent(num)}`;
      if (c === 'usps') return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${encodeURIComponent(num)}`;
      if (c === 'fedex') return `https://www.fedex.com/fedextrack/?tracknumbers=${encodeURIComponent(num)}`;
      return '';
    }

    function attachBackdropClose(el, handler) {
      if (!el || typeof handler !== 'function') return;
      let downOnBackdrop = false;
      el.addEventListener('pointerdown', (e) => {
        downOnBackdrop = e.target === el;
      });
      el.addEventListener('pointerup', (e) => {
        if (downOnBackdrop && e.target === el) handler();
        downOnBackdrop = false;
      });
    }

    function trackingPhase(tracking) {
      const carrierSupported = ['ups','usps','fedex'].includes((tracking.carrier || '').toLowerCase());
      if (tracking.delivered || tracking.cache?.delivered) return 'delivered';
      const statusText = (tracking.status || tracking.cache?.status || tracking.cache?.summary || '').toLowerCase();
      if (!carrierSupported) return 'unknown';
      if (/label|pending|ready for shipment|not shipped|waiting|created/i.test(statusText)) return 'pending';
      return 'intransit';
    }

    function renderTrackingBadges(tracking = []) {
      const list = Array.isArray(tracking) ? tracking.filter(t => t && t.trackingNumber) : [];
      if (!list.length) return '';
      return `<div class="tracking-badges">${
        list.map(t => {
          const url = trackingLink(t.carrier, t.trackingNumber, t.trackingUrl || t.cache?.trackingUrl);
          const label = `${(t.carrier || 'TRACK').toUpperCase()} ${t.trackingNumber}`;
          const status = t.cache?.status || t.cache?.summary || t.status || '';
          const delivered = Boolean(t.cache?.delivered);
          const deliveredOn = delivered
            ? (t.cache?.lastEventTime || t.cache?.deliveredTime || t.deliveredTime || t.lastUpdated || t.lastEvent || t.lastUpdatedAt || t.lastCheckedAt || t.cache?.lastCheckedAt)
            : undefined;
          const etaText = !delivered ? (t.cache?.eta || t.eta) : undefined;
          const subtitleParts = [];
          if (delivered) {
            subtitleParts.push(`Delivered${deliveredOn ? ' on ' + formatDateOnly(deliveredOn) : ''}`);
          } else if (etaText) {
            const etaFmt = formatDateMaybe(etaText);
            subtitleParts.push(`ETA ${etaFmt || etaText}`);
          } else if (status) {
            subtitleParts.push(status);
          } else {
            subtitleParts.push('Refreshing status…');
          }
          const subtitle = subtitleParts.filter(Boolean).join(' · ');
          const safeSubtitle = escapeHtml(subtitle || '');
          const safeLabel = escapeHtml(label || '');
          const phase = trackingPhase(t);
          const badge = `<span class="tag tracking ${phase}" title="${safeSubtitle || 'Open tracking'}">${safeLabel}${subtitle ? ' · ' + safeSubtitle : ''}</span>`;
          return url ? `<a href="${url}" target="_blank" rel="noopener noreferrer">${badge}</a>` : badge;
        }).join('')
      }</div>`;
    }
    function showBoardMessage(text, type = 'info', timeout = 3500) {
      boardMessage.textContent = text;
      boardMessage.style.borderColor = type === 'error' ? 'var(--danger)' : 'var(--border)';
      boardMessage.style.color = type === 'error' ? 'var(--danger)' : 'var(--text)';
      boardMessage.style.display = 'block';
      if (showBoardMessage._t) clearTimeout(showBoardMessage._t);
      showBoardMessage._t = setTimeout(() => { boardMessage.style.display = 'none'; }, timeout);
    }

    function matchesSearch(order, term) {
      if (!term) return true;
      const trackingText = (order.tracking || []).map(t => [t.trackingNumber, t.carrier, t.cache?.status, t.cache?.summary].filter(Boolean).join(' ')).join(' ');
      const groupTrackingText = (order.group?.tracking || []).map(t => [t.trackingNumber, t.carrier, t.cache?.status, t.cache?.summary].filter(Boolean).join(' ')).join(' ');
      const hay = [
        order.partName,
        order.vendorPartNumber,
        order.partLink,
        order.studentName,
        order.supplier,
        order.productCode,
        order.orderNumber,
        order.category,
        order.priority,
        order.group && order.group.title,
        order.group && order.group.trackingNumber,
        trackingText,
        groupTrackingText
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(term.toLowerCase());
    }

    function withinDate(order, start, end) {
      if (!start && !end) return true;
      const ts = order.requestedDisplayAt || order.requestedAt || Date.parse(order.createdAt || '') || 0;
      if (start && ts < start) return false;
      if (end && ts > end) return false;
      return true;
    }

    function filteredOrders() {
      const term = globalSearch.value.trim();
      const s = statusFilter.value;
      const v = vendorFilter.value;
      const start = startDate.value ? Date.parse(startDate.value) : null;
      const end = endDate.value ? Date.parse(endDate.value) + 24*60*60*1000 : null; // inclusive
      return orders
        .filter(o =>
          matchesSearch(o, term) &&
          (!s || o.status === s) &&
          (!v || (o.supplier || '').toLowerCase() === v.toLowerCase()) &&
          withinDate(o, start, end)
        )
        .sort((a, b) => getOrderTimestamp(b) - getOrderTimestamp(a));
    }

    async function fetchOrders() {
      if (!currentUser) return;
      const res = await fetch('/api/orders');
      const data = await res.json();
      orders = (data.orders || []).map(o => ({
        ...o,
        tracking: o.tracking || [],
        group: o.group ? { ...o.group, tracking: o.group.tracking || [] } : null,
        _id: o._id || o.id || o.orderNumber
      }));
      // Debug tracking payloads for visibility
      console.log('[tracking] orders loaded', orders.map(o => ({
        id: o._id,
        tracking: o.tracking,
        groupTracking: o.group?.tracking
      })));
      const allTracking = [];
      orders.forEach(o => {
        (o.tracking || []).forEach(t => allTracking.push(t));
        (o.group?.tracking || []).forEach(t => allTracking.push(t));
      });
      const lastChecked = allTracking
        .map(t => t.lastCheckedAt || t.cache?.lastCheckedAt || t.cache?.lastEventTime || t.lastUpdated)
        .filter(Boolean)
        .sort((a, b) => b - a)[0];
      const trackingErrors = allTracking
        .map(t => t.cache?.summary || t.cache?.status || t.status)
        .filter(msg => msg && /error|missing|invalid|unauthorized|fail/i.test(msg));
      const trackingUpdatedEl = document.getElementById('tracking-updated');
      if (trackingUpdatedEl) {
        const errText = trackingErrors.length ? ` · Tracking error: ${trackingErrors[0]}` : '';
        trackingUpdatedEl.textContent = (lastChecked ? `Tracking updated ${fmtDate(lastChecked)}` : '') + errText;
      }
      buildFilters();
      renderBoard();
      renderTable();
      updateSelectionBar();
      updateUndoRedoUI();
    }

    function buildFilters() {
      const statusesUnique = Array.from(new Set(orders.map(o => o.status).filter(Boolean)));
      statusFilter.innerHTML = ['<option value="">All statuses</option>', ...statusesUnique.map(s => `<option>${s}</option>`)].join('');
      const vendors = Array.from(new Set(orders.map(o => (o.supplier || '').trim()).filter(Boolean)));
      vendorFilter.innerHTML = ['<option value="">All vendors</option>', ...vendors.map(v => `<option>${v}</option>`)].join('');
    }

    function openEdit(order) {
      editingOrderId = order._id;
      resetCatalogLookup();
      resetCatalogSavePanel();
      syncCatalogSaveUI();
      orderForm.elements.vendor.value = order.vendor || order.supplier || '';
      orderForm.elements.vendorPartNumber.value = order.vendorPartNumber || '';
      orderForm.elements.partLink.value = order.partLink || '';
      orderForm.elements.partName.value = order.partName || '';
      orderForm.elements.unitCost.value = order.unitCost || order.fetchedPrice || '';
      orderForm.elements.quantityRequested.value = order.quantityRequested || 1;
      orderForm.elements.priority.value = order.priority || 'Medium';
      setOrderSource('manual');
      scheduleCatalogPresenceCheck();
      if (currentUser?.permissions?.canEditInventoryCatalog && catalogSaveCategory) {
        catalogSaveCategory.value = order.category || '';
      }
      if (orderTrackingList) setTrackingRows(orderTrackingList, []);
      if (addOrderTracking) addOrderTracking.disabled = true;
      if (orderTrackingList) orderTrackingList.style.display = 'none';
      renderTagOptions(order.tags || []);
      renderPriorityOptions();
      orderForm.elements.notes.value = order.notes || '';
      modal.style.display = 'flex';
    }

    function createCard(order) {
      const card = document.createElement('div');
      card.className = 'card';
      card.draggable = false;
      card.dataset.id = order._id;
      card.dataset.vendor = getOrderVendor(order) || '';
      if (selected.has(order._id)) card.classList.add('selected');

      card.innerHTML = `
        <div class="flex-between" style="gap:8px;">
          <div>
            <h4>${order.partName || 'Untitled part'}</h4>
            <div class="meta">Requested by ${order.studentName || 'Unknown'} · ${fmtDate(order.requestedDisplayAt || order.requestedAt)}</div>
          </div>
        </div>
        <div class="meta">
          ${(() => {
            const unit = order.unitCost ?? order.fetchedPrice;
            const qty = order.quantityRequested || 1;
            const total = order.totalCost ?? (unit !== undefined ? Number((unit * qty).toFixed(2)) : undefined);
            return total !== undefined ? '$' + total : (unit !== undefined ? '$'+unit : '');
          })()}
          ${order.quantityRequested ? ' · x' + order.quantityRequested : ''}
        </div>
        ${order.notes ? `<div class="meta" style="margin-top:4px; white-space:pre-wrap;">Notes: ${escapeHtml(order.notes)}</div>` : ''}
        <div class="meta" style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-wrap:wrap;">
          <div style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:200px;">
            <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
              ${order.supplier || order.vendor ? `<span class="tag supplier">${order.supplier || order.vendor}</span>` : ''}
              ${order.vendorPartNumber ? `<span class="tag">${order.vendorPartNumber}</span>` : ''}
              ${order.priority ? `<span class="tag priority" style="border-color:${getPriorityColor(order.priority)}; color:${getPriorityColor(order.priority)};">${order.priority}</span>` : ''}
              ${order.group ? `<span class="tag group">Group: ${order.group.title || order.group.supplier || 'Grouped'}</span>` : ''}
              ${renderTagChips(order.tags || [])}
              ${order.approvalStatus === 'approved'
                ? `<span class="tag" style="background:rgba(74,210,143,0.16); color:var(--success);">Approved${order.approvedBy ? ' · ' + order.approvedBy : ''}</span>`
                : `<span class="tag" style="background:rgba(253,208,35,0.16); color:var(--gold);">Pending approval</span>`}
            </div>
            ${renderTrackingBadges((order.group?.tracking && order.group.tracking.length) ? order.group.tracking : (order.tracking || []))}
          </div>
          <div class="row-actions" style="display:flex; gap:6px; align-self:flex-end; flex-wrap:wrap;">
            ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="approve" style="padding:4px 8px;">${order.approvalStatus === 'approved' ? 'Unapprove' : 'Approve'}</button>` : ''}
            ${order.partLink || order.supplierLink ? `<a class="btn ghost" data-action="link" href="${escapeHtml(order.partLink || order.supplierLink)}" target="_blank" rel="noopener noreferrer" style="padding:4px 8px;">Link</a>` : ''}
            ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="edit" style="padding:4px 8px;">Edit</button>` : ''}
            ${currentUser?.permissions?.canDeleteOrders ? `<button class="btn ghost" data-action="delete" style="padding:4px 8px; color: var(--danger);">Delete</button>` : ''}
          </div>
        </div>
      `;
      card.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        if (e.target.closest('a')) return;
        if (addToOrderMode && addToOrderVendor) {
          showBoardMessage('Tap a grouped order to add these parts.', 'error', 2000);
          return;
        }
        toggleSelect(order._id);
      });

      card.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openEdit(order);
        });
      });
      card.querySelectorAll('button[data-action="approve"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const next = order.approvalStatus === 'approved' ? 'pending' : 'approved';
          await approveOrder(order._id, next);
          fetchOrders();
        });
      });

      card.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          openConfirm('Delete this order?', async () => {
            const snapshot = snapshotOrder(order._id);
            await fetch(`/api/orders/${order._id}`, { method: 'DELETE' });
            if (snapshot) {
              recordAction({
                undo: { type: 'restoreOrder', payload: { order: snapshot, groupId: snapshot.groupId || snapshot.group?._id } },
                redo: { type: 'deleteOrder', payload: { orderId: order._id } }
              });
            }
            fetchOrders();
          });
        });
      });
      card.querySelectorAll('a[data-action="link"]').forEach(anchor => {
        anchor.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      });
      return card;
    }

    function applyAddTargetStyles(el, vendor, isSelected, isGroup = false) {
      if (!el) return;
      el.classList.remove('add-target-valid', 'add-target-disabled');
      if (!addToOrderMode) return;
      if (!isGroup) {
        el.classList.add('add-target-disabled');
        return;
      }
      const canTarget = addToOrderVendor && vendor && !isSelected && vendor === addToOrderVendor;
      el.classList.add(canTarget ? 'add-target-valid' : 'add-target-disabled');
    }

    function renderBoard() {
      const fo = filteredOrders();
      const groupedByStatus = {};
      const groupMap = {};
      const selectionActions = selectionBar?.querySelector('.selection-actions');
      [selectAllBtn, selectSameVendorBtn, unselectAllBtn, groupBtn, addToOrderBtn].forEach(btn => {
        if (btn && selectionActions && btn.parentElement !== selectionActions) {
          selectionActions.appendChild(btn);
        }
      });

      fo.forEach(order => {
        if (order.groupId || order.group?._id) {
          const gid = order.groupId || order.group?._id;
          if (!groupMap[gid]) groupMap[gid] = [];
          groupMap[gid].push(order);
        } else {
          groupedByStatus[order.status] = groupedByStatus[order.status] || [];
          groupedByStatus[order.status].push(order);
        }
      });

      boardEl.innerHTML = '';
      statuses.forEach(col => {
        const status = col.status;
      const column = document.createElement('div');
      column.className = 'column';
      column.dataset.status = col.status;
      column.innerHTML = `
        <div class="flex-between" style="align-items:flex-start; gap:8px; flex-wrap:wrap;">
          <div>
            <h3>${col.label} <span class="pill">${(groupedByStatus[col.status] || []).length + Object.values(groupMap).filter(items => (items[0]?.status === col.status)).length}</span></h3>
            <div class="small" style="margin-bottom:6px;">${col.hint}</div>
          </div>
          ${col.status === 'Requested' ? `<div class="to-order-actions" style="display:flex; gap:8px; flex-wrap:wrap; margin-left:auto;"></div>` : ''}
        </div>
        <div class="board-drop"></div>
      `;
        const dropArea = column.querySelector('.board-drop');
        const actionsRow = column.querySelector('.to-order-actions');
        if (actionsRow && col.status === 'Requested') {
          const selectedOrders = orders.filter(o => selected.has(o._id));
          const allRequested = selectedOrders.every(o => o.status === 'Requested');
          const sameVendor = selectedOrders.length > 0 && allRequested && selectedOrders.every(o => getOrderVendor(o) === getOrderVendor(selectedOrders[0]));
          const selectAllBtnEl = document.getElementById('select-all-btn');
          const selectSameVendorBtnEl = document.getElementById('select-same-vendor-btn');
          const unselectAllBtnEl = document.getElementById('unselect-all-btn');
          const groupBtnEl = document.getElementById('group-btn');
          const addToOrderBtnEl = document.getElementById('add-to-order-btn');
          const showSelectSameVendor = sameVendor;
          const showSelectAll = selectedOrders.length === 0 || !sameVendor;
          if (selectAllBtnEl) {
            selectAllBtnEl.style.display = showSelectAll ? 'inline-flex' : 'none';
            actionsRow.appendChild(selectAllBtnEl);
          }
          if (selectSameVendorBtnEl) {
            selectSameVendorBtnEl.style.display = showSelectSameVendor ? 'inline-flex' : 'none';
            actionsRow.appendChild(selectSameVendorBtnEl);
          }
          if (unselectAllBtnEl) {
            unselectAllBtnEl.style.display = selected.size ? 'inline-flex' : 'none';
            actionsRow.appendChild(unselectAllBtnEl);
          }
          if (addToOrderBtnEl) {
            addToOrderBtnEl.style.display = selected.size && sameVendor ? 'inline-flex' : 'none';
            actionsRow.appendChild(addToOrderBtnEl);
          }
          if (groupBtnEl) {
            groupBtnEl.style.display = selected.size && sameVendor ? 'inline-flex' : 'none';
            actionsRow.appendChild(groupBtnEl);
          }
          if (deleteSelectedBtn) {
            deleteSelectedBtn.style.display = selected.size ? 'inline-flex' : 'none';
            actionsRow.appendChild(deleteSelectedBtn);
          }
        }

        (groupedByStatus[col.status] || []).forEach(order => {
          const card = createCard(order);
          applyAddTargetStyles(card, getOrderVendor(order), selected.has(order._id), false);
          dropArea.appendChild(card);
        });

        const groupsForStatus = Object.entries(groupMap)
          .filter(([, items]) => items[0]?.status === col.status)
          .sort(([, a], [, b]) => getGroupTimestamp(b) - getGroupTimestamp(a));

      groupsForStatus.forEach(([gid, items]) => {
        const first = items[0];
        const card = document.createElement('div');
        card.className = 'card';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '8px';
        card.draggable = false;
        card.dataset.groupId = gid;
        card.dataset.vendor = (first.supplier || first.vendor || '').toLowerCase();
        const vendor = first.supplier || first.vendor || '';
      const total = items.reduce((sum, o) => sum + (o.totalCost || 0), 0);
          const trackingList = (first.group?.tracking && first.group.tracking.length ? first.group.tracking : trackingFromOrder(first));
      const groupedAt = first.group?.requestedDisplayAt || first.group?.createdAt || Date.now();
      const timePart = new Date(groupedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const groupTitle = first.group?.title || `${vendor || 'Grouped Order'} - ${formatShortDate(new Date(groupedAt))} ${timePart}`;
          card.innerHTML = `
            <div class="flex-between" style="gap:8px;">
              <div>
                <h4>${groupTitle}</h4>
                <div class="meta">Items in order: ${items.length}</div>
              </div>
              <div class="row-actions" style="display:flex; gap:6px;">
                ${status === 'Ordered' ? `<button class="btn ghost" data-action="advance-group" style="padding:4px 8px;">Advance</button>` : ''}
                ${status === 'Received' ? `<button class="btn ghost" data-action="revert-group" style="padding:4px 8px;">Revert</button>` : ''}
                ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="edit-group" style="padding:4px 8px;">Edit</button>` : ''}
                ${currentUser?.permissions?.canDeleteOrders ? `<button class="btn ghost" data-action="delete-group" style="padding:4px 8px; color: var(--danger);">Delete</button>` : ''}
              </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div>${vendor ? `<span class="tag supplier">${vendor}</span>` : ''}</div>
                ${renderTrackingBadges(trackingList)}
              </div>
              <div class="muted" style="min-width:80px; text-align:right; align-self:flex-end;">${total ? '$'+total.toFixed(2) : ''}</div>
            </div>
            <div class="group-items-container" style="margin-top:6px; display:${expandedGroups.has(gid) ? 'block' : 'none'};">
              ${items.map(o => `
                <div class="small group-item" data-id="${o._id}" style="display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; margin-top:4px; flex-wrap:wrap;">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; flex:1;">
                    <span class="muted" style="font-weight:700;">${o.quantityRequested ? `${o.quantityRequested}x` : ''}</span>
                    <span style="font-weight:700;">${o.partName || ''}</span>
                    ${o.studentName ? `<span class="tag" style="background:rgba(79,180,255,0.16); color:var(--accent-2); border-color:var(--border);">${o.studentName}</span>` : ''}
                    ${renderTagChips(o.tags || [])}
                  </div>
                  <div style="display:flex; gap:6px; flex-wrap:wrap; margin-left:auto;">
                    ${o.partLink || o.supplierLink ? `<a class="btn ghost" data-action="link-part" href="${escapeHtml(o.partLink || o.supplierLink)}" target="_blank" rel="noopener noreferrer" style="padding:4px 8px;">Link</a>` : ''}
                    ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="edit-part" style="padding:4px 8px;">Edit</button>` : ''}
                    ${currentUser?.permissions?.canEditOrders ? `<button class="btn ghost" data-action="remove-part" style="padding:4px 8px;">Remove</button>` : ''}
                    ${currentUser?.permissions?.canDeleteOrders ? `<button class="btn ghost" data-action="delete-part" style="padding:4px 8px; color:var(--danger);">Delete</button>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          applyAddTargetStyles(card, vendor.toLowerCase(), false, true);

          card.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('.group-item')) return;
            if (addToOrderMode && addToOrderVendor) {
              const valid = vendor && vendor.toLowerCase() === addToOrderVendor;
              if (valid) {
                addSelectedToGroup(gid, status);
                return;
              }
              showBoardMessage('Vendor mismatch. Pick a matching grouped order.', 'error', 2000);
              return;
            }
            if (expandedGroups.has(gid)) expandedGroups.delete(gid); else expandedGroups.add(gid);
            const container = card.querySelector('.group-items-container');
            if (container) container.style.display = expandedGroups.has(gid) ? 'block' : 'none';
          });

          card.querySelectorAll('button[data-action="edit-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              openGroupModal({
                id: gid,
                title: first.group?.title || groupTitle,
                tracking: trackingList,
                notes: first.group?.notes || ''
              });
            });
          });

          card.querySelectorAll('button[data-action="delete-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const orderIds = items.map(o => o._id);
              openConfirm('Delete this group? Orders will be ungrouped.', async () => {
                await fetch(`/api/order-groups/${gid}`, { method: 'DELETE' });
                recordAction({
                  undo: { type: 'createGroup', payload: { title: groupTitle, supplier: vendor || undefined, requestedDisplayAt: first.group?.requestedDisplayAt || first.group?.createdAt, orderIds } },
                  redo: { type: 'deleteGroup', payload: { groupId: gid } }
                });
                fetchOrders();
              });
            });
          });
          card.querySelectorAll('button[data-action="advance-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await updateGroupStatus(gid, 'Received');
            });
          });
          card.querySelectorAll('button[data-action="revert-group"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await updateGroupStatus(gid, 'Ordered');
            });
          });

          card.querySelectorAll('button[data-action="edit-part"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              const order = orders.find(o => o._id === oid);
              if (order) openEdit(order);
            });
          });
          card.querySelectorAll('button[data-action="remove-part"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              await removePartFromGroup(oid);
            });
          });
          card.querySelectorAll('a[data-action="link-part"]').forEach(anchor => {
            anchor.addEventListener('click', (e) => {
              e.stopPropagation();
            });
          });
          card.querySelectorAll('button[data-action="delete-part"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const oid = e.target.closest('.group-item').dataset.id;
              openConfirm('Delete this order?', async () => {
                await fetch(`/api/orders/${oid}`, { method: 'DELETE' });
                fetchOrders();
              });
            });
          });

          dropArea.appendChild(card);
        });

        const hasSingles = (groupedByStatus[col.status] || []).length > 0;
        const hasGroups = Object.values(groupMap).some(items => items[0]?.status === col.status);
        if (!hasSingles && !hasGroups) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'Drag an order here or create a new one.';
          dropArea.appendChild(empty);
        }

        boardEl.appendChild(column);
      });

      if (addToOrderMode && boardEl) {
        boardEl.querySelectorAll('.board .card').forEach(card => {
          const vendor = card.dataset.vendor || '';
          const isGroup = Boolean(card.dataset.groupId);
          const isSelected = card.dataset.id ? selected.has(card.dataset.id) : false;
          applyAddTargetStyles(card, vendor, isSelected, isGroup);
        });
      }
      resizeColumns();
    }

    function renderStockFilters() {
      if (!stockSubteamFilter) return;
      const options = [`<option value="all">All locations</option>`, `<option value="none">Common Stock</option>`];
      (stockSubteams || []).forEach(st => {
        options.push(`<option value="${st._id}">${escapeHtml(st.name)}</option>`);
      });
      stockSubteamFilter.innerHTML = options.join('');
      const desired = selectedStockSubteam || 'all';
      const hasOption = Array.from(stockSubteamFilter.options || []).some(opt => opt.value === desired);
      stockSubteamFilter.value = hasOption ? desired : 'all';
    }

    function setSelectedStockCatalogItem(item) {
      selectedStockCatalogItem = item;
      if (stockCatalogSelected) {
        stockCatalogSelected.textContent = item
          ? `${item.name || ''}${item.vendor ? ' · ' + item.vendor : ''}${item.vendorPartNumber ? ' · ' + item.vendorPartNumber : ''}`
          : 'Search for a catalog item to track.';
      }
    }

    function buildStockCard(item, canAdjustStock) {
      const qty = item.quantityOnHand ?? 0;
      const low = item.lowStockThreshold;
      const isEmpty = qty <= 0;
      const isLow = !isEmpty && low !== undefined && qty <= low;
      const card = document.createElement('div');
      card.className = 'card stock-card';
      if (isLow) card.classList.add('stock-low');
      if (isEmpty) card.classList.add('stock-empty');
      card.dataset.id = item._id;
      const subteamLabel = item.subteam || 'Common Stock';
      const statusText = isEmpty ? '<span class="stock-empty-text">Out of stock</span>' : (isLow ? '<span class="stock-low-text">Low</span>' : '');
      card.innerHTML = `
          <div class="flex-between" style="gap:8px; align-items:flex-start;">
            <div>
              <h4 style="margin:0 0 6px;">${escapeHtml(item.name)}</h4>
              <div class="meta">
                <span class="stock-chip">${escapeHtml(subteamLabel)}</span>
                ${item.category ? `<span class="stock-chip">${escapeHtml(item.category)}</span>` : ''}
                ${item.location ? `<span class="stock-chip">📍 ${escapeHtml(item.location)}</span>` : ''}
              </div>
              <div class="meta">
                ${item.vendor ? `<span class="tag supplier">${escapeHtml(item.vendor)}</span>` : ''}
                ${item.vendorPartNumber ? `<span class="tag">${escapeHtml(item.vendorPartNumber)}</span>` : ''}
              </div>
            </div>
            ${statusText ? `<div>${statusText}</div>` : ''}
          </div>
          <div class="stock-row">
            <div class="stock-adjust">
              ${canAdjustStock ? `<button class="btn ghost" data-action="adjust-stock" data-id="${item._id}" data-delta="-1" style="padding:6px 10px;">-</button>` : ''}
              <div class="stock-level">${qty}</div>
              ${canAdjustStock ? `<button class="btn ghost" data-action="adjust-stock" data-id="${item._id}" data-delta="1" style="padding:6px 10px;">+</button>` : ''}
              ${!canAdjustStock ? `<div class="small">View only</div>` : ''}
            </div>
            <div class="stock-actions" style="margin-left:auto;">
              ${item.supplierLink ? `<a class="btn ghost" href="${escapeHtml(item.supplierLink)}" target="_blank" style="padding:4px 8px;">Link</a>` : ''}
              ${currentUser?.permissions?.canManageStock ? `<button class="btn ghost" data-action="edit-stock" data-id="${item._id}" style="padding:4px 8px;">Edit</button>` : ''}
              ${currentUser?.permissions?.canManageStock ? `<button class="btn ghost" data-action="delete-stock" data-id="${item._id}" style="padding:4px 8px; color: var(--danger);">Untrack</button>` : ''}
              <button class="btn primary" data-action="request-stock" data-id="${item._id}" style="padding:4px 10px;">Request</button>
            </div>
          </div>
        `;
      return card;
    }

    function mergeStockItem(id, changes) {
      const idx = stockItems.findIndex(s => s._id === id);
      if (idx === -1) return false;
      stockItems[idx] = { ...stockItems[idx], ...changes };
      renderStockGrid();
      return true;
    }

    function openDeleteStockModal(id) {
      pendingDeleteStockId = id;
      if (stockDeleteMessage) stockDeleteMessage.textContent = 'Are you sure you want to untrack this item?';
      if (stockDeleteModal) stockDeleteModal.style.display = 'flex';
    }

    function openConfirm(message, action) {
      if (!confirmModal) return action?.();
      pendingConfirmAction = action;
      if (confirmMessage) confirmMessage.textContent = message || 'Are you sure?';
      if (confirmStatus) { confirmStatus.textContent = ''; confirmStatus.className = 'small'; }
      confirmModal.style.display = 'flex';
    }

    function renderStockGrid() {
      if (!stockGrid) return;
      if (!currentUser) {
        stockGrid.innerHTML = '<div class="empty">Login to view stock.</div>';
        return;
      }
      if (!stockItems.length) {
        stockGrid.innerHTML = '<div class="empty">No stock tracked yet. Add items to start tracking.</div>';
        return;
      }
      stockGrid.innerHTML = '';
      const canAdjustStock = currentUser?.permissions?.canEditStock || currentUser?.permissions?.canManageStock;
      const isGrouped = selectedStockSubteam && selectedStockSubteam !== 'all';
      stockGrid.classList.toggle('grouped', isGrouped);

      const buildCategoryLabel = (item) => {
        return (item.category || '').trim() ||
          'Uncategorized';
      };

      if (isGrouped) {
        const groups = new Map();
        stockItems.forEach(item => {
          const label = buildCategoryLabel(item);
          if (!groups.has(label)) groups.set(label, []);
          groups.get(label).push(item);
        });
        const sortedLabels = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b));
        sortedLabels.forEach(label => {
          const wrapper = document.createElement('div');
          wrapper.className = 'stock-category-block';
          const title = document.createElement('div');
          title.className = 'stock-category-title';
          title.textContent = label;
          const grid = document.createElement('div');
          grid.className = 'stock-category-grid';
          const items = groups.get(label) || [];
          items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          items.forEach(item => grid.appendChild(buildStockCard(item, canAdjustStock)));
          wrapper.appendChild(title);
          wrapper.appendChild(grid);
          stockGrid.appendChild(wrapper);
        });
      } else {
        stockItems
          .slice()
          .sort((a, b) => (a.subteam || '').localeCompare(b.subteam || '') || (a.name || '').localeCompare(b.name || ''))
          .forEach(item => stockGrid.appendChild(buildStockCard(item, canAdjustStock)));
      }

      stockGrid.querySelectorAll('button[data-action="adjust-stock"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          const delta = Number(e.target.dataset.delta);
          if (!id || !Number.isFinite(delta)) return;
          await adjustStockQuantity(id, delta);
        });
      });
      stockGrid.querySelectorAll('button[data-action="request-stock"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const item = stockItems.find(s => s._id === id);
          if (!item) return;
          if (!currentUser?.permissions?.canPlaceOrders) {
            showBoardMessage('No permission to place orders.', 'error');
            return;
          }
          const requestItem = item.catalogItem || {
            name: item.name,
            vendor: item.vendor,
            vendorPartNumber: item.vendorPartNumber,
            supplierLink: item.supplierLink,
            unitCost: item.unitCost,
            defaultQuantity: 1,
            fullPath: item.catalogFullPath
          };
          openCatalogRequestModal(requestItem);
        });
      });
      stockGrid.querySelectorAll('button[data-action="edit-stock"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const item = stockItems.find(s => s._id === id);
          if (item) openStockModal(item);
        });
      });
      stockGrid.querySelectorAll('button[data-action="delete-stock"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          if (!id) return;
          openDeleteStockModal(id);
        });
      });
    }

    async function loadStock() {
      if (!stockGrid) return;
      if (!currentUser) {
        stockGrid.innerHTML = '<div class="empty">Login to view stock.</div>';
        return;
      }
      const params = new URLSearchParams();
      const searchTerm = (globalSearch?.value || '').trim();
      if (searchTerm) params.set('search', searchTerm);
      if (selectedStockSubteam && selectedStockSubteam !== 'all' && selectedStockSubteam !== 'none') {
        params.set('subteamId', selectedStockSubteam);
      }
      const qs = params.toString() ? `?${params.toString()}` : '';
      stockGrid.innerHTML = '<div class="empty">Loading stock...</div>';
      try {
        const res = await fetch(`/api/stock${qs}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load stock');
        const incoming = data.items || [];
        stockSubteams = data.subteams || stockSubteams;
        renderStockFilters();
        stockItems = selectedStockSubteam === 'none'
          ? incoming.filter(i => !i.subteamId)
          : incoming;
        renderStockGrid();
      } catch (err) {
        stockGrid.innerHTML = `<div class="empty">${escapeHtml(err.message || 'Failed to load stock')}</div>`;
      }
    }

    function resetStockModal() {
      if (!stockForm) return;
      stockForm.reset();
      setSelectedStockCatalogItem(null);
      if (stockCatalogSearch) { stockCatalogSearch.value = ''; stockCatalogSearch.disabled = false; }
      if (stockCatalogResults) { stockCatalogResults.innerHTML = ''; stockCatalogResults.style.display = 'none'; }
      if (stockModalMessage) { stockModalMessage.textContent = ''; stockModalMessage.className = 'small'; }
      if (deleteStockBtn) deleteStockBtn.style.display = 'none';
      if (stockModalTitle) stockModalTitle.textContent = 'Add Stock';
      if (stockModalSubtitle) stockModalSubtitle.textContent = 'Pick a catalog part to track and set the starting quantity.';
      if (stockCategoryInput) stockCategoryInput.value = '';
    }

    function openStockModal(item = null) {
      if (!currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to configure stock.', 'error');
        return;
      }
      if (!stockForm) return;
      resetStockModal();
      renderStockFilters();
      if (stockSubteamSelect) {
        const opts = [`<option value="">Common Stock</option>`].concat(
          (stockSubteams || []).map(st => `<option value="${st._id}">${escapeHtml(st.name)}</option>`)
        );
        stockSubteamSelect.innerHTML = opts.join('');
      }
      if (item) {
        stockForm.elements.id.value = item._id || '';
        if (stockQuantityInput) stockQuantityInput.value = item.quantityOnHand ?? 0;
        if (stockLowInput) stockLowInput.value = item.lowStockThreshold ?? '';
        if (stockLocationInput) stockLocationInput.value = item.location || '';
        if (stockCategoryInput) stockCategoryInput.value = item.category || '';
        if (stockNotesInput) stockNotesInput.value = item.notes || '';
        if (stockSubteamSelect) stockSubteamSelect.value = item.subteamId ? item.subteamId.toString() : '';
        setSelectedStockCatalogItem(item.catalogItem || item);
        if (stockCatalogSearch) stockCatalogSearch.disabled = true;
        if (stockModalTitle) stockModalTitle.textContent = 'Edit stock item';
        if (stockModalSubtitle) stockModalSubtitle.textContent = 'Update location, thresholds, or counts.';
        if (deleteStockBtn) deleteStockBtn.style.display = 'inline-flex';
      } else {
        if (stockSubteamSelect) stockSubteamSelect.value = selectedStockSubteam && selectedStockSubteam !== 'all' ? selectedStockSubteam : '';
        setSelectedStockCatalogItem(null);
      }
      if (stockModal) stockModal.style.display = 'flex';
    }

    async function saveStockForm(e) {
      e.preventDefault();
      if (!stockForm) return;
      const id = stockForm.elements.id.value || null;
      const quantity = Number(stockQuantityInput?.value || 0);
      const low = stockLowInput?.value === '' ? undefined : Number(stockLowInput?.value);
      const subteamId = stockSubteamSelect ? stockSubteamSelect.value : '';
      const location = stockLocationInput?.value?.trim() || undefined;
      const category = stockCategoryInput?.value?.trim() || undefined;
      const notes = stockNotesInput?.value?.trim() || undefined;
      const targetLocationName = subteamId
        ? (stockSubteams?.find?.(s => s._id === subteamId)?.name || 'Selected location')
        : 'Common Stock';
      const finalizeSuccess = () => {
        if (stockModal) stockModal.style.display = 'none';
        showBoardMessage('Stock saved.', 'info');
      };
      if (!id && !selectedStockCatalogItem) {
        stockModalMessage.textContent = 'Select a catalog item first.';
        stockModalMessage.className = 'error';
        return;
      }
      if (stockModalMessage) { stockModalMessage.textContent = 'Saving...'; stockModalMessage.className = 'small'; }
      try {
        if (id) {
          const res = await fetch(`/api/stock/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subteamId: subteamId === '' ? null : subteamId,
              quantityOnHand: Number.isFinite(quantity) ? quantity : undefined,
              lowStockThreshold: Number.isFinite(low) ? low : undefined,
              location,
              category,
              notes
            })
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'Failed to update stock');
          }
          const subteamName = subteamId && stockSubteams?.find?.(s => s._id === subteamId)?.name;
          const moveOutOfView = selectedStockSubteam && selectedStockSubteam !== 'all' && selectedStockSubteam !== subteamId && !(selectedStockSubteam === 'none' && !subteamId);
          if (moveOutOfView) {
            stockItems = stockItems.filter(s => s._id !== id);
          } else {
            mergeStockItem(id, {
              subteamId: subteamId || undefined,
              subteam: subteamId ? subteamName || undefined : 'Common Stock',
              quantityOnHand: Number.isFinite(quantity) ? quantity : undefined,
              lowStockThreshold: Number.isFinite(low) ? low : undefined,
              location,
              category,
              notes
            });
          }
          finalizeSuccess();
        } else {
          const payload = {
            catalogItemId: selectedStockCatalogItem?._id || selectedStockCatalogItem?.id,
            subteamId: subteamId === '' ? undefined : subteamId,
            quantityOnHand: Number.isFinite(quantity) ? quantity : 0,
            lowStockThreshold: Number.isFinite(low) ? low : undefined,
            location,
            category,
            notes
          };
          const execCreate = async () => {
            const res = await fetch('/api/stock', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Failed to create stock');
            await loadStock();
          };
          try {
            const checkUrl = `/api/stock?catalogItemId=${encodeURIComponent(payload.catalogItemId)}`;
            const dupRes = await fetch(checkUrl);
            if (dupRes.ok) {
              const dupData = await dupRes.json();
              const items = dupData.items || [];
              const norm = (val) => (val ? val.toString() : '');
              const targetId = norm(subteamId || undefined);
              const sameLocation = items.find(i => norm(i.subteamId) === targetId);
              if (sameLocation) {
                throw new Error('Item already exists in location');
              }
              const otherLocation = items.find(i => norm(i.subteamId) !== targetId);
              if (otherLocation) {
                const otherName = otherLocation.subteam || 'Common Stock';
                openConfirm(`This item already exists in ${otherName}. Add it to ${targetLocationName} as well?`, async () => {
                  try {
                    if (stockModalMessage) { stockModalMessage.textContent = 'Saving...'; stockModalMessage.className = 'small'; }
                    await execCreate();
                    finalizeSuccess();
                  } catch (err) {
                    if (stockModalMessage) {
                      stockModalMessage.textContent = err.message || 'Failed to save stock';
                      stockModalMessage.className = 'error';
                    }
                  }
                });
                if (stockModalMessage) { stockModalMessage.textContent = 'Awaiting confirmation...'; stockModalMessage.className = 'small'; }
                return;
              }
            }
          } catch (err) {
            if (err?.message === 'Item already exists in location') throw err;
            // If the duplicate check fails for network/other reasons, fall through to attempt creation
          }
          await execCreate();
          finalizeSuccess();
        }
      } catch (err) {
        if (stockModalMessage) {
          stockModalMessage.textContent = err.message || 'Failed to save stock';
          stockModalMessage.className = 'error';
        }
      }
    }

    async function adjustStockQuantity(id, delta, absolute) {
      if (!currentUser?.permissions?.canEditStock && !currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to edit stock.', 'error');
        return;
      }
      try {
        const res = await fetch(`/api/stock/${id}/adjust`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            delta: absolute === undefined ? delta : undefined,
            quantityOnHand: absolute
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to update stock');
        const nextQty = data.quantityOnHand;
        if (!mergeStockItem(id, { quantityOnHand: nextQty })) {
          await loadStock();
        }
      } catch (err) {
        showBoardMessage(err.message || 'Failed to update stock', 'error');
      }
    }

    async function saveStockThreshold(id, value) {
      if (!currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to configure stock.', 'error');
        return;
      }
      try {
        await fetch(`/api/stock/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lowStockThreshold: value })
        });
        await loadStock();
      } catch (err) {
        showBoardMessage(err.message || 'Failed to save threshold', 'error');
      }
    }

    async function deleteStockItem(id) {
      if (!currentUser?.permissions?.canManageStock) {
        showBoardMessage('No permission to untrack stock.', 'error');
        return;
      }
      try {
        await fetch(`/api/stock/${id}`, { method: 'DELETE' });
        await loadStock();
        showBoardMessage('Stock entry removed.', 'info');
      } catch (err) {
        showBoardMessage(err.message || 'Failed to remove stock', 'error');
      }
    }

    function renderSubteamList() {
      if (!stockSubteamList) return;
      if (!stockSubteams.length) {
        stockSubteamList.innerHTML = '<div class="empty">No locations yet.</div>';
        return;
      }
      stockSubteamList.innerHTML = stockSubteams.map(st => `
        <div class="tag-manager-item" data-id="${st._id}">
          <div class="tag-manager-meta" style="flex-wrap:wrap; gap:6px;">
            <div style="font-weight:700;">${escapeHtml(st.name)}</div>
            ${st.description ? `<div class="small">${escapeHtml(st.description)}</div>` : ''}
          </div>
          <div class="flex-between" style="gap:6px;">
            <button class="btn ghost" data-action="edit-subteam" style="padding:6px 10px;">Edit</button>
            <button class="btn ghost" data-action="delete-subteam" style="padding:6px 10px; color: var(--danger);">Delete</button>
          </div>
        </div>
      `).join('');
      stockSubteamList.querySelectorAll('button[data-action="edit-subteam"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.closest('.tag-manager-item')?.dataset.id;
          const st = stockSubteams.find(s => s._id === id);
          if (!st || !stockSubteamForm) return;
          stockSubteamForm.elements.id.value = st._id;
          stockSubteamForm.elements.name.value = st.name || '';
          stockSubteamForm.elements.description.value = st.description || '';
        });
      });
      stockSubteamList.querySelectorAll('button[data-action="delete-subteam"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.closest('.tag-manager-item')?.dataset.id;
          if (!id) return;
          openConfirm('Delete this location? Items will become unassigned.', async () => {
            await removeSubteam(id);
          });
        });
      });
    }

    async function loadSubteams() {
      if (!currentUser) return;
      try {
        const res = await fetch('/api/stock/subteams');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load locations');
        stockSubteams = data.subteams || [];
        renderSubteamList();
        renderStockFilters();
      } catch (err) {
        if (stockSubteamMessage) {
          stockSubteamMessage.textContent = err.message || 'Failed to load locations';
          stockSubteamMessage.className = 'error';
        }
      }
    }

    function openSubteamsModal() {
      if (!currentUser?.permissions?.canManageStock) return;
      if (stockSubteamMessage) { stockSubteamMessage.textContent = ''; stockSubteamMessage.className = 'small'; }
      stockSubteamForm?.reset();
      renderSubteamList();
      if (stockSubteamsModal) stockSubteamsModal.style.display = 'flex';
    }

    async function saveSubteam(e) {
      e.preventDefault();
      if (!stockSubteamForm) return;
      const id = stockSubteamForm.elements.id.value || null;
      const name = stockSubteamForm.elements.name.value?.trim();
      const description = stockSubteamForm.elements.description.value?.trim();
      if (!name) return;
      if (stockSubteamMessage) { stockSubteamMessage.textContent = 'Saving...'; stockSubteamMessage.className = 'small'; }
      try {
        const url = id ? `/api/stock/subteams/${id}` : '/api/stock/subteams';
        const method = id ? 'PATCH' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save location');
        stockSubteamForm.reset();
        await loadSubteams();
        await loadStock();
        if (stockSubteamMessage) { stockSubteamMessage.textContent = 'Saved.'; stockSubteamMessage.className = 'success'; }
      } catch (err) {
        if (stockSubteamMessage) { stockSubteamMessage.textContent = err.message || 'Failed to save location'; stockSubteamMessage.className = 'error'; }
      }
    }

    async function removeSubteam(id) {
      if (!currentUser?.permissions?.canManageStock) return;
      openConfirm('Delete this location? Items will become unassigned.', async () => {
        await fetch(`/api/stock/subteams/${id}`, { method: 'DELETE' });
        await loadSubteams();
        await loadStock();
      });
    }

    async function searchStockCatalog(term) {
      if (!stockCatalogResults) return;
      const q = (term || '').trim();
      if (q.length < 2) {
        stockCatalogResults.style.display = 'none';
        stockCatalogResults.innerHTML = '';
        return;
      }
      stockCatalogResults.style.display = 'block';
      stockCatalogResults.innerHTML = '<div class="small" style="padding:8px 10px;">Searching...</div>';
      try {
        const res = await fetch(`/api/catalog/items?search=${encodeURIComponent(q)}&includeDescendants=true`);
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) {
          stockCatalogResults.innerHTML = '<div class="small" style="padding:8px 10px;">No matches</div>';
          return;
        }
        stockCatalogResults.innerHTML = items.slice(0, 30).map(item => `
          <div class="tag-option" data-id="${item._id}">
            <div style="font-weight:700;">${escapeHtml(item.name)}</div>
            <div class="small">${escapeHtml(item.fullPath || (item.categoryPathLabels || []).join(' / ') || '')}${item.vendor ? ' · ' + escapeHtml(item.vendor) : ''}${item.vendorPartNumber ? ' · ' + escapeHtml(item.vendorPartNumber) : ''}</div>
          </div>
        `).join('');
        stockCatalogResults.querySelectorAll('.tag-option').forEach(row => {
          row.addEventListener('click', () => {
            const id = row.dataset.id;
            const found = items.find(i => i._id === id);
            if (found) {
              setSelectedStockCatalogItem(found);
              stockCatalogResults.style.display = 'none';
              stockCatalogSearch.value = found.name || '';
            }
          });
        });
      } catch (err) {
        stockCatalogResults.innerHTML = '<div class="small" style="padding:8px 10px;">Failed to search catalog</div>';
      }
    }

    function renderTable() {
      const rows = filteredOrders();
      if (!rows.length) {
        tableContainer.innerHTML = '<div class="empty">No orders found.</div>';
        return;
      }

      const header = `
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>Part</th>
              <th>Status</th>
              <th>Tracking</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Total</th>
              <th>Vendor</th>
              <th>Requested by</th>
            <th>Order placed</th>
            </tr>
          </thead>
          <tbody>
      `;
      const body = rows.map(o => `
        <tr data-id="${o._id}">
          <td><input type="checkbox" class="row-check" ${selected.has(o._id) ? 'checked' : ''}></td>
          <td>
            <div>${o.partName || ''}</div>
            ${o.vendorPartNumber ? `<div class="small">${o.vendorPartNumber}</div>` : ''}
            ${o.partLink ? `<div class="small"><a href="${o.partLink}" target="_blank">link</a></div>` : ''}
            ${(o.tags && o.tags.length) ? `<div class="small" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">${renderTagChips(o.tags)}</div>` : ''}
            <div class="small" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
              ${o.approvalStatus === 'approved'
                ? `<span class="tag" style="background:rgba(74,210,143,0.16); color:var(--success);">Approved${o.approvedBy ? ' · ' + o.approvedBy : ''}</span>`
                : `<span class="tag" style="background:rgba(253,208,35,0.16); color:var(--gold);">Pending approval</span>`}
              ${o.group ? `<span class="tag group">Group</span>` : ''}
            </div>
          </td>
          <td><span class="status-chip status-${o.status || ''}">${o.status || ''}</span></td>
          <td>${renderTrackingBadges(o.group?.tracking || [])}</td>
          <td>${o.quantityRequested || ''}</td>
          <td>${o.unitCost ? '$'+o.unitCost : (o.fetchedPrice ? '$'+o.fetchedPrice : '')}</td>
          <td>${(() => {
            const unit = o.unitCost ?? o.fetchedPrice;
            const qty = o.quantityRequested || 1;
            const total = o.totalCost ?? (unit !== undefined ? Number((unit * qty).toFixed(2)) : undefined);
            return total !== undefined ? '$'+total : '';
          })()}</td>
          <td>${o.supplier || o.vendor || ''}</td>
          <td>${o.studentName || ''}</td>
          <td>${fmtDate(o.group?.requestedDisplayAt || o.group?.createdAt || o.requestedDisplayAt || o.requestedAt)}</td>
        </tr>
      `).join('');
      tableContainer.innerHTML = header + body + '</tbody></table>';

      tableContainer.querySelector('#select-all').addEventListener('change', (e) => {
        const check = e.target.checked;
        rows.forEach(o => { if (check) selected.add(o._id); else selected.delete(o._id); });
        renderBoard(); renderTable(); updateSelectionBar();
      });
      tableContainer.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = e.target.closest('tr').dataset.id;
          if (e.target.checked) selected.add(id); else selected.delete(id);
          renderBoard(); updateSelectionBar();
        });
      });
      resizeColumns();
    }

    function toggleSelect(id) {
      if (selected.has(id)) selected.delete(id);
      else selected.add(id);
      renderBoard();
      renderTable();
      updateSelectionBar();
    }

    const canLeaveRequested = (order) => Boolean(order?.groupId || order?.group);
    const isGroupOrder = (order) => Boolean(order?.groupId || order?.group);

    async function updateStatus(id, status, tracking) {
      const order = getOrderById(id);
      if (!order) return;
      if (status !== 'Requested' && !canLeaveRequested(order)) {
        showBoardMessage('Move the part into an order first.', 'error');
        return;
      }
      const trackingList = Array.isArray(tracking)
        ? tracking
        : (tracking ? [{ carrier: 'unknown', trackingNumber: tracking }] : undefined);
      await fetch(`/api/orders/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          tracking: trackingList,
          trackingNumber: trackingList?.[0]?.trackingNumber
        })
      });
      selected.delete(id);
      await fetchOrders();
    }

    function updateSelectionBar() {
      const selectedOrders = orders.filter(o => selected.has(o._id));
      if (selected.size === 0) {
        selectionCount.textContent = 'No parts selected';
        groupVendorNote.textContent = '';
      document.getElementById('delete-selected').style.display = 'none';
      if (addToOrderBtn) addToOrderBtn.style.display = 'none';
      addToOrderMode = false;
      addToOrderVendor = null;
    } else {
    const vendor = selectedOrders[0]?.supplier || selectedOrders[0]?.vendor || 'Mixed';
    selectionCount.textContent = `${selected.size} selected`;
    groupVendorNote.textContent = `Vendor: ${vendor}${selectedOrders.every(o => (o.supplier || o.vendor) === (selectedOrders[0]?.supplier || selectedOrders[0]?.vendor)) ? '' : ' (mixed - fix selection)'}`;
    document.getElementById('delete-selected').style.display = 'inline-flex';
    if (addToOrderMode && addToOrderVendor && selectedOrders.some(o => getOrderVendor(o) !== addToOrderVendor)) {
      resetAddToOrderMode();
    }
  }
  }

    async function createGroup() {
      if (selected.size === 0) return;
      const selectedOrders = orders.filter(o => selected.has(o._id));
      const baseVendor = selectedOrders[0]?.supplier || selectedOrders[0]?.vendor;
      const mixed = selectedOrders.some(o => (o.supplier || o.vendor) !== baseVendor);
      if (mixed) {
        showBoardMessage('Select orders from the same vendor to group.', 'error');
        return;
      }
      const now = new Date();
      const fallbackTitle = baseVendor ? `${baseVendor} - ${formatShortDate(now)} ${formatTimeShort(now)}` : `Group - ${formatShortDate(now)} ${formatTimeShort(now)}`;
      const res = await fetch('/api/order-groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: fallbackTitle,
          supplier: baseVendor || undefined,
          requestedDisplayAt: now.getTime(),
          orderIds: Array.from(selected)
        })
      });
      const data = await res.json();
      const newGroupId = data.groupId || data._id;
      await Promise.all(Array.from(selected).map(id => patchStatusOnly(id, 'Ordered')));
      recordAction({
        undo: { type: 'deleteGroup', payload: { groupId: newGroupId } },
        redo: { type: 'createGroup', payload: { title: fallbackTitle, supplier: baseVendor || undefined, requestedDisplayAt: now.getTime(), orderIds: Array.from(selected) } }
      });
      selected.clear();
      groupVendorNote.textContent = 'Vendor: auto from selection';
      await fetchOrders();
    }

    function resetAddToOrderMode() {
      addToOrderMode = false;
      addToOrderVendor = null;
      renderBoard();
    }

    function startAddToOrderMode() {
      if (!selected.size) return;
      const selectedOrders = orders.filter(o => selected.has(o._id));
      const vendor = getOrderVendor(selectedOrders[0]);
      const mixed = selectedOrders.some(o => getOrderVendor(o) !== vendor);
      if (!vendor || mixed) {
        showBoardMessage('Select parts from the same vendor to add to an order.', 'error');
        return;
      }
      addToOrderVendor = vendor;
      addToOrderMode = true;
      renderBoard();
      showBoardMessage('Tap an existing order with the same vendor to add the selected parts.', 'info', 3000);
    }

    async function addSelectedToGroup(groupId, targetStatus) {
      if (!selected.size) return;
      const ids = Array.from(selected);
      for (const id of ids) {
        await assignGroup(id, groupId);
        if (targetStatus) await patchStatusOnly(id, targetStatus);
      }
      selected.clear();
      updateSelectionBar();
      resetAddToOrderMode();
      await fetchOrders();
    }

    async function addSelectedToOrder(order) {
      if (!order || !selected.size) return;
      const targetVendor = getOrderVendor(order);
      if (addToOrderVendor && targetVendor !== addToOrderVendor) {
        showBoardMessage('Select an order with the same vendor.', 'error');
        return;
      }
      const targetStatus = order.status;
      let groupId = order.groupId || order.group?._id;
      if (!groupId) {
        const now = new Date();
        const title = `${order.supplier || order.vendor || 'Order'} - ${formatShortDate(now)} ${formatTimeShort(now)}`;
        const payloadIds = [order._id, ...Array.from(selected)];
        const res = await fetch('/api/order-groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            supplier: order.supplier || order.vendor || undefined,
            requestedDisplayAt: now.getTime(),
            orderIds: payloadIds
          })
        });
        const data = await res.json();
        groupId = data.groupId || data._id;
        for (const id of Array.from(selected)) {
          if (targetStatus) await patchStatusOnly(id, targetStatus);
        }
      } else {
        for (const id of Array.from(selected)) {
          await assignGroup(id, groupId);
          if (targetStatus) await patchStatusOnly(id, targetStatus);
        }
      }
      selected.clear();
      updateSelectionBar();
      resetAddToOrderMode();
      await fetchOrders();
    }

    async function removePartFromGroup(orderId) {
      await assignGroup(orderId, undefined);
      await patchStatusOnly(orderId, 'Requested');
      await fetchOrders();
    }

    function selectSameVendorRequested() {
      const current = orders.find(o => selected.has(o._id));
      if (!current) return;
      const vendor = getOrderVendor(current);
      if (!vendor) return;
      orders.forEach(o => {
        if (o.status === 'Requested' && getOrderVendor(o) === vendor) {
          selected.add(o._id);
        }
      });
      updateSelectionBar();
      renderBoard();
    }

    // Event wiring
    function showOrdersView() {
      activePrimaryView = 'orders';
      ordersViewBtn?.classList.add('active');
      stockViewBtn?.classList.remove('active');
      if (ordersLayoutRow) ordersLayoutRow.style.display = 'flex';
      if (ordersLayoutToggle) ordersLayoutToggle.style.display = 'inline-flex';
      if (selectionBar) selectionBar.style.display = '';
      if (stockSection) stockSection.style.display = 'none';
      boardSection.style.display = boardBtn.classList.contains('active') ? 'flex' : 'none';
      tableSection.style.display = tableBtn.classList.contains('active') ? 'flex' : 'none';
      if (primaryTitle) primaryTitle.textContent = 'Orders';
      if (primarySubtitle) primarySubtitle.textContent = 'Track parts from request to delivery.';
      updateSearchPlaceholder();
      updateSelectionBar();
      resizeColumns();
      setTimeout(resizeColumns, 30);
    }

    function showStockView() {
      resetAddToOrderMode();
      activePrimaryView = 'stock';
      stockViewBtn?.classList.add('active');
      ordersViewBtn?.classList.remove('active');
      if (ordersLayoutRow) ordersLayoutRow.style.display = 'none';
      if (ordersLayoutToggle) ordersLayoutToggle.style.display = 'none';
      if (selectionBar) selectionBar.style.display = 'none';
      boardSection.style.display = 'none';
      tableSection.style.display = 'none';
      if (stockSection) stockSection.style.display = 'flex';
      if (primaryTitle) primaryTitle.textContent = 'Stock';
      if (primarySubtitle) primarySubtitle.textContent = 'Live view of parts on-hand by location.';
      loadStock();
      updateSearchPlaceholder();
      resizeColumns();
      setTimeout(resizeColumns, 30);
    }

    const switchToBoard = () => {
      if (activePrimaryView !== 'orders') showOrdersView();
      boardBtn.classList.add('active'); tableBtn.classList.remove('active');
      boardSection.style.display = 'flex'; tableSection.style.display = 'none';
      resizeColumns();
      setTimeout(resizeColumns, 30);
    };
    const switchToTable = () => {
      if (activePrimaryView !== 'orders') showOrdersView();
      tableBtn.classList.add('active'); boardBtn.classList.remove('active');
      boardSection.style.display = 'none'; tableSection.style.display = 'flex';
      resizeColumns();
      setTimeout(resizeColumns, 30);
    };
    ordersViewBtn?.addEventListener('click', showOrdersView);
    stockViewBtn?.addEventListener('click', showStockView);
    boardBtn.addEventListener('click', switchToBoard);
    tableBtn.addEventListener('click', switchToTable);
    selectSameVendorBtn?.addEventListener('click', selectSameVendorRequested);
    boardEl?.addEventListener('click', (e) => {
      if (!addToOrderMode) return;
      if (e.target.closest('.to-order-actions') || e.target.closest('.selection-actions')) return;
      if (!e.target.closest('.card')) {
        resetAddToOrderMode();
        renderBoard();
      }
    });
    refreshBtn.addEventListener('click', () => {
      if (activePrimaryView === 'stock') loadStock(); else fetchOrders();
    });
    undoBtn.addEventListener('click', doUndo);
    redoBtn.addEventListener('click', doRedo);
    globalSearch.addEventListener('input', () => {
      if (activePrimaryView === 'stock') {
        clearTimeout(stockSearchTimer);
        stockSearchTimer = setTimeout(() => loadStock(), 250);
      } else {
        renderBoard(); renderTable();
      }
    });
    statusFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    vendorFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    startDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    endDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    stockSubteamFilter?.addEventListener('change', () => { selectedStockSubteam = stockSubteamFilter.value; loadStock(); });
      addStockBtn?.addEventListener('click', () => openStockModal());
      manageSubteamsBtn?.addEventListener('click', async () => { await loadSubteams(); openSubteamsModal(); });
      stockForm?.addEventListener('submit', saveStockForm);
      addToOrderBtn?.addEventListener('click', () => {
        if (addToOrderMode) resetAddToOrderMode(); else startAddToOrderMode();
      });
      selectAllBtn?.addEventListener('click', () => {
        orders.filter(o => o.status === 'Requested').forEach(o => selected.add(o._id));
        updateSelectionBar();
        renderBoard(); renderTable();
      });
      unselectAllBtn?.addEventListener('click', () => {
        selected.clear();
        updateSelectionBar();
        renderBoard(); renderTable();
      });
      deleteStockBtn?.addEventListener('click', async () => {
        const id = stockForm?.elements?.id?.value;
        if (id) {
          if (stockModal) stockModal.style.display = 'none';
          openDeleteStockModal(id);
      }
    });
    cancelStockBtn?.addEventListener('click', () => { if (stockModal) stockModal.style.display = 'none'; resetStockModal(); });
    closeStockModalBtn?.addEventListener('click', () => { if (stockModal) stockModal.style.display = 'none'; resetStockModal(); });
    stockCatalogSearch?.addEventListener('input', () => {
      clearTimeout(stockCatalogSearchTimer);
      stockCatalogSearchTimer = setTimeout(() => searchStockCatalog(stockCatalogSearch.value || ''), 220);
    });
    stockSubteamForm?.addEventListener('submit', saveSubteam);
    clearSubteamFormBtn?.addEventListener('click', () => { stockSubteamForm?.reset(); });
    closeSubteamsModal?.addEventListener('click', () => { if (stockSubteamsModal) stockSubteamsModal.style.display = 'none'; });
    cancelDeleteStock?.addEventListener('click', () => {
      pendingDeleteStockId = null;
      if (stockDeleteModal) stockDeleteModal.style.display = 'none';
    });
    confirmDeleteStock?.addEventListener('click', async () => {
      if (!pendingDeleteStockId) return;
      const id = pendingDeleteStockId;
      pendingDeleteStockId = null;
      if (stockDeleteModal) stockDeleteModal.style.display = 'none';
      await deleteStockItem(id);
    });
    confirmCancel?.addEventListener('click', () => {
      pendingConfirmAction = null;
      if (confirmModal) confirmModal.style.display = 'none';
    });
    confirmOk?.addEventListener('click', async () => {
      if (!pendingConfirmAction) {
        if (confirmModal) confirmModal.style.display = 'none';
        return;
      }
      try {
        const result = pendingConfirmAction();
        if (result instanceof Promise) await result;
        if (confirmStatus) confirmStatus.textContent = '';
        if (confirmModal) confirmModal.style.display = 'none';
      } catch (err) {
        if (confirmStatus) {
          confirmStatus.textContent = err.message || 'Action failed';
          confirmStatus.className = 'error';
        }
      } finally {
        pendingConfirmAction = null;
      }
    });
    groupBtn.addEventListener('click', createGroup);
    deleteSelectedBtn?.addEventListener('click', async () => {
      if (!currentUser?.permissions?.canDeleteOrders) {
        showBoardMessage('No permission to delete orders.', 'error');
        return;
      }
      if (!selected.size) return;
      openConfirm(`Delete ${selected.size} selected item(s)?`, async () => {
        for (const id of Array.from(selected)) {
          const snapshot = snapshotOrder(id);
          await fetch(`/api/orders/${id}`, { method: 'DELETE' });
          if (snapshot) {
            recordAction({
              undo: { type: 'restoreOrder', payload: { order: snapshot, groupId: snapshot.groupId || snapshot.group?._id } },
              redo: { type: 'deleteOrder', payload: { orderId: id } }
            });
          }
        }
        selected.clear();
        await fetchOrders();
      });
    });
    document.getElementById('new-order-btn').addEventListener('click', () => {
      editingOrderId = null;
      orderForm.reset();
      orderForm.elements.quantityRequested.value = 1;
      renderTagOptions([]);
      renderPriorityOptions();
      resetCatalogLookup();
      resetCatalogSavePanel();
      syncCatalogSaveUI();
      setOrderSource('manual');
      if (orderTrackingList) setTrackingRows(orderTrackingList, []);
      if (addOrderTracking) addOrderTracking.disabled = true;
      if (orderTrackingList) orderTrackingList.style.display = 'none';
      modal.style.display = 'flex';
    });
    cancelOrder.addEventListener('click', () => { modal.style.display = 'none'; resetCatalogLookup(); resetCatalogSavePanel(); setOrderSource('manual'); });
    const resetGroupModal = () => {
      groupModal.style.display = 'none';
      groupForm.reset();
      setTrackingRows(groupModalTrackingList, []);
      editingGroupId = null;
      groupMessage.textContent = '';
    };
    closeGroup.addEventListener('click', resetGroupModal);
    cancelGroup.addEventListener('click', resetGroupModal);

    function resetUserForm() {
      userForm?.reset();
      if (userForm?.elements?.id) userForm.elements.id.value = '';
      if (userMessage) {
        userMessage.textContent = '';
        userMessage.className = 'small';
      }
      if (saveUserBtn) saveUserBtn.textContent = 'Create user';
    }

    function closeUserModal() {
      if (userModal) userModal.style.display = 'none';
      resetUserForm();
    }

    function openUserModal(user) {
      resetUserForm();
      if (user) {
        if (userForm?.elements?.id) userForm.elements.id.value = user._id || '';
        if (userForm?.elements?.username) userForm.elements.username.value = user.username || '';
        if (userForm?.elements?.name) userForm.elements.name.value = user.name || '';
        if (userForm?.elements?.role) userForm.elements.role.value = user.role || 'student';
        if (userForm?.elements?.active) userForm.elements.active.value = user.active ? 'true' : 'false';
        if (saveUserBtn) saveUserBtn.textContent = 'Update user';
      }
      if (userModal) userModal.style.display = 'flex';
    }

    newUserBtn?.addEventListener('click', () => openUserModal());
    closeUserModalBtn?.addEventListener('click', closeUserModal);
    cancelUserBtn?.addEventListener('click', closeUserModal);

    function resetVendorForm() {
      vendorForm?.reset();
      if (vendorForm?.elements?.id) vendorForm.elements.id.value = '';
      if (vendorMessage) {
        vendorMessage.textContent = '';
        vendorMessage.className = 'small';
      }
      const resultsEl = document.getElementById('extract-results');
      if (resultsEl) resultsEl.textContent = '';
      const previewNameEl = document.getElementById('preview-name');
      const previewPriceEl = document.getElementById('preview-price');
      const pickNameEl = document.getElementById('pick-name');
      const pickPriceEl = document.getElementById('pick-price');
      const selectorSnippetEl = document.getElementById('selector-snippet');
      if (previewNameEl) previewNameEl.textContent = '';
      if (previewPriceEl) previewPriceEl.textContent = '';
      if (pickNameEl) pickNameEl.innerHTML = '';
      if (pickPriceEl) pickPriceEl.innerHTML = '';
      if (selectorSnippetEl) selectorSnippetEl.value = '';
      if (testUrl) testUrl.value = '';
    }

    function closeVendorModal() {
      if (vendorModal) vendorModal.style.display = 'none';
      resetVendorForm();
    }

    function openVendorModal(vendor) {
      resetVendorForm();
      if (vendor) {
        if (vendorForm?.elements?.id) vendorForm.elements.id.value = vendor._id || '';
        vendorForm.elements.vendor.value = vendor.vendor || '';
        vendorForm.elements.baseUrl.value = vendor.baseUrl || '';
        vendorForm.elements.productUrlTemplate.value = vendor.productUrlTemplate || '';
        vendorForm.elements.partNumberExample.value = vendor.partNumberExample || '';
        vendorForm.elements.partNumberPattern.value = vendor.partNumberPattern || '';
        vendorForm.elements.nameSelector.value = vendor.nameSelector || '';
        vendorForm.elements.priceSelector.value = vendor.priceSelector || '';
        vendorForm.elements.notes.value = vendor.notes || '';
      }
      if (vendorModal) vendorModal.style.display = 'flex';
    }

    newVendorBtn?.addEventListener('click', () => openVendorModal());
    closeVendorModalBtn?.addEventListener('click', closeVendorModal);
    cancelVendorBtn?.addEventListener('click', closeVendorModal);

    attachBackdropClose(modal, () => { modal.style.display = 'none'; });
    attachBackdropClose(groupModal, resetGroupModal);
    attachBackdropClose(loginModal, () => { loginModal.style.display = 'none'; });
    attachBackdropClose(accountModal, () => { accountModal.style.display = 'none'; });
    attachBackdropClose(tagsModal, () => { tagsModal.style.display = 'none'; });
    attachBackdropClose(adminModal, () => { adminModal.style.display = 'none'; });
    attachBackdropClose(catalogModal, () => { catalogModal.style.display = 'none'; if (catalogItemModal) catalogItemModal.style.display = 'none'; });
    attachBackdropClose(catalogCategoryNewModal, () => { catalogCategoryNewModal.style.display = 'none'; });
    attachBackdropClose(catalogCategoryEditModal, () => { catalogCategoryEditModal.style.display = 'none'; });
    attachBackdropClose(catalogItemModal, () => { catalogItemModal.style.display = 'none'; resetCatalogItemForm(); });
    attachBackdropClose(catalogRequestModal, () => { catalogRequestModal.style.display = 'none'; pendingCatalogRequest = null; });
    attachBackdropClose(stockModal, () => { if (stockModal) stockModal.style.display = 'none'; resetStockModal(); });
    attachBackdropClose(stockSubteamsModal, () => { if (stockSubteamsModal) stockSubteamsModal.style.display = 'none'; });
    attachBackdropClose(stockDeleteModal, () => { if (stockDeleteModal) stockDeleteModal.style.display = 'none'; pendingDeleteStockId = null; });
    attachBackdropClose(confirmModal, () => { if (confirmModal) confirmModal.style.display = 'none'; pendingConfirmAction = null; });
    attachBackdropClose(vendorModal, closeVendorModal);
    attachBackdropClose(userModal, closeUserModal);

    function findVendorConfig(name) {
      if (!name) return null;
      const lower = name.toLowerCase();
      return vendorConfigs.find(v => (v.vendor || '').toLowerCase() === lower) || null;
    }

    function deriveUrl(config, partNum, link) {
      if (link) return link;
      if (!config) return null;
      if (config.productUrlTemplate && partNum) {
        return config.productUrlTemplate.replace('{partNumber}', partNum);
      }
      if (config.baseUrl && partNum) {
        return `${config.baseUrl.replace(/\/$/, '')}/${partNum}`;
      }
      return null;
    }

    function extractPartNumberFromUrl(config, link) {
      if (!config || !link) return null;
      const cleanLink = link.replace(/\/+$/, '');
      if (config.productUrlTemplate && config.productUrlTemplate.includes('{partNumber}')) {
        // Escape the template and swap the placeholder with a capture group.
        const pattern = config.productUrlTemplate
          .replace(/\{partNumber\}/g, '__PART__')
          .replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')
          .replace(/__PART__/g, '([^/?#]+)');
        const regex = new RegExp('^' + pattern.replace(/\\\/+$/, '') + '\\/?$', 'i');
        const m = cleanLink.match(regex);
        if (m && m[1]) return decodeURIComponent(m[1]);
      }
      if (config.partNumberPattern) {
        const regex = new RegExp(config.partNumberPattern, 'i');
        const m = cleanLink.match(regex);
        if (m && m[1]) return m[1];
      }
      const parts = cleanLink.split('/').filter(Boolean);
      return parts[parts.length - 1] || null;
    }

    function parsePrice(text) {
      if (!text) return undefined;
      const num = parseFloat(text.replace(/[^0-9\\.]+/g, ''));
      return Number.isFinite(num) ? num : undefined;
    }

    async function fetchCatalogDetails() {
      if (!currentUser) return;
      const vendorInput = catalogItemForm?.elements?.vendor;
      const partInput = catalogItemForm?.elements?.vendorPartNumber;
      const linkInput = catalogItemForm?.elements?.supplierLink;
      const nameInput = catalogItemForm?.elements?.name;
      const priceInput = catalogItemForm?.elements?.unitCost;
      const vendor = vendorInput?.value?.trim();
      let partNumber = partInput?.value?.trim();
      const link = linkInput?.value?.trim();
      const config = detectVendor(partNumber, link) || findVendorConfig(vendor);
      if (!partNumber && config && link) {
        const extracted = extractPartNumberFromUrl(config, link);
        if (extracted && partInput) {
          partInput.value = extracted;
          partNumber = extracted;
        }
      }
      if (config?.vendor && vendorInput) vendorInput.value = config.vendor;
      const url = deriveUrl(config, partNumber, link) || link;
      catalogItemMessage.textContent = 'Fetching...';
      catalogItemMessage.className = 'small';
      if (!url) {
        catalogItemMessage.textContent = 'Provide a vendor link or part number first.';
        catalogItemMessage.className = 'error';
        return;
      }
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url,
            selectors: {
              nameSelector: config?.nameSelector,
              priceSelector: config?.priceSelector,
            }
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Fetch failed');

        const pickName = data.picks?.name || data.candidates?.titles?.[0]?.text;
        const pickPrice = data.picks?.price || data.candidates?.prices?.[0]?.text;

        if (pickName && nameInput && !nameInput.value) nameInput.value = pickName;
        const priceNum = parsePrice(pickPrice);
        if (priceNum !== undefined && priceInput) {
          priceInput.value = priceNum;
        }
        if (linkInput && !linkInput.value) linkInput.value = url;
        if (config?.vendor && vendorInput) vendorInput.value = config.vendor;

        catalogItemMessage.textContent = 'Fetched. Verify fields before saving.';
        catalogItemMessage.className = 'success';
      } catch (err) {
        catalogItemMessage.textContent = 'Fetch failed. Fill manually.';
        catalogItemMessage.className = 'error';
      }
    }

    async function assignGroup(orderId, groupId) {
      return fetch(`/api/orders/${orderId}/group`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupId: groupId === undefined ? undefined : groupId })
      });
    }

    async function patchStatusOnly(id, status, tracking) {
      const trackingList = Array.isArray(tracking)
        ? tracking
        : (tracking ? [{ carrier: 'unknown', trackingNumber: tracking }] : undefined);
      await fetch(`/api/orders/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          tracking: trackingList,
          trackingNumber: trackingList?.[0]?.trackingNumber
        })
      });
    }

    async function moveOrderToStatus(orderId, status) {
      const prev = snapshotOrder(orderId);
      if (!prev) return;
      if (status !== 'Requested' && !canLeaveRequested(prev)) {
        showBoardMessage('Create an order first. Drag into a group to move it.', 'error');
        return;
      }
      if (status === prev.status) return;
      await assignGroup(orderId, undefined);
      await patchStatusOnly(orderId, status);
      recordAction({
        undo: { type: 'updateStatus', payload: { orderId, status: prev?.status, groupId: prev?.groupId || prev?.group?._id } },
        redo: { type: 'updateStatus', payload: { orderId, status, groupId: undefined } }
      });
      await fetchOrders();
      selected.delete(orderId);
      updateSelectionBar();
    }

    async function updateGroupStatus(groupId, status) {
      const affected = orders.filter(o => (o.groupId && o.groupId === groupId) || (o.group && o.group._id === groupId));
      const snapshot = affected.map(o => ({
        orderId: o._id,
        status: o.status,
        groupId: o.groupId || o.group?._id
      }));
      for (const o of affected) {
        await patchStatusOnly(o._id, status);
      }
      if (snapshot.length) {
        recordAction({
          undo: { type: 'bulkStatus', payload: { entries: snapshot } },
          redo: { type: 'bulkStatus', payload: { entries: affected.map(o => ({ orderId: o._id, status, groupId: o.groupId || o.group?._id })) } }
        });
      }
      await fetchOrders();
    }

    function fetchOrderDetails(configHint) {
      return async () => {
        const formData = new FormData(orderForm);
        const partInput = orderForm.elements.vendorPartNumber;
        const linkInput = orderForm.elements.partLink;
        const vendorInput = orderForm.elements.vendor;
        let partNum = (formData.get('vendorPartNumber') || '').toString().trim();
        const link = (formData.get('partLink') || '').toString().trim();
        const vendorName = (formData.get('vendor') || '').toString().trim();
        let config = configHint || findVendorConfig(vendorName) || detectVendor(partNum, link);
        if (!config && vendorName) config = findVendorConfig(vendorName);
        if (!partNum && config && link) {
          const extracted = extractPartNumberFromUrl(config, link);
          if (extracted && partInput) {
            partInput.value = extracted;
            partNum = extracted;
          }
        }
        if (config?.vendor && vendorInput) vendorInput.value = config.vendor;
        const url = deriveUrl(config, partNum, link) || link;
        if (!url) {
          orderMessage.textContent = 'Provide a link or part number (for vendors with part number templates).';
          orderMessage.className = 'error';
          return;
        }
        if (config && !config.productUrlTemplate && !link) {
          orderMessage.textContent = 'This vendor needs a link to fetch details.';
          orderMessage.className = 'error';
          return;
        }
        orderMessage.textContent = 'Fetching...';
        orderMessage.className = 'small';
        try {
          const res = await fetch('/api/vendors/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              url,
              selectors: {
                nameSelector: config?.nameSelector,
                priceSelector: config?.priceSelector,
              }
            })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Fetch failed');

          const pickName = data.picks?.name || data.candidates?.titles?.[0]?.text;
          const pickPrice = data.picks?.price || data.candidates?.prices?.[0]?.text;

          if (pickName && !orderForm.elements.partName.value) orderForm.elements.partName.value = pickName;
          const priceNum = parsePrice(pickPrice);
          if (priceNum !== undefined) {
            orderForm.elements.unitCost.value = priceNum;
          }
          if (!orderForm.elements.partLink.value) orderForm.elements.partLink.value = url;
          if (config?.vendor && orderForm.elements.vendor && !orderForm.elements.vendor.value) {
            orderForm.elements.vendor.value = config.vendor;
          }

          orderMessage.textContent = 'Fetched. Verify fields before submitting.';
          orderMessage.className = 'success';
          await checkCatalogPresence();
        } catch (err) {
          orderMessage.textContent = 'Fetch failed. Fill manually.';
          orderMessage.className = 'error';
        }
      };
    }

    fetchProduct.addEventListener('click', fetchOrderDetails());

    function flattenCatalogMatches(items = []) {
      return items.map(item => ({
        id: item._id || item.id,
        label: item.name,
        partName: item.name,
        path: item.fullPath || (item.categoryPathLabels || []).join(' / '),
        vendor: item.vendor,
        vendorPartNumber: item.vendorPartNumber,
        supplierLink: item.supplierLink,
        unitCost: item.unitCost,
        defaultQuantity: item.defaultQuantity
      })).slice(0, 40);
    }

    function renderCatalogLookupList() {
      if (!catalogLookupResults) return;
      if (!catalogLookupMatches.length) {
        catalogLookupResults.innerHTML = '<div class="small" style="padding:6px 8px;">No matches yet.</div>';
        catalogLookupResults.style.display = 'block';
        return;
      }
      catalogLookupResults.innerHTML = catalogLookupMatches.map((m, idx) => `
        <div class="tag-picker-option" data-idx="${idx}" style="padding:6px 8px; cursor:pointer; border:1px solid var(--border); border-radius:8px; margin-bottom:4px;">
          <div style="font-weight:700;">${escapeHtml(m.label)}</div>
          <div class="small">${escapeHtml(m.path || '')}${m.vendor ? ' · ' + escapeHtml(m.vendor) : ''}${m.vendorPartNumber ? ' · ' + escapeHtml(m.vendorPartNumber) : ''}</div>
        </div>
      `).join('');
      catalogLookupResults.style.display = 'block';
      catalogLookupResults.querySelectorAll('.tag-picker-option').forEach(el => {
        el.addEventListener('click', () => {
          const idx = Number(el.dataset.idx);
          const match = catalogLookupMatches[idx];
          if (match) applyCatalogSelection(match);
        });
      });
    }

    async function performCatalogLookup(term) {
      const q = (term || '').trim();
      if (!q) {
        if (catalogLookupResults) catalogLookupResults.style.display = 'none';
        return;
      }
      try {
        const res = await fetch(`/api/catalog/items?search=${encodeURIComponent(q)}&includeDescendants=true`);
        const data = await res.json();
        catalogLookupMatches = flattenCatalogMatches(data.items || []);
        renderCatalogLookupList();
      } catch (err) {
        console.warn('Catalog lookup failed', err);
      }
    }

    function applyCatalogSelection(match) {
      if (!match || !orderForm) return;
      selectedCatalogMatch = match;
      if (orderForm.elements.partName && !orderForm.elements.partName.value) orderForm.elements.partName.value = match.partName || match.label || '';
      if (orderForm.elements.vendor && match.vendor) orderForm.elements.vendor.value = match.vendor;
      if (orderForm.elements.vendorPartNumber && match.vendorPartNumber) orderForm.elements.vendorPartNumber.value = match.vendorPartNumber;
      if (orderForm.elements.partLink && match.supplierLink) orderForm.elements.partLink.value = match.supplierLink;
      if (orderForm.elements.unitCost && match.unitCost !== undefined) orderForm.elements.unitCost.value = match.unitCost;
      if (orderForm.elements.quantityRequested && match.defaultQuantity) orderForm.elements.quantityRequested.value = match.defaultQuantity;
      if (catalogLookupSelected) catalogLookupSelected.textContent = `Using catalog: ${match.label}${match.path ? ' · ' + match.path : ''}`;
      if (catalogLookupResults) catalogLookupResults.style.display = 'none';
      if (catalogSaveCategory && match.path) catalogSaveCategory.value = match.path;
      setOrderSource('catalog');
      catalogAlreadySaved = true;
      catalogAlreadySavedItem = match;
      syncCatalogSaveUI();
      scheduleCatalogPresenceCheck();
      renderCatalogRequestTagOptions(getCatalogRequestTagIds());
    }

    function resetCatalogLookup() {
      catalogLookupMatches = [];
      selectedCatalogMatch = null;
      catalogAlreadySaved = false;
      catalogAlreadySavedItem = null;
      if (catalogLookupResults) {
        catalogLookupResults.style.display = 'none';
        catalogLookupResults.innerHTML = '';
      }
      if (catalogLookupSelected) catalogLookupSelected.textContent = '';
      if (catalogLookupInput) catalogLookupInput.value = '';
      syncCatalogSaveUI();
    }

    function toggleCatalogSaveFields(show) {
      if (!catalogSaveFields) return;
      const open = show !== undefined ? show : saveToCatalogToggle?.checked;
      catalogSaveFields.style.display = open ? 'grid' : 'none';
    }

    function resetCatalogSavePanel(clearStatus = true) {
      if (saveToCatalogToggle) saveToCatalogToggle.checked = false;
      if (catalogSaveCategory) catalogSaveCategory.value = '';
      if (catalogSaveSubteam) catalogSaveSubteam.value = '';
      if (catalogSaveType) catalogSaveType.value = '';
      if (catalogSaveMessage) { catalogSaveMessage.textContent = ''; catalogSaveMessage.className = 'small'; }
      if (clearStatus) {
        catalogAlreadySaved = false;
        catalogAlreadySavedItem = null;
        if (catalogSaveStatus) { catalogSaveStatus.textContent = ''; catalogSaveStatus.className = 'small'; }
      }
      toggleCatalogSaveFields(false);
    }

    function syncCatalogSaveUI() {
      const canEdit = currentUser?.permissions?.canEditInventoryCatalog;
      const showToggle = canEdit && !catalogAlreadySaved;
      if (catalogSaveContainer) catalogSaveContainer.style.display = showToggle ? 'block' : 'none';
      if (catalogSaveStatus) {
        if (catalogAlreadySaved) {
          const name = catalogAlreadySavedItem?.name || 'catalog item';
          const path = catalogAlreadySavedItem?.fullPath || (catalogAlreadySavedItem?.categoryPathLabels || []).join(' / ');
          const detail = path ? ` (${path})` : '';
          catalogSaveStatus.textContent = `Already in catalog: ${name}${detail}`;
          catalogSaveStatus.className = 'success small';
        } else {
          catalogSaveStatus.textContent = '';
          catalogSaveStatus.className = 'small';
        }
      }
      if (!showToggle) {
        if (saveToCatalogToggle) saveToCatalogToggle.checked = false;
        toggleCatalogSaveFields(false);
      }
    }

    function normalizeLink(link) {
      return (link || '').trim().replace(/\/+$/, '');
    }

    async function checkCatalogPresence() {
      if (!orderForm || !currentUser) {
        catalogAlreadySaved = false;
        catalogAlreadySavedItem = null;
        syncCatalogSaveUI();
        return;
      }
      const partNum = (orderForm.elements.vendorPartNumber?.value || '').trim();
      const link = (orderForm.elements.partLink?.value || '').trim();
      if (selectedCatalogMatch) {
        catalogAlreadySaved = true;
        catalogAlreadySavedItem = selectedCatalogMatch;
        syncCatalogSaveUI();
        return;
      }
      if (!partNum && !link) {
        catalogAlreadySaved = false;
        catalogAlreadySavedItem = null;
        syncCatalogSaveUI();
        return;
      }
      const terms = [partNum, link].filter(Boolean);
      let found = null;
      for (const term of terms) {
        try {
          const res = await fetch(`/api/catalog/items?search=${encodeURIComponent(term)}&includeDescendants=true`);
          const data = await res.json();
          const items = data.items || [];
          const linkNorm = normalizeLink(link);
          const match = items.find(i => {
            const skuMatch = partNum && (i.vendorPartNumber || '').toLowerCase() === partNum.toLowerCase();
            const linkMatch = linkNorm && normalizeLink(i.supplierLink || '') === linkNorm;
            return skuMatch || linkMatch;
          });
          if (match) {
            found = match;
            break;
          }
        } catch (err) {
          console.warn('catalog presence check failed', err);
        }
      }
      catalogAlreadySaved = Boolean(found);
      catalogAlreadySavedItem = found;
      syncCatalogSaveUI();
    }

    function scheduleCatalogPresenceCheck() {
      clearTimeout(catalogPresenceTimer);
      catalogPresenceTimer = setTimeout(checkCatalogPresence, 250);
    }

    async function saveCurrentOrderToCatalog(force = false) {
      if (!currentUser?.permissions?.canEditInventoryCatalog) return { skipped: true };
      if (!force && !saveToCatalogToggle?.checked) return { skipped: true };
      const name = orderForm?.elements?.partName?.value?.trim();
      if (!name) {
        if (catalogSaveMessage) {
          catalogSaveMessage.textContent = 'Enter a part name before saving to catalog.';
          catalogSaveMessage.className = 'error';
        }
        return { error: 'missing name' };
      }
      const path = (catalogSaveCategory?.value || selectedCatalogMatch?.path || '').split('/').map(p => p.trim()).filter(Boolean);
      const payload = {
        name,
        categoryPath: path,
        subteam: catalogSaveSubteam?.value?.trim() || undefined,
        type: catalogSaveType?.value?.trim() || undefined,
        vendor: orderForm?.elements?.vendor?.value || undefined,
        vendorPartNumber: orderForm?.elements?.vendorPartNumber?.value || undefined,
        supplierLink: orderForm?.elements?.partLink?.value || undefined,
        unitCost: orderForm?.elements?.unitCost?.value ? Number(orderForm.elements.unitCost.value) : undefined,
        aliases: []
      };
      try {
        const res = await fetch('/api/catalog/items', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save');
        if (catalogSaveMessage) {
          catalogSaveMessage.textContent = 'Saved to catalog.';
          catalogSaveMessage.className = 'success';
        }
        if (currentUser?.permissions?.canEditInventoryCatalog) {
          refreshCatalogView();
        }
        await checkCatalogPresence();
        return { ok: true, id: data.id };
      } catch (err) {
        if (catalogSaveMessage) {
          catalogSaveMessage.textContent = err.message || 'Failed to save to catalog.';
          catalogSaveMessage.className = 'error';
        }
        return { error: err.message };
      }
    }

    saveToCatalogToggle?.addEventListener('change', () => toggleCatalogSaveFields());
    catalogLookupInput?.addEventListener('input', () => {
      clearTimeout(catalogLookupTimer);
      catalogLookupTimer = setTimeout(() => performCatalogLookup(catalogLookupInput.value), 200);
    });
    catalogLookupInput?.addEventListener('focus', () => {
      if (catalogLookupInput.value) performCatalogLookup(catalogLookupInput.value);
    });
    document.addEventListener('click', (e) => {
      if (!catalogLookupResults || !catalogLookupInput) return;
      if (!catalogLookupResults.contains(e.target) && e.target !== catalogLookupInput) {
        catalogLookupResults.style.display = 'none';
      }
    });
    orderForm?.elements?.vendorPartNumber?.addEventListener('input', scheduleCatalogPresenceCheck);
    orderForm?.elements?.partLink?.addEventListener('input', scheduleCatalogPresenceCheck);

    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(orderForm);
      const payload = Object.fromEntries(formData.entries());
      payload.quantityRequested = Number(payload.quantityRequested || 0);
      payload.unitCost = payload.unitCost ? Number(payload.unitCost) : undefined;
      payload.fetchedPrice = payload.unitCost || undefined;
      payload.tracking = [];
      payload.trackingNumber = undefined;
      payload.tags = tagSelect ? Array.from(tagSelect.selectedOptions).map(o => o.value) : [];
      if (!payload.vendor) {
        const auto = detectVendor(payload.vendorPartNumber, payload.partLink);
        if (auto?.vendor) {
          payload.vendor = auto.vendor;
          if (orderForm?.elements?.vendor) orderForm.elements.vendor.value = auto.vendor;
        }
      }
      payload.supplier = payload.vendor || payload.supplier;
      orderMessage.textContent = 'Submitting...';
      orderMessage.className = 'small';
      try {
        if (editingOrderId) {
          const prev = snapshotOrder(editingOrderId);
          await fetch(`/api/orders/${editingOrderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (prev) {
            recordAction({
              undo: { type: 'updateOrder', payload: { orderId: editingOrderId, data: {
                partName: prev.partName,
                quantityRequested: prev.quantityRequested,
                priority: prev.priority,
                supplier: prev.supplier,
                vendor: prev.vendor,
                partLink: prev.partLink,
                vendorPartNumber: prev.vendorPartNumber,
                trackingNumber: prev.trackingNumber,
                status: prev.status,
                unitCost: prev.unitCost,
                fetchedPrice: prev.fetchedPrice,
                notes: prev.notes
              }}},
              redo: { type: 'updateOrder', payload: { orderId: editingOrderId, data: payload } }
            });
          }
          orderMessage.textContent = 'Order updated.';
        } else {
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          const newId = data.order?.orderId || data.orderId || data.order?._id;
          recordAction({
            undo: { type: 'deleteOrder', payload: { orderId: newId } },
            redo: { type: 'restoreOrder', payload: { order: payload } }
          });
          orderMessage.textContent = 'Order created.';
        }
        if (currentUser?.permissions?.canEditInventoryCatalog && saveToCatalogToggle?.checked) {
          await saveCurrentOrderToCatalog(true);
        }
        orderMessage.className = 'success';
        modal.style.display = 'none';
        orderForm.reset();
        resetCatalogLookup();
        resetCatalogSavePanel();
        editingOrderId = null;
        if (orderTrackingList) setTrackingRows(orderTrackingList, []);
        await fetchOrders();
      } catch (err) {
        orderMessage.textContent = 'Failed to create order';
        orderMessage.className = 'error';
      }
    });

    adminBtn.addEventListener('click', () => {
      adminModal.style.display = 'flex';
      updateAdminTabsVisibility();
      const allowed = allowedAdminTabs();
      if (!allowed.length) { adminModal.style.display = 'none'; return; }
      const target = allowed[0];
      if (allowed.includes('users')) {
        loadUsers();
      }
      if (allowed.includes('roles')) loadRoles();
      if (allowed.includes('tracking')) loadTrackingSettings();
      if (allowed.includes('vendors')) loadVendors();
      showAdminSection(target);
    });
    tagsBtn?.addEventListener('click', () => {
      if (!currentUser) return;
      tagsModal.style.display = 'flex';
      syncTagEditUI();
      loadTags();
      loadPriorityTags();
      showTagsModalTab('tags');
    });
    tagsTabTags?.addEventListener('click', () => showTagsModalTab('tags'));
    tagsTabPriorities?.addEventListener('click', () => showTagsModalTab('priorities'));
    closeTags?.addEventListener('click', () => { tagsModal.style.display = 'none'; });
    closeAdmin.addEventListener('click', () => { adminModal.style.display = 'none'; resetCatalogItemForm(); closeVendorModal(); });
    function updateCatalogEditVisibility() {
      const canEdit = currentUser?.permissions?.canEditInventoryCatalog;
      if (catalogItemForm) catalogItemForm.style.display = canEdit ? catalogItemForm.style.display : 'none';
      if (newCatalogItemBtn) newCatalogItemBtn.style.display = canEdit ? 'inline-flex' : 'none';
      if (deleteCatalogItemBtn) deleteCatalogItemBtn.style.display = canEdit ? 'inline-flex' : 'none';
      if (fetchCatalogProductBtn) fetchCatalogProductBtn.style.display = canEdit ? 'inline-flex' : 'none';
      if (catalogNewCategoryBtn) catalogNewCategoryBtn.style.display = canEdit ? 'inline-flex' : 'none';
    }

    function openCatalogModal() {
      if (!currentUser) return;
      resetCatalogItemForm();
      currentCatalogCategoryId = 'root';
      selectedCatalogCategoryId = null;
      catalogNavStack = [];
      updateCatalogEditVisibility();
      updateCatalogItemHint();
      catalogModal.style.display = 'flex';
      refreshCatalogCategories();
      refreshCatalogItems();
      renderCatalogSaveCategoryOptions();
    }

    catalogBtn.addEventListener('click', openCatalogModal);
    closeCatalog?.addEventListener('click', () => { catalogModal.style.display = 'none'; if (catalogItemModal) catalogItemModal.style.display = 'none'; });
    accountBtn.addEventListener('click', () => {
      accountModal.style.display = 'flex';
    });

    function openGroupModal(data) {
      editingGroupId = data?.id || null;
      groupForm.elements.id.value = data?.id || '';
      groupForm.elements.title.value = data?.title || '';
      const parts = orders.filter(o => o.groupId === data?.id || o.group?._id === data?.id).map(o => ({ id: o._id, label: o.partName || o.vendorPartNumber || o.productCode || o._id }));
      setTrackingRows(groupModalTrackingList, data?.tracking?.length ? data.tracking : (data?.trackingNumber ? [{ carrier: 'unknown', trackingNumber: data.trackingNumber }] : []), parts);
      groupForm.elements.notes.value = data?.notes || '';
      groupMessage.textContent = '';
      groupModal.style.display = 'flex';
    }

    groupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(groupForm);
      const payload = Object.fromEntries(formData.entries());
      const tracking = collectTrackingRows(groupModalTrackingList);
      const id = payload.id;
      groupMessage.textContent = 'Saving...';
      groupMessage.className = 'small';
      try {
        await fetch(`/api/order-groups/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: payload.title || undefined,
            trackingNumber: tracking[0]?.trackingNumber || undefined,
            tracking: tracking.length ? tracking : [],
            notes: payload.notes || undefined
          })
        });
        groupMessage.textContent = 'Saved.';
        groupMessage.className = 'success';
        resetGroupModal();
        await fetchOrders();
      } catch (err) {
        groupMessage.textContent = 'Failed to save group';
        groupMessage.className = 'error';
      }
    });

    async function loadVendors() {
      if (!currentUser) return;
      vendorList.textContent = 'Loading...';
      try {
        const res = await fetch('/api/vendors/configs');
        const data = await res.json();
        vendorConfigs = data.vendors || [];
        renderVendorOptions();
        if (!vendorConfigs.length) {
          vendorList.innerHTML = '<div class="empty">No vendor configs yet. Click "New vendor" to add one.</div>';
          return;
        }
        vendorList.innerHTML = vendorConfigs.map(v => `
          <div class="card" data-id="${v._id}" style="margin-bottom:8px;">
            <div class="flex-between">
              <div>
                <h4 style="margin:0 0 4px;">${v.vendor}</h4>
                <div class="small">${v.baseUrl || ''}</div>
                <div class="small">Template: ${v.productUrlTemplate || ''}</div>
                <div class="small">Selectors: ${v.nameSelector || '-'} | ${v.priceSelector || '-'}</div>
              </div>
              <div class="flex-between" style="gap:8px;">
                <button class="btn ghost" data-action="edit">Edit</button>
                <button class="btn ghost" data-action="delete" style="color:var(--danger);">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        vendorList.querySelectorAll('button[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const v = vendorConfigs.find(x => x._id === id);
            if (!v) return;
            openVendorModal(v);
          });
        });

        vendorList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            if (!id) return;
            openConfirm('Delete this vendor config?', async () => {
              await fetch(`/api/vendors/configs/${id}`, { method: 'DELETE' });
              loadVendors();
            });
          });
        });
      } catch (e) {
        vendorList.textContent = 'Failed to load vendors';
      }
    }

    function categoryPathLabel(cat) {
      if (!cat) return '';
      const path = cat.path || [];
      return path.length ? path.join(' / ') : cat.name || '';
    }

    function currentCategory() {
      if (!currentCatalogCategoryId || currentCatalogCategoryId === 'root') return null;
      return catalogCategories.find(c => String(c._id) === String(currentCatalogCategoryId)) || null;
    }
    function renderCatalogSaveCategoryOptions() {
      if (!catalogSaveCategory) return;
      const options = ['<option value="">Select category</option>'].concat(
        catalogCategories
          .slice()
          .sort((a, b) => (a.path || []).join(' / ').localeCompare((b.path || []).join(' / ')))
          .map(c => `<option value="${(c.path || []).join('/')}">${escapeHtml((c.path || []).join(' / '))}</option>`)
      );
      catalogSaveCategory.innerHTML = options.join('');
    }

    function getDescendantIds(rootId) {
      const set = new Set();
      const walk = (pid) => {
        catalogCategories.filter(c => String(c.parentId || '') === String(pid)).forEach(child => {
          const cid = child._id?.toString();
          if (cid && !set.has(cid)) {
            set.add(cid);
            walk(cid);
          }
        });
      };
      walk(rootId);
      return set;
    }

    function renderEditCategoryParentOptions(cat) {
      if (!catalogCategoryEditForm) return;
      const select = catalogCategoryEditForm.elements.parentId;
      if (!select) return;
      const exclude = new Set([cat?._id?.toString()]);
      getDescendantIds(cat?._id)?.forEach(id => exclude.add(id));
      const options = ['<option value="">(Root)</option>'].concat(
        catalogCategories
          .filter(c => !exclude.has(c._id?.toString()))
          .slice()
          .sort((a, b) => (a.path || []).join(' / ').localeCompare((b.path || []).join(' / ')))
          .map(c => `<option value="${c._id}" ${String(cat?.parentId || '') === String(c._id) ? 'selected' : ''}>${escapeHtml((c.path || []).join(' / ') || c.name || '')}</option>`)
      );
      select.innerHTML = options.join('');
    }

    function renderCatalogCategoriesList() {
      if (!catalogCategoryList) return;
      const cat = currentCategory();
      const parentId = cat?.parentId ? cat.parentId.toString() : null;
      const children = catalogCategories.filter(c => {
        const pid = c.parentId ? c.parentId.toString() : null;
        return pid === (currentCatalogCategoryId === 'root' ? null : currentCatalogCategoryId.toString());
      });
      const pathLabels = cat?.path || [];
      catalogPathDisplay.textContent = pathLabels.length ? pathLabels.join(' / ') : 'Top level';
      catalogBackBtn.style.display = cat ? 'inline-flex' : 'none';
      if (!children.length) {
        catalogCategoryList.className = 'empty';
        catalogCategoryList.textContent = 'No subcategories here.';
        return;
      }
      catalogCategoryList.className = '';
      catalogCategoryList.innerHTML = children.map(c => `
        <div class="card" data-id="${c._id}" style="margin-bottom:6px; cursor:pointer;">
          <div class="flex-between" style="align-items:center; gap:8px;">
            <div>
              <div style="font-weight:700;">${escapeHtml(c.name)}</div>
              <div class="small">${escapeHtml((c.path || []).join(' / '))}</div>
            </div>
            ${currentUser?.permissions?.canEditInventoryCatalog ? `<div class="flex-between" style="gap:6px;">
              <button class="btn ghost" data-action="edit" style="padding:6px 10px;">Edit</button>
              <button class="btn ghost" data-action="delete" style="color:var(--danger); padding:6px 10px;">Delete</button>
            </div>` : ''}
          </div>
        </div>
      `).join('');
      catalogCategoryList.querySelectorAll('.card').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.dataset.id;
          if (!id) return;
          selectCatalogCategory(id);
        });
        el.querySelectorAll('button[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = el.dataset.id;
            const cat = catalogCategories.find(c => String(c._id) === String(id));
            if (cat) openEditCategoryModal(cat);
          });
        });
        el.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const id = el.dataset.id;
            if (!id) return;
            openConfirm('Delete this category? Subcategories will also be removed if cascade is allowed.', async () => {
              await fetch(`/api/catalog/categories/${id}?cascade=true`, { method: 'DELETE' });
              await refreshCatalogCategories();
              await refreshCatalogItems();
            });
          });
        });
      });
    }

    function openNewCategoryModal() {
      if (!currentUser?.permissions?.canEditInventoryCatalog) return;
      if (catalogCategoryNewForm) catalogCategoryNewForm.reset();
      if (catalogCategoryNewMessage) { catalogCategoryNewMessage.textContent = ''; catalogCategoryNewMessage.className = 'small'; }
      const cat = currentCategory();
      const path = cat?.path?.join(' / ') || (cat?.name || '') || 'Top level';
      if (catalogCategoryNewPath) catalogCategoryNewPath.textContent = `Parent: ${path}`;
      if (catalogCategoryNewModal) catalogCategoryNewModal.style.display = 'flex';
    }

    function openEditCategoryModal(cat) {
      if (!currentUser?.permissions?.canEditInventoryCatalog || !cat) return;
      if (catalogCategoryEditForm) {
        catalogCategoryEditForm.reset();
        catalogCategoryEditForm.elements.id.value = cat._id || cat.id || '';
        catalogCategoryEditForm.elements.name.value = cat.name || '';
      }
      if (catalogCategoryEditMessage) { catalogCategoryEditMessage.textContent = ''; catalogCategoryEditMessage.className = 'small'; }
      if (catalogCategoryEditPath) catalogCategoryEditPath.textContent = (cat.path || []).join(' / ');
      renderEditCategoryParentOptions(cat);
      if (catalogCategoryEditModal) catalogCategoryEditModal.style.display = 'flex';
    }

    async function refreshCatalogCategories() {
      if (catalogCategoryList) catalogCategoryList.textContent = 'Loading categories...';
      try {
        const res = await fetch('/api/catalog/categories');
        const data = await res.json();
        catalogCategories = data.categories || [];
        catalogTree = data.tree || [];
        const exists = currentCatalogCategoryId === 'root' || catalogCategories.some(c => String(c._id) === String(currentCatalogCategoryId));
        if (!exists) {
          currentCatalogCategoryId = 'root';
          selectedCatalogCategoryId = null;
        }
        renderCatalogCategoriesList();
        renderCatalogSaveCategoryOptions();
      } catch (err) {
        if (catalogCategoryList) {
          catalogCategoryList.textContent = 'Failed to load categories';
        }
      }
    }

    function selectCatalogCategory(id) {
      currentCatalogCategoryId = id || 'root';
      selectedCatalogCategoryId = id || null;
      renderCatalogCategoriesList();
      refreshCatalogItems();
      updateCatalogItemHint();
    }
    refreshCatalogCategoriesBtn?.addEventListener('click', refreshCatalogCategories);
    catalogNewCategoryBtn?.addEventListener('click', openNewCategoryModal);
    catalogCategoryNewCancel?.addEventListener('click', () => { catalogCategoryNewModal.style.display = 'none'; });
    catalogCategoryEditCancel?.addEventListener('click', () => { catalogCategoryEditModal.style.display = 'none'; });
    catalogCategoryNewForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = catalogCategoryNewForm.elements.name.value.trim();
      if (!name) return;
      const parentId = currentCatalogCategoryId && currentCatalogCategoryId !== 'root' ? currentCatalogCategoryId : undefined;
      catalogCategoryNewMessage.textContent = 'Creating...';
      catalogCategoryNewMessage.className = 'small';
      try {
        await fetch('/api/catalog/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parentId })
        });
        catalogCategoryNewMessage.textContent = 'Created.';
        catalogCategoryNewMessage.className = 'success';
        catalogCategoryNewModal.style.display = 'none';
        await refreshCatalogCategories();
        await refreshCatalogItems();
      } catch (err) {
        catalogCategoryNewMessage.textContent = err.message || 'Failed to create category';
        catalogCategoryNewMessage.className = 'error';
      }
    });
    catalogCategoryEditForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = catalogCategoryEditForm.elements.id.value;
      const name = catalogCategoryEditForm.elements.name.value.trim();
      const parentId = catalogCategoryEditForm.elements.parentId.value || undefined;
      if (!id || !name) return;
      const invalidParents = getDescendantIds(id);
      invalidParents.add(String(id));
      if (parentId && invalidParents.has(String(parentId))) {
        catalogCategoryEditMessage.textContent = 'Cannot move a category into itself or its descendants.';
        catalogCategoryEditMessage.className = 'error';
        return;
      }
      catalogCategoryEditMessage.textContent = 'Saving...';
      catalogCategoryEditMessage.className = 'small';
      try {
        await fetch(`/api/catalog/categories/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parentId })
        });
        catalogCategoryEditMessage.textContent = 'Saved.';
        catalogCategoryEditMessage.className = 'success';
        catalogCategoryEditModal.style.display = 'none';
        await refreshCatalogCategories();
        await refreshCatalogItems();
      } catch (err) {
        catalogCategoryEditMessage.textContent = err.message || 'Failed to save category';
        catalogCategoryEditMessage.className = 'error';
      }
    });

    function updateCatalogItemHint() {
      if (!catalogItemHint) return;
      const cat = currentCategory();
      catalogItemHint.textContent = cat ? `Browsing ${categoryPathLabel(cat)}` : 'Browsing top level';
    }

    function resetCatalogItemForm(item = null, showModal = false) {
      if (!catalogItemForm) return;
      catalogItemForm.reset();
      selectedCatalogItemId = null;
      catalogItemMessage.textContent = '';
      catalogItemMessage.className = 'small';
      if (item) {
        catalogItemForm.elements.id.value = item._id || item.id || '';
        catalogItemForm.elements.name.value = item.name || '';
        const pathLabel = Array.isArray(item.categoryPathLabels)
          ? item.categoryPathLabels.join(' / ')
          : (item.fullPath || item.categoryPathLabels || '');
        catalogItemForm.elements.categoryPath.value = pathLabel || '';
        catalogItemForm.elements.subteam.value = item.subteam || '';
        catalogItemForm.elements.type.value = item.type || '';
        catalogItemForm.elements.vendor.value = item.vendor || '';
        catalogItemForm.elements.vendorPartNumber.value = item.vendorPartNumber || '';
        catalogItemForm.elements.supplierLink.value = item.supplierLink || '';
        catalogItemForm.elements.unitCost.value = item.unitCost ?? '';
        catalogItemForm.elements.defaultQuantity.value = item.defaultQuantity ?? '';
        catalogItemForm.elements.aliases.value = (item.aliases || []).join(', ');
        selectedCatalogItemId = item._id || item.id || null;
        if (catalogItemModalHint) catalogItemModalHint.textContent = 'Edit saved part';
      } else {
        if (catalogItemModalHint) catalogItemModalHint.textContent = 'Create a saved part';
      }
      if (catalogItemModal) catalogItemModal.style.display = showModal ? 'flex' : catalogItemModal.style.display;
    }

    function renderCatalogItems() {
      if (!catalogItemList) return;
      if (!catalogItems.length) {
        catalogItemList.className = 'empty';
        catalogItemList.textContent = 'No catalog items yet.';
        return;
      }
      const canEdit = currentUser?.permissions?.canEditInventoryCatalog;
      catalogItemList.className = '';
      catalogItemList.innerHTML = catalogItems.map(item => {
        const path = escapeHtml((item.fullPath || (item.categoryPathLabels || []).join(' / ')) || '');
        const vendor = escapeHtml(item.vendor || '');
        const sku = escapeHtml(item.vendorPartNumber || '');
        return `<div class="card" data-id="${item._id || item.id}" style="margin-bottom:8px;">
          <div class="flex-between" style="gap:8px; align-items:flex-start;">
            <div>
              <h4 style="margin:0 0 4px;">${escapeHtml(item.name)}</h4>
              <div class="small">${path || 'Uncategorized'}</div>
              <div class="small">${vendor || ''} ${sku ? '· ' + sku : ''}</div>
            </div>
            <div class="flex-between" style="gap:6px; flex-wrap:wrap; justify-content:flex-end;">
              ${canEdit ? `<button class="btn ghost" data-action="edit">Edit</button>` : ''}
              ${canEdit ? `<button class="btn ghost" data-action="delete" style="color:var(--danger);">Delete</button>` : ''}
              <button class="btn primary" data-action="request">Request</button>
            </div>
          </div>
        </div>`;
      }).join('');
    catalogItemList.querySelectorAll('button[data-action="request"]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.closest('.card')?.dataset.id;
        if (!id) return;
        const item = catalogItems.find(i => String(i._id || i.id) === String(id));
        if (item) openCatalogRequestModal(item);
      });
    });
    if (canEdit) {
      catalogItemList.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.closest('.card')?.dataset.id;
          if (!id) return;
          const item = catalogItems.find(i => String(i._id || i.id) === String(id));
          if (item) resetCatalogItemForm(item, true);
        });
      });
        catalogItemList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.card')?.dataset.id;
            if (!id) return;
            openConfirm('Delete this saved item?', async () => {
              await fetch(`/api/catalog/items/${id}`, { method: 'DELETE' });
              await refreshCatalogItems();
              resetCatalogItemForm();
            });
          });
        });
      }
    }

    async function refreshCatalogItems() {
      if (!currentUser) return;
      catalogItemList.textContent = 'Loading...';
      const params = new URLSearchParams();
      if (currentCatalogCategoryId) params.set('categoryId', currentCatalogCategoryId);
      params.set('includeDescendants', 'false');
      if (catalogItemSearch?.value) params.set('search', catalogItemSearch.value.trim());
      try {
        const res = await fetch(`/api/catalog/items?${params.toString()}`);
        const data = await res.json();
        catalogItems = data.items || [];
        renderCatalogItems();
      } catch (err) {
        catalogItemList.textContent = 'Failed to load catalog items';
      }
    }

    catalogItemForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(catalogItemForm).entries());
      const id = payload.id;
      const aliases = (payload.aliases || '').split(',').map(a => a.trim()).filter(Boolean);
      const body = {
        name: payload.name,
        categoryPath: (payload.categoryPath || '').split('/').map(p => p.trim()).filter(Boolean),
        subteam: payload.subteam || undefined,
        type: payload.type || undefined,
        vendor: payload.vendor || undefined,
        vendorPartNumber: payload.vendorPartNumber || undefined,
        supplierLink: payload.supplierLink || undefined,
        unitCost: payload.unitCost ? Number(payload.unitCost) : undefined,
        defaultQuantity: payload.defaultQuantity ? Number(payload.defaultQuantity) : undefined,
        aliases
      };
      catalogItemMessage.textContent = 'Saving...';
      catalogItemMessage.className = 'small';
      try {
        if (id) {
          await fetch(`/api/catalog/items/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        } else {
          await fetch('/api/catalog/items', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        }
        catalogItemMessage.textContent = 'Saved';
        catalogItemMessage.className = 'success';
        await refreshCatalogItems();
        if (catalogItemModal) catalogItemModal.style.display = 'none';
        if (!id) resetCatalogItemForm();
      } catch (err) {
        catalogItemMessage.textContent = err.message || 'Failed to save item';
        catalogItemMessage.className = 'error';
      }
    });

    cancelCatalogItemBtn?.addEventListener('click', () => { catalogItemModal.style.display = 'none'; resetCatalogItemForm(); });
    deleteCatalogItemBtn?.addEventListener('click', async () => {
      const id = catalogItemForm?.elements.id.value;
      if (!id) return;
      openConfirm('Delete this saved item?', async () => {
        await fetch(`/api/catalog/items/${id}`, { method: 'DELETE' });
        await refreshCatalogItems();
        resetCatalogItemForm();
        if (catalogItemModal) catalogItemModal.style.display = 'none';
      });
    });
    newCatalogItemBtn?.addEventListener('click', () => {
      resetCatalogItemForm({ name: '', categoryPathLabels: currentCategory() ? [categoryPathLabel(currentCategory())] : [] }, true);
    });
    refreshCatalogItemsBtn?.addEventListener('click', () => refreshCatalogItems());
    fetchCatalogProductBtn?.addEventListener('click', fetchCatalogDetails);
    catalogItemSearch?.addEventListener('input', () => {
      clearTimeout(catalogItemSearchTimer);
      catalogItemSearchTimer = setTimeout(refreshCatalogItems, 200);
    });
    catalogBackBtn?.addEventListener('click', () => {
      const cat = currentCategory();
      if (cat?.parentId) {
        selectCatalogCategory(cat.parentId.toString());
      } else {
        currentCatalogCategoryId = 'root';
        selectedCatalogCategoryId = null;
        renderCatalogCategoriesList();
        refreshCatalogItems();
        updateCatalogItemHint();
      }
    });

    function refreshCatalogView() {
      currentCatalogCategoryId = 'root';
      selectedCatalogCategoryId = null;
      renderCatalogCategoriesList();
      refreshCatalogCategories();
      refreshCatalogItems();
      updateCatalogItemHint();
      updateCatalogEditVisibility();
    }

    async function loadTags() {
      try {
        const res = await fetch('/api/tags');
        const data = await res.json();
        tagList = data.tags || [];
        renderTagOptions(getSelectedTagIds());
        renderCatalogRequestTagOptions(getCatalogRequestTagIds());
        renderTagsManager();
        renderBoard();
        renderTable();
      } catch (e) {
        console.warn('Failed to load tags', e);
      }
    }

    async function loadPriorityTags() {
      try {
        const res = await fetch('/api/priority-tags');
        const data = await res.json();
        priorityList = (data.priorities && data.priorities.length ? data.priorities : defaultPriorities) || defaultPriorities;
      renderPriorityOptions();
      renderPriorityManager();
    } catch (e) {
      console.warn('Failed to load priorities', e);
      priorityList = defaultPriorities;
      renderPriorityOptions();
      renderPriorityManager();
    }
      renderCatalogSaveCategoryOptions();
  }

    function renderTagOptions(selected = []) {
      if (!tagSelect) return;
      const selSet = new Set(selected.map(String));
      tagSelect.innerHTML = tagList.map(t => `<option value="${t._id || t.id || t.label}" ${selSet.has(String(t._id || t.id || t.label)) ? 'selected' : ''}>${t.label}</option>`).join('');
      updateTagSelection(selected);
    }

    function updateTagSelection(ids = []) {
      if (tagSelect) {
        const selSet = new Set(ids.map(String));
        Array.from(tagSelect.options || []).forEach(opt => { opt.selected = selSet.has(opt.value); });
      }
      if (tagPickerDisplay) {
        const labels = ids.map(getTagLabel).filter(Boolean);
        tagPickerDisplay.textContent = labels.length ? labels.join(', ') : 'Select tags';
      }
      renderTagDropdownList(ids);
    }

    function renderTagDropdownList(selected = getSelectedTagIds()) {
      if (!tagPickerOptions) return;
      const term = (tagPickerSearch?.value || '').toLowerCase().trim();
      const filtered = tagList.filter(t => !term || (t.label || '').toLowerCase().includes(term));
      const selSet = new Set(selected.map(String));
      tagPickerOptions.innerHTML = filtered.length ? filtered.map(t => {
        const id = String(t._id || t.id || t.label);
        const selectedCls = selSet.has(id) ? 'selected' : '';
        const color = t.color || '#fdd023';
        return `<div class="tag-option ${selectedCls}" data-id="${id}">
          <span class="tag-dot" style="background:${color};"></span>
          <span>${escapeHtml(t.label || id)}</span>
        </div>`;
      }).join('') : `<div class="small" style="padding:8px 10px;">No tags</div>`;
    }

    function toggleTagPanel(open) {
      if (!tagPickerPanel) return;
      const shouldOpen = open !== undefined ? open : tagPickerPanel.style.display !== 'block';
      tagPickerPanel.style.display = shouldOpen ? 'block' : 'none';
    }

    tagPickerDisplay?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleTagPanel(true);
    });
    document.addEventListener('click', (e) => {
      if (!tagPicker) return;
      if (!tagPicker.contains(e.target)) toggleTagPanel(false);
    });
    tagPickerSearch?.addEventListener('input', () => renderTagDropdownList(getSelectedTagIds()));
    tagPickerOptions?.addEventListener('click', (e) => {
      const row = e.target.closest('.tag-option');
      if (!row) return;
      const id = row.dataset.id;
      if (!id) return;
      const selected = new Set(getSelectedTagIds().map(String));
      if (selected.has(id)) selected.delete(id); else selected.add(id);
      updateTagSelection(Array.from(selected));
    });

    function syncTagEditUI() {
      const canManage = currentUser?.permissions?.canManageTags;
      if (createTagForm) createTagForm.style.display = canManage ? 'flex' : 'none';
      if (createPriorityForm) createPriorityForm.style.display = canManage ? 'flex' : 'none';
    }

    function showTagsModalTab(which) {
      activeTagsTab = which === 'priorities' ? 'priorities' : 'tags';
      if (tagsTabTags) tagsTabTags.classList.toggle('primary', activeTagsTab === 'tags');
      if (tagsTabPriorities) tagsTabPriorities.classList.toggle('primary', activeTagsTab === 'priorities');
      if (tagsSection) tagsSection.style.display = activeTagsTab === 'tags' ? 'block' : 'none';
      if (prioritiesSection) prioritiesSection.style.display = activeTagsTab === 'priorities' ? 'block' : 'none';
    }
    function getCatalogRequestTagIds() {
      if (!catalogRequestTags) return [];
      return Array.from(catalogRequestTags.selectedOptions || []).map(o => o.value);
    }
    function renderCatalogRequestTagOptions(selected = []) {
      if (!catalogRequestTags) return;
      const selSet = new Set(selected.map(String));
      catalogRequestTags.innerHTML = tagList.map(t => {
        const id = t._id || t.id || t.label;
        return `<option value="${id}" ${selSet.has(String(id)) ? 'selected' : ''}>${escapeHtml(t.label || '')}</option>`;
      }).join('');
      updateCatalogRequestTagSelection(selected);
    }
    function updateCatalogRequestTagSelection(ids = []) {
      if (catalogRequestTags) {
        const selSet = new Set(ids.map(String));
        Array.from(catalogRequestTags.options || []).forEach(opt => { opt.selected = selSet.has(opt.value); });
      }
      if (catalogRequestTagPickerDisplay) {
        const labels = ids.map(getTagLabel).filter(Boolean);
        catalogRequestTagPickerDisplay.textContent = labels.length ? labels.join(', ') : 'Select tags';
      }
      renderCatalogRequestTagDropdownList(ids);
    }
    function renderCatalogRequestTagDropdownList(selected = getCatalogRequestTagIds()) {
      if (!catalogRequestTagPickerOptions) return;
      const term = (catalogRequestTagPickerSearch?.value || '').toLowerCase().trim();
      const filtered = tagList.filter(t => !term || (t.label || '').toLowerCase().includes(term));
      const selSet = new Set(selected.map(String));
      catalogRequestTagPickerOptions.innerHTML = filtered.length ? filtered.map(t => {
        const id = String(t._id || t.id || t.label);
        const selectedCls = selSet.has(id) ? 'selected' : '';
        const color = t.color || '#fdd023';
        return `<div class="tag-option ${selectedCls}" data-id="${id}">
          <span class="tag-dot" style="background:${color};"></span>
          <span>${escapeHtml(t.label || id)}</span>
        </div>`;
      }).join('') : `<div class="small" style="padding:8px 10px;">No tags</div>`;
    }
    function toggleCatalogRequestTagPanel(open) {
      if (!catalogRequestTagPickerPanel) return;
      const shouldOpen = open !== undefined ? open : catalogRequestTagPickerPanel.style.display !== 'block';
      catalogRequestTagPickerPanel.style.display = shouldOpen ? 'block' : 'none';
    }

    catalogRequestTagPickerDisplay?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleCatalogRequestTagPanel(true);
    });
    document.addEventListener('click', (e) => {
      if (!catalogRequestTagPicker) return;
      if (!catalogRequestTagPicker.contains(e.target)) toggleCatalogRequestTagPanel(false);
    });
    catalogRequestTagPickerSearch?.addEventListener('input', () => renderCatalogRequestTagDropdownList(getCatalogRequestTagIds()));
    catalogRequestTagPickerOptions?.addEventListener('click', (e) => {
      const row = e.target.closest('.tag-option');
      if (!row) return;
      const id = row.dataset.id;
      if (!id) return;
      const selected = new Set(getCatalogRequestTagIds().map(String));
      if (selected.has(id)) selected.delete(id); else selected.add(id);
      updateCatalogRequestTagSelection(Array.from(selected));
    });

    function renderTagsManager() {
      if (!tagsList) return;
      syncTagEditUI();
      if (!tagList.length) {
        tagsList.innerHTML = '<div class="empty">No tags yet.</div>';
        return;
      }
      tagsList.innerHTML = tagList.map(t => {
        const id = String(t._id || t.id || t.label);
        const color = t.color || '#fdd023';
        return `<div class="tag-manager-item" data-id="${id}">
          <div class="tag-manager-meta">
            <input type="color" class="tag-color-input inline-color" value="${color}" data-id="${id}" title="Pick color" ${!currentUser?.permissions?.canManageTags ? 'disabled' : ''}/>
            <div>${escapeHtml(t.label || id)}</div>
          </div>
          ${currentUser?.permissions?.canManageTags ? `<button class="btn ghost" data-action="delete-tag" style="color: var(--danger);">Delete</button>` : ''}
        </div>`;
      }).join('');
      if (currentUser?.permissions?.canManageTags) {
        tagsList.querySelectorAll('.tag-color-input').forEach(inp => {
          inp.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            await fetch(`/api/tags/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ color: e.target.value })
            });
            await loadTags();
          });
        });
      }
      tagsList.querySelectorAll('button[data-action="delete-tag"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.closest('.tag-manager-item')?.dataset.id;
          if (!id) return;
          openConfirm('Delete this tag?', async () => {
            await fetch(`/api/tags/${id}`, { method: 'DELETE' });
            await loadTags();
          });
        });
      });
    }

      refreshTagsBtn?.addEventListener('click', () => loadTags());
    createTagForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser?.permissions?.canManageTags) return;
      const label = (tagLabelInput?.value || '').trim();
      const color = tagColorInput?.value || '#fdd023';
      if (!label) return;
      tagsMessage.textContent = 'Saving...';
      tagsMessage.className = 'small';
      try {
        const res = await fetch('/api/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, color })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create tag');
        tagLabelInput.value = '';
        tagsMessage.textContent = 'Tag created';
        tagsMessage.className = 'success';
        await loadTags();
      } catch (err) {
        tagsMessage.textContent = err.message || 'Failed to create tag';
        tagsMessage.className = 'error';
      }
    });

    function renderPriorityOptions() {
      const select = orderForm.elements.priority;
      if (!select) return;
      const list = priorityList && priorityList.length ? priorityList : defaultPriorities;
      const current = select.value || 'Medium';
      select.innerHTML = list.map(p => `<option value="${p.label}">${p.label}</option>`).join('');
      if (list.some(p => p.label === current)) {
        select.value = current;
      } else if (list.length) {
        select.value = list[0].label;
      }
      renderCatalogRequestPriorityOptions();
    }

    function renderCatalogRequestPriorityOptions() {
      if (!catalogRequestPriority) return;
      const list = priorityList && priorityList.length ? priorityList : defaultPriorities;
      const current = catalogRequestPriority.value || defaultPriorityLabel();
      catalogRequestPriority.innerHTML = list.map(p => `<option value="${p.label}">${p.label}</option>`).join('');
      if (list.some(p => p.label === current)) {
        catalogRequestPriority.value = current;
      } else if (list.length) {
        catalogRequestPriority.value = list[0].label;
      }
    }

    function renderPriorityManager() {
      if (!prioritiesList) return;
      syncTagEditUI();
      if (!priorityList.length) {
        prioritiesList.innerHTML = '<div class="empty">No priorities yet.</div>';
        return;
      }
      prioritiesList.innerHTML = priorityList.map(p => {
        const id = p._id || p.id || p.label;
        const color = p.color || '#fdd023';
        const sort = p.sortOrder ?? '';
        return `<div class="tag-manager-item" data-id="${id}">
          <div class="tag-manager-meta" style="gap:12px;">
            <input type="color" class="priority-color-input inline-color" value="${color}" data-id="${id}" title="Pick color" ${!currentUser?.permissions?.canManageTags ? 'disabled' : ''}/>
            <div style="min-width:140px;">${escapeHtml(p.label || '')}</div>
            <input type="number" class="priority-sort-input input" data-id="${id}" value="${sort}" placeholder="Sort" style="width:80px;" ${!currentUser?.permissions?.canManageTags ? 'disabled' : ''}/>
          </div>
          ${currentUser?.permissions?.canManageTags ? `<button class="btn ghost" data-action="delete-priority" style="color: var(--danger);">Delete</button>` : ''}
        </div>`;
      }).join('');
      if (currentUser?.permissions?.canManageTags) {
        prioritiesList.querySelectorAll('.priority-color-input').forEach(inp => {
          inp.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            await fetch(`/api/priority-tags/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ color: e.target.value })
            });
            await loadPriorityTags();
          });
        });
        prioritiesList.querySelectorAll('.priority-sort-input').forEach(inp => {
          inp.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            const sort = Number(e.target.value);
            await fetch(`/api/priority-tags/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sortOrder: Number.isFinite(sort) ? sort : null })
            });
            await loadPriorityTags();
          });
        });
        prioritiesList.querySelectorAll('button[data-action="delete-priority"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.tag-manager-item')?.dataset.id;
            if (!id) return;
            openConfirm('Delete this priority?', async () => {
              await fetch(`/api/priority-tags/${id}`, { method: 'DELETE' });
              await loadPriorityTags();
            });
          });
        });
      }
    }

    function openCatalogRequestModal(item) {
      pendingCatalogRequest = item;
      if (catalogRequestMessage) {
        catalogRequestMessage.textContent = '';
        catalogRequestMessage.className = 'small';
      }
      if (catalogRequestQty) {
        catalogRequestQty.value = item?.defaultQuantity || 1;
        setTimeout(() => catalogRequestQty.focus(), 50);
      }
      renderCatalogRequestPriorityOptions();
      updateCatalogRequestTagSelection([]);
      if (catalogRequestNotes) catalogRequestNotes.value = '';
      if (catalogRequestSubtitle) {
        const path = item?.fullPath || (item?.categoryPathLabels || []).join(' / ');
        catalogRequestSubtitle.textContent = item ? `${item.name}${path ? ' · ' + path : ''}` : 'Choose quantity and confirm.';
      }
      if (catalogRequestModal) catalogRequestModal.style.display = 'flex';
    }

    async function submitCatalogRequest() {
      const item = pendingCatalogRequest;
      if (!item) return;
      if (!currentUser) {
        showBoardMessage('Login to create an order.', 'error');
        return;
      }
      if (!currentUser.permissions?.canPlaceOrders) {
        showBoardMessage('No permission to place orders.', 'error');
        return;
      }
      const qty = Number(catalogRequestQty?.value || item.defaultQuantity || 1);
      if (!Number.isFinite(qty) || qty <= 0) {
        if (catalogRequestMessage) {
          catalogRequestMessage.textContent = 'Enter a valid quantity.';
          catalogRequestMessage.className = 'error';
        }
        return;
      }
      const priority = catalogRequestPriority?.value || defaultPriorityLabel();
      const tags = getCatalogRequestTagIds();
      const notes = catalogRequestNotes?.value?.trim();
      const payload = {
        partName: item.name,
        vendor: item.vendor,
        supplier: item.vendor,
        vendorPartNumber: item.vendorPartNumber,
        partLink: item.supplierLink,
        unitCost: item.unitCost ?? undefined,
        fetchedPrice: item.unitCost ?? undefined,
        quantityRequested: qty,
        status: 'Requested',
        priority,
        tags,
        notes: notes || (item.fullPath ? `From catalog: ${item.fullPath}` : undefined)
      };
      if (catalogRequestMessage) {
        catalogRequestMessage.textContent = 'Creating request...';
        catalogRequestMessage.className = 'small';
      }
      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create order');
        if (catalogRequestMessage) {
          catalogRequestMessage.textContent = 'Added to requests.';
          catalogRequestMessage.className = 'success';
        }
        if (catalogRequestModal) catalogRequestModal.style.display = 'none';
        pendingCatalogRequest = null;
        await fetchOrders();
        showBoardMessage('Requested from catalog.', 'info');
      } catch (err) {
        if (catalogRequestMessage) {
          catalogRequestMessage.textContent = err.message || 'Failed to create order';
          catalogRequestMessage.className = 'error';
        }
      }
    }

    refreshPrioritiesBtn?.addEventListener('click', () => loadPriorityTags());
    createPriorityForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser?.permissions?.canManageTags) return;
      const label = (priorityLabelInput?.value || '').trim();
      const color = priorityColorInput?.value || '#fdd023';
      const sortOrder = Number(prioritySortInput?.value);
      if (!label) return;
      prioritiesMessage.textContent = 'Saving...';
      prioritiesMessage.className = 'small';
      try {
        const res = await fetch('/api/priority-tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, color, sortOrder: Number.isFinite(sortOrder) ? sortOrder : undefined })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create priority');
        priorityLabelInput.value = '';
        prioritySortInput.value = '';
        prioritiesMessage.textContent = 'Priority created';
        prioritiesMessage.className = 'success';
        await loadPriorityTags();
      } catch (err) {
        prioritiesMessage.textContent = err.message || 'Failed to create priority';
        prioritiesMessage.className = 'error';
      }
    });
    confirmCatalogRequest?.addEventListener('click', submitCatalogRequest);
    cancelCatalogRequest?.addEventListener('click', () => { pendingCatalogRequest = null; catalogRequestModal.style.display = 'none'; });
    vendorForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(vendorForm).entries());
      const id = data.id || undefined;
      if (!data.vendor) {
        vendorMessage.textContent = 'Vendor is required';
        vendorMessage.className = 'error';
        return;
      }
      vendorMessage.textContent = 'Saving...';
      vendorMessage.className = 'small';
      let headersObj;
      if (data.notes) {
        try {
          headersObj = JSON.parse(data.notes);
        } catch (e) {
          vendorMessage.textContent = 'Notes/headers not valid JSON.';
          vendorMessage.className = 'error';
          return;
        }
      }
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/vendors/configs/${id}` : '/api/vendors/configs';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vendor: data.vendor,
            baseUrl: data.baseUrl || undefined,
            productUrlTemplate: data.productUrlTemplate || undefined,
            partNumberExample: data.partNumberExample || undefined,
            partNumberPattern: data.partNumberPattern || undefined,
            nameSelector: data.nameSelector || undefined,
            priceSelector: data.priceSelector || undefined,
            platform: data.platform || undefined,
            notes: data.notes || undefined,
            headers: headersObj
          })
        });
        vendorMessage.textContent = 'Saved.';
        vendorMessage.className = 'success';
        loadVendors();
        closeVendorModal();
      } catch (err) {
        vendorMessage.textContent = 'Failed to save vendor';
        vendorMessage.className = 'error';
      }
    });

    userForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(userForm).entries());
      const id = data.id || undefined;
      const payload = {
        username: data.username,
        name: data.name,
        role: data.role,
        active: data.active === 'true',
        permissions: undefined
      };
      if (data.password) payload.password = data.password;
      userMessage.textContent = 'Saving...';
      userMessage.className = 'small';
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/users/${id}` : '/api/users';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        userMessage.textContent = 'Saved user.';
        userMessage.className = 'success';
        loadUsers();
        closeUserModal();
      } catch (err) {
        userMessage.textContent = 'Failed to save user';
        userMessage.className = 'error';
      }
    });

    passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(passwordForm).entries());
      passwordMessage.textContent = 'Updating...';
      passwordMessage.className = 'small';
      const res = await fetch('/api/auth/password', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const resp = await res.json();
      if (!res.ok) {
        passwordMessage.textContent = resp.error || 'Failed';
        passwordMessage.className = 'error';
        return;
      }
      passwordMessage.textContent = 'Password updated.';
      passwordMessage.className = 'success';
      passwordForm.reset();
    });

    async function testExtraction() {
      const url = testUrl.value.trim();
      if (!url) {
        vendorMessage.textContent = 'Provide a URL to test.';
        vendorMessage.className = 'error';
        return;
      }
      const selectors = {
        nameSelector: vendorForm.elements.nameSelector.value || undefined,
        priceSelector: vendorForm.elements.priceSelector.value || undefined
      };
      const headers = {};
      try {
        const notes = vendorForm.elements.notes.value;
        if (notes) {
          const parsed = JSON.parse(notes);
          Object.assign(headers, parsed);
        }
      } catch (e) {
        vendorMessage.textContent = 'Notes/headers not valid JSON.';
        vendorMessage.className = 'error';
        return;
      }

      const resultsEl = document.getElementById('extract-results');
      resultsEl.textContent = 'Testing...';
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, selectors, headers })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        resultsEl.textContent = 'Pick which value looks correct for each field. You can paste CSS selectors (e.g., span.money).';

        if (data.shopify) {
          vendorMessage.textContent = 'Shopify data detected. Name/price auto-filled. Editing selectors will override Shopify.';
          vendorMessage.className = 'small';
          if (data.shopify.vendor && !vendorForm.elements.vendor.value) {
            vendorForm.elements.vendor.value = data.shopify.vendor;
          }
          if (data.shopify.variant?.name && !vendorForm.elements.nameSelector.value) {
            previewName.textContent = data.shopify.variant.name;
          }
          if (data.shopify.variant?.price !== undefined && !vendorForm.elements.priceSelector.value) {
            previewPrice.textContent = data.shopify.variant.price.toFixed(2);
          }
        }

        const trim = (t) => (t && t.length > 120 ? t.slice(0, 120) + '…' : t || '');
        const nameOptions = (data.picks?.name ? [{ text: data.picks.name, selector: selectors.nameSelector }] : []).concat(data.candidates?.titles || []);
        const priceOptions = (data.picks?.price ? [{ text: data.picks.price, selector: selectors.priceSelector }] : []).concat(data.candidates?.prices || []);

        const makeOptions = (opts) => opts.map(c => `<option data-text="${c.text || ''}" title="${c.text || ''}" value="${c.selector || ''}">${trim(c.text)}</option>`).join('');
        pickName.innerHTML = '<option value="">-- choose name --</option>' + makeOptions(nameOptions);
        pickPrice.innerHTML = '<option value="">-- choose price --</option>' + makeOptions(priceOptions);

        const applySelection = (selectEl, fieldName, previewEl) => {
          const apply = () => {
            const selOption = selectEl.options[selectEl.selectedIndex];
            const selSelector = selOption?.value || '';
            const selText = selOption?.dataset?.text || selOption?.title || selOption?.text || '';
            if (selSelector) {
              vendorForm.elements[fieldName].value = selSelector;
            }
            if (previewEl) previewEl.textContent = selText;
          };
          selectEl.addEventListener('change', apply);
          if (selectEl.options.length > 1) {
            selectEl.selectedIndex = 1;
            apply();
          }
        };
        applySelection(pickName, 'nameSelector', previewName);
        applySelection(pickPrice, 'priceSelector', previewPrice);
      } catch (err) {
        resultsEl.textContent = 'Extraction failed. Check URL/headers.';
        vendorMessage.textContent = err.message;
        vendorMessage.className = 'error';
      }
    }

    // Live preview when selectors change (uses current test URL if present)
    const debounce = (fn, ms = 400) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    };
    const liveExtract = debounce(() => {
      if (!testUrl.value.trim()) return;
      testExtraction();
    }, 500);

    ['nameSelector', 'priceSelector'].forEach(name => {
      vendorForm.elements[name].addEventListener('input', liveExtract);
    });

    function deriveFromSnippet(snippet) {
      if (!snippet) return '';
      const text = snippet.trim().replace(/;$/, '');
      const qsMatch = text.match(/querySelector(All)?\((['"`])([^'"`]+)\2\)/i);
      if (qsMatch) {
        return qsMatch[3].trim();
      }
      // CSS selector only
      return text;
    }

    applySelector.addEventListener('click', () => {
      const sel = deriveFromSnippet(selectorSnippet.value || '');
      if (!sel) return;
      const target = selectorTarget.value;
      vendorForm.elements[target].value = sel;
      liveExtract();
    });

    function guessRegexFromExample(example) {
      if (!example) return '';
      // If looks like ABC-1234 or AM-4896
      if (/^[A-Za-z]{2,}-\d+$/i.test(example)) {
        const prefix = example.split('-')[0];
        return `^${prefix}-\\d+$`;
      }
      // Alphanumeric with dashes
      if (/^[A-Za-z0-9-]+$/.test(example)) {
        return '^[A-Za-z0-9-]+$';
      }
      return '';
    }

    partExample.addEventListener('blur', () => {
      const guess = guessRegexFromExample(partExample.value.trim());
      if (guess && !partPattern.value) {
        partPattern.value = guess;
      }
    });

    testExtract.addEventListener('click', testExtraction);

    function updateUserUI() {
      if (currentUser) {
        userChip.textContent = `${currentUser.name || currentUser.username || 'User'} · ${currentUser.role || ''}`;
        userChip.style.display = 'inline-flex';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        accountBtn.style.display = 'inline-flex';
        tagsBtn.style.display = 'inline-flex';
        catalogBtn.style.display = 'inline-flex';
      } else {
        userChip.textContent = '';
        userChip.style.display = 'none';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        accountBtn.style.display = 'none';
        tagsBtn.style.display = 'none';
        catalogBtn.style.display = 'none';
        adminBtn.style.display = 'none';
      }
      const perms = computePerms(currentUser);
      if (currentUser) currentUser.permissions = perms;
      newOrderBtn.disabled = !perms.canPlaceOrders;
      adminBtn.style.display = (perms.canManageUsers || perms.canManageVendors || perms.canEditInventoryCatalog) ? 'inline-flex' : 'none';
      if (addStockBtn) addStockBtn.style.display = perms.canManageStock ? 'inline-flex' : 'none';
      if (manageSubteamsBtn) manageSubteamsBtn.style.display = perms.canManageStock ? 'inline-flex' : 'none';
      updateAdminTabsVisibility();
      syncCatalogSaveUI();
      updateCatalogEditVisibility();
      syncTagEditUI();
    }

    async function loadUsers() {
      if (!currentUser?.permissions?.canManageUsers) {
        userList.innerHTML = '<div class="empty">No access to manage users.</div>';
        return;
      }
      userList.textContent = 'Loading users...';
      try {
        const res = await fetch('/api/users');
        const data = await res.json();
        const users = data.users || [];
        if (!users.length) {
          userList.innerHTML = '<div class="empty">No users.</div>';
          return;
        }
        userList.innerHTML = users.map(u => `
          <div class="card" data-id="${u._id}" style="margin-bottom:6px;">
            <div class="flex-between">
              <div>
                <div><strong>${u.username}</strong> (${u.role})</div>
                <div class="small">${u.name || ''}</div>
                <div class="small">Active: ${u.active ? 'Yes' : 'No'}</div>
              </div>
              <div class="flex-between" style="gap:8px;">
                <button class="btn ghost" data-action="edit-user">Edit</button>
                <button class="btn ghost" data-action="delete-user" style="color: var(--danger);">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        userList.querySelectorAll('button[data-action="edit-user"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const u = users.find(x => x._id === id);
            if (!u) return;
            openUserModal(u);
          });
        });
        userList.querySelectorAll('button[data-action="delete-user"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.card')?.dataset.id;
            if (!id) return;
            openConfirm('Delete this user?', async () => {
              await fetch(`/api/users/${id}`, { method: 'DELETE' });
              loadUsers();
            });
          });
        });
      } catch (e) {
        userList.textContent = 'Failed to load users';
      }
    }

    async function loadRoles() {
      if (!currentUser?.permissions?.canManageUsers) {
        roleList.innerHTML = '<div class="empty">No access to manage roles.</div>';
        return;
      }
      roleList.textContent = 'Loading roles...';
      try {
        const res = await fetch('/api/roles');
        const data = await res.json();
        const roles = data.roles || [];
        const combined = {
          admin: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: true, canManageTags: true, canEditInventoryCatalog: true, canManageStock: true, canEditStock: true },
          mentor: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: false, canManageTags: true, canEditInventoryCatalog: true, canManageStock: true, canEditStock: true },
          student: { canPlaceOrders: true, canMoveOrders: false, canEditOrders: false, canDeleteOrders: false, canManageVendors: false, canManageUsers: false, canManageTags: false, canEditInventoryCatalog: false, canManageStock: false, canEditStock: false }
        };
        roles.forEach(r => { combined[r.role] = { ...(combined[r.role] || {}), ...(r.permissions || {}) }; });

        const renderToggle = (role, key, label) => {
          const disabled = role === 'admin' ? 'disabled' : '';
          return `
          <label class="small" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" data-role="${role}" data-key="${key}" ${combined[role]?.[key] ? 'checked' : ''} ${disabled}/>
            ${label}
          </label>`;
        };

        const roleCard = (role) => `
          <div class="card" style="margin-bottom:8px;">
            <div class="page-title" style="font-size:16px;">${role}</div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px;">
              ${renderToggle(role, 'canPlaceOrders', 'Can place orders')}
              ${renderToggle(role, 'canMoveOrders', 'Can move orders')}
              ${renderToggle(role, 'canEditOrders', 'Can edit orders')}
              ${renderToggle(role, 'canDeleteOrders', 'Can delete orders')}
              ${renderToggle(role, 'canManageVendors', 'Can manage vendors')}
              ${renderToggle(role, 'canManageUsers', 'Can manage users')}
              ${renderToggle(role, 'canManageTags', 'Can manage tags')}
              ${renderToggle(role, 'canEditInventoryCatalog', 'Can edit inventory catalog')}
              ${renderToggle(role, 'canManageStock', 'Can configure tracked stock & locations')}
              ${renderToggle(role, 'canEditStock', 'Can edit stock levels')}
            </div>
            ${role === 'admin'
              ? `<div class="small" style="margin-top:8px;">Admin permissions are fixed and cannot be changed.</div>`
              : `<div class="flex-between" style="margin-top:8px;">
                  <button class="btn primary" data-action="save-role" data-role="${role}">Save ${role}</button>
                </div>`}
          </div>`;

        roleList.innerHTML = ['admin', 'mentor', 'student'].map(roleCard).join('');
        if (roleMessage) roleMessage.textContent = '';

        roleList.querySelectorAll('button[data-action="save-role"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const role = e.target.dataset.role;
            if (role === 'admin') {
              if (roleMessage) {
                roleMessage.textContent = 'Admin permissions are fixed and cannot be edited.';
                roleMessage.className = 'small';
              }
              return;
            }
            const inputs = roleList.querySelectorAll(`input[data-role="${role}"]`);
            const perms = {};
            inputs.forEach(input => {
              perms[input.dataset.key] = input.checked;
            });
            await fetch(`/api/roles/${role}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ permissions: perms })
            });
            if (roleMessage) {
              roleMessage.textContent = `Saved permissions for ${role}.`;
              roleMessage.className = 'success';
            }
          });
        });
      } catch (e) {
        roleList.textContent = 'Failed to load roles';
        if (roleMessage) {
          roleMessage.textContent = 'Failed to load roles.';
          roleMessage.className = 'error';
        }
      }
    }

    async function syncTrackingAutoRefreshFromServer() {
      try {
        const res = await fetch('/api/tracking/settings');
        if (!res.ok) return;
        const data = await res.json();
        const minutes = Number(data.settings?.refreshMinutes);
        if (Number.isFinite(minutes) && minutes > 0) {
          startTrackingAutoRefresh(minutes);
        }
      } catch (_) {
        // ignore - auto refresh will keep existing cadence
      }
    }

    async function loadTrackingSettings() {
      if (!trackingSettingsForm) return;
      trackingSettingsMessage.textContent = 'Loading tracking settings...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/settings');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load settings');
        const settings = data.settings || {};
        ['upsClientId','upsClientSecret','uspsUserId','fedexClientId','fedexClientSecret'].forEach(key => {
          if (trackingSettingsForm.elements[key]) {
            trackingSettingsForm.elements[key].value = settings[key] || '';
          }
        });
        if (trackingSettingsForm.elements.refreshMinutes) {
          trackingSettingsForm.elements.refreshMinutes.value = settings.refreshMinutes || 30;
        }
        if (settings.refreshMinutes) {
          startTrackingAutoRefresh(settings.refreshMinutes);
        }
        trackingSettingsMessage.textContent = 'Tracking settings loaded.';
        trackingSettingsMessage.className = 'small';
      } catch (e) {
        trackingSettingsMessage.textContent = e.message || 'Failed to load tracking settings';
        trackingSettingsMessage.className = 'error';
      }
    }

    trackingSettingsForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(trackingSettingsForm).entries());
      payload.refreshMinutes = Number(payload.refreshMinutes || 30);
      if (!Number.isFinite(payload.refreshMinutes) || payload.refreshMinutes <= 0) {
        payload.refreshMinutes = 30;
      }
      trackingSettingsMessage.textContent = 'Saving...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/settings', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save settings');
        trackingSettingsMessage.textContent = 'Saved tracking settings.';
        trackingSettingsMessage.className = 'success';
        startTrackingAutoRefresh(payload.refreshMinutes);
      } catch (err) {
        trackingSettingsMessage.textContent = err.message || 'Failed to save settings';
        trackingSettingsMessage.className = 'error';
      }
    });

    refreshTrackingNow?.addEventListener('click', async () => {
      trackingSettingsMessage.textContent = 'Refreshing tracking now...';
      trackingSettingsMessage.className = 'small';
      try {
        const res = await fetch('/api/tracking/refresh', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to refresh');
        if (data.lastError) {
          trackingSettingsMessage.textContent = `Refresh triggered, but tracking error: ${data.lastError}`;
          trackingSettingsMessage.className = 'error';
        } else {
          trackingSettingsMessage.textContent = 'Refresh triggered. Data will update shortly.';
          trackingSettingsMessage.className = 'success';
        }
        fetchOrders();
      } catch (err) {
        trackingSettingsMessage.textContent = err.message || 'Failed to refresh tracking';
        trackingSettingsMessage.className = 'error';
      }
    });

    function allowedAdminTabs() {
      const tabs = [];
      if (currentUser?.permissions?.canManageUsers) {
        tabs.push('users', 'roles', 'tracking');
      }
      if (currentUser?.permissions?.canManageVendors) {
        tabs.push('vendors');
      }
      return tabs;
    }

    function updateAdminTabsVisibility() {
      const allowed = allowedAdminTabs();
      if (adminTabUsers) adminTabUsers.style.display = currentUser?.permissions?.canManageUsers ? 'inline-flex' : 'none';
      if (adminTabRoles) adminTabRoles.style.display = currentUser?.permissions?.canManageUsers ? 'inline-flex' : 'none';
      if (adminTabTracking) adminTabTracking.style.display = currentUser?.permissions?.canManageUsers ? 'inline-flex' : 'none';
      if (adminTabVendors) adminTabVendors.style.display = currentUser?.permissions?.canManageVendors ? 'inline-flex' : 'none';
      if (!allowed.includes(activeAdminTab)) {
        activeAdminTab = allowed[0] || null;
      }
      if (adminUsersSection) adminUsersSection.style.display = 'none';
      if (adminRolesSection) adminRolesSection.style.display = 'none';
      if (adminTrackingSection) adminTrackingSection.style.display = 'none';
      if (adminVendorsSection) adminVendorsSection.style.display = 'none';
    }

    function showAdminSection(which) {
      const allowed = allowedAdminTabs();
      if (!allowed.length) return;
      if (!allowed.includes(which)) which = allowed[0];
      activeAdminTab = which;
      adminUsersSection.style.display = which === 'users' ? 'block' : 'none';
      if (adminRolesSection) adminRolesSection.style.display = which === 'roles' ? 'block' : 'none';
      adminTrackingSection.style.display = which === 'tracking' ? 'block' : 'none';
      adminVendorsSection.style.display = which === 'vendors' ? 'block' : 'none';
      [adminTabUsers, adminTabRoles, adminTabTracking, adminTabVendors].forEach(btn => btn?.classList.remove('primary'));
      if (which === 'users') adminTabUsers?.classList.add('primary');
      if (which === 'roles') adminTabRoles?.classList.add('primary');
      if (which === 'tracking') adminTabTracking?.classList.add('primary');
      if (which === 'vendors') adminTabVendors?.classList.add('primary');
    }
    adminTabUsers?.addEventListener('click', () => showAdminSection('users'));
    adminTabRoles?.addEventListener('click', () => { showAdminSection('roles'); loadRoles(); });
    adminTabTracking?.addEventListener('click', () => showAdminSection('tracking'));
    adminTabVendors?.addEventListener('click', () => { showAdminSection('vendors'); loadVendors(); });

    async function fetchMe() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) throw new Error('unauth');
        const data = await res.json();
        currentUser = data.user;
        currentUser.permissions = computePerms(currentUser);
        updateUserUI();
        syncCatalogSaveUI();
        await syncTrackingAutoRefreshFromServer();
        await loadTags();
        await loadPriorityTags();
        fetchOrders();
        await loadStock();
        await loadSubteams();
        loadVendors();
        loadUsers();
        refreshCatalogView();
      } catch {
        currentUser = null;
        updateUserUI();
        resetCatalogSavePanel();
        resetCatalogLookup();
        stockItems = [];
        renderStockGrid();
        renderStockFilters();
      }
    }

    loginBtn.addEventListener('click', () => {
      loginModal.style.display = 'flex';
    });
    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      currentUser = null;
      updateUserUI();
      resetCatalogSavePanel();
      resetCatalogLookup();
      orders = [];
      renderBoard();
      renderTable();
      stockItems = [];
      renderStockGrid();
      stockSubteams = [];
      renderStockFilters();
      showOrdersView();
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(loginForm);
      const payload = Object.fromEntries(formData.entries());
      loginMessage.textContent = 'Signing in...';
      loginMessage.className = 'small';
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) {
        loginMessage.textContent = data.error || 'Login failed';
        loginMessage.className = 'error';
        return;
      }
      currentUser = data.user;
      currentUser.permissions = computePerms(currentUser);
      loginMessage.textContent = '';
      loginModal.style.display = 'none';
      updateUserUI();
      syncCatalogSaveUI();
      syncTrackingAutoRefreshFromServer();
      await loadTags();
      await loadPriorityTags();
      fetchOrders();
      await loadStock();
      await loadSubteams();
      loadVendors();
      loadUsers();
      refreshCatalogView();
    });

    updateSearchPlaceholder();
    startTrackingAutoRefresh(DEFAULT_TRACKING_POLL_MINUTES);
    fetchMe();
  </script>
</body>
</html>
