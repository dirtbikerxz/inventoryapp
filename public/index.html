<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DV Parts Orders</title>
  <style>
    :root {
      --purple: #461D7C;
      --gold: #FDD023;
      --bg: #110b1f;
      --panel: #1a1230;
      --panel-2: #140d25;
      --accent: var(--gold);
      --accent-2: #f7d96c;
      --text: #f5efff;
      --muted: #c8c1dd;
      --border: #2a1f45;
      --danger: #ff5565;
      --success: #4ad28f;
      --warning: var(--gold);
      --card-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: linear-gradient(120deg, #1b0f32, #120924);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .brand {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--gold);
      text-shadow: 0 2px 10px rgba(253,208,35,0.2);
    }
    .search {
      flex: 1;
      max-width: 400px;
      margin: 0 16px;
      position: relative;
    }
    .search input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn {
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.15s ease;
    }
    .btn:hover { border-color: var(--accent); box-shadow: 0 6px 18px rgba(253,208,35,0.25); }
    .btn.primary {
      background: var(--accent);
      color: #2b1d00;
      border-color: var(--accent);
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(253,208,35,0.25);
    }
    .btn.ghost {
      background: transparent;
    }
    main { padding: 24px; }
    .page-title { font-size: 32px; font-weight: 800; margin: 0 0 4px; color: var(--gold); }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .view-toggle {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--panel);
    }
    .view-toggle button {
      border: none;
      background: transparent;
      color: var(--text);
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      min-width: 100px;
    }
    .view-toggle button.active {
      background: var(--accent);
      color: #0b1324;
    }
    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    /* Board */
    .board {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      margin-top: 16px;
    }
    .column {
      background: var(--panel-2);
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 12px;
      min-height: 300px;
      position: relative;
    }
    .column h3 {
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
    }
    .pill {
      background: #1f2a44;
      color: var(--text);
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
    }
    .board-drop {
      min-height: 200px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      cursor: grab;
      transition: transform 0.1s ease, border-color 0.1s ease, box-shadow 0.15s ease;
    }
    .card:hover { border-color: var(--accent); box-shadow: 0 10px 28px rgba(253,208,35,0.18); }
    .card h4 { margin: 0 0 6px; font-size: 15px; }
    .meta {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1b2440;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .tag.supplier { background: rgba(79,180,255,0.12); color: var(--accent-2); }
    .tag.priority { background: rgba(248,197,82,0.16); color: var(--gold); }
    .tag.group { background: rgba(74,210,143,0.16); color: var(--success); }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .checkbox {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
    }
    .card.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(79,180,255,0.25); }
    /* Table */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .input {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      width: 100%;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 13px;
    }
    th { color: var(--muted); font-weight: 600; }
    tr:hover td { background: rgba(79,180,255,0.05); }
    .status-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .status-Requested { background: rgba(253,208,35,0.18); color: var(--gold); }
    .status-Ordered { background: rgba(253,208,35,0.28); color: #1f1a00; }
    .status-Received { background: rgba(74,210,143,0.16); color: var(--success); }
    .status-Cancelled { background: rgba(255,85,101,0.16); color: var(--danger); }
    .selection-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
      margin: 12px 0;
    }
    .selection-bar.active { display: flex; }
    .input-inline {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--text);
    }
    .small { font-size: 12px; color: var(--muted); }
    .empty {
      border: 1px dashed var(--border);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
      background: var(--panel-2);
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">DV Parts Orders</div>
    <div class="search">
      <input id="global-search" placeholder="Search parts, students, suppliers..." />
    </div>
    <div class="toolbar">
      <div id="user-chip" class="pill" style="background: var(--panel); border:1px solid var(--border);"></div>
      <button class="btn ghost" id="login-btn">Login</button>
      <button class="btn ghost" id="logout-btn" style="display:none;">Logout</button>
      <button class="btn ghost" id="account-btn">Account</button>
      <button class="btn ghost" id="admin-btn" style="display:none;">Admin</button>
      <button class="btn ghost" id="vendor-btn" style="display:none;">Vendors</button>
      <button class="btn ghost" id="refresh-btn">Refresh</button>
      <button class="btn primary" id="new-order-btn">New order</button>
    </div>
  </header>

  <main>
    <div class="flex-between">
      <div>
        <div class="page-title">Orders</div>
        <div class="subtitle">Track parts from request to delivery.</div>
      </div>
      <div class="view-toggle">
        <button id="board-view-btn" class="active">Board</button>
        <button id="table-view-btn">Table</button>
        <button id="settings-btn" class="btn ghost" style="border:none; padding:8px 12px;">Settings</button>
      </div>
    </div>

    <div id="selection-bar" class="selection-bar">
      <div id="selection-count"></div>
      <div class="flex-between" style="gap:8px; flex:1;">
        <input id="group-title" class="input-inline" placeholder="Group title" />
        <input id="group-vendor" class="input-inline" placeholder="Vendor / Supplier" />
        <input id="group-tracking" class="input-inline" placeholder="Tracking number" />
      </div>
      <button class="btn primary" id="group-btn">Create/Update Group</button>
    </div>

    <section id="board-section">
      <div class="board" id="board"></div>
    </section>

    <section id="table-section" style="display:none;">
      <div class="filters">
        <div><label class="small">Start date</label><input id="start-date" class="input" type="date" /></div>
        <div><label class="small">End date</label><input id="end-date" class="input" type="date" /></div>
        <div><label class="small">Status</label><select id="status-filter" class="input"></select></div>
        <div><label class="small">Vendor</label><select id="vendor-filter" class="input"></select></div>
      </div>
      <div id="table-container"></div>
    </section>
  </main>

  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:50; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:720px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">New Order</div>
          <div class="subtitle" style="margin-bottom:12px;">Provide a vendor link or part number. We’ll fetch details when supported; otherwise enter manually.</div>
        </div>
        <button class="btn ghost" id="close-modal">Close</button>
      </div>
      <form id="order-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:12px;">
        <div>
          <label class="small">Vendor</label>
          <input name="vendor" class="input" placeholder="WCP, AM, McMaster, DigiKey..." />
        </div>
        <div>
          <label class="small">Product number</label>
          <input name="vendorPartNumber" class="input" placeholder="e.g., WCP-0921" />
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Product link</label>
          <input name="partLink" class="input" placeholder="https://vendor.com/product/..." />
        </div>
        <div style="grid-column: span 2;">
          <button type="button" class="btn primary" id="fetch-product">Fetch details</button>
          <span class="small">Supported vendors: WCP (beta). Others: fill manually.</span>
        </div>
        <div>
          <label class="small">Part name</label>
          <input name="partName" class="input" required />
        </div>
        <div>
          <label class="small">Unit price</label>
          <input name="unitCost" class="input" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label class="small">Quantity</label>
          <input name="quantityRequested" class="input" type="number" min="1" value="1" required />
        </div>
        <div>
          <label class="small">Stock status</label>
          <input name="stockStatus" class="input" placeholder="In stock / Backordered / Lead time" />
        </div>
        <div>
          <label class="small">Priority</label>
          <select name="priority" class="input">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </div>
        <div style="grid-column: span 2;">
          <label class="small">Notes</label>
          <textarea name="notes" class="input" rows="3" placeholder="Justification, sizing details, links, etc."></textarea>
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="order-message" class="small"></div>
          <div class="flex-between" style="gap:8px;">
            <button type="button" class="btn ghost" id="cancel-order">Cancel</button>
            <button type="submit" class="btn primary">Submit order</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="login-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:70; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:420px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:22px;">Sign In</div>
      <div class="subtitle" style="margin-bottom:12px;">Use your team-issued account.</div>
      <form id="login-form" class="grid" style="grid-template-columns:1fr; gap:12px;">
        <div>
          <label class="small">Username</label>
          <input name="username" class="input" required />
        </div>
        <div>
          <label class="small">Password</label>
          <input name="password" class="input" type="password" required />
        </div>
        <div class="flex-between">
          <div id="login-message" class="small"></div>
          <button type="submit" class="btn primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <div id="account-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:65; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:500px; width:100%; box-shadow:var(--card-shadow); padding:18px;">
      <div class="page-title" style="font-size:22px;">My Account</div>
      <div class="subtitle" style="margin-bottom:12px;">Update your password.</div>
      <form id="password-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:8px; margin-top:8px;">
        <div>
          <label class="small">Old password</label>
          <input name="oldPassword" class="input" type="password" required />
        </div>
        <div>
          <label class="small">New password</label>
          <input name="newPassword" class="input" type="password" required />
        </div>
        <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
          <div id="password-message" class="small"></div>
          <button type="submit" class="btn primary">Update password</button>
        </div>
      </form>
    </div>
  </div>

  <div id="admin-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:60; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Admin Panel</div>
          <div class="subtitle" style="margin-bottom:12px;">Manage users and role permissions.</div>
        </div>
        <button class="btn ghost" id="close-admin">Close</button>
      </div>

      <div class="card" style="background:var(--panel-2); margin-top:12px;">
        <div class="page-title" style="font-size:18px;">User Management</div>
        <div id="user-list" class="small" style="margin-top:8px;">Loading users...</div>
        <form id="user-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:10px;">
          <input type="hidden" name="id" />
          <div>
            <label class="small">Username</label>
            <input name="username" class="input" required />
          </div>
          <div>
            <label class="small">Name</label>
            <input name="name" class="input" required />
          </div>
          <div>
            <label class="small">Role</label>
            <select name="role" class="input">
              <option>admin</option>
              <option>mentor</option>
              <option>student</option>
            </select>
          </div>
          <div>
            <label class="small">Password (set/reset)</label>
            <input name="password" class="input" type="password" placeholder="Leave blank to keep existing" />
          </div>
          <div>
            <label class="small">Active</label>
            <select name="active" class="input">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
            <div id="user-message" class="small"></div>
            <div class="flex-between" style="gap:8px;">
              <button type="button" class="btn ghost" id="clear-user">Clear</button>
              <button type="submit" class="btn primary">Save user</button>
            </div>
          </div>
        </form>
      </div>

      <div class="card" style="background:var(--panel-2); margin-top:12px;">
        <div class="page-title" style="font-size:18px;">Role Permissions</div>
        <div class="subtitle">Toggle what each role can do.</div>
        <div id="role-list" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <div id="vendor-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:60; align-items:center; justify-content:center; padding:16px;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; box-shadow:var(--card-shadow); padding:18px; max-height:90vh; overflow:auto;">
      <div class="flex-between" style="align-items:flex-start;">
        <div>
          <div class="page-title" style="font-size:22px;">Vendor Extraction Settings</div>
          <div class="subtitle" style="margin-bottom:12px;">Configure how to pull product details from each vendor.</div>
        </div>
        <button class="btn ghost" id="close-settings">Close</button>
      </div>

      <div class="card" style="background:var(--panel-2);">
        <form id="vendor-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px;">
          <input type="hidden" name="id" />
          <div>
            <label class="small">Vendor name</label>
            <input name="vendor" class="input" placeholder="e.g., WCP" required />
          </div>
          <div>
            <label class="small">Base URL</label>
            <input name="baseUrl" class="input" placeholder="https://wcproducts.com" />
          </div>
          <div>
            <label class="small">Product URL template</label>
            <input name="productUrlTemplate" class="input" placeholder="https://wcproducts.com/products/{partNumber}" />
          </div>
          <div>
            <label class="small">Part # example</label>
            <input name="partNumberExample" class="input" placeholder="WCP-0921" />
          </div>
          <div>
            <label class="small">Part # regex</label>
            <input name="partNumberPattern" class="input" placeholder="^WCP-\\d+$" />
          </div>
          <div>
            <label class="small">Name selector</label>
            <input name="nameSelector" class="input" placeholder=".product-title" />
          </div>
          <div>
            <label class="small">Price selector</label>
            <input name="priceSelector" class="input" placeholder=".price" />
          </div>
          <div>
            <label class="small">Stock selector</label>
            <input name="stockSelector" class="input" placeholder=".stock" />
          </div>
          <div style="grid-column: span 2;">
            <label class="small">Notes / headers JSON (optional)</label>
            <textarea name="notes" class="input" rows="2" placeholder="Headers: {\"User-Agent\":\"...\"}"></textarea>
          </div>
          <div style="grid-column: span 2;">
            <div class="small" style="margin-bottom:6px;">Test extraction (paste a product URL)</div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:8px;">
              <input id="test-url" class="input" placeholder="https://vendor.com/product/123" />
              <button type="button" class="btn primary" id="test-extract">Test</button>
            </div>
            <div id="extract-results" class="small" style="margin-top:8px;"></div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px;">
              <div>
                <label class="small">Pick name</label>
                <select id="pick-name" class="input"></select>
              </div>
              <div>
                <label class="small">Pick price</label>
                <select id="pick-price" class="input"></select>
              </div>
              <div>
                <label class="small">Pick stock</label>
                <select id="pick-stock" class="input"></select>
              </div>
            </div>
          </div>
          <div class="flex-between" style="grid-column: span 2; margin-top:6px;">
            <div id="vendor-message" class="small"></div>
            <div class="flex-between" style="gap:8px;">
              <button type="button" class="btn ghost" id="clear-vendor">Clear</button>
              <button type="submit" class="btn primary">Save vendor</button>
            </div>
          </div>
        </form>
      </div>

      <div id="vendor-list" style="margin-top:14px;"></div>

    </div>
  </div>

  <script>
    const boardEl = document.getElementById('board');
    const boardBtn = document.getElementById('board-view-btn');
    const tableBtn = document.getElementById('table-view-btn');
    const boardSection = document.getElementById('board-section');
    const tableSection = document.getElementById('table-section');
    const refreshBtn = document.getElementById('refresh-btn');
    const globalSearch = document.getElementById('global-search');
    const statusFilter = document.getElementById('status-filter');
    const vendorFilter = document.getElementById('vendor-filter');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const tableContainer = document.getElementById('table-container');
    const selectionBar = document.getElementById('selection-bar');
    const selectionCount = document.getElementById('selection-count');
    const groupBtn = document.getElementById('group-btn');
    const groupTitle = document.getElementById('group-title');
    const groupVendor = document.getElementById('group-vendor');
    const groupTracking = document.getElementById('group-tracking');
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('close-modal');
    const cancelOrder = document.getElementById('cancel-order');
    const orderForm = document.getElementById('order-form');
    const orderMessage = document.getElementById('order-message');
    const fetchProduct = document.getElementById('fetch-product');
    const newOrderBtn = document.getElementById('new-order-btn');
    const vendorBtn = document.getElementById('vendor-btn');
    const settingsModal = document.getElementById('vendor-modal');
    const closeSettings = document.getElementById('close-settings');
    const adminBtn = document.getElementById('admin-btn');
    const adminModal = document.getElementById('admin-modal');
    const closeAdmin = document.getElementById('close-admin');
    const accountBtn = document.getElementById('account-btn');
    const accountModal = document.getElementById('account-modal');
    const vendorForm = document.getElementById('vendor-form');
    const vendorMessage = document.getElementById('vendor-message');
    const clearVendor = document.getElementById('clear-vendor');
    const vendorList = document.getElementById('vendor-list');
    const testUrl = document.getElementById('test-url');
    const testExtract = document.getElementById('test-extract');
    const pickName = document.getElementById('pick-name');
    const pickPrice = document.getElementById('pick-price');
    const pickStock = document.getElementById('pick-stock');
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('login-form');
    const loginMessage = document.getElementById('login-message');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userChip = document.getElementById('user-chip');
    const userList = document.getElementById('user-list');
    const userForm = document.getElementById('user-form');
    const userMessage = document.getElementById('user-message');
    const clearUser = document.getElementById('clear-user');
    const passwordForm = document.getElementById('password-form');
    const passwordMessage = document.getElementById('password-message');
    const roleList = document.getElementById('role-list');
    let vendorConfigs = [];
    let currentUser = null;

    const statuses = [
      { label: 'To order', status: 'Requested', hint: 'Parts requests - awaiting purchase' },
      { label: 'Ordered', status: 'Ordered', hint: 'Placed orders - awaiting arrival' },
      { label: 'Arrived', status: 'Received', hint: 'Items received' },
      { label: 'Cancelled', status: 'Cancelled', hint: 'Not moving forward' }
    ];

    let orders = [];
    let selected = new Set();

    function fmtDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function matchesSearch(order, term) {
      if (!term) return true;
      const hay = [
        order.partName,
        order.vendorPartNumber,
        order.partLink,
        order.studentName,
        order.supplier,
        order.productCode,
        order.orderNumber,
        order.category,
        order.priority,
        order.group && order.group.title,
        order.group && order.group.trackingNumber
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(term.toLowerCase());
    }

    function withinDate(order, start, end) {
      if (!start && !end) return true;
      const ts = order.requestedAt || Date.parse(order.createdAt || '') || 0;
      if (start && ts < start) return false;
      if (end && ts > end) return false;
      return true;
    }

    function filteredOrders() {
      const term = globalSearch.value.trim();
      const s = statusFilter.value;
      const v = vendorFilter.value;
      const start = startDate.value ? Date.parse(startDate.value) : null;
      const end = endDate.value ? Date.parse(endDate.value) + 24*60*60*1000 : null; // inclusive
      return orders.filter(o =>
        matchesSearch(o, term) &&
        (!s || o.status === s) &&
        (!v || (o.supplier || '').toLowerCase() === v.toLowerCase()) &&
        withinDate(o, start, end)
      );
    }

    async function fetchOrders() {
      if (!currentUser) return;
      const res = await fetch('/api/orders');
      const data = await res.json();
      orders = (data.orders || []).map(o => ({ ...o, _id: o._id || o.id || o.orderNumber }));
      buildFilters();
      renderBoard();
      renderTable();
      updateSelectionBar();
    }

    function buildFilters() {
      const statusesUnique = Array.from(new Set(orders.map(o => o.status).filter(Boolean)));
      statusFilter.innerHTML = ['<option value="">All statuses</option>', ...statusesUnique.map(s => `<option>${s}</option>`)].join('');
      const vendors = Array.from(new Set(orders.map(o => (o.supplier || '').trim()).filter(Boolean)));
      vendorFilter.innerHTML = ['<option value="">All vendors</option>', ...vendors.map(v => `<option>${v}</option>`)].join('');
    }

    function createCard(order) {
      const card = document.createElement('div');
      card.className = 'card';
      card.draggable = true;
      card.dataset.id = order._id;
      if (selected.has(order._id)) card.classList.add('selected');

      card.innerHTML = `
        <div class="flex-between" style="gap:8px;">
          <div>
            <h4>${order.partName || 'Untitled part'}</h4>
            <div class="meta">Requested by ${order.studentName || 'Unknown'}</div>
          </div>
          <input type="checkbox" class="checkbox" ${selected.has(order._id) ? 'checked' : ''}/>
        </div>
          <div class="meta">
          ${order.totalCost ? '$'+order.totalCost : (order.unitCost ? '$'+order.unitCost : (order.fetchedPrice ? '$'+order.fetchedPrice : ''))}
          ${order.quantityRequested ? ' · x' + order.quantityRequested : ''}
        </div>
        <div class="meta">
          ${order.supplier || order.vendor ? `<span class="tag supplier">${order.supplier || order.vendor}</span>` : ''}
          ${order.vendorPartNumber ? `<span class="tag">${order.vendorPartNumber}</span>` : ''}
          ${order.stockStatus ? `<span class="tag priority">${order.stockStatus}</span>` : ''}
          ${order.priority ? `<span class="tag priority">${order.priority}</span>` : ''}
          ${order.group ? `<span class="tag group">Group: ${order.group.title || order.group.supplier || 'Grouped'}</span>` : ''}
        </div>
        <div class="card-footer">
          <span class="muted">${order.productCode || ''}</span>
          <span class="muted">${fmtDate(order.requestedAt)}</span>
        </div>
      `;

      card.querySelector('.checkbox').addEventListener('click', (e) => {
        e.stopPropagation();
        toggleSelect(order._id);
      });

      card.addEventListener('click', (e) => {
        if (e.target.closest('.checkbox')) return;
        toggleSelect(order._id);
      });

      card.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', order._id);
        card.style.opacity = '0.6';
      });
      card.addEventListener('dragend', () => { card.style.opacity = '1'; });
      return card;
    }

    function renderBoard() {
      const grouped = filteredOrders().reduce((acc, order) => {
        acc[order.status] = acc[order.status] || [];
        acc[order.status].push(order);
        return acc;
      }, {});

      boardEl.innerHTML = '';
      statuses.forEach(col => {
        const column = document.createElement('div');
        column.className = 'column';
        column.dataset.status = col.status;
        column.innerHTML = `
          <h3>${col.label} <span class="pill">${(grouped[col.status] || []).length}</span></h3>
          <div class="small" style="margin-bottom:6px;">${col.hint}</div>
          <div class="board-drop"></div>
        `;
        const dropArea = column.querySelector('.board-drop');

        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.border = '1px dashed var(--accent)'; });
        dropArea.addEventListener('dragleave', () => { dropArea.style.border = 'none'; });
        dropArea.addEventListener('drop', (e) => {
          e.preventDefault();
          dropArea.style.border = 'none';
          const id = e.dataTransfer.getData('text/plain');
          if (id) updateStatus(id, col.status);
        });

        (grouped[col.status] || []).forEach(order => {
          dropArea.appendChild(createCard(order));
        });

        if ((grouped[col.status] || []).length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'Drag an order here or create a new one.';
          dropArea.appendChild(empty);
        }

        boardEl.appendChild(column);
      });
    }

    function renderTable() {
      const rows = filteredOrders();
      if (!rows.length) {
        tableContainer.innerHTML = '<div class="empty">No orders found.</div>';
        return;
      }

      const header = `
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>Part</th>
              <th>Status</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Total</th>
              <th>Vendor</th>
              <th>Requested by</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody>
      `;
      const body = rows.map(o => `
        <tr data-id="${o._id}">
          <td><input type="checkbox" class="row-check" ${selected.has(o._id) ? 'checked' : ''}></td>
          <td>
            ${o.partName || ''}
            ${o.vendorPartNumber ? `<div class="small">${o.vendorPartNumber}</div>` : ''}
            ${o.partLink ? `<div class="small"><a href="${o.partLink}" target="_blank">link</a></div>` : ''}
            ${o.group ? `<span class="tag group">Group</span>` : ''}
          </td>
          <td><span class="status-chip status-${o.status || ''}">${o.status || ''}</span></td>
          <td>${o.quantityRequested || ''}</td>
          <td>${o.unitCost ? '$'+o.unitCost : (o.fetchedPrice ? '$'+o.fetchedPrice : '')}</td>
          <td>${o.totalCost ? '$'+o.totalCost : ''}</td>
          <td>${o.supplier || o.vendor || ''}</td>
          <td>${o.studentName || ''}</td>
          <td>${fmtDate(o.requestedAt)}</td>
        </tr>
      `).join('');
      tableContainer.innerHTML = header + body + '</tbody></table>';

      tableContainer.querySelector('#select-all').addEventListener('change', (e) => {
        const check = e.target.checked;
        rows.forEach(o => { if (check) selected.add(o._id); else selected.delete(o._id); });
        renderBoard(); renderTable(); updateSelectionBar();
      });
      tableContainer.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = e.target.closest('tr').dataset.id;
          if (e.target.checked) selected.add(id); else selected.delete(id);
          renderBoard(); updateSelectionBar();
        });
      });
    }

    function toggleSelect(id) {
      if (selected.has(id)) selected.delete(id);
      else selected.add(id);
      renderBoard();
      renderTable();
      updateSelectionBar();
    }

    async function updateStatus(id, status) {
      await fetch(`/api/orders/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      selected.delete(id);
      await fetchOrders();
    }

    function updateSelectionBar() {
      if (selected.size === 0) {
        selectionBar.classList.remove('active');
        selectionCount.textContent = '';
        return;
      }
      selectionBar.classList.add('active');
      selectionCount.textContent = `${selected.size} selected`;
    }

    async function createGroup() {
      if (selected.size === 0) return;
      await fetch('/api/order-groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: groupTitle.value || undefined,
          supplier: groupVendor.value || undefined,
          trackingNumber: groupTracking.value || undefined,
          orderIds: Array.from(selected)
        })
      });
      selected.clear();
      groupTitle.value = '';
      groupVendor.value = '';
      groupTracking.value = '';
      await fetchOrders();
    }

    // Event wiring
    boardBtn.addEventListener('click', () => {
      boardBtn.classList.add('active'); tableBtn.classList.remove('active');
      boardSection.style.display = 'block'; tableSection.style.display = 'none';
    });
    tableBtn.addEventListener('click', () => {
      tableBtn.classList.add('active'); boardBtn.classList.remove('active');
      boardSection.style.display = 'none'; tableSection.style.display = 'block';
    });
    refreshBtn.addEventListener('click', fetchOrders);
    globalSearch.addEventListener('input', () => { renderBoard(); renderTable(); });
    statusFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    vendorFilter.addEventListener('change', () => { renderBoard(); renderTable(); });
    startDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    endDate.addEventListener('change', () => { renderBoard(); renderTable(); });
    groupBtn.addEventListener('click', createGroup);
    document.getElementById('new-order-btn').addEventListener('click', () => {
      modal.style.display = 'flex';
    });
    closeModal.addEventListener('click', () => { modal.style.display = 'none'; });
    cancelOrder.addEventListener('click', () => { modal.style.display = 'none'; });

    function findVendorConfig(name) {
      if (!name) return null;
      const lower = name.toLowerCase();
      return vendorConfigs.find(v => (v.vendor || '').toLowerCase() === lower) || null;
    }

    function deriveUrl(config, partNum, link) {
      if (link) return link;
      if (!config) return null;
      if (config.productUrlTemplate && partNum) {
        return config.productUrlTemplate.replace('{partNumber}', partNum);
      }
      if (config.baseUrl && partNum) {
        return `${config.baseUrl.replace(/\/$/, '')}/${partNum}`;
      }
      return null;
    }

    function parsePrice(text) {
      if (!text) return undefined;
      const num = parseFloat(text.replace(/[^0-9\\.]+/g, ''));
      return Number.isFinite(num) ? num : undefined;
    }

    fetchProduct.addEventListener('click', async () => {
      const formData = new FormData(orderForm);
      const vendor = (formData.get('vendor') || '').toString().trim();
      const vendorLower = vendor.toLowerCase();
      const partNum = (formData.get('vendorPartNumber') || '').toString().trim();
      const link = (formData.get('partLink') || '').toString().trim();
      const config = findVendorConfig(vendorLower);
      const url = deriveUrl(config, partNum, link);
      if (!url) {
        orderMessage.textContent = 'Provide a link or vendor part number.';
        orderMessage.className = 'error';
        return;
      }
      orderMessage.textContent = 'Fetching...';
      orderMessage.className = 'small';
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url,
            selectors: {
              nameSelector: config?.nameSelector,
              priceSelector: config?.priceSelector,
              stockSelector: config?.stockSelector
            }
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Fetch failed');

        const pickName = data.picks?.name || data.candidates?.titles?.[0]?.text;
        const pickPrice = data.picks?.price || data.candidates?.prices?.[0]?.text;
        const pickStock = data.picks?.stock || data.candidates?.stocks?.[0]?.text;

        if (pickName && !orderForm.elements.partName.value) orderForm.elements.partName.value = pickName;
        const priceNum = parsePrice(pickPrice);
        if (priceNum !== undefined) {
          orderForm.elements.unitCost.value = priceNum;
        }
        if (pickStock) orderForm.elements.stockStatus.value = pickStock;
        if (!orderForm.elements.partLink.value) orderForm.elements.partLink.value = url;

        orderMessage.textContent = 'Fetched. Verify fields before submitting.';
        orderMessage.className = 'success';
      } catch (err) {
        orderMessage.textContent = 'Fetch failed. Fill manually.';
        orderMessage.className = 'error';
      }
    });

    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(orderForm);
      const payload = Object.fromEntries(formData.entries());
      payload.quantityRequested = Number(payload.quantityRequested || 0);
      payload.unitCost = payload.unitCost ? Number(payload.unitCost) : undefined;
      payload.fetchedPrice = payload.unitCost || undefined;
      payload.supplier = payload.vendor || payload.supplier;
      orderMessage.textContent = 'Submitting...';
      orderMessage.className = 'small';
      try {
        await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        orderMessage.textContent = 'Order created.';
        orderMessage.className = 'success';
        modal.style.display = 'none';
        orderForm.reset();
        await fetchOrders();
      } catch (err) {
        orderMessage.textContent = 'Failed to create order';
        orderMessage.className = 'error';
      }
    });

    vendorBtn.addEventListener('click', () => {
      settingsModal.style.display = 'flex';
      loadVendors();
    });
    closeSettings.addEventListener('click', () => { settingsModal.style.display = 'none'; });
    adminBtn.addEventListener('click', () => {
      adminModal.style.display = 'flex';
      loadUsers();
      loadRoles();
    });
    closeAdmin.addEventListener('click', () => { adminModal.style.display = 'none'; });
    accountBtn.addEventListener('click', () => {
      accountModal.style.display = 'flex';
    });
    clearVendor.addEventListener('click', () => { vendorForm.reset(); vendorForm.elements.id.value = ''; });

    async function loadVendors() {
      if (!currentUser) return;
      vendorList.textContent = 'Loading...';
      try {
        const res = await fetch('/api/vendors/configs');
        const data = await res.json();
        vendorConfigs = data.vendors || [];
        if (!vendorConfigs.length) {
          vendorList.innerHTML = '<div class="empty">No vendor configs yet. Create one above.</div>';
          return;
        }
        vendorList.innerHTML = vendorConfigs.map(v => `
          <div class="card" data-id="${v._id}" style="margin-bottom:8px;">
            <div class="flex-between">
              <div>
                <h4 style="margin:0 0 4px;">${v.vendor}</h4>
                <div class="small">${v.baseUrl || ''}</div>
                <div class="small">Template: ${v.productUrlTemplate || ''}</div>
                <div class="small">Selectors: ${v.nameSelector || '-'} | ${v.priceSelector || '-'} | ${v.stockSelector || '-'}</div>
              </div>
              <div class="flex-between" style="gap:8px;">
                <button class="btn ghost" data-action="edit">Edit</button>
                <button class="btn ghost" data-action="delete" style="color:var(--danger);">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        vendorList.querySelectorAll('button[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const v = vendorConfigs.find(x => x._id === id);
            if (!v) return;
            vendorForm.elements.id.value = id;
            vendorForm.elements.vendor.value = v.vendor || '';
            vendorForm.elements.baseUrl.value = v.baseUrl || '';
            vendorForm.elements.productUrlTemplate.value = v.productUrlTemplate || '';
            vendorForm.elements.partNumberExample.value = v.partNumberExample || '';
            vendorForm.elements.partNumberPattern.value = v.partNumberPattern || '';
            vendorForm.elements.nameSelector.value = v.nameSelector || '';
            vendorForm.elements.priceSelector.value = v.priceSelector || '';
            vendorForm.elements.stockSelector.value = v.stockSelector || '';
            vendorForm.elements.notes.value = v.notes || '';
          });
        });

        vendorList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            if (!id) return;
            await fetch(`/api/vendors/configs/${id}`, { method: 'DELETE' });
            loadVendors();
          });
        });
      } catch (e) {
        vendorList.textContent = 'Failed to load vendors';
      }
    }

    vendorForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(vendorForm).entries());
      const id = data.id || undefined;
      if (!data.vendor) {
        vendorMessage.textContent = 'Vendor is required';
        vendorMessage.className = 'error';
        return;
      }
      vendorMessage.textContent = 'Saving...';
      vendorMessage.className = 'small';
      let headersObj;
      if (data.notes) {
        try {
          headersObj = JSON.parse(data.notes);
        } catch (e) {
          vendorMessage.textContent = 'Notes/headers not valid JSON.';
          vendorMessage.className = 'error';
          return;
        }
      }
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/vendors/configs/${id}` : '/api/vendors/configs';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vendor: data.vendor,
            baseUrl: data.baseUrl || undefined,
            productUrlTemplate: data.productUrlTemplate || undefined,
            partNumberExample: data.partNumberExample || undefined,
            partNumberPattern: data.partNumberPattern || undefined,
            nameSelector: data.nameSelector || undefined,
            priceSelector: data.priceSelector || undefined,
            stockSelector: data.stockSelector || undefined,
            notes: data.notes || undefined,
            headers: headersObj
          })
        });
        vendorMessage.textContent = 'Saved.';
        vendorMessage.className = 'success';
        vendorForm.reset();
        loadVendors();
      } catch (err) {
        vendorMessage.textContent = 'Failed to save vendor';
        vendorMessage.className = 'error';
      }
    });

    userForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(userForm).entries());
      const id = data.id || undefined;
      const payload = {
        username: data.username,
        name: data.name,
        role: data.role,
        active: data.active === 'true',
        permissions: undefined
      };
      if (data.password) payload.password = data.password;
      userMessage.textContent = 'Saving...';
      userMessage.className = 'small';
      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/users/${id}` : '/api/users';
      try {
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        userMessage.textContent = 'Saved user.';
        userMessage.className = 'success';
        userForm.reset();
        loadUsers();
      } catch (err) {
        userMessage.textContent = 'Failed to save user';
        userMessage.className = 'error';
      }
    });

    clearUser.addEventListener('click', () => {
      userForm.reset();
      userForm.elements.id.value = '';
    });

    passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(passwordForm).entries());
      passwordMessage.textContent = 'Updating...';
      passwordMessage.className = 'small';
      const res = await fetch('/api/auth/password', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const resp = await res.json();
      if (!res.ok) {
        passwordMessage.textContent = resp.error || 'Failed';
        passwordMessage.className = 'error';
        return;
      }
      passwordMessage.textContent = 'Password updated.';
      passwordMessage.className = 'success';
      passwordForm.reset();
    });

    async function testExtraction() {
      const url = testUrl.value.trim();
      if (!url) {
        vendorMessage.textContent = 'Provide a URL to test.';
        vendorMessage.className = 'error';
        return;
      }
      const selectors = {
        nameSelector: vendorForm.elements.nameSelector.value || undefined,
        priceSelector: vendorForm.elements.priceSelector.value || undefined,
        stockSelector: vendorForm.elements.stockSelector.value || undefined
      };
      const headers = {};
      try {
        const notes = vendorForm.elements.notes.value;
        if (notes) {
          const parsed = JSON.parse(notes);
          Object.assign(headers, parsed);
        }
      } catch (e) {
        vendorMessage.textContent = 'Notes/headers not valid JSON.';
        vendorMessage.className = 'error';
        return;
      }

      const resultsEl = document.getElementById('extract-results');
      resultsEl.textContent = 'Testing...';
      try {
        const res = await fetch('/api/vendors/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, selectors, headers })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        resultsEl.textContent = 'Pick which value looks correct for each field.';

        const nameOptions = (data.picks?.name ? [{ text: data.picks.name, selector: selectors.nameSelector }] : []).concat(data.candidates?.titles || []);
        const priceOptions = (data.picks?.price ? [{ text: data.picks.price, selector: selectors.priceSelector }] : []).concat(data.candidates?.prices || []);
        const stockOptions = (data.picks?.stock ? [{ text: data.picks.stock, selector: selectors.stockSelector }] : []).concat(data.candidates?.stocks || []);

        const makeOptions = (opts) => opts.map(c => `<option value="${c.selector || ''}">${c.text || ''}</option>`).join('');
        pickName.innerHTML = '<option value="">-- choose name --</option>' + makeOptions(nameOptions);
        pickPrice.innerHTML = '<option value="">-- choose price --</option>' + makeOptions(priceOptions);
        pickStock.innerHTML = '<option value="">-- choose stock --</option>' + makeOptions(stockOptions);

        const applySelection = (selectEl, fieldName) => {
          const apply = () => {
            const selSelector = selectEl.value || '';
            if (selSelector) {
              vendorForm.elements[fieldName].value = selSelector;
            }
          };
          selectEl.addEventListener('change', apply);
          if (selectEl.options.length > 1) {
            selectEl.selectedIndex = 1;
            apply();
          }
        };
        applySelection(pickName, 'nameSelector');
        applySelection(pickPrice, 'priceSelector');
        applySelection(pickStock, 'stockSelector');
      } catch (err) {
        resultsEl.textContent = 'Extraction failed. Check URL/headers.';
        vendorMessage.textContent = err.message;
        vendorMessage.className = 'error';
      }
    }

    testExtract.addEventListener('click', testExtraction);

    function updateUserUI() {
      if (currentUser) {
        userChip.textContent = `${currentUser.name || currentUser.username || 'User'} · ${currentUser.role || ''}`;
        userChip.style.display = 'inline-flex';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        accountBtn.style.display = 'inline-flex';
      } else {
        userChip.textContent = '';
        userChip.style.display = 'none';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        accountBtn.style.display = 'none';
        adminBtn.style.display = 'none';
        vendorBtn.style.display = 'none';
      }
      // Permissions gating
      if (currentUser?.permissions?.canPlaceOrders) {
        newOrderBtn.disabled = false;
      } else {
        newOrderBtn.disabled = true;
      }
      vendorBtn.style.display = currentUser?.permissions?.canManageVendors ? 'inline-flex' : 'none';
      adminBtn.style.display = currentUser?.permissions?.canManageUsers ? 'inline-flex' : 'none';
    }

    async function loadUsers() {
      if (!currentUser?.permissions?.canManageUsers) {
        userList.innerHTML = '<div class="empty">No access to manage users.</div>';
        return;
      }
      userList.textContent = 'Loading users...';
      try {
        const res = await fetch('/api/users');
        const data = await res.json();
        const users = data.users || [];
        if (!users.length) {
          userList.innerHTML = '<div class="empty">No users.</div>';
          return;
        }
        userList.innerHTML = users.map(u => `
          <div class="card" data-id="${u._id}" style="margin-bottom:6px;">
            <div class="flex-between">
              <div>
                <div><strong>${u.username}</strong> (${u.role})</div>
                <div class="small">${u.name || ''}</div>
                <div class="small">Active: ${u.active ? 'Yes' : 'No'}</div>
              </div>
              <div class="flex-between" style="gap:8px;">
                <button class="btn ghost" data-action="edit-user">Edit</button>
              </div>
            </div>
          </div>
        `).join('');

        userList.querySelectorAll('button[data-action="edit-user"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.card');
            const id = card.dataset.id;
            const u = users.find(x => x._id === id);
            if (!u) return;
            userForm.elements.id.value = u._id;
            userForm.elements.username.value = u.username;
            userForm.elements.name.value = u.name || '';
            userForm.elements.role.value = u.role || 'student';
            userForm.elements.active.value = u.active ? 'true' : 'false';
          });
        });
      } catch (e) {
        userList.textContent = 'Failed to load users';
      }
    }

    async function loadRoles() {
      if (!currentUser?.permissions?.canManageUsers) {
        roleList.innerHTML = '<div class="empty">No access to manage roles.</div>';
        return;
      }
      roleList.textContent = 'Loading roles...';
      try {
        const res = await fetch('/api/roles');
        const data = await res.json();
        const roles = data.roles || [];
        const combined = {
          admin: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: true },
          mentor: { canPlaceOrders: true, canMoveOrders: true, canEditOrders: true, canDeleteOrders: true, canManageVendors: true, canManageUsers: false },
          student: { canPlaceOrders: true, canMoveOrders: false, canEditOrders: false, canDeleteOrders: false, canManageVendors: false, canManageUsers: false }
        };
        roles.forEach(r => { combined[r.role] = r.permissions; });

        const renderToggle = (role, key, label) => `
          <label class="small" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" data-role="${role}" data-key="${key}" ${combined[role]?.[key] ? 'checked' : ''}/>
            ${label}
          </label>`;

        const roleCard = (role) => `
          <div class="card" style="margin-bottom:8px;">
            <div class="page-title" style="font-size:16px;">${role}</div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px;">
              ${renderToggle(role, 'canPlaceOrders', 'Can place orders')}
              ${renderToggle(role, 'canMoveOrders', 'Can move orders')}
              ${renderToggle(role, 'canEditOrders', 'Can edit orders')}
              ${renderToggle(role, 'canDeleteOrders', 'Can delete orders')}
              ${renderToggle(role, 'canManageVendors', 'Can manage vendors')}
              ${renderToggle(role, 'canManageUsers', 'Can manage users')}
            </div>
            <div class="flex-between" style="margin-top:8px;">
              <button class="btn primary" data-action="save-role" data-role="${role}">Save ${role}</button>
            </div>
          </div>`;

        roleList.innerHTML = ['admin', 'mentor', 'student'].map(roleCard).join('');

        roleList.querySelectorAll('button[data-action="save-role"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const role = e.target.dataset.role;
            const inputs = roleList.querySelectorAll(`input[data-role="${role}"]`);
            const perms = {};
            inputs.forEach(input => {
              perms[input.dataset.key] = input.checked;
            });
            await fetch(`/api/roles/${role}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ permissions: perms })
            });
          });
        });
      } catch (e) {
        roleList.textContent = 'Failed to load roles';
      }
    }

    async function fetchMe() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) throw new Error('unauth');
        const data = await res.json();
        currentUser = data.user;
        updateUserUI();
        fetchOrders();
        loadVendors();
        loadUsers();
      } catch {
        currentUser = null;
        updateUserUI();
      }
    }

    loginBtn.addEventListener('click', () => {
      loginModal.style.display = 'flex';
    });
    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      currentUser = null;
      updateUserUI();
      orders = [];
      renderBoard();
      renderTable();
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(loginForm);
      const payload = Object.fromEntries(formData.entries());
      loginMessage.textContent = 'Signing in...';
      loginMessage.className = 'small';
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) {
        loginMessage.textContent = data.error || 'Login failed';
        loginMessage.className = 'error';
        return;
      }
      currentUser = data.user;
      loginMessage.textContent = '';
      loginModal.style.display = 'none';
      updateUserUI();
      fetchOrders();
      loadVendors();
      loadUsers();
    });

    fetchMe();
  </script>
</body>
</html>
